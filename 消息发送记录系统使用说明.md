# æ¶ˆæ¯å‘é€è®°å½•ç³»ç»Ÿä½¿ç”¨è¯´æ˜

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

**åŠŸèƒ½**ï¼šå®Œæ•´è®°å½•æ‰€æœ‰å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯çš„å‘é€æƒ…å†µï¼ˆæˆåŠŸ/å¤±è´¥/è·³è¿‡ï¼‰

**ç”¨é€”**ï¼š
1. âœ… **é˜²æ­¢é‡å¤å‘é€**ï¼šåŸºäºæ•°æ®åº“è®°å½•ï¼Œæ›´å¯é 
2. âœ… **è¿½è¸ªå‘é€å†å²**ï¼šå®Œæ•´çš„å‘é€è®°å½•ï¼Œä¾¿äºé—®é¢˜æ’æŸ¥
3. âœ… **ç»Ÿè®¡åˆ†æ**ï¼šå‘é€æˆåŠŸç‡ã€å¤±è´¥åŸå› åˆ†æ
4. âœ… **å®¡è®¡æ—¥å¿—**ï¼šè°åœ¨ä»€ä¹ˆæ—¶é—´å‘é€äº†ä»€ä¹ˆé€šçŸ¥

---

## ğŸ—ƒï¸ æ•°æ®åº“è¡¨ç»“æ„

### ä¸»è¡¨ï¼š`notification_log`

| å­—æ®µ | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|
| `id` | INT | ä¸»é”®ID | 1 |
| `appointment_id` | INT | é¢„çº¦ID | 123 |
| `plate_number` | VARCHAR(20) | è½¦ç‰Œå· | "äº¬A12345" |
| `openid` | VARCHAR(100) | æ¥æ”¶è€…openid | "oXXXX..." |
| `notification_type` | VARCHAR(50) | é€šçŸ¥ç±»å‹ | "timeout_15min" |
| `notify_time_point` | INT | é€šçŸ¥æ—¶é—´ç‚¹ | 15 |
| `remaining_minutes` | INT | å‰©ä½™æ—¶é—´ | 15 |
| `receiver_type` | VARCHAR(20) | æ¥æ”¶è€…ç±»å‹ | "visitor" |
| `appoint_type` | VARCHAR(20) | é¢„çº¦ç±»å‹ | "é‚€è¯·" |
| **`send_status`** | TINYINT | å‘é€çŠ¶æ€ | 0=å¤±è´¥, 1=æˆåŠŸ, 2=è·³è¿‡ |
| `send_time` | DATETIME | å‘é€æ—¶é—´ | 2024-12-04 11:45:00 |
| `success` | TINYINT | æ˜¯å¦æˆåŠŸ | 0=å¦, 1=æ˜¯ |
| `error_message` | TEXT | é”™è¯¯ä¿¡æ¯ | "openidæ— æ•ˆ" |
| `wechat_msg_id` | VARCHAR(100) | å¾®ä¿¡æ¶ˆæ¯ID | "..." |
| `send_by` | VARCHAR(50) | å‘é€æ¥æº | "scheduled_task" |

### è§†å›¾ï¼š`v_notification_statistics`

è‡ªåŠ¨ç»Ÿè®¡æ¯å¤©çš„å‘é€æƒ…å†µï¼š
```sql
SELECT * FROM v_notification_statistics WHERE send_date = CURDATE();
```

---

## ğŸ’» Javaä»£ç ä½¿ç”¨

### 1. åœ¨Serviceä¸­æ³¨å…¥

```java
@Resource
private NotificationLogService notificationLogService;
```

### 2. åˆ›å»ºé€šçŸ¥è®°å½•

#### æ–¹å¼1ï¼šä½¿ç”¨ä¾¿æ·æ–¹æ³•ï¼ˆæ¨èï¼‰

```java
// åˆ›å»ºè¶…æ—¶é€šçŸ¥è®°å½•
NotificationLog log = notificationLogService.createTimeoutLog(
    appointment.getId(),        // é¢„çº¦ID
    appointment.getPlatenumber(), // è½¦ç‰Œå·
    openid,                      // æ¥æ”¶è€…openid
    15,                          // é€šçŸ¥æ—¶é—´ç‚¹ï¼ˆ15/5/1ï¼‰
    15,                          // å‰©ä½™æ—¶é—´
    "visitor",                   // æ¥æ”¶è€…ç±»å‹
    appointment.getAppointtype() // é¢„çº¦ç±»å‹
);
```

#### æ–¹å¼2ï¼šæ‰‹åŠ¨åˆ›å»º

```java
NotificationLog log = new NotificationLog();
log.setAppointmentId(appointment.getId());
log.setPlateNumber(appointment.getPlatenumber());
log.setOpenid(openid);
log.setNotificationType(NotificationLog.NotificationType.TIMEOUT_15MIN);
log.setNotifyTimePoint(15);
log.setRemainingMinutes(15);
log.setReceiverType(NotificationLog.ReceiverType.VISITOR);
log.setAppointType(appointment.getAppointtype());
log.setSendBy(NotificationLog.SendBy.SCHEDULED_TASK);
```

### 3. è®°å½•å‘é€ç»“æœ

#### å‘é€æˆåŠŸ
```java
// è°ƒç”¨å¾®ä¿¡APIå‘é€
Map<String, Object> result = weChatTemplateMessageService.send...(...);

if (Boolean.TRUE.equals(result.get("success"))) {
    // è®°å½•æˆåŠŸ
    log.setWechatMsgId((String) result.get("msgid"));  // å¾®ä¿¡æ¶ˆæ¯ID
    notificationLogService.logSuccess(log);
}
```

#### å‘é€å¤±è´¥
```java
else {
    // è®°å½•å¤±è´¥
    log.setErrorCode((String) result.get("errcode"));
    log.setErrorMessage((String) result.get("errmsg"));
    notificationLogService.logFailure(log);
}
```

#### è·³è¿‡ï¼ˆé‡å¤ï¼‰
```java
if (notificationLogService.isDuplicateSend(appointmentId, notifyTimePoint, 5)) {
    // è®°å½•è·³è¿‡
    notificationLogService.logSkipped(log);
    return;
}
```

### 4. å®Œæ•´ç¤ºä¾‹

```java
/**
 * å‘é€è¶…æ—¶é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
private boolean sendTimeoutNotificationWithLog(Appointment appointment, long remainingMinutes, String openid, String receiverType) {
    try {
        // 1. æ£€æŸ¥æ˜¯å¦å·²å‘é€è¿‡ï¼ˆåŸºäºæ•°æ®åº“ï¼‰
        if (notificationLogService.isDuplicateSend(
                appointment.getId(), 
                (int) remainingMinutes, 
                5  // 5åˆ†é’Ÿå†…ä¸é‡å¤å‘é€
            )) {
            log.info("â­ï¸ è·³è¿‡é‡å¤å‘é€ - è½¦ç‰Œ: {}, æ—¶é—´ç‚¹: {}åˆ†é’Ÿ", 
                appointment.getPlatenumber(), remainingMinutes);
            return false;
        }
        
        // 2. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createTimeoutLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            openid,
            (int) remainingMinutes,
            (int) remainingMinutes,
            receiverType,
            appointment.getAppointtype()
        );
        
        // 3. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendParkingAlmostTimeoutNotification(
            openid,
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getArrivedate(),
            remainingMinutes
        );
        
        // 4. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… å‘é€æˆåŠŸ - è½¦ç‰Œ: {}, æ—¶é—´ç‚¹: {}åˆ†é’Ÿ", 
                appointment.getPlatenumber(), remainingMinutes);
            return true;
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
            log.warn("âš ï¸ å‘é€å¤±è´¥ - è½¦ç‰Œ: {}, åŸå› : {}", 
                appointment.getPlatenumber(), result.get("message"));
            return false;
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€é€šçŸ¥å¼‚å¸¸ - è½¦ç‰Œ: {}", appointment.getPlatenumber(), e);
        return false;
    }
}
```

---

## ğŸ” æŸ¥è¯¢å’Œç»Ÿè®¡

### 1. æŸ¥è¯¢æŸä¸ªé¢„çº¦çš„æ‰€æœ‰é€šçŸ¥

```java
List<NotificationLog> logs = notificationLogService.getByAppointmentId(appointmentId);
```

### 2. æŸ¥è¯¢æŸè¾†è½¦çš„é€šçŸ¥å†å²

```java
List<NotificationLog> logs = notificationLogService.getByPlateNumber("äº¬A12345", 50);
```

### 3. æŸ¥è¯¢ä»Šå¤©å‘é€å¤±è´¥çš„é€šçŸ¥

```java
LocalDateTime today = LocalDateTime.now().withHour(0).withMinute(0).withSecond(0);
LocalDateTime tomorrow = today.plusDays(1);

List<NotificationLog> failed = notificationLogService.getFailedNotifications(today, tomorrow);
```

### 4. ç»Ÿè®¡å‘é€æˆåŠŸç‡ï¼ˆæŒ‰ç±»å‹ï¼‰

```java
LocalDateTime startTime = LocalDateTime.now().minusDays(7);  // æœ€è¿‘7å¤©
LocalDateTime endTime = LocalDateTime.now();

List<Map<String, Object>> stats = notificationLogService.getStatisticsByType(startTime, endTime);

// ç»“æœç¤ºä¾‹ï¼š
// [
//   {notificationType: "timeout_15min", totalCount: 100, successCount: 95, failCount: 5, successRate: 95.00},
//   {notificationType: "timeout_5min", totalCount: 80, successCount: 78, failCount: 2, successRate: 97.50}
// ]
```

### 5. ç»Ÿè®¡æ¯æ—¥å‘é€æƒ…å†µ

```java
List<Map<String, Object>> dailyStats = notificationLogService.getStatisticsByDate(7);  // æœ€è¿‘7å¤©
```

### 6. è·å–æ€»ä½“æˆåŠŸç‡

```java
LocalDateTime startTime = LocalDateTime.now().minusDays(7);
LocalDateTime endTime = LocalDateTime.now();

Double successRate = notificationLogService.getSuccessRate(startTime, endTime);
log.info("ğŸ“Š æœ€è¿‘7å¤©å‘é€æˆåŠŸç‡: {}%", successRate);
```

---

## ğŸ”§ å®šæœŸæ¸…ç†

### æ‰‹åŠ¨æ¸…ç†

```java
// æ¸…ç†90å¤©å‰çš„è®°å½•
int deleted = notificationLogService.cleanExpiredLogs(90);
log.info("ğŸ§¹ æ¸…ç†è¿‡æœŸè®°å½•ï¼Œåˆ é™¤: {}æ¡", deleted);
```

### å®šæ—¶ä»»åŠ¡æ¸…ç†ï¼ˆå¯é€‰ï¼‰

```java
@Scheduled(cron = "0 0 3 * * ?")  // æ¯å¤©å‡Œæ™¨3ç‚¹
public void cleanExpiredNotificationLogs() {
    notificationLogService.cleanExpiredLogs(90);  // ä¿ç•™90å¤©
}
```

---

## ğŸ“Š SQLæŸ¥è¯¢ç¤ºä¾‹

### 1. æŸ¥è¯¢æŸä¸ªé¢„çº¦çš„æ‰€æœ‰é€šçŸ¥è®°å½•

```sql
SELECT * 
FROM notification_log 
WHERE appointment_id = 123 
ORDER BY send_time DESC;
```

### 2. æŸ¥è¯¢ä»Šå¤©å‘é€å¤±è´¥çš„é€šçŸ¥

```sql
SELECT * 
FROM notification_log 
WHERE DATE(send_time) = CURDATE() 
  AND send_status = 0
ORDER BY send_time DESC;
```

### 3. æŸ¥è¯¢æŸè¾†è½¦çš„é€šçŸ¥å†å²

```sql
SELECT * 
FROM notification_log 
WHERE plate_number = 'äº¬A12345' 
ORDER BY send_time DESC 
LIMIT 50;
```

### 4. ç»Ÿè®¡ä»Šå¤©çš„å‘é€æƒ…å†µ

```sql
SELECT * 
FROM v_notification_statistics 
WHERE send_date = CURDATE();
```

### 5. æ£€æŸ¥é‡å¤å‘é€ï¼ˆ5åˆ†é’Ÿå†…ï¼‰

```sql
SELECT appointment_id, notify_time_point, COUNT(*) as count 
FROM notification_log 
WHERE send_time > DATE_SUB(NOW(), INTERVAL 5 MINUTE) 
  AND send_status IN (1, 2)
GROUP BY appointment_id, notify_time_point 
HAVING count > 1;
```

### 6. æŸ¥è¯¢å‘é€æˆåŠŸç‡ï¼ˆæŒ‰ç±»å‹ï¼‰

```sql
SELECT notification_type, 
       COUNT(*) as total,
       SUM(success) as success,
       ROUND(SUM(success) * 100.0 / COUNT(*), 2) as success_rate
FROM notification_log
WHERE send_time > DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY notification_type;
```

### 7. æŸ¥è¯¢æœ€å¸¸è§çš„é”™è¯¯

```sql
SELECT error_message, COUNT(*) as count
FROM notification_log
WHERE send_status = 0
  AND error_message IS NOT NULL
GROUP BY error_message
ORDER BY count DESC
LIMIT 10;
```

---

## ğŸ¯ å¸¸é‡å®šä¹‰

### é€šçŸ¥ç±»å‹
```java
NotificationLog.NotificationType.TIMEOUT_15MIN  // "timeout_15min"
NotificationLog.NotificationType.TIMEOUT_5MIN   // "timeout_5min"
NotificationLog.NotificationType.TIMEOUT_1MIN   // "timeout_1min"
NotificationLog.NotificationType.VIOLATION      // "violation"
```

### å‘é€çŠ¶æ€
```java
NotificationLog.SendStatus.FAILED   // 0 - å¤±è´¥
NotificationLog.SendStatus.SUCCESS  // 1 - æˆåŠŸ
NotificationLog.SendStatus.SKIPPED  // 2 - è·³è¿‡ï¼ˆé‡å¤ï¼‰
```

### æ¥æ”¶è€…ç±»å‹
```java
NotificationLog.ReceiverType.VISITOR      // "visitor" - è®¿å®¢
NotificationLog.ReceiverType.OWNER        // "owner" - ä¸šä¸»
NotificationLog.ReceiverType.HOUSEKEEPER  // "housekeeper" - ç®¡å®¶
```

### å‘é€æ¥æº
```java
NotificationLog.SendBy.SCHEDULED_TASK  // "scheduled_task" - å®šæ—¶ä»»åŠ¡
NotificationLog.SendBy.API             // "api" - APIè°ƒç”¨
NotificationLog.SendBy.MANUAL          // "manual" - æ‰‹åŠ¨
```

---

## âœ… éƒ¨ç½²æ­¥éª¤

### 1. æ‰§è¡ŒSQLè„šæœ¬

```bash
# åœ¨æ•°æ®åº“ä¸­æ‰§è¡Œ
mysql -u username -p database_name < src/main/resources/sql/notification_log.sql
```

### 2. é‡å¯æœåŠ¡

```bash
# é‡å¯Spring Bootåº”ç”¨
# MyBatis Plusä¼šè‡ªåŠ¨è¯†åˆ«æ–°çš„Entityå’ŒMapper
```

### 3. éªŒè¯

```java
// æµ‹è¯•æ’å…¥ä¸€æ¡è®°å½•
NotificationLog testLog = new NotificationLog();
testLog.setOpenid("test_openid");
testLog.setNotificationType("test");
testLog.setSendStatus(1);
testLog.setSendTime(LocalDateTime.now());

boolean saved = notificationLogService.save(testLog);
log.info("æµ‹è¯•ä¿å­˜ç»“æœ: {}", saved);
```

---

## ğŸ“ˆ ç›‘æ§å»ºè®®

### 1. æ¯æ—¥æˆåŠŸç‡ç›‘æ§

```java
@Scheduled(cron = "0 0 9 * * ?")  // æ¯å¤©æ—©ä¸Š9ç‚¹
public void dailySuccessRateReport() {
    LocalDateTime yesterday = LocalDateTime.now().minusDays(1).withHour(0).withMinute(0).withSecond(0);
    LocalDateTime today = LocalDateTime.now().withHour(0).withMinute(0).withSecond(0);
    
    Double successRate = notificationLogService.getSuccessRate(yesterday, today);
    
    if (successRate < 90.0) {
        // æˆåŠŸç‡ä½äº90%ï¼Œå‘é€å‘Šè­¦
        log.warn("âš ï¸ æ˜¨æ—¥æ¶ˆæ¯å‘é€æˆåŠŸç‡è¿‡ä½: {}%", successRate);
    }
}
```

### 2. å¤±è´¥é€šçŸ¥é‡è¯•

```java
@Scheduled(cron = "0 */30 * * * ?")  // æ¯30åˆ†é’Ÿ
public void retryFailedNotifications() {
    // æŸ¥è¯¢1å°æ—¶å†…å¤±è´¥ä¸”é‡è¯•æ¬¡æ•°<3çš„è®°å½•
    List<NotificationLog> retryList = baseMapper.getRetryableFailedNotifications(3, 10);
    
    for (NotificationLog failedLog : retryList) {
        // é‡æ–°å‘é€...
        // æ›´æ–°é‡è¯•æ¬¡æ•°
        failedLog.setRetryCount(failedLog.getRetryCount() + 1);
        notificationLogService.updateById(failedLog);
    }
}
```

---

## âœ¨ æ€»ç»“

âœ… **å·²åˆ›å»ºå®Œæ•´çš„æ¶ˆæ¯å‘é€è®°å½•ç³»ç»Ÿ**ï¼š
1. æ•°æ®åº“è¡¨ï¼ˆnotification_logï¼‰
2. Javaå®ä½“ç±»ï¼ˆNotificationLogï¼‰
3. Mapperæ¥å£ï¼ˆNotificationLogMapperï¼‰
4. Serviceå±‚ï¼ˆNotificationLogServiceï¼‰
5. XMLæŸ¥è¯¢é…ç½®
6. ç»Ÿè®¡è§†å›¾

âœ… **åŠŸèƒ½å®Œå¤‡**ï¼š
- è®°å½•æˆåŠŸ/å¤±è´¥/è·³è¿‡
- é˜²æ­¢é‡å¤å‘é€
- ç»Ÿè®¡åˆ†æ
- å®šæœŸæ¸…ç†
- å¤±è´¥é‡è¯•

âœ… **ä½¿ç”¨ç®€å•**ï¼š
```java
// 1. åˆ›å»ºè®°å½•
NotificationLog log = notificationLogService.createTimeoutLog(...);

// 2. å‘é€é€šçŸ¥
Map<String, Object> result = weChatService.send...(...);

// 3. è®°å½•ç»“æœ
notificationLogService.logSuccess(log);  // æˆ– logFailure(log)
```

---

**åˆ›å»ºæ—¶é—´**ï¼š2024-12-04  
**ä½œè€…**ï¼šAI Assistant
