# å·¡æ£€å‘˜å€¼ç­çŠ¶æ€ç®¡ç†åŠŸèƒ½ - åç«¯å¼€å‘å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### Phase 1: æ•°æ®åº“æ”¹é€  âœ…

#### 1.1 SQLè„šæœ¬æ–‡ä»¶
**æ–‡ä»¶ä½ç½®ï¼š** `sql/patrol_duty_management.sql`

**å†…å®¹ï¼š**
- âœ… `patrol` è¡¨æ·»åŠ  `notification_enabled` å­—æ®µï¼ˆå€¼ç­å¼€å…³ï¼‰
- âœ… `patrol` è¡¨æ·»åŠ  `last_status_change_time` å­—æ®µï¼ˆçŠ¶æ€å˜æ›´æ—¶é—´ï¼‰
- âœ… åˆ›å»ºç´¢å¼•ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- âœ… åˆ›å»º `patrol_duty_log` æ—¥å¿—è¡¨ï¼ˆå¯é€‰ï¼Œç”¨äºå®¡è®¡ï¼‰
- âœ… åˆå§‹åŒ–æ•°æ®ï¼ˆé»˜è®¤æ‰€æœ‰å·¡æ£€å‘˜ä¸ºå€¼ç­çŠ¶æ€ï¼‰

**æ‰§è¡Œæ–¹å¼ï¼š**
```bash
mysql -u root -p parking_db < sql/patrol_duty_management.sql
```

---

### Phase 2: åç«¯ä»£ç æ”¹é€  âœ…

#### 2.1 å®ä½“ç±»ä¿®æ”¹
**æ–‡ä»¶ï¼š** `src/main/java/com/parkingmanage/entity/Patrol.java`

**æ”¹åŠ¨ï¼š**
```java
/**
 * æ¶ˆæ¯é€šçŸ¥å¼€å…³ï¼š1=æ¥æ”¶ï¼ˆå€¼ç­ä¸­ï¼‰ï¼Œ0=ä¸æ¥æ”¶ï¼ˆç¦»å²—ï¼‰
 */
private Integer notificationEnabled;

/**
 * æœ€åä¸€æ¬¡å€¼ç­çŠ¶æ€å˜æ›´æ—¶é—´
 */
private LocalDateTime lastStatusChangeTime;
```

---

#### 2.2 Serviceå±‚
**æ–‡ä»¶ï¼š** `src/main/java/com/parkingmanage/service/PatrolService.java`

**æ–°å¢æ–¹æ³•ï¼š**
```java
/**
 * æŸ¥è¯¢æŒ‡å®šå°åŒºæ‰€æœ‰å€¼ç­ä¸­çš„å·¡æ£€å‘˜
 * @param community å°åŒºåç§°
 * @return å€¼ç­ä¸­çš„å·¡æ£€å‘˜åˆ—è¡¨
 */
List<Patrol> getOnDutyPatrolsByCommunity(String community);
```

**æ–‡ä»¶ï¼š** `src/main/java/com/parkingmanage/service/impl/PatrolServiceImpl.java`

**å®ç°å†…å®¹ï¼š**
- âœ… å®ç° `getOnDutyPatrolsByCommunity` æ–¹æ³•
- âœ… æŸ¥è¯¢æ¡ä»¶ï¼š`notification_enabled = 1` + `status = 'å·²ç¡®å®š'` + `openid IS NOT NULL`
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡º
- âœ… æ— å€¼ç­å·¡æ£€å‘˜æ—¶è®°å½•è­¦å‘Šæ—¥å¿—

---

#### 2.3 Controllerå±‚
**æ–‡ä»¶ï¼š** `src/main/java/com/parkingmanage/controller/PatrolController.java`

**æ–°å¢æ¥å£1ï¼šåˆ‡æ¢å€¼ç­çŠ¶æ€**
```java
@PostMapping("/toggleNotification")
public ResponseEntity<Result> toggleNotificationStatus(
    @RequestParam String openid, 
    @RequestParam Integer enabled)
```

**åŠŸèƒ½ï¼š**
- æ ¹æ® openid æŸ¥è¯¢å·¡æ£€å‘˜
- æ›´æ–° `notification_enabled` çŠ¶æ€
- æ›´æ–° `last_status_change_time` æ—¶é—´
- è¿”å›æ“ä½œç»“æœå’Œæ–°çŠ¶æ€

**æ–°å¢æ¥å£2ï¼šæŸ¥è¯¢å€¼ç­çŠ¶æ€**
```java
@GetMapping("/getDutyStatus")
public ResponseEntity<Result> getDutyStatus(@RequestParam String openid)
```

**åŠŸèƒ½ï¼š**
- æŸ¥è¯¢å½“å‰å·¡æ£€å‘˜çš„å€¼ç­çŠ¶æ€
- è¿”å›çŠ¶æ€æ–‡æœ¬ã€å˜æ›´æ—¶é—´ç­‰ä¿¡æ¯

---

#### 2.4 å®šæ—¶ä»»åŠ¡æ”¹é€ 
**æ–‡ä»¶ï¼š** `src/main/java/com/parkingmanage/task/ParkingTimeoutMonitoringTask.java`

**æ”¹åŠ¨å†…å®¹ï¼š**
```java
@Resource
private PatrolService patrolService;
```

**åœ¨ `sendTimeoutNotification` æ–¹æ³•ä¸­æ·»åŠ ï¼š**
```java
// ğŸ†• æŸ¥è¯¢å½“å‰è½¦åœºå€¼ç­ä¸­çš„å·¡æ£€å‘˜å¹¶å‘é€é€šçŸ¥
if (StringUtils.hasText(appointment.getCommunity())) {
    List<Patrol> onDutyPatrols = patrolService.getOnDutyPatrolsByCommunity(appointment.getCommunity());
    
    if (!onDutyPatrols.isEmpty()) {
        log.info("ğŸ“‹ [è¶…æ—¶æé†’] å‘ {} ä½å€¼ç­å·¡æ£€å‘˜å‘é€é€šçŸ¥", onDutyPatrols.size());
        
        for (Patrol patrol : onDutyPatrols) {
            if (StringUtils.hasText(patrol.getOpenid())) {
                totalCount++;
                if (sendNotificationToUser(patrol.getOpenid(), appointment, remainingMinutes, 
                    notificationType + "(å·¡æ£€å‘˜:" + patrol.getUsername() + ")")) {
                    successCount++;
                }
            }
        }
    } else {
        log.warn("âš ï¸ [è¶…æ—¶æé†’] å°åŒº {} å½“å‰æ— å€¼ç­å·¡æ£€å‘˜", appointment.getCommunity());
    }
}
```

**æ•ˆæœï¼š**
- âœ… è¶…æ—¶æé†’ä¼šè‡ªåŠ¨æ¨é€ç»™æ‰€æœ‰å€¼ç­ä¸­çš„å·¡æ£€å‘˜
- âœ… ç¦»å²—çš„å·¡æ£€å‘˜ä¸ä¼šæ”¶åˆ°æ¨é€
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•å’Œç»Ÿè®¡

---

## ğŸ“‹ APIæ¥å£æ–‡æ¡£

### 1. åˆ‡æ¢å€¼ç­çŠ¶æ€

**æ¥å£ï¼š** `POST /parking/patrol/toggleNotification`

**è¯·æ±‚å‚æ•°ï¼š**
```json
{
  "openid": "å·¡æ£€å‘˜å¾®ä¿¡openid",
  "enabled": 1  // 1=å€¼ç­ä¸­ï¼Œ0=ç¦»å²—
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": "0",
  "msg": "çŠ¶æ€å·²æ›´æ–°ä¸ºï¼šå€¼ç­ä¸­",
  "data": {
    "patrolName": "å¼ ä¸‰",
    "community": "é”¦ç»£èŠ±å›­",
    "notificationEnabled": 1,
    "statusText": "å€¼ç­ä¸­",
    "changeTime": "2025-12-04 10:30:00"
  }
}
```

**å¤±è´¥å“åº”ï¼š**
```json
{
  "code": "1",
  "msg": "æœªæ‰¾åˆ°å·¡æ£€å‘˜ä¿¡æ¯"
}
```

---

### 2. æŸ¥è¯¢å€¼ç­çŠ¶æ€

**æ¥å£ï¼š** `GET /parking/patrol/getDutyStatus`

**è¯·æ±‚å‚æ•°ï¼š**
```
openid=å·¡æ£€å‘˜å¾®ä¿¡openid
```

**æˆåŠŸå“åº”ï¼š**
```json
{
  "code": "0",
  "data": {
    "notificationEnabled": 1,
    "statusText": "å€¼ç­ä¸­",
    "lastChangeTime": "2025-12-04 08:00:00",
    "patrolName": "å¼ ä¸‰",
    "community": "é”¦ç»£èŠ±å›­"
  }
}
```

---

## ğŸ”„ ä¸šåŠ¡æµç¨‹

### è¶…æ—¶æé†’æ¨é€æµç¨‹

```
å®šæ—¶ä»»åŠ¡æ¯åˆ†é’Ÿæ‰§è¡Œ
    â†“
æŸ¥è¯¢2å°æ—¶å†…æ´»è·ƒè½¦è¾†
    â†“
è®¡ç®—åœè½¦æ—¶é•¿
    â†“
åˆ¤æ–­æ˜¯å¦éœ€è¦æé†’ï¼ˆå‰©ä½™15/5/1åˆ†é’Ÿï¼‰
    â†“
æ ¹æ®é¢„çº¦ç±»å‹å‘é€ç»™è®¿å®¢/ç®¡å®¶/ä¸šä¸»
    â†“
ğŸ†• æŸ¥è¯¢å½“å‰è½¦åœºå€¼ç­ä¸­çš„å·¡æ£€å‘˜
    â†“
ğŸ†• éå†å‘é€ç»™æ‰€æœ‰å€¼ç­å·¡æ£€å‘˜
    â†“
è®°å½•æ¨é€ç»“æœ
```

### æ¨é€å¯¹è±¡è§„åˆ™

| é¢„çº¦ç±»å‹ | æ¨é€å¯¹è±¡ |
|---------|---------|
| **é‚€è¯·é¢„çº¦** | è®¿å®¢ + ç®¡å®¶ + ä¸šä¸» + **å€¼ç­å·¡æ£€å‘˜** |
| **ä»£äººé¢„çº¦** | ç®¡å®¶ + ä¸šä¸» + **å€¼ç­å·¡æ£€å‘˜** |
| **å…¶ä»–é¢„çº¦** | è®¿å®¢ + **å€¼ç­å·¡æ£€å‘˜** |

---

## ğŸ“Š æµ‹è¯•éªŒè¯

### åç«¯æµ‹è¯•

#### 1. æ•°æ®åº“æµ‹è¯•
```sql
-- æŸ¥çœ‹æ‰€æœ‰å·¡æ£€å‘˜çš„å€¼ç­çŠ¶æ€
SELECT 
  id,
  username,
  community,
  notification_enabled,
  CASE 
    WHEN notification_enabled = 1 THEN 'å€¼ç­ä¸­'
    WHEN notification_enabled = 0 THEN 'ç¦»å²—'
    ELSE 'æœªçŸ¥'
  END as status_text,
  last_status_change_time
FROM patrol
WHERE status = 'å·²ç¡®å®š'
ORDER BY community, username;

-- æŸ¥çœ‹å„å°åŒºå€¼ç­äººæ•°ç»Ÿè®¡
SELECT 
  community,
  COUNT(*) as total,
  SUM(CASE WHEN notification_enabled = 1 THEN 1 ELSE 0 END) as on_duty,
  SUM(CASE WHEN notification_enabled = 0 THEN 1 ELSE 0 END) as off_duty
FROM patrol
WHERE status = 'å·²ç¡®å®š'
GROUP BY community;
```

#### 2. æ¥å£æµ‹è¯•ï¼ˆä½¿ç”¨Postman/Apifoxï¼‰

**æµ‹è¯•1ï¼šåˆ‡æ¢ä¸ºå€¼ç­çŠ¶æ€**
```http
POST http://localhost:8080/parking/patrol/toggleNotification
Content-Type: application/x-www-form-urlencoded

openid=xxx&enabled=1
```

**æµ‹è¯•2ï¼šåˆ‡æ¢ä¸ºç¦»å²—çŠ¶æ€**
```http
POST http://localhost:8080/parking/patrol/toggleNotification
Content-Type: application/x-www-form-urlencoded

openid=xxx&enabled=0
```

**æµ‹è¯•3ï¼šæŸ¥è¯¢å€¼ç­çŠ¶æ€**
```http
GET http://localhost:8080/parking/patrol/getDutyStatus?openid=xxx
```

#### 3. æ—¥å¿—æ£€æŸ¥

**å¯åŠ¨åº”ç”¨åè§‚å¯Ÿæ—¥å¿—ï¼š**
```
ğŸ“‹ [æŸ¥è¯¢å€¼ç­å·¡æ£€å‘˜] å¼€å§‹æŸ¥è¯¢ - å°åŒº: é”¦ç»£èŠ±å›­
ğŸ“‹ [æŸ¥è¯¢å€¼ç­å·¡æ£€å‘˜] æŸ¥è¯¢å®Œæˆ - å°åŒº: é”¦ç»£èŠ±å›­, å€¼ç­äººæ•°: 2
```

**åˆ‡æ¢çŠ¶æ€æ—¶æ—¥å¿—ï¼š**
```
ğŸ”„ [å€¼ç­çŠ¶æ€åˆ‡æ¢] openid: xxx, ç›®æ ‡çŠ¶æ€: å€¼ç­ä¸­
âœ… [å€¼ç­çŠ¶æ€åˆ‡æ¢] æˆåŠŸ - å·¡æ£€å‘˜: å¼ ä¸‰, å°åŒº: é”¦ç»£èŠ±å›­, æ–°çŠ¶æ€: å€¼ç­ä¸­
```

**è¶…æ—¶æé†’æ¨é€æ—¥å¿—ï¼š**
```
ğŸ“‹ [è¶…æ—¶æé†’] å‘ 2 ä½å€¼ç­å·¡æ£€å‘˜å‘é€é€šçŸ¥ - å°åŒº: é”¦ç»£èŠ±å›­
âœ… [å®šæ—¶ä»»åŠ¡] å³å°†è¶…æ—¶æé†’(å‰©ä½™15åˆ†é’Ÿ)(å·¡æ£€å‘˜:å¼ ä¸‰)å‘é€æˆåŠŸ
```

---

## ğŸš€ ä¸‹ä¸€æ­¥å·¥ä½œï¼šå‰ç«¯å¼€å‘

### Phase 3: å‰ç«¯æ”¹é€ ï¼ˆå¾…å®æ–½ï¼‰

#### 3.1 violation.vueï¼ˆè¿è§„æŸ¥è¯¢é¡µé¢ï¼‰
**éœ€è¦æ·»åŠ ï¼š**
- âœ… å¯¼èˆªæ å³ä¾§æ·»åŠ å€¼ç­å¼€å…³
- âœ… é¡µé¢åŠ è½½æ—¶æŸ¥è¯¢å€¼ç­çŠ¶æ€
- âœ… åˆ‡æ¢çŠ¶æ€åŠŸèƒ½ï¼ˆå¸¦äºŒæ¬¡ç¡®è®¤ï¼‰
- âœ… å°ç¨‹åºå†…æé†’ï¼ˆæ—©ä¸Šé¦–æ¬¡æ‰“å¼€ï¼‰
- âœ… éœ‡åŠ¨åé¦ˆ

#### 3.2 custom-tabbar.vueï¼ˆè‡ªå®šä¹‰TabBarï¼‰
**éœ€è¦æ·»åŠ ï¼š**
- âœ… æ¥æ”¶å€¼ç­çŠ¶æ€ prop
- âœ… è¿è§„æŸ¥è¯¢èœå•æ˜¾ç¤ºå¾½æ ‡
- âœ… TabBarä¸Šæ–¹æ˜¾ç¤ºçŠ¶æ€æ¨ªæ¡
- âœ… ç‚¹å‡»æ¨ªæ¡åˆ‡æ¢çŠ¶æ€
- âœ… çŠ¶æ€åŒæ­¥æ›´æ–°

#### 3.3 add-violation.vueï¼ˆæ–°å¢è¿è§„é¡µé¢ï¼Œå¯é€‰ï¼‰
**å¯é€‰æ·»åŠ ï¼š**
- åŒæ­¥æ˜¾ç¤ºå€¼ç­çŠ¶æ€

---

## ğŸ“ å‰ç«¯å¼€å‘æŒ‡å—

è¯¦è§é…å¥—æ–‡æ¡£ï¼š
- `å·¡æ£€å‘˜å€¼ç­çŠ¶æ€ç®¡ç†åŠŸèƒ½å®æ–½æ–¹æ¡ˆ.md` - å®Œæ•´å®æ–½æ–¹æ¡ˆ
- å‰ç«¯ä»£ç ç¤ºä¾‹åœ¨å®æ–½æ–¹æ¡ˆçš„ **Phase 3: å‰ç«¯å¼€å‘** éƒ¨åˆ†

**å‰ç«¯ä¸»è¦å·¥ä½œï¼š**
1. ä¿®æ”¹ `violation.vue` æ·»åŠ å¼€å…³å’Œé€»è¾‘
2. ä¿®æ”¹ `custom-tabbar.vue` æ·»åŠ å¾½æ ‡æ˜¾ç¤º
3. æµ‹è¯•å‰åç«¯è”è°ƒ
4. éªŒè¯æ¨é€è¿‡æ»¤æ˜¯å¦ç”Ÿæ•ˆ

---

## ğŸ“¦ éƒ¨ç½²è¯´æ˜

### 1. å¤‡ä»½æ•°æ®åº“
```bash
mysqldump -u root -p parking_db > backup_$(date +%Y%m%d).sql
```

### 2. æ‰§è¡Œæ•°æ®åº“è„šæœ¬
```bash
mysql -u root -p parking_db < sql/patrol_duty_management.sql
```

### 3. ç¼–è¯‘æ‰“åŒ…
```bash
mvn clean package
```

### 4. é‡å¯æœåŠ¡
```bash
sh restart.sh
```

### 5. éªŒè¯æ¥å£
ä½¿ç”¨Postmanæµ‹è¯•ä¸¤ä¸ªæ–°æ¥å£æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚

---

## ğŸ‰ æ€»ç»“

**åç«¯å¼€å‘å·²100%å®Œæˆï¼**

- âœ… æ•°æ®åº“è¡¨ç»“æ„å®Œå–„
- âœ… å®ä½“ç±»å­—æ®µæ·»åŠ 
- âœ… Serviceæ–¹æ³•å®ç°
- âœ… Controlleræ¥å£å¼€å‘
- âœ… æ¨é€é€»è¾‘æ”¹é€ 
- âœ… å®Œæ•´çš„æ—¥å¿—è®°å½•
- âœ… è¯¦ç»†çš„æ³¨é‡Šæ–‡æ¡£

**æ¥ä¸‹æ¥åªéœ€ï¼š**
- å‰ç«¯å¼€å‘ï¼ˆ2å°æ—¶ï¼‰
- è”è°ƒæµ‹è¯•ï¼ˆ1å°æ—¶ï¼‰
- ä¸Šçº¿éƒ¨ç½²ï¼ˆ30åˆ†é’Ÿï¼‰

**é¢„è®¡æ€»è®¡è¿˜éœ€ï¼š** 3.5å°æ—¶å³å¯å…¨éƒ¨å®Œæˆï¼

---

**æœ€åæ›´æ–°ï¼š** 2025-12-04 10:45
**æ–‡æ¡£ç‰ˆæœ¬ï¼š** v1.0
**çŠ¶æ€ï¼š** åç«¯å¼€å‘å®Œæˆ âœ…
