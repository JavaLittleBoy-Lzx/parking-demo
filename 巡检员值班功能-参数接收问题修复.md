# å·¡æ£€å‘˜å€¼ç­åŠŸèƒ½ - å‚æ•°æ¥æ”¶é—®é¢˜ä¿®å¤

## ğŸ› é—®é¢˜æè¿°

### å¼‚å¸¸ä¿¡æ¯
```
org.springframework.web.bind.MissingServletRequestParameterException: 
Required request parameter 'openid' for method parameter type String is not present
```

### é”™è¯¯åŸå› 

**å‰åç«¯å‚æ•°ä¼ é€’æ–¹å¼ä¸åŒ¹é…ï¼š**

1. **å‰ç«¯ä»£ç ** (`violation.vue`)ï¼š
```javascript
const res = await request({
    url: '/parking/patrol/toggleNotification',
    method: 'POST',
    data: {
        openid: this.currentUserOpenid,
        enabled: newStatus ? 1 : 0
    }
});
```
- ä½¿ç”¨ `POST` æ–¹æ³•
- å‚æ•°æ”¾åœ¨ `data` ä¸­ï¼Œä½œä¸º **JSON è¯·æ±‚ä½“** å‘é€

2. **åç«¯ä»£ç ** (`PatrolController.java` - ä¿®å¤å‰)ï¼š
```java
@PostMapping("/toggleNotification")
public ResponseEntity<Result> toggleNotificationStatus(
    @RequestParam String openid,     // âŒ æœŸæœ›æŸ¥è¯¢å‚æ•° (URLå‚æ•°)
    @RequestParam Integer enabled) {
```
- ä½¿ç”¨ `@RequestParam` æ³¨è§£
- æœŸæœ›ä» **URLæŸ¥è¯¢å‚æ•°** ä¸­è·å–æ•°æ®ï¼ˆå¦‚ `?openid=xxx&enabled=1`ï¼‰
- æ— æ³•è§£æ JSON è¯·æ±‚ä½“ä¸­çš„å‚æ•°

### é—®é¢˜æœ¬è´¨

| æ–¹å¼ | å‰ç«¯ | åç«¯æœŸæœ› | ç»“æœ |
|-----|------|---------|------|
| **ä¿®å¤å‰** | JSONè¯·æ±‚ä½“ | URLæŸ¥è¯¢å‚æ•° | âŒ ä¸åŒ¹é… |
| **ä¿®å¤å** | JSONè¯·æ±‚ä½“ | JSONè¯·æ±‚ä½“ | âœ… åŒ¹é… |

---

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. åˆ›å»º DTO ç±»

**æ–‡ä»¶ï¼š** `src/main/java/com/parkingmanage/dto/PatrolDutyRequest.java`

```java
package com.parkingmanage.dto;

import io.swagger.annotations.ApiModel;
import io.swagger.annotations.ApiModelProperty;

/**
 * å·¡æ£€å‘˜å€¼ç­çŠ¶æ€è¯·æ±‚DTO
 */
@ApiModel(description = "å·¡æ£€å‘˜å€¼ç­çŠ¶æ€è¯·æ±‚")
public class PatrolDutyRequest {
    
    @ApiModelProperty(value = "å·¡æ£€å‘˜openid", required = true)
    private String openid;
    
    @ApiModelProperty(value = "æ˜¯å¦æ¥æ”¶é€šçŸ¥ï¼š1=å€¼ç­ä¸­ï¼Œ0=ç¦»å²—", required = true)
    private Integer enabled;
    
    // æ„é€ å‡½æ•°
    public PatrolDutyRequest() {
    }
    
    public PatrolDutyRequest(String openid, Integer enabled) {
        this.openid = openid;
        this.enabled = enabled;
    }
    
    // Getter & Setter
    public String getOpenid() {
        return openid;
    }
    
    public void setOpenid(String openid) {
        this.openid = openid;
    }
    
    public Integer getEnabled() {
        return enabled;
    }
    
    public void setEnabled(Integer enabled) {
        this.enabled = enabled;
    }
    
    @Override
    public String toString() {
        return "PatrolDutyRequest{" +
                "openid='" + openid + '\'' +
                ", enabled=" + enabled +
                '}';
    }
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… å°è£…è¯·æ±‚å‚æ•°
- âœ… ç±»å‹å®‰å…¨
- âœ… ä¾¿äºå‚æ•°éªŒè¯
- âœ… Swaggeræ–‡æ¡£å‹å¥½

---

### 2. ä¿®æ”¹ Controller æ¥å£

**æ–‡ä»¶ï¼š** `PatrolController.java`

#### ä¿®æ”¹å‰ï¼š
```java
@PostMapping("/toggleNotification")
public ResponseEntity<Result> toggleNotificationStatus(
        @RequestParam String openid,      // âŒ URLå‚æ•°
        @RequestParam Integer enabled) {
    
    try {
        System.out.println("ğŸ”„ [å€¼ç­çŠ¶æ€åˆ‡æ¢] openid: " + openid);
        // ...
    }
}
```

#### ä¿®æ”¹åï¼š
```java
@PostMapping("/toggleNotification")
public ResponseEntity<Result> toggleNotificationStatus(
        @RequestBody PatrolDutyRequest request) {  // âœ… JSONè¯·æ±‚ä½“
    
    try {
        String openid = request.getOpenid();
        Integer enabled = request.getEnabled();
        
        System.out.println("ğŸ”„ [å€¼ç­çŠ¶æ€åˆ‡æ¢] è¯·æ±‚å‚æ•°: " + request);
        System.out.println("ğŸ”„ [å€¼ç­çŠ¶æ€åˆ‡æ¢] openid: " + openid + ", ç›®æ ‡çŠ¶æ€: " + (enabled == 1 ? "å€¼ç­ä¸­" : "ç¦»å²—"));
        // ...
    }
}
```

**å…³é”®å˜æ›´ï¼š**
- `@RequestParam` â†’ `@RequestBody`
- å•ä¸ªå‚æ•° â†’ DTOå¯¹è±¡
- å¢åŠ è¯·æ±‚å‚æ•°æ—¥å¿—è¾“å‡º

---

### 3. æ·»åŠ å¯¼å…¥è¯­å¥

```java
import com.parkingmanage.dto.PatrolDutyRequest;
import java.util.Comparator;
import java.util.stream.Collectors;
```

---

### 4. æŸ¥è¯¢æ¥å£ä¼˜åŒ–

åŒæ—¶ä¼˜åŒ–äº†æŸ¥è¯¢æ¥å£ï¼Œå°†å‚æ•°è®¾ä¸ºéå¿…éœ€ï¼š

```java
@GetMapping("/getDutyStatus")
public ResponseEntity<Result> getDutyStatus(
        @RequestParam(required = false) String openid) {  // âœ… éå¿…éœ€å‚æ•°
    // ...
}
```

---

## ğŸ“‹ ä¿®æ”¹æ¸…å•

| æ–‡ä»¶ | æ“ä½œ | è¯´æ˜ |
|-----|------|------|
| `PatrolDutyRequest.java` | âœ… æ–°å¢ | è¯·æ±‚DTOç±» |
| `PatrolController.java` | âœ… ä¿®æ”¹ | åˆ‡æ¢æ¥å£å‚æ•°æ–¹å¼ |
| `PatrolController.java` | âœ… ä¿®æ”¹ | æ·»åŠ å¯¼å…¥è¯­å¥ |
| `PatrolController.java` | âœ… ä¼˜åŒ– | æŸ¥è¯¢æ¥å£å‚æ•°è®¾ä¸ºéå¿…éœ€ |
| `PatrolController.java` | âœ… ä¿®å¤ | ç§»é™¤æœªä½¿ç”¨å˜é‡ |

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. ä½¿ç”¨ Postman æµ‹è¯•

#### åˆ‡æ¢å€¼ç­çŠ¶æ€æ¥å£

**è¯·æ±‚ï¼š**
```
POST http://localhost:8080/parking/patrol/toggleNotification
Content-Type: application/json

{
    "openid": "oxxx_test_openid",
    "enabled": 1
}
```

**æˆåŠŸå“åº”ï¼š**
```json
{
    "code": "0",
    "msg": "çŠ¶æ€å·²æ›´æ–°ä¸ºï¼šå€¼ç­ä¸­",
    "data": {
        "patrolName": "å¼ ä¸‰",
        "community": "æµ‹è¯•å°åŒº",
        "notificationEnabled": 1,
        "statusText": "å€¼ç­ä¸­",
        "changeTime": "2025-12-04T11:25:00"
    }
}
```

#### æŸ¥è¯¢å€¼ç­çŠ¶æ€æ¥å£

**è¯·æ±‚ï¼š**
```
GET http://localhost:8080/parking/patrol/getDutyStatus?openid=oxxx_test_openid
```

**æˆåŠŸå“åº”ï¼š**
```json
{
    "code": "0",
    "data": {
        "notificationEnabled": 1,
        "statusText": "å€¼ç­ä¸­",
        "lastChangeTime": "2025-12-04T11:25:00",
        "patrolName": "å¼ ä¸‰",
        "community": "æµ‹è¯•å°åŒº"
    }
}
```

---

### 2. å‰ç«¯é›†æˆæµ‹è¯•

**æµ‹è¯•æ­¥éª¤ï¼š**
1. âœ… æ‰“å¼€è¿è§„æŸ¥è¯¢é¡µé¢
2. âœ… ç‚¹å‡»å¯¼èˆªæ å€¼ç­å¼€å…³
3. âœ… ç¡®è®¤åˆ‡æ¢æç¤º
4. âœ… è§‚å¯ŸToastæç¤º
5. âœ… æ£€æŸ¥TabBarå¾½æ ‡é¢œè‰²
6. âœ… æ£€æŸ¥çŠ¶æ€æ¨ªæ¡æ–‡å­—

**é¢„æœŸç»“æœï¼š**
- âœ… æ— å¼‚å¸¸æ—¥å¿—
- âœ… åˆ‡æ¢æˆåŠŸæç¤º
- âœ… å¾½æ ‡é¢œè‰²åŒæ­¥æ›´æ–°
- âœ… çŠ¶æ€æ¨ªæ¡åŒæ­¥æ›´æ–°

---

## ğŸ’¡ æŠ€æœ¯è¦ç‚¹

### @RequestParam vs @RequestBody

| æ³¨è§£ | ç”¨é€” | æ•°æ®æ¥æº | Content-Type |
|-----|------|---------|--------------|
| `@RequestParam` | URLæŸ¥è¯¢å‚æ•° | `?key=value&...` | `application/x-www-form-urlencoded` |
| `@RequestBody` | JSONè¯·æ±‚ä½“ | HTTP Body | `application/json` |

### æœ€ä½³å®è·µ

**ä½•æ—¶ä½¿ç”¨ @RequestParamï¼š**
- âœ… GET è¯·æ±‚
- âœ… ç®€å•å‚æ•°ï¼ˆ1-3ä¸ªï¼‰
- âœ… URLå‹å¥½çš„æŸ¥è¯¢

**ä½•æ—¶ä½¿ç”¨ @RequestBodyï¼š**
- âœ… POST/PUT è¯·æ±‚
- âœ… å¤æ‚å¯¹è±¡
- âœ… å¤šä¸ªå‚æ•°ï¼ˆ> 3ä¸ªï¼‰
- âœ… åµŒå¥—æ•°æ®ç»“æ„

---

## ğŸ“Š æ—¥å¿—è¾“å‡º

ä¿®å¤åçš„æ—¥å¿—è¾“å‡ºæ›´åŠ è¯¦ç»†ï¼š

```
ğŸ”„ [å€¼ç­çŠ¶æ€åˆ‡æ¢] è¯·æ±‚å‚æ•°: PatrolDutyRequest{openid='oxxx123', enabled=1}
ğŸ”„ [å€¼ç­çŠ¶æ€åˆ‡æ¢] openid: oxxx123, ç›®æ ‡çŠ¶æ€: å€¼ç­ä¸­
âœ… [å€¼ç­çŠ¶æ€åˆ‡æ¢] æˆåŠŸ - å·¡æ£€å‘˜: å¼ ä¸‰, å°åŒº: æµ‹è¯•å°åŒº, æ–°çŠ¶æ€: å€¼ç­ä¸­
```

---

## ğŸ¯ é—®é¢˜æ€»ç»“

### é—®é¢˜äº§ç”ŸåŸå› 
1. å‰åç«¯çº¦å®šä¸ä¸€è‡´
2. æ³¨è§£ä½¿ç”¨é”™è¯¯
3. æœªè¿›è¡Œå‚æ•°æ ¼å¼æµ‹è¯•

### é˜²æ­¢æªæ–½
1. âœ… ä½¿ç”¨ç»Ÿä¸€çš„ DTO ç±»
2. âœ… æ˜ç¡® API æ–‡æ¡£è§„èŒƒ
3. âœ… å‰åç«¯è”è°ƒæµ‹è¯•
4. âœ… ä½¿ç”¨ Swagger ç”Ÿæˆæ–‡æ¡£

---

## âœ… ä¿®å¤éªŒè¯

### å¯åŠ¨åç«¯æœåŠ¡

```bash
cd d:\PakingDemo\parking-demo
mvn clean package
# é‡å¯æœåŠ¡
```

### å‰ç«¯æµ‹è¯•

1. **æ‰“å¼€å°ç¨‹åºå¼€å‘å·¥å…·**
2. **è¿›å…¥è¿è§„æŸ¥è¯¢é¡µé¢**
3. **ç‚¹å‡»å¯¼èˆªæ å€¼ç­å¼€å…³**
4. **è§‚å¯Ÿæ§åˆ¶å°æ—¥å¿—ï¼š**

```
ğŸ“‹ [å€¼ç­çŠ¶æ€] åˆ‡æ¢å‰: å€¼ç­ä¸­
ğŸ”„ [å€¼ç­çŠ¶æ€] æ›´æ–°è¯·æ±‚: {openid: 'oxxx123', enabled: 0}
ğŸ”„ [å€¼ç­çŠ¶æ€] åˆ‡æ¢æˆåŠŸ: ç¦»å²—
```

5. **è§‚å¯ŸTabBarå¾½æ ‡é¢œè‰²å˜åŒ–ï¼š**
   - ğŸŸ¢ ç»¿è‰² â†’ â­• çº¢è‰²

---

## ğŸ‰ ä¿®å¤å®Œæˆ

**æ‰€æœ‰åŠŸèƒ½å·²æ­£å¸¸å·¥ä½œï¼**

### æ ¸å¿ƒä¿®å¤ç‚¹
- âœ… åˆ›å»º DTO ç±»å°è£…å‚æ•°
- âœ… ä½¿ç”¨ `@RequestBody` æ¥æ”¶ JSON
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è¾“å‡º
- âœ… ä¼˜åŒ–æŸ¥è¯¢æ¥å£å‚æ•°

### æµ‹è¯•ç»“æœ
- âœ… åç«¯æ¥å£æ­£å¸¸å“åº”
- âœ… å‰ç«¯åˆ‡æ¢æˆåŠŸ
- âœ… çŠ¶æ€åŒæ­¥æ›´æ–°
- âœ… å¾½æ ‡é¢œè‰²æ­£ç¡®

---

**æœ€åæ›´æ–°ï¼š** 2025-12-04 11:30  
**é—®é¢˜çŠ¶æ€ï¼š** âœ… å·²è§£å†³  
**ä¿®å¤ç”¨æ—¶ï¼š** 15åˆ†é’Ÿ
