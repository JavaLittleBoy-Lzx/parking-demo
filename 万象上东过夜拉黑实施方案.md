# 万象上东过夜拉黑实施方案

## 一、业务需求

### 拉黑规则
1. **触发条件**：
   - 11点-6点进场的车辆
   - 停车超过2小时
   - 属于"待检查"的VIP月票类型

2. **拉黑范围**：
   - **关键点**：不只拉黑触发车辆，而是拉黑该业主名下的所有车牌号
   - 通过 `month_tick` 表的 `userPhone` 字段关联业主
   - 批量拉黑该业主在同一车场的所有有效月票车辆

3. **配置项**：
   - 待检查VIP月票类型列表（可配置）
   - 拉黑天数（默认永久）
   - 黑名单名称（可配置）

---

## 二、数据关联设计

### 关联逻辑
```
触发车牌 → month_tick.car_no
         ↓
    month_tick.user_phone (业主手机号)
         ↓
    查询 month_tick WHERE user_phone = ? AND park_name = ? AND valid_status = 1
         ↓
    获取该业主所有车牌号列表
         ↓
    批量拉黑所有车牌
```

### 核心表结构

#### month_tick 表
```sql
- id (主键)
- car_no (车牌号)
- park_name (车场名称)
- user_phone (业主手机号) ← 关键关联字段
- ticket_name (月票类型)
- valid_status (有效状态: 1=有效, 0=无效)
- is_frozen (冻结状态: 1=冻结, 0=正常)
- time_period_list (有效期)
```

#### ownerinfo 表
```sql
- id (主键)
- ownerphone (业主手机号) ← 关联字段
- plates (车牌号)
- community (小区/车场)
- ownername (业主姓名)
```

---

## 三、技术实现

### 1. 配置管理

#### 配置表：monthly_ticket_timeout_config
在 `description` 字段中存储配置：
```
月票车配置: 夜间(23:00-06:00)超过2小时拉黑 | [待检:VIP月票A,VIP月票B] | [拉黑天数:永久] | [黑名单名称:万象上东违规月票车]
```

#### 配置解析逻辑
```java
// ViolationsService.getMonthlyTicketTimeoutConfig()
Map<String, Object> config = {
    "vipCheckMode": "include",           // 待检查模式
    "vipTicketTypes": ["VIP月票A", "VIP月票B"],
    "blacklistDays": "永久",
    "blacklistName": "万象上东违规月票车",
    "nightStartTime": "23:00",
    "nightEndTime": "06:00",
    "nightTimeHours": 2
}
```

---

### 2. 核心方法实现

#### 方法1：processWanXiangBlacklistByOwner
**功能**：处理万象上东业主名下所有车牌的批量拉黑

**位置**：`VehicleReservationController.java` (line 2979)

**流程**：
```java
1. 获取车场配置
2. 通过触发车牌查询 month_tick 获取 userPhone
3. 检查 ticketName 是否在待检查列表
4. 调用 getAllCarNumbersByPhone() 获取该业主所有车牌
5. 遍历所有车牌：
   - 记录违规（violationsService.recordViolation）
   - 本地拉黑（violationsService.addToBlacklist）
   - 调用外部接口拉黑（callAddBlackListCarAPIForWanXiang）
6. 返回批量拉黑结果统计
```

**调用示例**：
```java
processWanXiangBlacklistByOwner("浙A12345", "万象上东ParkCode");
```

---

#### 方法2：getAllCarNumbersByPhone
**功能**：根据业主手机号查询所有车牌号

**位置**：`VehicleReservationController.java` (line 3099)

**SQL逻辑**：
```sql
SELECT car_no 
FROM month_tick 
WHERE user_phone = ? 
  AND park_name = ? 
  AND valid_status = 1
```

**返回**：`List<String>` 车牌号列表

---

#### 方法3：callAddBlackListCarAPIForWanXiang
**功能**：调用艾科外部接口拉黑

**位置**：`VehicleReservationController.java` (line 3140)

**参数**：
```java
{
    "parkCodeList": ["万象上东ParkCode"],
    "carCode": "浙A12345",
    "blacklistType": "万象上东违规月票车",
    "reason": "业主张三名下车辆浙A12345夜间停车超时，关联拉黑",
    "validDays": 9999  // 永久=9999，7天=7
}
```

---

### 3. 定时任务集成

#### 方案A：在 ParkingTimeoutMonitoringTask 中添加
在现有的超时监控定时任务中添加万象上东检查：

```java
@Scheduled(cron = "0 * * * * ?")  // 每分钟执行
public void checkParkingTimeout() {
    try {
        // 原有逻辑：预约车辆超时提醒
        checkAppointmentTimeout();
        
        // 🆕 新增：万象上东VIP月票车拉黑检查
        checkWanXiangVipBlacklist();
        
    } catch (Exception e) {
        log.error("❌ [定时任务异常]", e);
    }
}

/**
 * 🆕 检查万象上东VIP月票车拉黑条件
 */
private void checkWanXiangVipBlacklist() {
    try {
        String parkCode = "万象上东ParkCode"; // 替换为实际编码
        
        // 1. 调用艾科接口获取在场车辆
        List<Map<String, Object>> onSiteVehicles = getOnSiteVehicles(parkCode);
        
        // 2. 遍历检查每辆车
        for (Map<String, Object> vehicle : onSiteVehicles) {
            String carNo = (String) vehicle.get("carNo");
            String enterTime = (String) vehicle.get("enterTime");
            String enterCustomVipName = (String) vehicle.get("enterCustomVipName");
            
            // 3. 检查是否满足拉黑条件
            if (shouldBlacklistWanXiang(carNo, enterTime, enterCustomVipName, parkCode)) {
                // 4. 调用批量拉黑
                vehicleReservationController.processWanXiangBlacklistByOwner(carNo, parkCode);
            }
        }
        
    } catch (Exception e) {
        log.error("❌ [万象上东检查异常]", e);
    }
}
```

#### 方案B：创建独立定时任务
创建 `WanXiangBlacklistMonitoringTask.java`：

```java
@Component
public class WanXiangBlacklistMonitoringTask {
    
    @Resource
    private VehicleReservationController vehicleReservationController;
    
    @Scheduled(cron = "0 */5 * * * ?")  // 每5分钟执行
    public void checkWanXiangBlacklist() {
        // 实现逻辑...
    }
}
```

---

## 四、数据流程图

```
┌─────────────────┐
│  车辆进场超时    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  检查进场时间    │  (23:00-06:00?)
└────────┬────────┘
         │ Yes
         ▼
┌─────────────────┐
│  检查停车时长    │  (>2小时?)
└────────┬────────┘
         │ Yes
         ▼
┌─────────────────────────────────────┐
│  查询 month_tick 获取 userPhone     │
│  SELECT * FROM month_tick            │
│  WHERE car_no = '浙A12345'          │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  检查 ticketName 是否为待检查类型   │
└────────┬────────────────────────────┘
         │ Yes
         ▼
┌─────────────────────────────────────┐
│  查询该业主所有车牌                  │
│  SELECT car_no FROM month_tick       │
│  WHERE user_phone = '138xxxx'        │
│    AND valid_status = 1              │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  结果: ['浙A12345', '浙B67890']     │
└────────┬────────────────────────────┘
         │
         ▼
┌─────────────────────────────────────┐
│  批量拉黑所有车牌 (for循环)         │
│  ├─ 记录violations表                │
│  ├─ 加入blacklist表                 │
│  └─ 调用艾科外部接口                │
└─────────────────────────────────────┘
```

---

## 五、关键代码示例

### 5.1 在定时任务中调用
```java
// 假设已经检测到某车牌需要拉黑
String triggerCarNo = "浙A12345";
String parkCode = "2KST9MNP";  // 万象上东

// 调用批量拉黑方法
vehicleReservationController.processWanXiangBlacklistByOwner(triggerCarNo, parkCode);
```

### 5.2 日志输出示例
```
🏢 [万象上东批量拉黑] 开始处理车牌: 浙A12345
📱 [万象上东] 业主手机: 13800138000, 月票类型: VIP业主月票
📋 [查询车牌] 手机号 13800138000 在 万象上东 共有 3 个车牌
🚗 [万象上东] 查询到业主名下共 3 个车牌: [浙A12345, 浙B67890, 浙C11111]
🚫 [万象上东拉黑] 开始拉黑车牌: 浙A12345
✅ [拉黑成功] 车牌: 浙A12345
🚫 [万象上东拉黑] 开始拉黑车牌: 浙B67890
✅ [拉黑成功] 车牌: 浙B67890
🚫 [万象上东拉黑] 开始拉黑车牌: 浙C11111
✅ [拉黑成功] 车牌: 浙C11111
✅ [万象上东批量拉黑完成] 总数: 3, 成功: 3, 失败: 0
```

---

## 六、配置步骤

### 步骤1：添加车场配置
在 `monthly_ticket_timeout_config` 表中插入/更新记录：

```sql
INSERT INTO monthly_ticket_timeout_config 
(park_code, park_name, night_start_time, night_end_time, night_time_hours, 
 enable_overnight_check, description, is_active, created_at, updated_at)
VALUES 
('2KST9MNP', '万象上东', '23:00', '06:00', 2, 1, 
 '月票车配置: 夜间(23:00-06:00)超过2小时拉黑 | [待检:VIP业主月票,VIP固定车位] | [拉黑天数:永久] | [黑名单名称:万象上东违规月票车]',
 1, NOW(), NOW());
```

### 步骤2：在前端配置页面设置
- 车场：万象上东
- 检查模式：待检查模式
- VIP月票类型：选择需要检查的类型
- 拉黑天数：永久
- 黑名单名称：万象上东违规月票车

### 步骤3：部署定时任务
选择方案A或方案B，在 `ParkingTimeoutMonitoringTask` 中添加检查逻辑。

---

## 七、注意事项

### 7.1 业主关联准确性
- ✅ 必须确保 `month_tick.user_phone` 数据准确
- ✅ 只查询 `valid_status = 1` 的有效月票
- ⚠️ 如果业主手机号为空，无法关联其他车辆

### 7.2 去重检查
- 在拉黑前检查车牌是否已在黑名单中
- 避免重复拉黑造成日志混乱

### 7.3 性能考虑
- 批量拉黑时，每个车牌独立处理
- 单个车牌失败不影响其他车牌
- 建议定时任务执行频率为 5-10 分钟

### 7.4 日志监控
- 关注批量拉黑的成功率
- 监控是否有大量失败的情况
- 定期检查配置是否正确

---

## 八、测试验证

### 测试场景1：单车牌业主
```
业主A：手机 138xxxx，车牌 [浙A12345]
触发车辆：浙A12345
预期结果：拉黑 1 个车牌
```

### 测试场景2：多车牌业主
```
业主B：手机 139xxxx，车牌 [浙B11111, 浙B22222, 浙B33333]
触发车辆：浙B11111
预期结果：拉黑 3 个车牌
```

### 测试场景3：不同月票类型
```
业主C：手机 137xxxx
  - 浙C11111 (VIP业主月票) ← 待检查类型
  - 浙C22222 (普通月票) ← 非待检查类型
触发车辆：浙C11111
预期结果：拉黑 1 个车牌（只拉黑VIP业主月票）
```

---

## 九、扩展性

### 支持多车场
当前实现可轻松扩展到其他车场：
1. 添加新车场配置到 `monthly_ticket_timeout_config`
2. 在定时任务中添加该车场的检查逻辑
3. 复用 `processWanXiangBlacklistByOwner` 方法

### 支持不同拉黑策略
- 可配置是否批量拉黑（当前默认批量）
- 可配置拉黑范围（当前为同一车场）
- 可配置拉黑时间段（当前为固定23:00-06:00）

---

## 十、总结

### 核心优势
✅ **关联拉黑**：一人违规，全部拉黑，增强管理效果  
✅ **灵活配置**：通过 description 字段灵活配置规则  
✅ **完整日志**：详细记录每个环节，便于排查问题  
✅ **批量处理**：高效处理多车牌场景  

### 实现状态
✅ 核心方法已实现  
✅ 数据关联逻辑已完成  
✅ 外部接口调用已集成  
⏳ 需在定时任务中添加调用逻辑  
⏳ 需创建前端配置页面  
