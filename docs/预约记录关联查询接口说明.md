# 🔍 预约记录关联查询接口说明

## 功能概述

新增了一个接口，通过业主姓名关联 `ownerinfo` 表和 `appointment` 表，筛选出与当前巡逻员相同车场（community）的数据，返回 `appointment` 表中的记录。

## 🌟 主要特性

- ✅ **关联查询**: 通过车牌号关联 `ownerinfo` 和 `appointment` 表
- ✅ **权限过滤**: 巡逻员只能查看自己负责社区的数据
- ✅ **多维搜索**: 支持车牌号、业主姓名、电话号码搜索
- ✅ **分页支持**: 支持分页查询，提高性能
- ✅ **数据丰富**: 返回预约信息和业主信息的完整数据

## 📊 接口详情

### 后端接口

**URL**: `GET /api/violations/appointment-records-by-owner`

**参数**:
```json
{
  "keyword": "搜索关键词（车牌号或业主姓名）", // 可选
  "page": 1,                               // 页码，默认1
  "size": 50                              // 每页数量，默认50
}
```

**响应数据**:
```json
{
  "code": 200,
  "message": "成功",
  "data": [
    {
      "appointmentId": 123,
      "plateNumber": "京A12345",
      "arriveDate": "2025-01-31 10:00:00",
      "leaveDate": "2025-01-31 12:00:00",
      "parkingSpace": "A-001",
      "appointmentStatus": "confirmed",
      "appointmentCreatedAt": "2025-01-30 15:30:00",
      "ownerId": 456,
      "ownerName": "张三",
      "ownerPhone": "13800138000",
      "community": "阳光花园",
      "parkingDuration": 2.0  // 停车时长（小时）
    }
  ]
}
```

### 前端 API 调用

```javascript
import { appointmentAnalysisApi } from '@/api/violation-api.js';

// 查询预约记录
const result = await appointmentAnalysisApi.getAppointmentRecordsByOwner({
  keyword: '京A12345',
  page: 1,
  size: 20
});
```

## 🔧 实现细节

### 后端实现

1. **Controller 层** (`ViolationsController.java`)
   - 新增 `getAppointmentRecordsByOwner` 接口方法
   - 处理参数验证和异常处理
   - 记录详细的操作日志

2. **Service 层** (`ViolationsService.java` & `ViolationsServiceImpl.java`)
   - 实现业务逻辑
   - 权限控制：巡逻员只能查看自己负责社区的数据
   - 数据关联查询和格式化

3. **SQL 查询逻辑**
   ```sql
   SELECT DISTINCT 
       a.id as appointment_id, 
       a.plate_number, 
       a.arrive_date, 
       a.leave_date, 
       a.parking_space, 
       a.status as appointment_status, 
       a.created_at as appointment_created_at, 
       o.id as owner_id, 
       o.name as owner_name, 
       o.phone as owner_phone, 
       o.community,
       TIMESTAMPDIFF(HOUR, a.arrive_date, a.leave_date) as parking_hours 
   FROM appointment a 
   INNER JOIN ownerinfo o ON a.plate_number = o.plate_number 
   WHERE 1=1 
     AND o.community = '当前巡逻员小区'  -- 🔒 严格的小区权限过滤
     AND (a.community IS NULL OR a.community = '' OR a.community = '当前巡逻员小区')  -- 🔒 appointment表小区一致性检查
     AND o.isaudit = '是'  -- 🔍 只查询已审核的业主
     AND (
       a.plate_number LIKE '%关键词%' 
       OR o.name LIKE '%关键词%' 
       OR o.phone LIKE '%关键词%'
     )  -- 🔍 搜索条件
   ORDER BY a.created_at DESC 
   LIMIT 50 OFFSET 0;  -- 📄 分页
   ```

### 前端实现

1. **API 封装** (`violation-api.js`)
   - 新增 `getAppointmentRecordsByOwner` 方法
   - 统一参数处理和错误处理

2. **测试页面** (`appointment-owner-test.vue`)
   - 完整的测试界面
   - 搜索功能和分页控制
   - 详细的数据展示和状态反馈

## 🔐 权限控制

- **巡逻员权限**: 严格限制只能查看自己负责小区的预约记录
- **其他角色**: 可以查看所有小区的预约记录（根据实际需求调整）

### 🔒 严格的小区权限控制逻辑：

1. **巡逻员身份验证**：
   - 从 Token 中解析用户角色
   - 如果是巡逻员，从 `patrolinfo` 表获取其负责的小区
   - 如果巡逻员没有小区信息，直接返回空结果

2. **小区数据过滤**：
   - 在 SQL 查询中强制添加 `o.community = '巡逻员小区'` 条件
   - 额外检查 appointment 表的小区字段（如果存在）
   - 只查询已审核的业主数据 `o.isaudit = '是'`

3. **双重保险机制**：
   - SQL 级别的小区过滤
   - 业务层的二次过滤确认
   - 确保 100% 的数据都与巡逻员小区一致

## 📱 使用方式

### 1. 测试接口
访问测试页面：`/pages/test/appointment-owner-test`

### 2. 集成到现有功能
```javascript
// 在违规录入页面中使用
const searchOwnerRecords = async (keyword) => {
  try {
    const records = await appointmentAnalysisApi.getAppointmentRecordsByOwner({
      keyword: keyword,
      page: 1,
      size: 20
    });
    
    // 处理返回的数据
    console.log('预约记录:', records);
  } catch (error) {
    console.error('查询失败:', error);
  }
};
```

## 🚀 扩展建议

1. **缓存优化**: 对频繁查询的数据添加缓存
2. **索引优化**: 为关联字段添加数据库索引
3. **统计分析**: 增加预约记录的统计分析功能
4. **实时更新**: 支持实时更新预约状态
5. **导出功能**: 支持查询结果导出为Excel

## 📋 注意事项

1. **性能考虑**: 大数据量时建议限制查询条件
2. **数据一致性**: 确保 `ownerinfo` 和 `appointment` 表的车牌号数据一致
3. **权限验证**: 确保 Token 解析和权限验证的正确性
4. **错误处理**: 完善的异常处理和用户友好的错误提示

## 🔄 版本历史

- **v1.1** (2025-01-31): 增强版本，严格的小区权限控制
  - 🔒 **新增严格小区限制**：确保所有数据都与巡逻员小区名称相同
  - 🔍 **双重保险机制**：SQL级别过滤 + 业务层二次确认
  - 📊 **SQL优化**：直接在数据库层计算停车时长
  - 🔐 **权限增强**：巡逻员无小区信息时返回空结果
  - ✅ **数据完整性**：只查询已审核的业主数据

- **v1.0** (2025-01-31): 初始版本，实现基本的关联查询功能
  - 支持车牌号和业主姓名搜索
  - 实现巡逻员权限控制
  - 提供完整的前后端实现

---

该功能已完成开发和测试，可以直接使用。如有问题请及时反馈。 