# 数据库修改说明

## 概述

基于原有的 `project_lzx.sql` 文件，参考 `parking-demo/database/` 下的数据库设计，对数据库进行了全面的改造和升级，使其支持完整的违规管理系统功能。

## 修改策略

### 1. 保留原有功能
- **appointment 表**: 保留原有的预约管理功能
- **area 表**: 保留原有的区域管理功能
- **数据兼容性**: 确保原有数据和功能不受影响

### 2. 新增违规管理功能
基于 `parking-demo/database/` 的设计，新增了完整的违规管理系统表结构。

## 新增表结构

### 核心业务表

#### 1. owners (车主信息表)
```sql
- id: 主键ID
- name: 车主姓名
- phone: 联系电话
- address: 住址
- building/unit/room: 楼栋/单元/房间信息
- credit_score: 信用分 (默认100分)
- status: 状态 (active/inactive)
```

#### 2. vehicles (车辆信息表)
```sql
- id: 主键ID
- plate_number: 车牌号 (唯一)
- owner_id: 车主ID (外键)
- is_new_energy: 是否新能源车
- vehicle_type: 车辆类型 (car/suv/truck/motorcycle)
- brand/model/color: 品牌/型号/颜色
```

#### 3. violations (违规记录表)
```sql
- id: 主键ID
- plate_number: 车牌号
- owner_id: 车主ID (外键)
- violation_type: 违规类型
- location: 违规位置
- description: 违规描述
- appointment_time/enter_time/leave_time: 时间信息
- status: 处理状态 (pending/processing/completed/cancelled)
- severity: 严重程度 (mild/moderate/severe)
- photos: 现场照片 (JSON格式)
- voice_memo: 语音备注
```

#### 4. violation_types (违规类型配置表)
```sql
- id: 主键ID
- name: 违规类型名称
- value: 违规类型值 (唯一)
- icon: 图标
- category: 分类 (common/others)
- usage_count: 使用次数
- sort_order: 排序
```

#### 5. parking_records (停车记录表)
```sql
- id: 主键ID
- plate_number: 车牌号
- owner_id: 车主ID (外键)
- appointment_time: 预约时间
- enter_time/leave_time: 进出场时间
- parking_duration: 停车时长
- status: 停车状态 (not_entered/in_progress/completed)
```

#### 6. users (用户表)
```sql
- id: 主键ID
- username: 用户名 (唯一)
- password: 密码
- real_name: 真实姓名
- role: 角色 (owner/manager/admin)
- owner_id: 关联车主ID (外键)
```

### 统计视图

#### 1. high_risk_vehicles (高风险车辆统计)
- 统计违规次数较多的车辆
- 包含车主信息、违规次数、最近违规时间等

#### 2. violation_statistics (违规统计汇总)
- 按违规类型统计违规数量
- 包含总数、月度数量、待处理数量等

## 数据特性

### 1. 字符集支持
- 全部使用 `utf8mb4` 字符集
- 支持 emoji 图标和特殊字符
- 支持多语言内容

### 2. 数据完整性
- 建立了完整的外键关系
- 设置了适当的约束条件
- 确保数据的一致性和完整性

### 3. 查询性能
- 为常用查询字段建立了索引
- 优化了表结构设计
- 支持高效的数据检索

### 4. 扩展性
- 预留了扩展字段
- 支持自定义违规类型
- 灵活的配置管理

## 初始化数据

### 测试数据包含：
- 8个车主信息 (不同信用分等级)
- 8个车辆信息 (包含新能源车和普通车)
- 13种违规类型 (常见违规和其他违规)
- 9条违规记录 (不同状态和严重程度)
- 5个用户账号 (业主、管家、管理员)
- 4条停车记录
- 示例预约和区域数据

### 违规类型配置：
**常见违规 (common):**
- 超时停车 🚗
- 未按位停车 🅿️
- 占用他人车位 🚫
- 遮挡车牌 🚫

**其他违规 (others):**
- 未经授权停车 🔒
- 堵塞通道 🚧
- 占用残疾人车位 ♿
- 逆向停车 🔄
- 跨线停车 📏
- 占用消防通道 🚒
- 占用充电桩车位 🔌
- 车辆损坏 🔧
- 其他 ➕

## 使用说明

### 1. 数据库部署
```bash
# 执行修改后的SQL文件
mysql -u root -p < project_lzx_modified.sql
```

### 2. 功能验证
- 原有预约管理功能正常
- 原有区域管理功能正常
- 新增违规管理功能可用
- 统计视图数据正确

### 3. 系统集成
- 前端可以继续使用原有的预约和区域管理接口
- 新增的违规管理接口独立运行
- 两套功能互不干扰，可以并行使用

## 升级优势

1. **平滑升级**: 保留原有功能，无需修改现有代码
2. **功能增强**: 新增完整的违规管理系统
3. **数据统一**: 统一的数据库管理，便于维护
4. **性能优化**: 优化的表结构和索引设计
5. **扩展性强**: 支持未来功能的扩展和定制

## 注意事项

1. **备份数据**: 升级前请备份原有数据库
2. **测试验证**: 在测试环境中验证所有功能
3. **权限配置**: 确保数据库用户有足够的权限
4. **字符集**: 确保数据库支持 utf8mb4 字符集
5. **外键约束**: 注意外键关系对数据操作的影响

## 技术支持

如有问题，请参考：
- 原始设计文档: `parking-demo/database/`
- 数据库脚本: `project_lzx_modified.sql`
- 系统架构: 违规管理系统设计文档
