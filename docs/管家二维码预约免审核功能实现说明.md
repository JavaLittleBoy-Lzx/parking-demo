# ç®¡å®¶äºŒç»´ç é¢„çº¦å…å®¡æ ¸åŠŸèƒ½å®ç°è¯´æ˜

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†è®¿å®¢æ‰«æç®¡å®¶äºŒç»´ç è¿›è¡Œé¢„çº¦æ—¶è‡ªåŠ¨è·³è¿‡å®¡æ ¸æµç¨‹ï¼Œå®¡æ ¸äººä¿¡æ¯è®¾ç½®ä¸ºå‘æ”¾äºŒç»´ç çš„ç®¡å®¶ã€‚

## ğŸ“‹ éœ€æ±‚åˆ†æ

### åŸæœ‰é€»è¾‘
- è®¿å®¢æ‰«æç®¡å®¶äºŒç»´ç åï¼Œé¢„çº¦ç±»å‹è®¾ç½®ä¸º"é‚€è¯·"
- "é‚€è¯·"ç±»å‹é¢„çº¦éœ€è¦æ ¹æ®æ—¶é—´æ®µåˆ¤æ–­æ˜¯å¦éœ€è¦å®¡æ ¸
- å¦‚æœéœ€è¦å®¡æ ¸ï¼ŒçŠ¶æ€è®¾ç½®ä¸º"å¾…å®¡æ‰¹"

### æ–°éœ€æ±‚
- è®¿å®¢æ‰«æç®¡å®¶äºŒç»´ç çš„é¢„çº¦åº”è¯¥æ— éœ€å®¡æ ¸
- å®¡æ ¸äººä¿¡æ¯åº”è¯¥æ˜¯å‘æ”¾äºŒç»´ç çš„ç®¡å®¶çš„æ‰‹æœºå·å’Œå§“å
- é¢„çº¦çŠ¶æ€ç›´æ¥è®¾ç½®ä¸º"å·²é€šè¿‡"å’Œ"å¾…å…¥åœº"

## ğŸ”§ å®ç°æ–¹æ¡ˆ

### 1. åç«¯ä¿®æ”¹

#### AppointmentController.java
ä¿®æ”¹é¢„çº¦åˆ›å»ºé€»è¾‘ä¸­çš„"é‚€è¯·"ç±»å‹å¤„ç†ï¼š

```java
}else if (appointment.getAppointtype().equals("é‚€è¯·")) {
    // é‚€è¯·ç±»å‹ï¼ˆè®¿å®¢æ‰«æç®¡å®¶äºŒç»´ç ï¼‰æ— éœ€å®¡æ ¸ï¼Œå®¡æ ¸äººæ˜¯å‘æ”¾äºŒç»´ç çš„ç®¡å®¶
    appointment.setAuditstatus("å·²é€šè¿‡");
    appointment.setVenuestatus("å¾…å…¥åœº");
    appointment.setAuditdate(LocalDateTime.now()); // è®¾ç½®å®¡æ ¸æ—¶é—´ä¸ºå½“å‰æ—¶é—´
    
    // å°è¯•ä»è®¿å®¢çš„ç”¨æˆ·ä¿¡æ¯ä¸­è·å–ç®¡å®¶ä¿¡æ¯
    try {
        // é¦–å…ˆå°è¯•ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–ç®¡å®¶ä¿¡æ¯
        String butlerOpenid = getButlerOpenidFromVisitor(appointment.getOpenid());
        if (butlerOpenid != null) {
            Butler butler = butlerService.getButlerByOpenId(butlerOpenid);
            if (butler != null) {
                appointment.setAuditopenid(butlerOpenid);
                appointment.setAuditusername(butler.getUsername());
                logger.info("é‚€è¯·é¢„çº¦è®¾ç½®ç®¡å®¶å®¡æ ¸ä¿¡æ¯: ç®¡å®¶={}, ç®¡å®¶openid={}", butler.getUsername(), butlerOpenid);
            } else {
                logger.warn("æœªæ‰¾åˆ°ç®¡å®¶ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å®¡æ ¸äºº: butlerOpenid={}", butlerOpenid);
                appointment.setAuditopenid(butlerOpenid);
                appointment.setAuditusername("ç®¡å®¶");
            }
        } else {
            logger.warn("æœªèƒ½è·å–ç®¡å®¶openidï¼Œä½¿ç”¨é»˜è®¤å®¡æ ¸ä¿¡æ¯");
            appointment.setAuditopenid("system");
            appointment.setAuditusername("ç³»ç»Ÿè‡ªåŠ¨å®¡æ ¸");
        }
    } catch (Exception e) {
        logger.error("è·å–ç®¡å®¶å®¡æ ¸ä¿¡æ¯å¤±è´¥: " + e.getMessage(), e);
        appointment.setAuditopenid("system");
        appointment.setAuditusername("ç³»ç»Ÿè‡ªåŠ¨å®¡æ ¸");
    }
    
    logger.info("é‚€è¯·é¢„çº¦æ— éœ€å®¡æ ¸ï¼Œå·²è‡ªåŠ¨é€šè¿‡: ç¤¾åŒº={}, å®¡æ ¸äºº={}", appointment.getCommunity(), appointment.getAuditusername());
}
```

#### æ–°å¢æ–¹æ³•ï¼šgetButlerOpenidFromVisitor
```java
/**
 * ä»è®¿å®¢openidè·å–å…³è”çš„ç®¡å®¶openid
 * é€šè¿‡æŸ¥è¯¢äºŒç»´ç ä½¿ç”¨è®°å½•è¡¨ï¼Œæ‰¾åˆ°ç”ŸæˆäºŒç»´ç çš„ç®¡å®¶ä¿¡æ¯
 * @param visitorOpenid è®¿å®¢çš„openid
 * @return ç®¡å®¶çš„openidï¼Œå¦‚æœæœªæ‰¾åˆ°åˆ™è¿”å›null
 */
private String getButlerOpenidFromVisitor(String visitorOpenid) {
    try {
        // é€šè¿‡è®¿å®¢openidæŸ¥è¯¢äºŒç»´ç ä½¿ç”¨è®°å½•
        QrCodeUsage qrCodeUsage = qrCodeUsageService.findByVisitorOpenid(visitorOpenid);
        if (qrCodeUsage != null && qrCodeUsage.getButlerPhone() != null) {
            // é€šè¿‡ç®¡å®¶æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶ä¿¡æ¯ï¼Œè·å–openid
            Butler butler = butlerService.getButlerByPhone(qrCodeUsage.getButlerPhone());
            if (butler != null) {
                logger.info("é€šè¿‡äºŒç»´ç è®°å½•æ‰¾åˆ°ç®¡å®¶: ç®¡å®¶æ‰‹æœºå·={}, ç®¡å®¶å§“å={}, ç®¡å®¶openid={}", 
                    qrCodeUsage.getButlerPhone(), butler.getUsername(), butler.getOpenid());
                return butler.getOpenid();
            } else {
                logger.warn("æœªæ‰¾åˆ°ç®¡å®¶ä¿¡æ¯: ç®¡å®¶æ‰‹æœºå·={}", qrCodeUsage.getButlerPhone());
            }
        } else {
            logger.warn("æœªæ‰¾åˆ°è®¿å®¢çš„äºŒç»´ç ä½¿ç”¨è®°å½•: visitorOpenid={}", visitorOpenid);
        }
    } catch (Exception e) {
        logger.error("è·å–ç®¡å®¶openidå¤±è´¥: visitorOpenid=" + visitorOpenid, e);
    }
    return null;
}
```

### 2. æœåŠ¡å±‚æ‰©å±•

#### QrCodeUsageService.java
æ–°å¢æ–¹æ³•æ¥å£ï¼š
```java
/**
 * æ ¹æ®è®¿å®¢openidæŸ¥è¯¢äºŒç»´ç ä½¿ç”¨è®°å½•
 * @param visitorOpenid è®¿å®¢openid
 * @return äºŒç»´ç ä½¿ç”¨è®°å½•
 */
QrCodeUsage findByVisitorOpenid(String visitorOpenid);
```

#### QrCodeUsageServiceImpl.java
å®ç°æ–¹æ³•ï¼š
```java
@Override
public QrCodeUsage findByVisitorOpenid(String visitorOpenid) {
    try {
        // æŸ¥è¯¢æœ€è¿‘ä½¿ç”¨çš„äºŒç»´ç è®°å½•ï¼ˆæŒ‰ä½¿ç”¨æ—¶é—´å€’åºï¼‰
        return this.baseMapper.findByVisitorOpenid(visitorOpenid);
    } catch (Exception e) {
        logger.error("âŒ æ ¹æ®è®¿å®¢openidæŸ¥è¯¢äºŒç»´ç è®°å½•å¤±è´¥: visitorOpenid=" + visitorOpenid, e);
        return null;
    }
}
```

### 3. æ•°æ®è®¿é—®å±‚æ‰©å±•

#### QrCodeUsageMapper.java
æ–°å¢æŸ¥è¯¢æ–¹æ³•ï¼š
```java
/**
 * æ ¹æ®è®¿å®¢openidæŸ¥è¯¢äºŒç»´ç ä½¿ç”¨è®°å½•ï¼ˆæœ€è¿‘ä½¿ç”¨çš„ä¸€æ¡ï¼‰
 * @param visitorOpenid è®¿å®¢openid
 * @return äºŒç»´ç ä½¿ç”¨è®°å½•
 */
@Select("SELECT * FROM qr_code_usage WHERE visitor_openid = #{visitorOpenid} AND is_used = 1 ORDER BY used_time DESC LIMIT 1")
QrCodeUsage findByVisitorOpenid(@Param("visitorOpenid") String visitorOpenid);
```

## ğŸ”„ å·¥ä½œæµç¨‹

### 1. è®¿å®¢æ‰«æç®¡å®¶äºŒç»´ç 
1. è®¿å®¢æ‰«æç®¡å®¶ç”Ÿæˆçš„äºŒç»´ç 
2. è¿›å…¥é¢„çº¦é¡µé¢ï¼Œé¢„çº¦ç±»å‹è‡ªåŠ¨è®¾ç½®ä¸º"é‚€è¯·"
3. è®¿å®¢å¡«å†™é¢„çº¦ä¿¡æ¯å¹¶æäº¤

### 2. é¢„çº¦å¤„ç†æµç¨‹
1. åç«¯æ¥æ”¶é¢„çº¦æ•°æ®ï¼Œæ£€æµ‹åˆ°é¢„çº¦ç±»å‹ä¸º"é‚€è¯·"
2. ç›´æ¥è®¾ç½®å®¡æ ¸çŠ¶æ€ä¸º"å·²é€šè¿‡"ï¼Œåœºåœ°çŠ¶æ€ä¸º"å¾…å…¥åœº"
3. é€šè¿‡è®¿å®¢openidæŸ¥è¯¢äºŒç»´ç ä½¿ç”¨è®°å½•
4. ä»äºŒç»´ç è®°å½•ä¸­è·å–ç®¡å®¶æ‰‹æœºå·
5. é€šè¿‡ç®¡å®¶æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶ä¿¡æ¯
6. è®¾ç½®å®¡æ ¸äººä¸ºå¯¹åº”çš„ç®¡å®¶

### 3. å®¡æ ¸ä¿¡æ¯è®¾ç½®
- `auditstatus`: "å·²é€šè¿‡"
- `venuestatus`: "å¾…å…¥åœº"
- `auditdate`: å½“å‰æ—¶é—´
- `auditopenid`: ç®¡å®¶çš„openid
- `auditusername`: ç®¡å®¶çš„å§“å

## ğŸ›¡ï¸ å®¹é”™æœºåˆ¶

1. **ç®¡å®¶ä¿¡æ¯æŸ¥è¯¢å¤±è´¥**ï¼šä½¿ç”¨é»˜è®¤å®¡æ ¸ä¿¡æ¯"ç³»ç»Ÿè‡ªåŠ¨å®¡æ ¸"
2. **äºŒç»´ç è®°å½•ä¸å­˜åœ¨**ï¼šä½¿ç”¨é»˜è®¤å®¡æ ¸ä¿¡æ¯
3. **æ•°æ®åº“æŸ¥è¯¢å¼‚å¸¸**ï¼šè®°å½•é”™è¯¯æ—¥å¿—ï¼Œä½¿ç”¨é»˜è®¤å®¡æ ¸ä¿¡æ¯
4. **ç®¡å®¶openidä¸ºç©º**ï¼šä½¿ç”¨é»˜è®¤å®¡æ ¸ä¿¡æ¯

## ğŸ“Š æ•°æ®å…³è”å…³ç³»

```
è®¿å®¢openid â†’ qr_code_usageè¡¨(visitor_openid) â†’ butler_phone â†’ butlerè¡¨ â†’ butler.openid
```

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. æ­£å¸¸æµç¨‹æµ‹è¯•
- ç®¡å®¶ç”ŸæˆäºŒç»´ç 
- è®¿å®¢æ‰«æäºŒç»´ç è¿›è¡Œé¢„çº¦
- éªŒè¯é¢„çº¦çŠ¶æ€ä¸º"å·²é€šè¿‡"
- éªŒè¯å®¡æ ¸äººä¸ºå¯¹åº”ç®¡å®¶

### 2. å¼‚å¸¸æƒ…å†µæµ‹è¯•
- äºŒç»´ç è®°å½•ä¸å­˜åœ¨çš„æƒ…å†µ
- ç®¡å®¶ä¿¡æ¯æŸ¥è¯¢å¤±è´¥çš„æƒ…å†µ
- æ•°æ®åº“è¿æ¥å¼‚å¸¸çš„æƒ…å†µ

### 3. æ•°æ®éªŒè¯
- æ£€æŸ¥appointmentè¡¨ä¸­çš„å®¡æ ¸ä¿¡æ¯æ˜¯å¦æ­£ç¡®
- éªŒè¯æ—¥å¿—è®°å½•æ˜¯å¦å®Œæ•´

## ğŸ“ æ³¨æ„äº‹é¡¹

1. æ­¤åŠŸèƒ½ä»…å½±å“"é‚€è¯·"ç±»å‹çš„é¢„çº¦ï¼ˆè®¿å®¢æ‰«æç®¡å®¶äºŒç»´ç ï¼‰
2. "ä»£äºº"ç±»å‹ï¼ˆç®¡å®¶ä»£ä¸ºé¢„çº¦ï¼‰å’Œ"è‡ªåŠ©"ç±»å‹é¢„çº¦é€»è¾‘ä¿æŒä¸å˜
3. éœ€è¦ç¡®ä¿qr_code_usageè¡¨ä¸­çš„æ•°æ®å®Œæ•´æ€§
4. å»ºè®®å®šæœŸæ¸…ç†è¿‡æœŸçš„äºŒç»´ç è®°å½•
