# äºŒç»´ç é¢„çº¦ä¸€æ¬¡æ€§ä½¿ç”¨åŠŸèƒ½éƒ¨ç½²æŒ‡å—

## ğŸš€ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—è¯¦ç»†è¯´æ˜å¦‚ä½•éƒ¨ç½²å’Œé…ç½®äºŒç»´ç é¢„çº¦ä¸€æ¬¡æ€§ä½¿ç”¨åŠŸèƒ½ï¼Œç¡®ä¿ç³»ç»Ÿå®‰å…¨ç¨³å®šè¿è¡Œã€‚

## ğŸ“¦ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶
```
src/main/java/com/parkingmanage/
â”œâ”€â”€ entity/QrCodeUsage.java                    # äºŒç»´ç ä½¿ç”¨è®°å½•å®ä½“ç±»
â”œâ”€â”€ mapper/QrCodeUsageMapper.java              # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ service/QrCodeUsageService.java            # æœåŠ¡æ¥å£
â”œâ”€â”€ service/impl/QrCodeUsageServiceImpl.java   # æœåŠ¡å®ç°
â””â”€â”€ controller/QrCodeController.java           # æ§åˆ¶å™¨

src/main/resources/sql/
â””â”€â”€ qr_code_usage.sql                          # æ•°æ®åº“è¡¨ç»“æ„
```

### å‰ç«¯æ–‡ä»¶
```
config/
â””â”€â”€ api.js                                     # APIé…ç½®æ›´æ–°

pages/reservation/
â””â”€â”€ form.vue                                   # é¢„çº¦é¡µé¢è®¿é—®æ§åˆ¶

pagesB/butler/
â””â”€â”€ qrcode-generator.vue                       # ç®¡å®¶äºŒç»´ç ç”Ÿæˆå™¨

docs/
â”œâ”€â”€ äºŒç»´ç é¢„çº¦ä¸€æ¬¡æ€§ä½¿ç”¨æµ‹è¯•æŒ‡å—.md
â””â”€â”€ äºŒç»´ç é¢„çº¦åŠŸèƒ½éƒ¨ç½²æŒ‡å—.md
```

## ğŸ—„ï¸ æ•°æ®åº“éƒ¨ç½²

### 1. åˆ›å»ºæ•°æ®è¡¨
```sql
-- è¿æ¥åˆ°æ•°æ®åº“
mysql -u username -p database_name

-- æ‰§è¡Œå»ºè¡¨è„šæœ¬
source src/main/resources/sql/qr_code_usage.sql;

-- éªŒè¯è¡¨åˆ›å»º
SHOW TABLES LIKE 'qr_code_usage';
DESC qr_code_usage;
```

### 2. è®¾ç½®ç´¢å¼•ä¼˜åŒ–
```sql
-- ç¡®ä¿å…³é”®ç´¢å¼•å­˜åœ¨
SHOW INDEX FROM qr_code_usage;

-- å¦‚æœéœ€è¦ï¼Œå¯ä»¥æ·»åŠ é¢å¤–ç´¢å¼•
CREATE INDEX idx_butler_community ON qr_code_usage(butler_phone, community);
CREATE INDEX idx_expire_used ON qr_code_usage(expire_time, is_used);
```

### 3. é…ç½®å®šæ—¶æ¸…ç†ï¼ˆå¯é€‰ï¼‰
```sql
-- å¯ç”¨äº‹ä»¶è°ƒåº¦å™¨
SET GLOBAL event_scheduler = ON;

-- åˆ›å»ºå®šæ—¶æ¸…ç†äº‹ä»¶
CREATE EVENT auto_clean_expired_qr_codes
ON SCHEDULE EVERY 1 DAY
STARTS TIMESTAMP(CURRENT_DATE + INTERVAL 1 DAY, '02:00:00')
DO
  CALL CleanExpiredQrCodes();
```

## ğŸ”§ åç«¯éƒ¨ç½²

### 1. ä¾èµ–æ£€æŸ¥
ç¡®ä¿ä»¥ä¸‹ä¾èµ–å·²æ·»åŠ åˆ° `pom.xml`ï¼š
```xml
<!-- MyBatis Plus -->
<dependency>
    <groupId>com.baomidou</groupId>
    <artifactId>mybatis-plus-boot-starter</artifactId>
</dependency>

<!-- Spring Boot Web -->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-web</artifactId>
</dependency>

<!-- MySQL Driver -->
<dependency>
    <groupId>mysql</groupId>
    <artifactId>mysql-connector-java</artifactId>
</dependency>
```

### 2. é…ç½®æ–‡ä»¶æ›´æ–°
åœ¨ `application.yml` ä¸­ç¡®è®¤æ•°æ®åº“é…ç½®ï¼š
```yaml
spring:
  datasource:
    url: jdbc:mysql://www.xuerparking.cn:3306/your_database?useUnicode=true&characterEncoding=utf8&serverTimezone=GMT%2B8
    username: your_username
    password: your_password
    driver-class-name: com.mysql.cj.jdbc.Driver

mybatis-plus:
  mapper-locations: classpath:mapper/*.xml
  type-aliases-package: com.parkingmanage.entity
  configuration:
    map-underscore-to-camel-case: true
```

### 3. ç¼–è¯‘å’Œæ‰“åŒ…
```bash
# æ¸…ç†å¹¶ç¼–è¯‘
mvn clean compile

# è¿è¡Œæµ‹è¯•
mvn test

# æ‰“åŒ…
mvn package -DskipTests

# å¯åŠ¨åº”ç”¨
java -jar target/your-app.jar
```

### 4. éªŒè¯åç«¯æ¥å£
```bash
# æµ‹è¯•äºŒç»´ç è®°å½•æ¥å£
curl -X POST http://www.xuerparking.cn:8080/parking/qrcode/record \
  -H "Content-Type: application/json" \
  -d '{
    "qrId": "TEST_QR_001",
    "butlerPhone": "13800138000",
    "butlerName": "æµ‹è¯•ç®¡å®¶",
    "community": "æµ‹è¯•å°åŒº"
  }'

# æµ‹è¯•äºŒç»´ç éªŒè¯æ¥å£
curl -X POST http://www.xuerparking.cn:8080/parking/qrcode/validate \
  -H "Content-Type: application/json" \
  -d '{
    "qrId": "TEST_QR_001",
    "openid": "test_openid_123"
  }'
```

## ğŸ“± å‰ç«¯éƒ¨ç½²

### 1. é…ç½®æ£€æŸ¥
ç¡®è®¤ `config/api.js` ä¸­çš„æ¥å£é…ç½®ï¼š
```javascript
// æ£€æŸ¥äºŒç»´ç ç›¸å…³æ¥å£é…ç½®
qrcode: {
  record: '/parking/qrcode/record',
  validate: '/parking/qrcode/validate',
  validateToken: '/parking/qrcode/validateToken',
  cleanExpired: '/parking/qrcode/cleanExpired',
  query: '/parking/qrcode/query'
}
```

### 2. å°ç¨‹åºç¼–è¯‘
```bash
# å®‰è£…ä¾èµ–
npm install

# ç¼–è¯‘é¡¹ç›®
npm run build

# æˆ–è€…åœ¨å¼€å‘å·¥å…·ä¸­ç›´æ¥ç¼–è¯‘
```

### 3. ä¸Šä¼ å’Œå‘å¸ƒ
1. åœ¨å¾®ä¿¡å¼€å‘è€…å·¥å…·ä¸­æ‰“å¼€é¡¹ç›®
2. ç‚¹å‡»"ä¸Šä¼ "æŒ‰é’®ï¼Œå¡«å†™ç‰ˆæœ¬å·å’Œé¡¹ç›®å¤‡æ³¨
3. ç™»å½•å¾®ä¿¡å…¬ä¼—å¹³å°ï¼Œæäº¤å®¡æ ¸
4. å®¡æ ¸é€šè¿‡åå‘å¸ƒ

## ğŸ”’ å®‰å…¨é…ç½®

### 1. è®¿é—®ä»¤ç‰Œå®‰å…¨
åœ¨ `QrCodeUsageServiceImpl.java` ä¸­é…ç½®ï¼š
```java
// ä¿®æ”¹è®¿é—®ä»¤ç‰Œå¯†é’¥ï¼ˆç”Ÿäº§ç¯å¢ƒå¿…é¡»ä¿®æ”¹ï¼‰
private static final String ACCESS_TOKEN_SECRET = "YOUR_PRODUCTION_SECRET_KEY_2024";

// è°ƒæ•´ä»¤ç‰Œæœ‰æ•ˆæœŸï¼ˆæ ¹æ®éœ€è¦ï¼‰
private static final long TOKEN_VALIDITY_PERIOD = 24 * 60 * 60 * 1000; // 24å°æ—¶
```

### 2. æ•°æ®åº“å®‰å…¨
```sql
-- åˆ›å»ºä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
CREATE USER 'qrcode_user'@'www.xuerparking.cn' IDENTIFIED BY 'strong_password_123';

-- æˆäºˆå¿…è¦æƒé™
GRANT SELECT, INSERT, UPDATE ON your_database.qr_code_usage TO 'qrcode_user'@'www.xuerparking.cn';

-- åˆ·æ–°æƒé™
FLUSH PRIVILEGES;
```

### 3. æ¥å£è®¿é—®æ§åˆ¶
åœ¨ `QrCodeController.java` ä¸­æ·»åŠ è®¿é—®æ§åˆ¶ï¼š
```java
// æ·»åŠ è®¿é—®é¢‘ç‡é™åˆ¶
@RateLimiter(name = "qrcode-api", fallbackMethod = "rateLimitFallback")

// æ·»åŠ IPç™½åå•æ£€æŸ¥
@PreAuthorize("hasRole('ADMIN') or @ipWhitelistService.isAllowed(request.remoteAddr)")
```

## ğŸ“Š ç›‘æ§å’Œæ—¥å¿—

### 1. æ—¥å¿—é…ç½®
åœ¨ `logback-spring.xml` ä¸­æ·»åŠ ï¼š
```xml
<logger name="com.parkingmanage.controller.QrCodeController" level="INFO"/>
<logger name="com.parkingmanage.service.impl.QrCodeUsageServiceImpl" level="INFO"/>

<!-- äºŒç»´ç ç›¸å…³æ—¥å¿—å•ç‹¬æ–‡ä»¶ -->
<appender name="QRCODE_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
    <file>logs/qrcode.log</file>
    <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
        <fileNamePattern>logs/qrcode.%d{yyyy-MM-dd}.log</fileNamePattern>
        <maxHistory>30</maxHistory>
    </rollingPolicy>
    <encoder>
        <pattern>%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n</pattern>
    </encoder>
</appender>
```

### 2. ç›‘æ§æŒ‡æ ‡
åˆ›å»ºç›‘æ§è„šæœ¬ `monitor_qrcode.sh`ï¼š
```bash
#!/bin/bash

# æ£€æŸ¥äºŒç»´ç ä½¿ç”¨æƒ…å†µ
mysql -u username -p -e "
SELECT 
  DATE(created_time) as date,
  COUNT(*) as total_generated,
  SUM(is_used) as total_used,
  COUNT(*) - SUM(is_used) as unused
FROM qr_code_usage 
WHERE created_time >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY DATE(created_time)
ORDER BY date DESC;
"

# æ£€æŸ¥è¿‡æœŸäºŒç»´ç 
mysql -u username -p -e "
SELECT COUNT(*) as expired_count 
FROM qr_code_usage 
WHERE expire_time < NOW() AND is_used = 0;
"
```

## ğŸ”„ ç»´æŠ¤æ“ä½œ

### 1. å®šæœŸæ¸…ç†
```sql
-- æ‰‹åŠ¨æ¸…ç†è¿‡æœŸäºŒç»´ç 
CALL CleanExpiredQrCodes();

-- æ¸…ç†30å¤©å‰çš„å·²ä½¿ç”¨è®°å½•ï¼ˆå¯é€‰ï¼‰
DELETE FROM qr_code_usage 
WHERE is_used = 1 AND used_time < DATE_SUB(NOW(), INTERVAL 30 DAY);
```

### 2. æ€§èƒ½ä¼˜åŒ–
```sql
-- åˆ†æè¡¨æ€§èƒ½
ANALYZE TABLE qr_code_usage;

-- ä¼˜åŒ–è¡¨ç»“æ„
OPTIMIZE TABLE qr_code_usage;

-- æ£€æŸ¥æ…¢æŸ¥è¯¢
SHOW PROCESSLIST;
```

### 3. å¤‡ä»½ç­–ç•¥
```bash
# æ¯æ—¥å¤‡ä»½äºŒç»´ç è¡¨
mysqldump -u username -p database_name qr_code_usage > backup/qr_code_usage_$(date +%Y%m%d).sql

# ä¿ç•™æœ€è¿‘30å¤©çš„å¤‡ä»½
find backup/ -name "qr_code_usage_*.sql" -mtime +30 -delete
```

## ğŸš¨ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜åŠè§£å†³æ–¹æ¡ˆ

1. **äºŒç»´ç ç”Ÿæˆå¤±è´¥**
   - æ£€æŸ¥æ•°æ®åº“è¿æ¥
   - éªŒè¯è¡¨ç»“æ„æ˜¯å¦æ­£ç¡®
   - æŸ¥çœ‹åç«¯æ—¥å¿—

2. **éªŒè¯æ¥å£è¿”å›é”™è¯¯**
   - æ£€æŸ¥äºŒç»´ç IDæ ¼å¼
   - éªŒè¯æ•°æ®åº“è®°å½•
   - ç¡®è®¤ç½‘ç»œè¿æ¥

3. **å‰ç«¯æ˜¾ç¤ºå¼‚å¸¸**
   - æ£€æŸ¥APIé…ç½®
   - éªŒè¯ç”¨æˆ·æƒé™
   - æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°

4. **æ€§èƒ½é—®é¢˜**
   - æ£€æŸ¥æ•°æ®åº“ç´¢å¼•
   - åˆ†ææ…¢æŸ¥è¯¢æ—¥å¿—
   - è€ƒè™‘å¢åŠ ç¼“å­˜

## âœ… éƒ¨ç½²æ£€æŸ¥æ¸…å•

éƒ¨ç½²å®Œæˆåï¼Œè¯·é€é¡¹æ£€æŸ¥ï¼š

- [ ] æ•°æ®åº“è¡¨åˆ›å»ºæˆåŠŸ
- [ ] åç«¯æœåŠ¡æ­£å¸¸å¯åŠ¨
- [ ] APIæ¥å£å“åº”æ­£å¸¸
- [ ] å‰ç«¯é¡µé¢åŠ è½½æ­£å¸¸
- [ ] ç®¡å®¶å¯ä»¥ç”ŸæˆäºŒç»´ç 
- [ ] è®¿å®¢æ‰«ç éªŒè¯æ­£å¸¸
- [ ] é‡å¤ä½¿ç”¨è¢«æ­£ç¡®æ‹¦æˆª
- [ ] ç›´æ¥è®¿é—®è¢«æ­£ç¡®é™åˆ¶
- [ ] æ—¥å¿—è®°å½•å®Œæ•´
- [ ] ç›‘æ§æŒ‡æ ‡æ­£å¸¸
- [ ] å®‰å…¨é…ç½®åˆ°ä½
- [ ] å¤‡ä»½ç­–ç•¥æ‰§è¡Œ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚é‡åˆ°éƒ¨ç½²é—®é¢˜ï¼Œè¯·æä¾›ä»¥ä¸‹ä¿¡æ¯ï¼š
1. é”™è¯¯æ—¥å¿—æˆªå›¾
2. æ•°æ®åº“ç‰ˆæœ¬å’Œé…ç½®
3. æœåŠ¡å™¨ç¯å¢ƒä¿¡æ¯
4. å…·ä½“æ“ä½œæ­¥éª¤
5. é¢„æœŸç»“æœå’Œå®é™…ç»“æœ

è”ç³»æ–¹å¼ï¼š[æŠ€æœ¯æ”¯æŒé‚®ç®±æˆ–è”ç³»æ–¹å¼]
