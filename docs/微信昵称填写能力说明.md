# 微信昵称填写能力实现说明

## 背景

根据微信官方2022年的规则调整，`wx.getUserProfile` 接口已被收回。从2022年10月25日起，小程序需要使用「头像昵称填写能力」来获取用户头像昵称。

## 官方文档链接
https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html

## 当前实现方案

### 1. 使用 type="nickname" 的 input 组件
```html
<form @submit="onFormSubmit">
    <input 
        type="nickname" 
        class="nickname-input" 
        placeholder="请输入昵称"
        name="nickname"
        @blur="onNicknameBlur"
    />
    <button form-type="submit">确认昵称</button>
</form>
```

### 2. 工作原理
- 用户点击 `type="nickname"` 的输入框
- **键盘上方会展示微信昵称**（不再是弹窗形式）
- 用户可以选择使用微信昵称或自定义昵称
- 填写完成后，昵称会自动填入输入框

### 3. 安全检测机制（基础库2.24.4+）
- **内容安全检测**: 微信会对用户输入的昵称进行安全检测
- **自动清空**: 不合规内容会被自动清空
- **异步处理**: 安全检测在 `onBlur` 事件时异步进行
- **推荐使用form**: 建议通过 `form-type="submit"` 的button收集用户输入

### 4. 兼容性说明
- **基础库版本要求**: 2.21.2+（基础功能）
- **安全检测要求**: 2.24.4+（内容安全）
- **微信版本要求**: iOS/Android 8.0.16+
- **低版本兼容**: 对于不支持的版本，输入框会降级为普通文本输入

## 实现特点

### ✅ 优势
1. **符合微信最新规范** - 使用官方推荐的头像昵称填写能力
2. **用户体验友好** - 键盘上方展示微信昵称，操作简单
3. **无需额外授权** - 不需要用户进行复杂的授权操作
4. **向下兼容** - 低版本微信客户端自动降级为普通输入
5. **内容安全保障** - 自动进行内容安全检测，降低风险

### ⚠️ 注意事项
1. **不强制使用微信昵称** - 用户可以选择自定义昵称
2. **需要用户主动填写** - 无法自动获取，需要用户点击输入
3. **基础库版本限制** - 需要确保小程序基础库版本足够新
4. **内容安全检测** - 不合规内容会被自动清空，需要处理这种情况
5. **推荐使用form** - 建议使用form表单收集用户输入，而非直接绑定值

## 代码实现

### HTML 结构
```html
<!-- 昵称填写区域 -->
<view class="nickname-input-area">
    <form @submit="onFormSubmit">
        <input 
            type="nickname" 
            class="nickname-input" 
            placeholder="请输入昵称"
            name="nickname"
            @blur="onNicknameBlur"
            :disabled="gettingWechatInfo"
        />
        <button 
            class="confirm-nickname-btn" 
            form-type="submit"
            :disabled="gettingWechatInfo"
        >
            确认昵称
        </button>
    </form>
</view>
```

### JavaScript 处理
```javascript
// 昵称失去焦点处理（基础库2.24.4+会进行安全检测）
onNicknameBlur(e) {
    console.log('昵称失去焦点，等待安全检测结果');
    // 注意：基础库2.24.4+会异步进行安全检测，不合规内容会被自动清空
},

// 表单提交处理（推荐使用form收集用户输入）
async onFormSubmit(e) {
    const formData = e.detail.value;
    const nickname = formData.nickname?.trim();
    
    if (!nickname) {
        uni.showToast({
            title: '请先填写昵称',
            icon: 'none'
        });
        return;
    }
    
    await this.confirmNickname(nickname);
},

// 确认昵称
async confirmNickname(nickname) {
    if (!nickname) return;
    
    // 保存昵称到本地和后端
    this.wechatUserInfo.nickname = nickname;
    uni.setStorageSync('wechatUserInfo', this.wechatUserInfo);
    
    // 检查数据库中是否存在该昵称
    await this.checkUserNicknameInDatabase();
}
```

## 与旧版本的区别

| 功能 | 旧版本 (wx.getUserProfile) | 新版本 (昵称填写能力) |
|------|---------------------------|---------------------|
| 获取方式 | 自动获取微信昵称 | 用户主动填写昵称 |
| 授权要求 | 需要用户授权 | 无需额外授权 |
| 昵称来源 | 只能是微信昵称 | 可以是微信昵称或自定义 |
| 实现复杂度 | 需要处理授权逻辑 | 相对简单 |
| 用户体验 | 可能被拒绝授权 | 用户主动参与 |

## 后续扩展

### 1. 头像获取
如果需要获取用户头像，需要使用 `type="avatar"` 的 `button` 组件：
```html
<button open-type="chooseAvatar" @chooseavatar="onChooseAvatar">
    <image :src="avatarUrl || defaultAvatar"></image>
</button>
```

### 2. 数据验证
可以添加昵称格式验证：
```javascript
validateNickname(nickname) {
    // 检查长度、特殊字符等
    if (nickname.length < 1 || nickname.length > 20) {
        return false;
    }
    return true;
}
```

### 3. 服务端集成
可以将昵称信息同步到服务端：
```javascript
async saveNicknameToServer(nickname) {
    await uni.request({
        url: '/api/user/updateNickname',
        method: 'POST',
        data: { nickname }
    });
}
```

## 测试建议

1. **不同版本测试** - 在不同微信版本上测试兼容性
2. **用户操作测试** - 测试用户取消填写、填写空值等场景
3. **网络异常测试** - 测试网络不稳定时的处理
4. **数据持久化测试** - 确保昵称信息正确保存和读取

## 最新更新（基础库2.24.4+）

### 内容安全检测
根据[官方文档](https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/userProfile.html)，从基础库2.24.4版本起：

1. **自动安全检测**: 组件已接入内容安全服务端接口（`mediaCheckAsync`、`msgSecCheck`）
2. **异步检测**: 在 `onBlur` 事件触发时，微信将异步对用户输入的内容进行安全监测
3. **自动清空**: 若未通过安全监测，微信将清空用户输入的内容
4. **推荐form收集**: 建议开发者通过 `form-type="submit"` 的button组件收集用户输入的内容

### 开发者工具说明
- input 组件在开发者工具上是用 web 组件模拟的
- 部分情况下并不能很好的还原真机的表现
- **建议在真机上进行调试**，特别是使用原生组件时

## 总结

新的昵称填写能力虽然需要用户主动参与，但符合微信的隐私保护理念，同时提供了更好的用户控制权和内容安全保障。最新版本还增加了自动内容安全检测功能，进一步降低了开发者的合规风险。建议所有使用旧版 `wx.getUserProfile` 的小程序尽快升级到新的实现方式。 