# 微信用户名获取和公众号关注功能说明

## 功能概述

本功能实现了在预约结果页面获取微信用户名，并根据数据库中的昵称记录决定是否显示公众号关注引导页面。

## 实现的功能

### 1. 微信用户名获取
- 在预约结果页面添加了"获取微信用户名"按钮
- 只获取用户昵称，不获取头像信息
- 支持用户主动授权获取微信信息

### 2. 昵称查询功能
- 查询 `user_mapping` 表中是否存在该昵称
- 如果存在昵称记录，不显示公众号关注页面
- 如果不存在昵称记录，显示公众号关注引导

### 3. 公众号关注引导
- 显示公众号二维码供用户扫描关注
- 提供"我已关注"检查按钮
- 支持"稍后关注"跳过功能

## 文件修改列表

### 前端文件
```
car-new-demo/pagesD/reservation/result.vue
- 添加了微信用户信息获取区域
- 添加了用户信息显示区域  
- 添加了公众号关注引导组件
- 集成了微信工具类调用
- 新增相关样式定义
```

### 后端文件
```
parking-demo/src/main/java/com/parkingmanage/controller/UserMappingController.java
- 新增用户映射控制器
- 实现昵称查询接口
- 实现用户信息保存接口
- 实现手机号查询接口

parking-demo/src/main/java/com/parkingmanage/entity/UserMapping.java
- 新增用户映射实体类
- 定义数据表结构映射

parking-demo/src/main/java/com/parkingmanage/mapper/UserMappingMapper.java  
- 新增用户映射数据访问接口
- 实现基础CRUD操作
```

### 数据库文件
```
parking-demo/sql/create_user_mapping_table.sql
- 用户映射表创建脚本
- 包含索引和约束定义
```

## API接口说明

### 1. 检查昵称是否存在
```
POST /parking/user/checkNicknameExists
请求体：{"nickname": "用户昵称"}
返回：{"code": "200", "data": {"exists": true/false, "nickname": "用户昵称", "count": 0}}
```

### 2. 根据昵称获取用户信息
```
POST /parking/user/getUserByNickname  
请求体：{"nickname": "用户昵称"}
返回：用户详细信息列表
```

### 3. 保存用户昵称信息
```
POST /parking/user/saveUserNickname
请求体：{"nickname": "昵称", "openid": "openid", "unionid": "unionid", "phone": "手机号"}
返回：保存结果
```

### 4. 根据手机号查询用户
```
POST /parking/user/getUserByPhone
请求体：{"phone": "手机号"}  
返回：用户信息
```

## 数据库表结构

### user_mapping 表
```sql
CREATE TABLE `user_mapping` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '主键ID',
    `nickname` VARCHAR(100) DEFAULT NULL COMMENT '微信昵称',
    `openid` VARCHAR(100) DEFAULT NULL COMMENT '微信OpenID', 
    `unionid` VARCHAR(100) DEFAULT NULL COMMENT '微信UnionID',
    `phone` VARCHAR(20) DEFAULT NULL COMMENT '手机号',
    `create_time` DATETIME DEFAULT NULL COMMENT '创建时间',
    `update_time` DATETIME DEFAULT NULL COMMENT '更新时间',
    `deleted` TINYINT(1) DEFAULT 0 COMMENT '是否删除 0-未删除 1-已删除',
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_openid` (`openid`),
    UNIQUE KEY `uk_unionid` (`unionid`),
    KEY `idx_nickname` (`nickname`),
    KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户映射表';
```

## 使用流程

### 1. 用户操作流程
1. 用户完成预约提交后进入结果页面
2. 如果用户未获取过微信信息，显示"获取微信用户名"按钮
3. 用户点击按钮，触发微信授权获取昵称
4. 系统查询数据库中是否存在该昵称
5. 如果不存在昵称，显示公众号关注引导
6. 用户可以扫码关注或选择跳过

### 2. 开发者配置
1. 执行SQL脚本创建 `user_mapping` 表
2. 将公众号二维码图片命名为 `wechat-qr.png` 放在 `/static/images/` 目录
3. 确保微信小程序已配置公众号关联
4. 部署后端接口并确保跨域配置正确

## 配置说明

### 必需配置
1. **数据库表** - 执行 `create_user_mapping_table.sql` 创建表
2. **公众号二维码** - 添加 `wechat-qr.png` 图片文件
3. **微信配置** - 确保小程序与公众号正确关联

### 可选配置
1. 可以调整公众号关注检查的缓存时间（默认1小时）
2. 可以自定义公众号关注引导的文案
3. 可以修改用户昵称的存储和查询逻辑

## 注意事项

1. **权限要求** - 需要用户主动授权才能获取微信信息
2. **网络依赖** - 需要访问微信API和后端服务
3. **数据同步** - 建议定期清理过期的用户映射数据
4. **隐私保护** - 仅获取必要的用户信息（昵称），不存储头像等敏感信息

## 错误处理

### 常见问题
1. **微信授权失败** - 检查小程序权限配置和网络连接
2. **数据库查询失败** - 确认表结构和接口配置
3. **图片加载失败** - 检查二维码图片路径和文件格式
4. **接口调用失败** - 检查后端服务状态和跨域配置

### 调试方法
1. 查看浏览器控制台日志
2. 检查网络请求状态
3. 验证数据库表结构
4. 测试接口是否正常响应

## 扩展建议

1. **数据统计** - 可以添加用户关注转化率统计
2. **消息推送** - 结合公众号实现预约状态推送
3. **用户画像** - 基于收集的信息完善用户画像
4. **A/B测试** - 测试不同引导方式的转化效果 