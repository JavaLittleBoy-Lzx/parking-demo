# 🕐 停车超时推送时间段配置说明

## 📌 功能说明

定时任务会检查停车超时的车辆，并在指定的时间段内向车主、巡检员、管家发送微信推送消息。

### 推送对象
1. **车主**：预约车辆的车主
2. **巡检员**：当前值班的巡检员
3. **管家**：代人预约的管家

### 推送时机
- 停车剩余 **15分钟** 时发送第一次提醒
- 停车剩余 **5分钟** 时发送第二次提醒
- 停车剩余 **1分钟** 时发送最后一次提醒

---

## ⏰ 推送时间段配置

### 默认配置
如果数据库中未配置，系统使用默认推送时间段：
- **开始时间**：23:00（晚上11点）
- **结束时间**：06:00（早上6点）

**说明**：只在每天晚上11点到早上6点之间发送推送消息，其他时间段不发送。

---

## 📝 数据库配置方法

### 配置位置
配置信息存储在 `monthly_ticket_timeout_config` 表的 `description` 字段中，使用 **JSON 格式**。

### JSON 格式
```json
{
  "notificationStartTime": "23:00",
  "notificationEndTime": "06:00"
}
```

### 字段说明
| 字段名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| notificationStartTime | String | 是 | 推送开始时间（24小时制） | "23:00" |
| notificationEndTime | String | 是 | 推送结束时间（24小时制） | "06:00" |

---

## 🔧 配置步骤

### 方法1：新增配置记录

```sql
-- 为指定车场添加推送时间段配置
INSERT INTO monthly_ticket_timeout_config (
    park_code,
    park_name,
    timeout_minutes,
    max_violation_count,
    is_active,
    description,
    created_at,
    updated_at
) VALUES (
    '2KST9MNP',  -- 车场编码
    '万象上东',   -- 车场名称
    120,          -- 超时时间（分钟）
    3,            -- 最大违规次数
    1,            -- 是否启用：1-启用
    '{"notificationStartTime": "23:00", "notificationEndTime": "06:00"}',  -- 推送时间段配置
    NOW(),
    NOW()
);
```

### 方法2：更新现有配置

```sql
-- 更新已有配置的推送时间段
UPDATE monthly_ticket_timeout_config 
SET description = '{"notificationStartTime": "23:00", "notificationEndTime": "06:00"}',
    updated_at = NOW()
WHERE park_code = '2KST9MNP'  -- 替换为实际的车场编码
  AND is_active = 1;
```

---

## 📊 配置示例

### 示例1：晚上11点到早上6点（跨日）
```json
{
  "notificationStartTime": "23:00",
  "notificationEndTime": "06:00"
}
```
**生效时间**：每天 23:00 - 次日 06:00

---

### 示例2：晚上10点到早上7点（跨日）
```json
{
  "notificationStartTime": "22:00",
  "notificationEndTime": "07:00"
}
```
**生效时间**：每天 22:00 - 次日 07:00

---

### 示例3：全天推送（00:00-23:59）
```json
{
  "notificationStartTime": "00:00",
  "notificationEndTime": "23:59"
}
```
**生效时间**：全天24小时

---

### 示例4：仅白天推送（08:00-18:00）
```json
{
  "notificationStartTime": "08:00",
  "notificationEndTime": "18:00"
}
```
**生效时间**：每天 08:00 - 18:00

---

## 🔍 查询当前配置

```sql
-- 查询所有启用的配置
SELECT 
    park_code,
    park_name,
    description,
    is_active,
    created_at,
    updated_at
FROM monthly_ticket_timeout_config
WHERE is_active = 1
ORDER BY updated_at DESC;
```

---

## 🔄 完整配置示例（带过夜检查）

如果需要同时配置过夜检查和推送时间段，`description` 字段可以包含更多信息：

```json
{
  "notificationStartTime": "23:00",
  "notificationEndTime": "06:00",
  "remark": "每天晚上11点到早上6点推送超时提醒"
}
```

**说明**：
- `notificationStartTime` 和 `notificationEndTime` 用于控制推送时间段
- `remark` 为可选字段，用于备注说明
- 系统只读取 `notificationStartTime` 和 `notificationEndTime` 字段

---

## ⚙️ 技术实现

### 时间判断逻辑

1. **跨日判断**（如 23:00-06:00）
   - 23:00 之后 **或** 06:00 之前都在时间段内
   - 实现：`当前时间 >= 23:00 || 当前时间 < 06:00`

2. **同日判断**（如 08:00-18:00）
   - 08:00 之后 **且** 18:00 之前才在时间段内
   - 实现：`当前时间 >= 08:00 && 当前时间 < 18:00`

### 配置读取优先级

1. 从数据库读取启用的配置（`is_active = 1`）
2. 解析 `description` 字段的 JSON
3. 如果配置无效或不存在，使用默认值（23:00-06:00）

### 异常处理

- 如果 JSON 解析失败，使用默认值
- 如果时间格式不正确，使用默认值
- 如果数据库查询异常，默认允许推送（避免影响功能）

---

## 📋 注意事项

1. **时间格式**：必须使用 24小时制，格式为 `HH:mm`（如 "23:00"）
2. **JSON 格式**：description 字段必须是合法的 JSON 字符串
3. **is_active 字段**：只有启用的配置（`is_active = 1`）才会生效
4. **跨日支持**：支持跨日时间段（如 23:00-06:00）
5. **立即生效**：配置更新后，下一次定时任务执行时立即生效（每1分钟执行一次）

---

## ✅ 验证配置

### 检查配置是否生效

1. **查看定时任务日志**
```
⏰ [定时任务] 停车超时监控开始执行
📋 [推送时间段] 从配置表读取: 23:00~06:00
✅ [推送时间段] 当前时间 23:30 在推送时间段 23:00~06:00 内
```

2. **非推送时间段的日志**
```
⏰ [定时任务] 停车超时监控开始执行
⏭️ [推送时间段] 当前时间 10:00 不在推送时间段 23:00~06:00 内
⏭️ [定时任务] 当前不在推送时间段内，跳过超时提醒发送
```

---

## 🛠️ 故障排查

### 问题1：配置不生效

**检查项**：
1. `is_active` 字段是否为 `1`
2. `description` 字段是否为有效 JSON
3. 时间格式是否为 `HH:mm`

**解决方案**：
```sql
-- 检查配置
SELECT park_code, park_name, description, is_active
FROM monthly_ticket_timeout_config
WHERE is_active = 1;
```

### 问题2：推送时间不对

**检查项**：
1. 确认服务器时区设置
2. 检查配置的时间是否正确

**解决方案**：
```sql
-- 检查当前时间
SELECT NOW(), CURTIME();

-- 更新配置
UPDATE monthly_ticket_timeout_config
SET description = '{"notificationStartTime": "23:00", "notificationEndTime": "06:00"}'
WHERE park_code = 'YOUR_PARK_CODE';
```

---

## 📚 相关文档

- 定时任务代码：`ParkingTimeoutMonitoringTask.java`
- 配置表实体：`MonthlyTicketTimeoutConfig.java`
- 推送服务：`WeChatTemplateMessageService.java`
