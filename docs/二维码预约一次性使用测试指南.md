# 二维码预约一次性使用功能测试指南

## 🎯 功能概述

本功能实现了访客二维码预约一次即失效的安全机制，确保每个二维码只能使用一次，防止重复使用和未授权访问。

## 📋 测试前准备

### 1. 数据库准备
```sql
-- 执行数据库脚本
source src/main/resources/sql/qr_code_usage.sql;

-- 验证表是否创建成功
SHOW TABLES LIKE 'qr_code_usage';
DESC qr_code_usage;
```

### 2. 后端服务启动
确保以下服务正常运行：
- QrCodeController
- QrCodeUsageService
- 相关数据库连接

### 3. 前端配置检查
确认以下文件已正确配置：
- `config/api.js` - API接口配置
- `pagesB/butler/qrcode-generator.vue` - 管家二维码生成
- `pages/reservation/form.vue` - 预约页面访问控制

## 🧪 测试用例

### 测试用例1：管家生成二维码
**目标**：验证管家能够成功生成带唯一ID的二维码

**步骤**：
1. 使用管家账号登录小程序
2. 进入二维码生成页面 (`pagesB/butler/qrcode-generator.vue`)
3. 选择完整的地址信息（省市区小区楼栋单元等）
4. 点击"生成二维码"按钮
5. 观察生成过程和结果

**预期结果**：
- ✅ 二维码成功生成
- ✅ 控制台显示唯一二维码ID（格式：QR_时间戳_手机号后4位_随机字符）
- ✅ 后端数据库 `qr_code_usage` 表中新增一条记录
- ✅ 记录状态为 `is_used = 0`（未使用）
- ✅ 有效期设置为24小时后

**验证SQL**：
```sql
SELECT * FROM qr_code_usage ORDER BY created_time DESC LIMIT 5;
```

### 测试用例2：访客首次扫码访问
**目标**：验证访客通过扫码能够正常进入预约页面

**步骤**：
1. 使用访客账号（非管家）
2. 扫描管家生成的二维码
3. 观察页面跳转和加载过程
4. 检查是否能正常进入预约表单

**预期结果**：
- ✅ 页面正常跳转到预约表单
- ✅ 控制台显示二维码验证成功日志
- ✅ 数据库中二维码状态更新为 `is_used = 1`
- ✅ 记录 `used_time` 和 `visitor_openid`
- ✅ 生成并保存访问令牌到本地存储

**验证SQL**：
```sql
SELECT qr_id, is_used, used_time, visitor_openid 
FROM qr_code_usage 
WHERE qr_id = '刚才的二维码ID';
```

### 测试用例3：访客重复扫码访问
**目标**：验证已使用的二维码无法再次使用

**步骤**：
1. 使用相同的二维码再次扫描
2. 或者直接访问带有已使用二维码ID的URL

**预期结果**：
- ❌ 显示"二维码已使用"错误提示
- ❌ 无法进入预约页面
- ✅ 提示联系管家重新生成二维码

### 测试用例4：访客直接访问预约页面
**目标**：验证未通过扫码的访客无法直接访问

**步骤**：
1. 使用访客账号
2. 直接通过小程序菜单或搜索进入预约页面
3. 不通过扫码方式

**预期结果**：
- ❌ 显示锁定屏幕界面
- ❌ 无法看到预约表单
- ✅ 显示"需要扫码预约"提示
- ✅ 提供"联系管家"按钮

### 测试用例5：管家直接访问预约页面
**目标**：验证管家不受访问限制

**步骤**：
1. 使用管家账号登录
2. 直接进入预约页面（不通过扫码）

**预期结果**：
- ✅ 正常显示预约表单
- ✅ 不显示锁定屏幕
- ✅ 控制台显示"管家角色，跳过访问控制检查"

### 测试用例6：二维码过期处理
**目标**：验证过期二维码无法使用

**步骤**：
1. 修改数据库中某个二维码的 `expire_time` 为过去时间
2. 尝试使用该二维码访问

**预期结果**：
- ❌ 显示"二维码已过期"错误提示
- ❌ 无法进入预约页面

**手动过期SQL**：
```sql
UPDATE qr_code_usage 
SET expire_time = DATE_SUB(NOW(), INTERVAL 1 HOUR) 
WHERE qr_id = '测试二维码ID';
```

### 测试用例7：访问令牌验证
**目标**：验证访问令牌的有效性检查

**步骤**：
1. 成功扫码进入后，关闭小程序
2. 重新打开小程序，直接进入预约页面
3. 检查是否仍能正常访问

**预期结果**：
- ✅ 如果令牌未过期，应能正常访问
- ❌ 如果令牌过期，应显示锁定屏幕

## 🔧 调试工具

### 1. 控制台日志关键词
搜索以下关键词来追踪流程：
- `🎯 生成二维码ID`
- `🔐 开始检查页面访问权限`
- `✅ 二维码验证成功`
- `❌ 二维码验证失败`
- `👨‍💼 管家角色，跳过访问控制检查`

### 2. 数据库查询
```sql
-- 查看最近的二维码记录
SELECT qr_id, butler_phone, community, is_used, created_time, used_time 
FROM qr_code_usage 
ORDER BY created_time DESC 
LIMIT 10;

-- 查看特定二维码的使用情况
SELECT * FROM qr_code_usage WHERE qr_id = '具体的二维码ID';

-- 统计二维码使用情况
SELECT 
  COUNT(*) as total,
  SUM(is_used) as used_count,
  COUNT(*) - SUM(is_used) as unused_count
FROM qr_code_usage;
```

### 3. 本地存储检查
在浏览器开发者工具中检查：
- `qrAccessToken` - 访问令牌
- `qrValidated` - 验证状态
- `scannedQrId` - 扫码的二维码ID

## 🚨 常见问题排查

### 问题1：二维码生成失败
**可能原因**：
- 后端API接口未启动
- 数据库连接问题
- 管家信息不完整

**排查步骤**：
1. 检查后端服务状态
2. 查看数据库连接
3. 验证管家账号信息

### 问题2：二维码验证失败
**可能原因**：
- 二维码ID格式错误
- 数据库中无对应记录
- 网络请求失败

**排查步骤**：
1. 检查二维码ID格式
2. 查询数据库记录
3. 检查网络连接

### 问题3：管家也被限制访问
**可能原因**：
- 角色判断逻辑错误
- 用户信息获取失败

**排查步骤**：
1. 检查 `currentUserRole` 值
2. 验证用户信息存储
3. 查看角色判断逻辑

## ✅ 测试完成标准

所有测试用例通过后，确认以下功能正常：

1. ✅ 管家可以正常生成唯一二维码
2. ✅ 访客扫码后能正常进入预约页面
3. ✅ 二维码使用后立即失效
4. ✅ 未扫码的访客无法直接访问
5. ✅ 管家不受访问限制
6. ✅ 过期二维码无法使用
7. ✅ 访问令牌验证正常工作
8. ✅ 错误提示友好清晰
9. ✅ 数据库记录准确完整
10. ✅ 用户体验流畅自然

## 📝 测试报告模板

```
测试时间：____年__月__日
测试人员：________
测试环境：________

测试结果：
□ 测试用例1：管家生成二维码 - 通过/失败
□ 测试用例2：访客首次扫码 - 通过/失败  
□ 测试用例3：重复扫码限制 - 通过/失败
□ 测试用例4：直接访问限制 - 通过/失败
□ 测试用例5：管家权限免检 - 通过/失败
□ 测试用例6：过期处理 - 通过/失败
□ 测试用例7：令牌验证 - 通过/失败

发现问题：
1. ________________
2. ________________

建议改进：
1. ________________
2. ________________
```
