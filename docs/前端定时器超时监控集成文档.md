# 🚗 前端定时器超时监控集成文档

## 📖 集成概述

基于您的需求，我们采用**前端定时器 + 后端API**的方式实现停车超时监控：

- 🔧 **前端负责**: 定时器调度、监控状态管理、用户界面提醒
- 🚀 **后端负责**: 数据查询、微信模板消息发送、业务逻辑处理
- ⚡ **智能控制**: 根据活跃车辆数量动态调整检查频率

## 🏗️ 架构设计

```
前端小程序 (car-new-demo)
├── utils/timeoutMonitoring.js        # 定时器监控工具
├── api/timeout-monitoring.js         # API接口定义
└── pages/test/timeout-monitoring.vue # 监控管理页面

后端Spring Boot (parking-demo)
├── controller/ParkingTimeoutController.java  # 超时监控接口
├── service/WeChatTemplateMessageService.java # 微信消息服务
└── mapper/UserMappingMapper.java              # 用户openid映射
```

## 🔄 工作流程

### 1. **前端启动监控**
```javascript
// 在App.vue或合适的页面中启动
import timeoutMonitoring from '@/utils/timeoutMonitoring.js'

// 应用启动时检查并启动监控
timeoutMonitoring.checkAndStartMonitoring()
```

### 2. **定时检查流程**
```
每10-20分钟（动态调整）
   ↓
查询2小时内活跃车辆数量
   ↓
如果有活跃车辆，执行超时检查
   ↓
后端返回超时车辆列表 + 发送结果
   ↓
前端显示用户提醒
```

### 3. **微信消息发送**
```
即将超时车辆（1小时45分钟+）
   ↓
通过appointment.visitorname → user_mapping表查询openid → 发送给访客
   ↓
已超时车辆（2小时+）
   ↓
通过appointment.visitorname → user_mapping表查询openid → 发送给访客
```

## 🛠️ 后端API接口

### 1. 获取活跃车辆数量
```
GET /parking/timeout/recent-active-count
```

**响应示例**:
```json
{
    "code": "0",
    "msg": "成功",
    "data": 5
}
```

**前端用法**:
```javascript
const response = await timeoutAPI.getRecentActiveCount()
if (response.code === 200 && response.data > 0) {
    // 有活跃车辆，启动监控
}
```

### 2. 检查超时车辆（核心接口）
```
GET /parking/timeout/check-recent-timeout
```

**响应示例**:
```json
{
    "code": "0",
    "msg": "成功",
    "data": {
        "totalActive": 8,
        "almostTimeoutCount": 2,
        "timeoutCount": 1,
        "processedCount": 3,
        "successCount": 2,
        "failCount": 1,
        "almostTimeoutVehicles": [
            {
                "id": 123,
                "plateNumber": "粤B12345",
                "parkName": "凯达尔停车场",
                "visitorName": "张三",
                "enterTime": "2024-01-15 10:00:00",
                "parkingMinutes": 110,
                "remainingMinutes": 10,
                "openid": "owner_13593527970_1756796430797",
                "notificationSent": true
            }
        ],
        "timeoutVehicles": [
            {
                "id": 124,
                "plateNumber": "粤B67890",
                "parkName": "凯达尔停车场",
                "visitorName": "李四",
                "enterTime": "2024-01-15 09:30:00",
                "parkingMinutes": 130,
                "remainingMinutes": -10,
                "overtimeMinutes": 10,
                "openid": "owner_13593527970_1756796430798",
                "notificationSent": true
            }
        ],
        "checkTime": "2024-01-15 12:00:00"
    }
}
```

**业务逻辑**:
- `almostTimeoutVehicles`: 停车105-119分钟（还剩1-15分钟到2小时）
- `timeoutVehicles`: 停车120分钟以上（已超时）
- 后端自动发送微信消息，返回发送结果

### 3. 手动发送通知（可选）
```
POST /parking/timeout/send-timeout-notification
```

**请求参数**:
```json
{
    "plateNumber": "粤B12345",
    "parkName": "凯达尔停车场"
}
```

### 4. 手动检查（调试用）
```
POST /parking/timeout/manual-check
```

## 📱 微信模板消息

### 即将超时提醒（发给访客）
**模板ID**: `NvxG4lJ8SSfhVh1cdK0Jachz9Fr383oAHWZfO29D2Ws`

```
停车超时通知

停车场名称：凯达尔停车场
车牌号：粤B88888
入场时间：2024-01-15 10:00:00
剩余时长：15分钟

您的车辆即将超过停车时限，请及时处理
```

### 超时通知（发给访客）
**模板ID**: 使用现有的进场通知模板

```
停车超时提醒

车牌号：粤B88888
停车场：凯达尔停车场
进场时间：2024-01-15 09:00:00
超时时长：30分钟
温馨提示：您的车辆已超过停车时限，请尽快处理
```

## 🔧 数据库依赖

### 1. appointment表字段
- `visitorname`: 访客姓名（用于查询访客openid）
- `auditusername`: 管家昵称
- `arrivedate`: 进场时间
- `venuestatus`: 车辆状态（已进场）

### 2. user_mapping表
- `nickname`: 用户昵称（对应appointment.visitorname）
- `openid`: 微信openid
- 用于通过访客姓名查询访客的openid发送超时提醒

## 🧪 前端集成示例

### 在App.vue中启用监控
```javascript
import timeoutMonitoring from '@/utils/timeoutMonitoring.js'

export default {
    onLaunch() {
        // 应用启动时检查是否需要监控
        this.$nextTick(() => {
            timeoutMonitoring.checkAndStartMonitoring()
        })
    },
    
    onShow() {
        // 应用从后台回到前台时重新检查
        timeoutMonitoring.checkAndStartMonitoring()
    },
    
    onHide() {
        // 应用进入后台时可以选择停止监控（可选）
        // timeoutMonitoring.stopMonitoring()
    }
}
```

### 在管理页面中手动控制
```javascript
// 在管家或业主的管理页面
export default {
    data() {
        return {
            monitoringStatus: {}
        }
    },
    
    mounted() {
        this.updateMonitoringStatus()
    },
    
    methods: {
        // 获取监控状态
        updateMonitoringStatus() {
            this.monitoringStatus = timeoutMonitoring.getMonitoringStatus()
        },
        
        // 手动启动监控
        async startMonitoring() {
            const started = await timeoutMonitoring.startMonitoring()
            if (started) {
                uni.showToast({ title: '监控已启动', icon: 'success' })
            } else {
                uni.showToast({ title: '暂无需要监控的车辆', icon: 'none' })
            }
            this.updateMonitoringStatus()
        },
        
        // 停止监控
        stopMonitoring() {
            timeoutMonitoring.stopMonitoring()
            uni.showToast({ title: '监控已停止', icon: 'success' })
            this.updateMonitoringStatus()
        },
        
        // 手动检查
        async forceCheck() {
            await timeoutMonitoring.forceCheck()
            this.updateMonitoringStatus()
        }
    }
}
```

## ⚙️ 配置说明

### 1. 前端配置（timeoutMonitoring.js）
```javascript
// 可以根据需要调整这些参数
checkInterval: 15 * 60 * 1000,  // 默认15分钟检查一次
maxRetryCount: 3,               // 最大重试次数
```

### 2. 后端配置（application.yml）
```yaml
wechat:
  public:
    appid: your_app_id
    secret: your_secret
  template:
    parking:
      enter: your_enter_template_id
      leave: your_leave_template_id
```

### 3. 检查频率动态调整
- 活跃车辆 ≤ 2辆: 20分钟检查一次
- 活跃车辆 3-5辆: 15分钟检查一次  
- 活跃车辆 > 5辆: 10分钟检查一次

## 🚨 注意事项

### 1. 权限控制
- 只有管家和业主角色可以启动监控
- 访客角色无监控权限

### 2. 网络处理
- 前端会检查网络状态，无网络时跳过检查
- 连续失败3次后暂停监控，5分钟后重试

### 3. 防重复发送
- 建议在数据库中记录通知历史
- 避免短时间内重复发送同一车辆的提醒

### 4. 数据完整性
- 确保appointment表中的visitorname字段有值
- 确保user_mapping表中有访客的昵称-openid映射

## 🔍 调试指南

### 1. 检查前端监控状态
```javascript
console.log('监控状态:', timeoutMonitoring.getMonitoringStatus())
```

### 2. 查看后端日志
```
[超时监控] 查询2小时内活跃车辆数量
[超时监控] 开始检查即将超时和已超时车辆
[超时监控] 即将超时提醒发送成功 - 车牌: 粤B12345
```

### 3. 测试API接口
```bash
# 测试活跃车辆查询
curl http://www.xuerparking.cn:8543/parking/timeout/recent-active-count

# 测试超时检查
curl http://www.xuerparking.cn:8543/parking/timeout/check-recent-timeout

# 手动触发检查
curl -X POST http://www.xuerparking.cn:8543/parking/timeout/manual-check
```

## 📊 监控指标

建议监控以下数据：
- 每次检查的活跃车辆数量
- 即将超时车辆数量
- 已超时车辆数量
- 微信消息发送成功/失败率
- 前端监控运行时长

---

## 🎯 总结

这个集成方案的优势：

1. **前后端分离**: 前端控制定时逻辑，后端专注业务处理
2. **智能调度**: 根据实际车辆数量动态调整检查频率
3. **用户体验**: 前端可以提供丰富的监控状态展示
4. **可控性强**: 用户可以手动启停监控，便于调试
5. **容错性好**: 网络异常、连续失败都有对应处理机制

通过这套方案，您可以实现高效、智能的停车超时监控，既保证了及时提醒，又避免了资源浪费。 