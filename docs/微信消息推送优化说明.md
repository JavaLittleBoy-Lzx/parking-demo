# 微信消息推送优化说明

## 📋 修改概述

根据需求：**后端发送微信的消息若发送成功就不用提醒了，未成功的话需要将原因提醒到小程序告知用户**

已完成对后端所有涉及微信推送的接口进行优化，使微信发送失败时能够将具体原因返回给小程序前端。

---

## 🔧 修改的接口

### 1. **预约接口 - AppointmentController**

#### 1.1 新增预约 (`insertAppointment`)

**文件位置**: `AppointmentController.java`

**修改内容**:
- 修改 `sendAppointmentSuccessNotification()` 方法，改为返回 `Map<String, Object>`
- 在 `insertAppointment()` 方法中捕获微信发送结果
- 如果发送失败，在返回数据中添加以下字段：
  - `wechatNotifyFailed`: `true` 表示微信通知失败
  - `wechatNotifyMessage`: 失败原因的详细信息

**返回数据示例**:
```json
{
  "code": "0",
  "msg": "成功",
  "data": {
    "auditstatus": "已通过",
    "venuestatus": "待入场",
    "appointtype": "邀请",
    "auditusername": "张管家",
    "id": 123,
    "wechatNotifyFailed": true,
    "wechatNotifyMessage": "接收者微信信息不存在，无法发送通知"
  }
}
```

#### 1.2 审核预约 (`auditAppoint`)

**文件位置**: `AppointmentController.java`

**修改内容**:
- 修改 `sendAppointmentAuditResultNotification()` 方法，改为返回 `Map<String, Object>`
- 在 `auditAppoint()` 方法中捕获微信发送结果（审核通过和驳回都处理）
- 如果发送失败，在返回数据中添加 `wechatNotifyFailed` 和 `wechatNotifyMessage` 字段

**返回数据示例**:
```json
{
  "code": "0",
  "msg": "成功",
  "data": {
    "wechatNotifyFailed": true,
    "wechatNotifyMessage": "访客姓名为空，无法发送通知"
  }
}
```

---

### 2. **违规记录接口 - ViolationsController**

#### 2.1 创建违规记录 (`createViolation`)

**文件位置**: `ViolationsController.java`

**修改内容**:
- 修改 `sendViolationNotification()` 方法，改为返回 `Map<String, Object>`
- 修改方法返回类型从 `Result<Boolean>` 改为 `Result<Map<String, Object>>`
- 在 `createViolation()` 方法中捕获微信发送结果
- 如果发送失败，在返回数据中添加：
  - `violationCreated`: `true` 表示违规记录创建成功
  - `wechatNotifyFailed`: `true` 表示微信通知失败
  - `wechatNotifyMessage`: 失败原因

**返回数据示例**:
```json
{
  "code": "0",
  "msg": "成功",
  "data": {
    "violationCreated": true,
    "wechatNotifyFailed": true,
    "wechatNotifyMessage": "部分微信通知发送失败（成功2个，失败1个）"
  }
}
```

---

## 📊 微信通知失败的常见原因

修改后，系统会返回以下几类失败原因：

### 预约相关通知
1. **"访客手机号为空，无法发送微信通知"** - 管家代人预约时访客手机号未填写
2. **"接收者微信信息不存在，无法发送通知"** - 接收者的openid为空或无效
3. **"车牌号为空，无法发送通知"** - 预约记录车牌号缺失
4. **"访客姓名为空，无法发送通知"** - 访客姓名未填写，无法查询openid
5. **"未找到访客对应的微信openid"** - 通过访客姓名未能查询到微信信息
6. **"微信通知发送失败：[具体错误]"** - 微信API返回的具体错误信息
7. **"微信通知发送异常：[异常信息]"** - 系统异常导致的错误

### 违规记录通知
1. **"车牌号为空，无法发送通知"** - 违规记录车牌号缺失
2. **"无预约记录，无法发送通知"** - 违规记录没有关联预约ID
3. **"未找到预约记录，无法发送通知"** - 预约记录已被删除或不存在
4. **"未找到可通知的用户"** - 预约记录中所有用户的openid都为空
5. **"所有微信通知发送失败（共X个）"** - 需要通知多个用户但全部失败
6. **"部分微信通知发送失败（成功X个，失败Y个）"** - 部分通知发送成功，部分失败
7. **"微信通知发送异常：[异常信息]"** - 系统异常

---

## 🔄 不受影响的通知场景

以下场景的微信推送**保持原有逻辑不变**（发送失败只记录日志，不返回给前端）：

### 1. 车辆进出场通知
**文件**: `VehicleReservationController.java`
- 预进场通知 (`reportPreCarIn`)
- 离场通知 (`reportCarOut`)

**原因**: 这些是后台自动触发的通知，不是用户主动操作的结果，失败时只需要记录日志供排查。

### 2. 超时提醒通知
**文件**: `ParkingTimeoutMonitoringTask.java`
- 即将超时提醒
- 滞留通知

**原因**: 这是定时任务自动执行的通知，不涉及用户交互，失败时只需要记录日志。

### 3. 预约待审核通知（发送给管家）
**文件**: `AppointmentController.java` 中的 `sendBookingPendingNotification()`

**原因**: 这是后台自动发送给管家的通知，不影响访客的操作结果。

---

## 🎯 前端处理建议

前端需要在以下接口的响应中检查微信通知失败的情况：

### 1. 新增预约接口 
```javascript
// POST /parking/appointment/insertAppointment
const response = await request.post('/parking/appointment/insertAppointment', data);
if (response.data.wechatNotifyFailed) {
  // 显示警告提示
  uni.showToast({
    title: `预约成功，但${response.data.wechatNotifyMessage}`,
    icon: 'none',
    duration: 3000
  });
} else {
  // 正常成功提示
  uni.showToast({
    title: '预约成功',
    icon: 'success'
  });
}
```

### 2. 审核预约接口
```javascript
// POST /parking/appointment/auditAppoint
const response = await request.post('/parking/appointment/auditAppoint', data);
if (response.data.wechatNotifyFailed) {
  uni.showToast({
    title: `审核已完成，但${response.data.wechatNotifyMessage}`,
    icon: 'none',
    duration: 3000
  });
}
```

### 3. 创建违规记录接口
```javascript
// POST /parking/violations
const response = await request.post('/parking/violations', data);
if (response.data.wechatNotifyFailed) {
  uni.showToast({
    title: `违规记录已创建，但${response.data.wechatNotifyMessage}`,
    icon: 'none',
    duration: 3000
  });
}
```

---

## ✅ 修改效果

### 修改前
- 微信发送失败时，只在后端日志中记录
- 用户无法知道通知是否发送成功
- 可能导致用户误以为对方已收到通知

### 修改后
- ✅ 微信发送成功：前端正常显示成功提示
- ⚠️ 微信发送失败：前端显示警告提示，告知用户具体原因
- 📝 操作成功但通知失败：业务操作仍然成功，只是额外提醒用户通知失败
- 🔍 详细的失败原因：帮助用户理解问题（如：手机号未填写、微信未绑定等）

---

## 🧪 测试建议

### 测试场景

1. **正常流程测试**
   - 预约成功 + 微信通知成功
   - 审核通过 + 微信通知成功
   - 创建违规 + 微信通知成功

2. **异常情况测试**
   - 管家代人预约，但访客手机号为空
   - 访客扫码预约，但管家openid为空
   - 审核预约，但访客姓名为空
   - 创建违规，但无关联预约记录
   - 创建违规，预约记录中所有openid都为空

3. **微信接口异常测试**
   - 微信模板消息接口返回错误
   - 网络超时

### 验证点

- ✅ 业务操作成功（预约创建、审核完成、违规记录创建）
- ✅ 前端能正确接收到 `wechatNotifyFailed` 标识
- ✅ 前端能正确显示 `wechatNotifyMessage` 中的失败原因
- ✅ 后端日志正确记录了微信发送的成功/失败情况

---

## 📝 日志记录

所有微信通知的发送情况都会在后端日志中详细记录：

```
✅ [预约成功通知发送成功] 车牌: 京A12345, 类型: 邀请, 接收者openid: oXXXX
⚠️ [预约创建成功但微信通知失败] 预约ID=123, 原因: 接收者微信信息不存在，无法发送通知
⚠️ [审核通过成功但微信通知失败] 预约ID=456, 车牌=京B67890, 原因: 访客姓名为空，无法发送通知
⚠️ [违规记录创建成功但微信通知失败] plateNumber=京C11111, 原因: 部分微信通知发送失败（成功2个，失败1个）
```

---

## 🔒 注意事项

1. **向后兼容**: 现有的微信通知功能完全保持不变，只是增加了返回失败信息的能力
2. **不影响业务**: 微信通知失败不会导致业务操作失败（预约、审核、违规记录等仍会正常保存）
3. **前端可选处理**: 如果前端不处理 `wechatNotifyFailed` 字段，系统仍能正常工作
4. **日志完整性**: 所有微信通知的发送情况都会记录在后端日志中，便于排查问题

---

## 📅 修改日期

2024年12月9日

## 👤 修改人

Cascade AI Assistant
