# 数据库最小化修改说明

## 概述

基于原有的 `project_lzx.sql` 文件进行最小化修改，只添加违规管理必需的功能，保持原有表结构和数据完全不变。

## 修改原则

1. **保留原有所有表和数据** - 不删除、不修改原有表结构
2. **最小化添加** - 只添加必要的字段和表
3. **向后兼容** - 原有功能完全不受影响
4. **利用现有数据** - 充分利用原有的车主、预约、停车位等信息

## 具体修改内容

### 1. 修改现有表

#### ownerinfo 表
- **添加字段**: `credit_score INT DEFAULT 100 COMMENT '信用分'`
- **说明**: 在原有车主信息表基础上添加信用分字段
- **初始值**: 为现有车主设置不同的初始信用分

### 2. 新增表

#### violations 表（违规记录表）
```sql
- id: 主键ID
- plate_number: 车牌号
- owner_id: 车主ID（关联ownerinfo.id）
- violation_type: 违规类型
- location: 违规位置
- description: 违规描述
- appointment_time/enter_time/leave_time: 时间信息
- status: 处理状态 (pending/processing/completed/cancelled)
- severity: 严重程度 (mild/moderate/severe)
- photos: 现场照片 (JSON格式)
- voice_memo: 语音备注
- remark: 处理备注
```

#### violation_types 表（违规类型配置表）
```sql
- id: 主键ID
- name: 违规类型名称
- value: 违规类型值
- icon: 图标（emoji）
- category: 分类 (common/others)
- usage_count: 使用次数
- is_active: 是否启用
- sort_order: 排序
```

### 3. 新增视图

#### high_risk_vehicles（高风险车辆统计）
- 基于 ownerinfo 和 violations 表
- 统计违规次数较多的车辆
- 包含车主信息、违规统计等

#### violation_statistics（违规统计汇总）
- 按违规类型统计
- 包含总数、月度数量、待处理数量等

### 4. 新增存储过程和触发器

#### UpdateOwnerCreditScore 存储过程
- 根据违规严重程度自动扣除信用分
- 确保信用分不低于0

#### tr_violations_after_insert 触发器
- 违规记录插入时自动调用信用分更新

## 数据设计特点

### 1. 利用现有数据结构
- **车牌信息**: 使用 `ownerinfo.plates` 字段（支持多车牌，逗号分隔）
- **车主信息**: 直接使用 `ownerinfo` 表的现有字段
- **预约信息**: 利用现有 `appointment` 表
- **停车位信息**: 利用现有 `parking` 表

### 2. 新能源车判断
- **前端处理**: 通过车牌号长度判断（8位为新能源车）
- **无需额外字段**: 不在数据库中存储车辆类型信息

### 3. 信用分系统
- **默认100分**: 新车主默认信用分100分
- **自动扣分**: 违规时根据严重程度自动扣分
  - 轻微违规: 扣2分
  - 中等违规: 扣5分  
  - 严重违规: 扣10分

## 初始化数据

### 违规类型（13种）
**常见违规:**
- 超时停车 🚗
- 未按位停车 🅿️
- 占用他人车位 🚫
- 遮挡车牌 🚫

**其他违规:**
- 未经授权停车 🔒
- 堵塞通道 🚧
- 占用残疾人车位 ♿
- 逆向停车 🔄
- 跨线停车 📏
- 占用消防通道 🚒
- 占用充电桩车位 🔌
- 车辆损坏 🔧
- 其他 ➕

### 测试违规记录（9条）
- 基于现有车主数据创建
- 包含不同状态和严重程度
- 涵盖各种违规类型

## 使用方法

### 1. 执行修改脚本
```bash
# 在原有数据库基础上执行
mysql -u root -p project_lzx < project_lzx_minimal_modified.sql
```

### 2. 验证修改
- 检查 ownerinfo 表是否添加了 credit_score 字段
- 确认新增的 violations 和 violation_types 表
- 验证视图和存储过程是否创建成功

### 3. 功能测试
- 原有预约管理功能正常
- 原有车主管理功能正常
- 新增违规记录功能可用
- 信用分自动更新功能正常

## 优势

1. **最小侵入**: 只添加必要的字段和表
2. **完全兼容**: 原有功能100%保持不变
3. **数据复用**: 充分利用现有数据结构
4. **易于维护**: 修改内容少，风险低
5. **功能完整**: 满足违规管理的所有需求

## 数据关系

```
ownerinfo (原有表 + credit_score字段)
    ↓ (id)
violations (新增表)
    ↓ (violation_type)
violation_types (新增表)

appointment (原有表，保持不变)
parking (原有表，保持不变)
user (原有表，保持不变)
```

## 注意事项

1. **备份数据**: 修改前请备份原有数据库
2. **字符集**: 新增表使用 utf8mb4 支持 emoji
3. **外键约束**: violations 表关联 ownerinfo 表
4. **触发器**: 违规记录会自动影响信用分
5. **多车牌**: ownerinfo.plates 字段支持多个车牌号（逗号分隔）

## 扩展性

- 可以继续添加其他违规相关功能
- 支持自定义违规类型
- 可以扩展信用分计算规则
- 支持更复杂的统计分析功能
