# 微信小程序码后端部署指南

## 🎯 部署目标

完成微信小程序码后端实现，实现扫码直接跳转到小程序功能。

## 📋 实现内容

### ✅ 已完成的代码实现

1. **添加微信小程序依赖**
   - 在 `pom.xml` 中添加了 `weixin-java-miniapp` 依赖

2. **配置文件更新**
   - 在 `application.yml` 中添加了微信小程序配置

3. **微信配置类**
   - 创建了 `WechatMiniAppConfig.java`

4. **小程序码生成服务**
   - 创建了 `WechatMiniProgramService.java`

5. **控制器更新**
   - 更新了 `ButlerController.java`
   - 添加了测试接口和正式接口

6. **数据库层实现**
   - 在 `ButlerService.java` 中添加了 `findByPhoneSuffix` 方法
   - 在 `ButlerServiceImpl.java` 中实现了该方法
   - 在 `ButlerMapper.java` 中添加了接口定义
   - 在 `ButlerMapper.xml` 中添加了 SQL 实现

## 🚀 部署步骤

### 第1步：配置微信小程序信息

1. **登录微信公众平台**
   - 访问：https://mp.weixin.qq.com
   - 使用小程序管理员账号登录

2. **获取AppID和AppSecret**
   ```yaml
   # 在 application.yml 中替换以下配置
   wechat:
     miniapp:
       appid: wx你的真实AppID    # 替换为实际的AppID
       secret: 你的真实AppSecret  # 替换为实际的AppSecret
       token-cache-time: 7000
   ```

3. **配置服务器域名**
   - 在微信开发者后台添加：`https://csharphrb.picp.vip`

### 第2步：构建和部署

1. **编译项目**
   ```bash
   cd parking-demo
   mvn clean install
   ```

2. **启动服务**
   ```bash
   java -jar target/parkingmanage-0.0.1-SNAPSHOT.jar
   ```

3. **验证服务启动**
   ```bash
   curl http://www.xuerparking.cn:8543/parking/butler/getByPhone?phone=测试手机号
   ```

### 第3步：测试API

1. **测试后端状态**
   ```bash
   curl "https://csharphrb.picp.vip/parking/butler/generateMiniProgramCode?phone=13800138000&test=true"
   ```

   **期望返回**：
   ```json
   {
     "code": "0",
     "data": {
       "type": "wechat_mini_program",
       "status": "backend_ready",
       "message": "后端已准备好生成小程序码"
     }
   }
   ```

2. **测试小程序码生成**
   ```bash
   curl "https://csharphrb.picp.vip/parking/butler/generateMiniProgramCode?phone=13800138000&community=测试小区&province=黑龙江省&city=哈尔滨市&district=道里区"
   ```

   **期望返回**（配置完微信信息后）：
   ```json
   {
     "code": "0",
     "data": {
       "type": "wechat_mini_program",
       "officialCode": true,
       "qrCodeImage": "data:image/png;base64,iVBORw0KGgo...",
       "pagePath": "pages/auth/visitor-apply",
       "butlerPhone": "13800138000",
       "butlerName": "管家姓名",
       "fullAddress": "完整地址",
       "timestamp": 1672531200000
     }
   }
   ```

### 第4步：前端测试

1. **打开小程序二维码生成页面**

2. **点击"🔍 检查后端API状态"按钮**
   - 应该显示"后端已准备好生成小程序码"

3. **生成小程序码**
   - 选择地址信息
   - 点击"生成小程序码"
   - 检查返回结果

## 🔧 配置检查清单

### ✅ 必须完成的配置

- [ ] 替换 `application.yml` 中的微信 AppID
- [ ] 替换 `application.yml` 中的微信 AppSecret  
- [ ] 微信开发者后台配置服务器域名
- [ ] 确保数据库中有管家数据
- [ ] 确保服务正常启动

### ✅ 可选的优化配置

- [ ] 配置日志级别
- [ ] 设置access_token缓存时间
- [ ] 配置错误处理策略

## 🔍 故障排除

### Q1: 提示"AppSecret配置错误"
**解决方案**：
- 检查 `application.yml` 中的配置是否正确
- 确认 AppSecret 没有多余空格
- 验证 AppID 和 AppSecret 对应关系

### Q2: 提示"access_token获取失败"
**解决方案**：
- 检查网络连接
- 确认服务器可以访问 `api.weixin.qq.com`
- 检查防火墙设置

### Q3: 前端显示"后端未返回小程序码图片"
**解决方案**：
- 查看后端日志中的错误信息
- 确认微信API调用是否成功
- 检查返回数据格式

### Q4: 数据库相关错误
**解决方案**：
- 确认数据库连接正常
- 检查 butler 表是否存在
- 确认有测试数据

## 📱 API接口说明

### 1. 测试接口
```
GET /parking/butler/generateMiniProgramCode?phone=手机号&test=true
```

### 2. 生成小程序码接口
```
GET /parking/butler/generateMiniProgramCode?phone=手机号&community=小区&province=省份&city=城市&district=区县
```

### 3. 手机号后缀查询接口
```
GET /parking/butler/getByPhoneSuffix?phoneSuffix=手机号后缀
```

## 🎯 成功验证标准

### 后端成功标志：
- ✅ 测试接口返回 "backend_ready"
- ✅ 小程序码生成接口返回Base64图片数据  
- ✅ 日志中显示"小程序码生成成功"

### 前端成功标志：
- ✅ 前端检查显示"后端已实现微信官方API"
- ✅ 生成时显示"微信官方小程序码生成成功"
- ✅ 扫码能直接跳转到小程序

### 完整功能验证：
- ✅ 管家生成小程序码
- ✅ 访客扫码直接打开小程序
- ✅ 自动跳转到访客申请页面  
- ✅ 管家信息和地址自动填入

完成以上步骤后，您的小程序码功能将实现真正的扫码跳转体验！

## 📞 技术支持

如果遇到问题，请：
1. 检查控制台日志
2. 确认微信开发者后台配置
3. 验证网络连接和API调用
4. 保留错误日志用于问题排查 