# 测试访客预约接口使用说明

## 📋 概述

这是一套**测试用接口**，用于模拟外部访客预约系统的数据接口，方便测试访客VIP自动开通功能。

---

## 🗄️ 数据库配置

### 1. 创建测试表

```bash
# 执行SQL文件
mysql -u root -p parking_management < docs/test_visitor_reservation.sql
```

### 2. 验证表创建

```sql
-- 查看表结构
DESC test_visitor_reservation;

-- 查看测试数据
SELECT * FROM test_visitor_reservation;
```

---

## 🔌 接口列表

### 1. 分页查询预约记录 ⭐核心接口

**接口地址**：`GET /parking/nefuData/page`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| startTime | String | 否 | 开始时间 | 2024-01-01 00:00:00 |
| endTime | String | 否 | 结束时间 | 2024-01-01 23:59:59 |
| pageNum | Integer | 否 | 页码（从1开始） | 1 |
| pageSize | Integer | 否 | 每页大小 | 10 |

**请求示例**：

```bash
# 示例1：查询今天的预约（分页）
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?startTime=2024-01-01%2000:00:00&endTime=2024-01-01%2023:59:59&pageNum=1&pageSize=10"

# 示例2：查询所有预约（第1页，每页1000条）
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?pageNum=1&pageSize=1000"

# 示例3：查询指定时间段
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?startTime=2024-01-01%2009:00:00&endTime=2024-01-01%2018:00:00"
```

**响应示例**：

```json
{
  "code": "0",
  "msg": "success",
  "data": {
    "records": [
      {
        "id": 1,
        "reservationId": "R2024010101",
        "visitorName": "张三",
        "visitorPhone": "13800138001",
        "visitorIdCard": "110101199001011234",
        "departmentName": "信息技术部",
        "carNumber": "京A12345",
        "parkName": "东门停车场",
        "startTime": "2024-01-01 09:00:00",
        "endTime": "2024-01-01 18:00:00",
        "vipTypeName": "临时访客",
        "remark1": "来访洽谈业务",
        "remark2": "需要会议室",
        "remark3": "已确认",
        "createTime": "2024-01-01 08:30:00"
      }
    ],
    "total": 100,
    "size": 10,
    "current": 1,
    "pages": 10
  }
}
```

---

### 2. 查询列表（不分页）

**接口地址**：`GET /parking/nefuData/list`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| startTime | String | 否 | 开始时间 |
| endTime | String | 否 | 结束时间 |

**请求示例**：

```bash
curl "http://www.xuerparking.cn:8080/parking/nefuData/list?startTime=2024-01-01%2000:00:00&endTime=2024-01-01%2023:59:59"
```

---

### 3. 添加预约记录

**接口地址**：`POST /parking/nefuData/add`

**请求示例**：

```bash
curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/add" \
  -H "Content-Type: application/json" \
  -d '{
    "reservationId": "R2024010199",
    "visitorName": "测试访客",
    "visitorPhone": "13800138999",
    "departmentName": "测试部门",
    "carNumber": "京Z99999",
    "parkName": "测试停车场",
    "startTime": "2024-01-01 10:00:00",
    "endTime": "2024-01-01 18:00:00",
    "vipTypeName": "临时访客"
  }'
```

---

### 4. 批量生成测试数据

**接口地址**：`POST /parking/nefuData/generateTestData`

**请求参数**：

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| count | Integer | 否 | 生成数量（默认10，最大100） |

**请求示例**：

```bash
# 生成10条测试数据
curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/generateTestData?count=10"

# 生成100条测试数据
curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/generateTestData?count=100"
```

---

### 5. 清空测试数据

**接口地址**：`DELETE /parking/nefuData/clearTestData`

**请求示例**：

```bash
curl -X DELETE "http://www.xuerparking.cn:8080/parking/nefuData/clearTestData"
```

⚠️ **警告**：此操作会删除表中所有数据，请谨慎使用！

---

### 6. 查询统计信息

**接口地址**：`GET /parking/nefuData/statistics`

**请求示例**：

```bash
curl "http://www.xuerparking.cn:8080/parking/nefuData/statistics"
```

**响应示例**：

```json
{
  "code": "0",
  "msg": "success",
  "data": {
    "total": 11,
    "typeStatistics": [
      {"vip_type_name": "临时访客", "count": 9},
      {"vip_type_name": "长期访客", "count": 1},
      {"vip_type_name": "体育馆自助访客", "count": 1}
    ]
  }
}
```

---

## 🧪 测试流程

### 第一步：初始化测试数据

```bash
# 1. 创建数据库表（执行SQL文件）
mysql -u root -p parking_management < docs/test_visitor_reservation.sql

# 2. 验证初始数据
curl "http://www.xuerparking.cn:8080/parking/nefuData/statistics"
```

---

### 第二步：测试分页查询

```bash
# 查询第1页，每页10条
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?pageNum=1&pageSize=10"

# 查询所有数据（每页1000条）
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?pageNum=1&pageSize=1000"
```

---

### 第三步：测试时间范围查询

```bash
# 查询今天的预约
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?startTime=2024-01-01%2000:00:00&endTime=2024-01-01%2023:59:59"

# 查询昨天的预约
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?startTime=2023-12-31%2000:00:00&endTime=2023-12-31%2023:59:59"
```

---

### 第四步：生成更多测试数据

```bash
# 生成50条测试数据
curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/generateTestData?count=50"

# 验证数据量
curl "http://www.xuerparking.cn:8080/parking/nefuData/statistics"
```

---

## 🔗 与自动开通服务集成

### 配置外部接口地址

在 `application.yml` 中配置：

```yaml
visitor:
  api:
    url: http://www.xuerparking.cn:8080  # 指向本地测试接口
    page-size: 1000
```

### 测试自动开通

```bash
# 1. 启动应用

# 2. 观察日志，应该看到：
📤 [外部接口请求] URL: http://www.xuerparking.cn:8080/parking/nefuData/page
📥 [外部接口响应] {"code":"0","data":{"records":[...]}}
📄 [第1页] 获取到 11 条预约记录
🆕 [新增] 预约ID: R2024010101, 访客: 张三, 车牌: 京A12345
...
```

---

## 📊 数据字段说明

| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| reservation_id | VARCHAR(100) | 预约记录ID | R2024010101 |
| visitor_name | VARCHAR(100) | 访客姓名 | 张三 |
| visitor_phone | VARCHAR(50) | 访客手机 | 13800138001 |
| visitor_id_card | VARCHAR(50) | 身份证号 | 110101199001011234 |
| department_name | VARCHAR(200) | 被访部门 | 信息技术部 |
| car_number | VARCHAR(200) | 车牌号 | 京A12345 |
| park_name | VARCHAR(200) | 车场名称 | 东门停车场 |
| start_time | VARCHAR(50) | 开始时间 | 2024-01-01 09:00:00 |
| end_time | VARCHAR(50) | 结束时间 | 2024-01-01 18:00:00 |
| vip_type_name | VARCHAR(100) | 表单名称 | 临时访客 |
| remark1/2/3 | VARCHAR(500) | 备注信息 | - |
| create_time | DATETIME | 创建时间 | 2024-01-01 08:30:00 |

---

## 🎯 常见使用场景

### 场景1：测试增量同步

```bash
# 1. 清空测试数据
curl -X DELETE "http://www.xuerparking.cn:8080/parking/nefuData/clearTestData"

# 2. 生成10条初始数据
curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/generateTestData?count=10"

# 3. 等待2秒，让自动开通服务同步

# 4. 再生成5条新数据
curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/generateTestData?count=5"

# 5. 观察日志，应该只处理新增的5条
```

---

### 场景2：测试时间范围查询

```bash
# 查询最近1小时的预约
curl "http://www.xuerparking.cn:8080/parking/nefuData/page?startTime=2024-01-01%2009:00:00&endTime=2024-01-01%2010:00:00"
```

---

### 场景3：测试大批量数据

```bash
# 生成1000条数据（分10次，每次100条）
for i in {1..10}; do
  curl -X POST "http://www.xuerparking.cn:8080/parking/nefuData/generateTestData?count=100"
  sleep 1
done

# 查询统计
curl "http://www.xuerparking.cn:8080/parking/nefuData/statistics"
```

---

## ⚠️ 注意事项

1. **仅供测试使用**
   - 这是测试接口，不要在生产环境使用
   - 数据表名带有 `test_` 前缀

2. **数据隔离**
   - 测试数据不会影响正式业务数据
   - 可以随时清空重建

3. **性能考虑**
   - 单次生成数据不超过100条
   - 分页查询建议每页不超过1000条

4. **时间格式**
   - 统一使用 `yyyy-MM-dd HH:mm:ss` 格式
   - URL中的空格需要编码为 `%20`

---

## 🔍 故障排查

### 问题1：接口404

**原因**：表未创建或Mapper未加载

**解决**：
```bash
# 1. 确认表已创建
mysql> SHOW TABLES LIKE 'test_visitor_reservation';

# 2. 检查Mapper配置
mybatis-plus:
  mapper-locations: classpath:**/mapper/xml/*.xml

# 3. 重启应用
```

---

### 问题2：查询无数据

**原因**：测试数据未插入

**解决**：
```bash
# 检查数据
mysql> SELECT COUNT(*) FROM test_visitor_reservation;

# 如果为0，重新执行SQL
mysql -u root -p parking_management < docs/test_visitor_reservation.sql
```

---

### 问题3：时间查询不准确

**原因**：时间格式不正确

**解决**：
```bash
# 正确格式（URL编码）
?startTime=2024-01-01%2000:00:00&endTime=2024-01-01%2023:59:59

# 或使用工具（如Postman）自动编码
```

---

## 🎉 总结

这套测试接口提供了：

- ✅ 完整的CRUD功能
- ✅ 分页查询支持
- ✅ 时间范围过滤
- ✅ 批量数据生成
- ✅ 统计分析功能

**可以完美模拟外部接口，方便测试访客VIP自动开通功能！** 🚀

