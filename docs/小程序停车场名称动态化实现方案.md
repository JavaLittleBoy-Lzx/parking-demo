# å°ç¨‹åºåœè½¦åœºåç§°åŠ¨æ€åŒ–å®ç°æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚åˆ†æ

### å½“å‰é—®é¢˜
1. **åœè½¦åœºåç§°å›ºå®š**: é¡µé¢é¡¶éƒ¨æ˜¾ç¤ºçš„åœè½¦åœºåç§°æ˜¯å›ºå®šçš„"æ¬§æ´²æ–°åŸ-åœè½¦åœº"
2. **è®¿é—®åœ°å€å›ºå®š**: ä¸‹æ–¹çš„è®¿é—®åœ°å€é€‰æ‹©å™¨æ˜¾ç¤ºçš„æ˜¯å›ºå®šçš„å°åŒºä¿¡æ¯
3. **ç¼ºä¹åŠ¨æ€æ€§**: æ²¡æœ‰æ ¹æ®å½“å‰ç®¡å®¶çš„å°åŒºä¿¡æ¯åŠ¨æ€è°ƒæ•´

### ç›®æ ‡æ•ˆæœ
1. **åŠ¨æ€åœè½¦åœºåç§°**: æ ¹æ®å½“å‰ç®¡å®¶æ‰€ç®¡ç†çš„å°åŒºåŠ¨æ€æ˜¾ç¤ºåœè½¦åœºåç§°
2. **åŠ¨æ€è®¿é—®åœ°å€**: è®¿é—®åœ°å€é€‰æ‹©å™¨æ ¹æ®ç®¡å®¶çš„å°åŒºåŠ¨æ€åŠ è½½æ¥¼æ ‹ã€å•å…ƒã€æˆ¿é—´ä¿¡æ¯
3. **ç®¡å®¶è§’è‰²é€‚é…**: é’ˆå¯¹ç®¡å®¶è§’è‰²ä¼˜åŒ–åœ°å€é€‰æ‹©å’Œä¸šä¸»ä¿¡æ¯æŸ¥è¯¢

## ğŸ—ï¸ æŠ€æœ¯æ–¹æ¡ˆ

### 1. è·å–ç®¡å®¶å°åŒºä¿¡æ¯çš„ç­–ç•¥

#### æ–¹æ¡ˆA: ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–ï¼ˆæ¨èï¼‰
```javascript
// åœ¨getUserRoleæ–¹æ³•ä¸­æ‰©å±•ç®¡å®¶ä¿¡æ¯è·å–
async getUserRole() {
    try {
        const userInfo = uni.getStorageSync('userInfo');
        
        if (userInfo && userInfo.role) {
            this.currentUserRole = userInfo.role;
            
            // å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ï¼Œè·å–ç®¡å®¶çš„å°åŒºä¿¡æ¯
            if (this.currentUserRole === 'manager') {
                await this.loadManagerCommunityInfo(userInfo);
            }
        }
        
        // å…¶ä»–ç°æœ‰é€»è¾‘...
    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
    }
}
```

#### æ–¹æ¡ˆB: é€šè¿‡APIæŸ¥è¯¢ç®¡å®¶ä¿¡æ¯
```javascript
// æ–°å¢æ–¹æ³•ï¼šæŸ¥è¯¢ç®¡å®¶çš„å°åŒºä¿¡æ¯
async loadManagerCommunityInfo(userInfo) {
    try {
        // å¦‚æœç”¨æˆ·ä¿¡æ¯ä¸­å·²æœ‰å°åŒºä¿¡æ¯ï¼Œç›´æ¥ä½¿ç”¨
        if (userInfo.userInfo && userInfo.userInfo.community) {
            const managerCommunity = {
                name: userInfo.userInfo.community,
                province: userInfo.userInfo.province || 'é»‘é¾™æ±Ÿçœ',
                city: userInfo.userInfo.city || 'å“ˆå°”æ»¨å¸‚',
                district: userInfo.userInfo.district || 'é¦™åŠåŒº'
            };
            
            this.setManagerCommunityInfo(managerCommunity);
            return;
        }
        
        // å¦‚æœæ²¡æœ‰å°åŒºä¿¡æ¯ï¼Œé€šè¿‡APIæŸ¥è¯¢
        const phone = userInfo.phone || userInfo.userInfo?.phone;
        if (phone) {
            const response = await this.queryManagerCommunityByPhone(phone);
            if (response && response.data) {
                this.setManagerCommunityInfo(response.data);
            }
        }
        
    } catch (error) {
        console.error('åŠ è½½ç®¡å®¶å°åŒºä¿¡æ¯å¤±è´¥:', error);
        // ä½¿ç”¨é»˜è®¤å°åŒºä¿¡æ¯
        this.useDefaultCommunityInfo();
    }
}
```

### 2. åŠ¨æ€æ›´æ–°åœè½¦åœºä¿¡æ¯

#### ä¿®æ”¹updateParkingLotInfoæ–¹æ³•
```javascript
async updateParkingLotInfo(userInfo) {
    try {
        let addressInfo;
        
        // å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ï¼Œä¼˜å…ˆä½¿ç”¨ç®¡å®¶çš„å°åŒºä¿¡æ¯
        if (this.currentUserRole === 'manager' && this.managerCommunityInfo) {
            addressInfo = {
                province: this.managerCommunityInfo.province,
                city: this.managerCommunityInfo.city,
                district: this.managerCommunityInfo.district,
                community: this.managerCommunityInfo.name
            };
            console.log('ğŸ‘¨â€ğŸ’¼ [ç®¡å®¶è§’è‰²] ä½¿ç”¨ç®¡å®¶å°åŒºä¿¡æ¯:', addressInfo);
        } else {
            // å…¶ä»–è§’è‰²ä½¿ç”¨åŸæœ‰é€»è¾‘
            addressInfo = await this.getAddressInfo(userInfo);
        }
        
        // æ„å»ºåœè½¦åœºå…¨å
        const fullName = `${addressInfo.community}-åœè½¦åœº`;
        const fullAddress = `${addressInfo.province}${addressInfo.city}${addressInfo.district}${addressInfo.community}`;
        
        // æ›´æ–°åœè½¦åœºä¿¡æ¯
        this.parkingLotInfo = {
            fullName: fullName,
            fullAddress: fullAddress,
            buildingInfo: this.parkingLotInfo.buildingInfo || ''
        };
        
        // æ›´æ–°é¡µé¢æ ‡é¢˜
        uni.setNavigationBarTitle({
            title: fullName
        });
        
        console.log('âœ… åœè½¦åœºä¿¡æ¯å·²æ›´æ–°:', this.parkingLotInfo);
        
    } catch (error) {
        console.error('âŒ æ›´æ–°åœè½¦åœºä¿¡æ¯å¤±è´¥:', error);
    }
}
```

### 3. åŠ¨æ€åŠ è½½åœ°å€æ•°æ®

#### ä¿®æ”¹loadAddressDataæ–¹æ³•
```javascript
async loadAddressData() {
    try {
        console.log('ğŸš€ å¼€å§‹åŠ è½½å››çº§åœ°å€æ•°æ®');
        
        let communityName;
        
        // å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ï¼Œä½¿ç”¨ç®¡å®¶çš„å°åŒºä¿¡æ¯
        if (this.currentUserRole === 'manager' && this.managerCommunityInfo) {
            communityName = this.managerCommunityInfo.name;
            console.log('ğŸ‘¨â€ğŸ’¼ [ç®¡å®¶è§’è‰²] ä½¿ç”¨ç®¡å®¶å°åŒºåç§°:', communityName);
        } else {
            // å…¶ä»–è§’è‰²ä½¿ç”¨åŸæœ‰é€»è¾‘
            const parkInfo = uni.getStorageSync('parkInfo');
            communityName = parkInfo?.name || this.currentCommunityName || 'å››å­£ä¸Šä¸œ';
        }
        
        // URLç¼–ç å¤„ç†
        if (communityName && typeof communityName === 'string' && communityName.includes('%')) {
            try {
                communityName = decodeURIComponent(communityName);
            } catch (e) {
                console.error('è§£ç å°åŒºåç§°å¤±è´¥:', e);
            }
        }
        
        console.log('ğŸ“ æœ€ç»ˆä½¿ç”¨çš„å°åŒºåç§°:', communityName);
        
        // æ˜¾ç¤ºåŠ è½½æç¤º
        uni.showLoading({
            title: 'åŠ è½½åœ°å€æ•°æ®...',
            mask: true
        });
        
        // è°ƒç”¨APIåŠ è½½åœ°å€æ•°æ®
        const response = await uni.request({
            url: `https://csharphrb.picp.vip/parking/community/getAllCommunity?community=${encodeURIComponent(communityName)}`,
            method: 'GET',
            header: {
                'content-type': 'application/json'
            },
            timeout: 10000
        });
        
        // å¤„ç†å“åº”æ•°æ®çš„é€»è¾‘ä¿æŒä¸å˜...
        
    } catch (error) {
        console.error('âŒ åŠ è½½åœ°å€æ•°æ®å¤±è´¥:', error);
        // é”™è¯¯å¤„ç†é€»è¾‘...
    } finally {
        uni.hideLoading();
    }
}
```

## ğŸ”§ å…·ä½“å®ç°æ­¥éª¤

### æ­¥éª¤1: åœ¨dataä¸­æ·»åŠ ç®¡å®¶å°åŒºä¿¡æ¯
```javascript
data() {
    return {
        // ç°æœ‰æ•°æ®...
        
        // æ–°å¢ï¼šç®¡å®¶å°åŒºä¿¡æ¯
        managerCommunityInfo: null, // ç®¡å®¶çš„å°åŒºä¿¡æ¯
        isManagerCommunityLoaded: false, // æ˜¯å¦å·²åŠ è½½ç®¡å®¶å°åŒºä¿¡æ¯
    }
}
```

### æ­¥éª¤2: æ–°å¢ç®¡å®¶å°åŒºä¿¡æ¯ç›¸å…³æ–¹æ³•
```javascript
methods: {
    // ç°æœ‰æ–¹æ³•...
    
    // æ–°å¢ï¼šè®¾ç½®ç®¡å®¶å°åŒºä¿¡æ¯
    setManagerCommunityInfo(communityInfo) {
        this.managerCommunityInfo = communityInfo;
        this.isManagerCommunityLoaded = true;
        
        // æ›´æ–°å½“å‰å°åŒºåç§°
        this.currentCommunityName = communityInfo.name;
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        const parkInfo = {
            name: communityInfo.name,
            fullName: `${communityInfo.name}-åœè½¦åœº`,
            province: communityInfo.province,
            city: communityInfo.city,
            district: communityInfo.district
        };
        uni.setStorageSync('parkInfo', parkInfo);
        
        console.log('âœ… ç®¡å®¶å°åŒºä¿¡æ¯å·²è®¾ç½®:', this.managerCommunityInfo);
    },
    
    // æ–°å¢ï¼šé€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯
    async queryManagerCommunityByPhone(phone) {
        try {
            // è¿™é‡Œéœ€è¦è°ƒç”¨åç«¯APIæŸ¥è¯¢ç®¡å®¶ä¿¡æ¯
            // å‡è®¾APIæ¥å£ä¸º /parking/butler/getCommunityByPhone
            const response = await uni.request({
                url: `https://csharphrb.picp.vip/parking/butler/getCommunityByPhone?phone=${phone}`,
                method: 'GET',
                header: {
                    'content-type': 'application/json'
                },
                timeout: 10000
            });
            
            if (response.statusCode === 200 && response.data.code === '0') {
                return response.data;
            } else {
                throw new Error('æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯å¤±è´¥');
            }
            
        } catch (error) {
            console.error('æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯å¤±è´¥:', error);
            return null;
        }
    },
    
    // æ–°å¢ï¼šä½¿ç”¨é»˜è®¤å°åŒºä¿¡æ¯
    useDefaultCommunityInfo() {
        const defaultCommunity = {
            name: 'å››å­£ä¸Šä¸œ',
            province: 'é»‘é¾™æ±Ÿçœ',
            city: 'å“ˆå°”æ»¨å¸‚',
            district: 'é¦™åŠåŒº'
        };
        this.setManagerCommunityInfo(defaultCommunity);
    }
}
```

### æ­¥éª¤3: ä¿®æ”¹é¡µé¢åŠ è½½é€»è¾‘
```javascript
async onLoad(options) {
    try {
        console.log('ğŸ” onLoadå¼€å§‹æ‰§è¡Œï¼Œæ¥æ”¶åˆ°å‚æ•°:', options);
        
        // è·å–ç”¨æˆ·è§’è‰²ï¼ˆè¿™é‡Œä¼šå¤„ç†ç®¡å®¶å°åŒºä¿¡æ¯ï¼‰
        await this.getUserRole();
        
        // å¤„ç†æ‰«ç ä¼ å…¥çš„åœ°å€å‚æ•°
        if (options) {
            // ç°æœ‰é€»è¾‘...
        }
        
        // åˆå§‹åŒ–åœ°å€æ•°æ® - ç¡®ä¿åœ¨ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½åæ‰§è¡Œ
        if (this.currentUserRole === 'manager') {
            // ç­‰å¾…ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½å®Œæˆ
            await this.waitForManagerCommunityInfo();
        }
        
        await this.loadCurrentCommunityInfo();
        
        // å…¶ä»–ç°æœ‰é€»è¾‘...
        
    } catch (error) {
        console.error('onLoadé”™è¯¯:', error);
    }
},

// æ–°å¢ï¼šç­‰å¾…ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½å®Œæˆ
async waitForManagerCommunityInfo() {
    let attempts = 0;
    const maxAttempts = 10;
    
    while (!this.isManagerCommunityLoaded && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }
    
    if (!this.isManagerCommunityLoaded) {
        console.warn('âš ï¸ ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯');
        this.useDefaultCommunityInfo();
    }
}
```

## ğŸ¯ åç«¯APIæ”¯æŒ

### éœ€è¦æ–°å¢çš„APIæ¥å£

#### 1. æ ¹æ®ç®¡å®¶æ‰‹æœºå·æŸ¥è¯¢å°åŒºä¿¡æ¯
```java
@RestController
@RequestMapping("/parking/butler")
public class ButlerController {
    
    @GetMapping("/getCommunityByPhone")
    public ResponseEntity<Result> getCommunityByPhone(@RequestParam String phone) {
        try {
            // æ ¹æ®æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶ä¿¡æ¯
            Butler butler = butlerService.getByPhone(phone);
            
            if (butler != null) {
                Map<String, Object> communityInfo = new HashMap<>();
                communityInfo.put("name", butler.getCommunity());
                communityInfo.put("province", butler.getProvince());
                communityInfo.put("city", butler.getCity());
                communityInfo.put("district", butler.getDistrict());
                
                Result result = new Result();
                result.setCode("0");
                result.setData(communityInfo);
                result.setMsg("æŸ¥è¯¢æˆåŠŸ");
                
                return ResponseEntity.ok(result);
            } else {
                Result result = new Result();
                result.setCode("1");
                result.setMsg("æœªæ‰¾åˆ°ç®¡å®¶ä¿¡æ¯");
                return ResponseEntity.ok(result);
            }
            
        } catch (Exception e) {
            Result result = new Result();
            result.setCode("1");
            result.setMsg("æŸ¥è¯¢å¤±è´¥: " + e.getMessage());
            return ResponseEntity.ok(result);
        }
    }
}
```

#### 2. ç¡®ä¿Butlerå®ä½“ç±»åŒ…å«å°åŒºä¿¡æ¯å­—æ®µ
```java
@Data
@TableName("butler")
public class Butler {
    @TableId(value = "id", type = IdType.AUTO)
    private Integer id;
    
    private String name;
    private String phone;
    private String openid;
    
    // æ–°å¢å°åŒºç›¸å…³å­—æ®µ
    private String community;   // å°åŒºåç§°
    private String province;    // çœä»½
    private String city;        // åŸå¸‚
    private String district;    // åŒºåŸŸ
    
    // å…¶ä»–ç°æœ‰å­—æ®µ...
}
```

## ğŸ“± å‰ç«¯UIä¼˜åŒ–

### 1. æ·»åŠ ç®¡å®¶å°åŒºä¿¡æ¯æ˜¾ç¤º
```vue
<template>
    <!-- åœ¨åœè½¦åœºåç§°ä¸‹æ–¹æ·»åŠ ç®¡å®¶å°åŒºæç¤º -->
    <view class="name">
        <text class="name-css">{{ parkingLotInfo.fullName }}</text>
        
        <!-- ç®¡å®¶è§’è‰²æ˜¾ç¤ºå½“å‰ç®¡ç†çš„å°åŒº -->
        <view v-if="currentUserRole === 'manager' && managerCommunityInfo" class="manager-community-info">
            <text class="manager-label">å½“å‰ç®¡ç†å°åŒºï¼š</text>
            <text class="community-name">{{ managerCommunityInfo.name }}</text>
        </view>
    </view>
</template>

<style>
.manager-community-info {
    margin-top: 10rpx;
    display: flex;
    align-items: center;
    justify-content: center;
}

.manager-label {
    font-size: 24rpx;
    color: #666;
    margin-right: 8rpx;
}

.community-name {
    font-size: 26rpx;
    color: #025def;
    font-weight: 500;
}
</style>
```

### 2. ä¼˜åŒ–åœ°å€é€‰æ‹©å™¨æç¤º
```vue
<!-- åœ¨åœ°å€é€‰æ‹©å™¨ä¸­æ·»åŠ ç®¡å®¶ä¸“ç”¨æç¤º -->
<u-form-item leftIcon="home" labelPosition="left" :leftIconStyle="{ 'color': '#025def' }" 
    labelWidth="90" borderBottom="false" label="è®¿é—®åœ°å€">
    
    <!-- ç®¡å®¶è§’è‰²ä¸“ç”¨æç¤º -->
    <view v-if="currentUserRole === 'manager'" class="manager-address-tip">
        <text class="tip-text">è¯·é€‰æ‹©è¦ä»£ä¸ºé¢„çº¦çš„ä¸šä¸»åœ°å€</text>
    </view>
    
    <!-- ç°æœ‰åœ°å€é€‰æ‹©å™¨å†…å®¹... -->
</u-form-item>
```

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### 1. åŠŸèƒ½æµ‹è¯•
- [ ] ç®¡å®¶ç™»å½•ååœè½¦åœºåç§°æ­£ç¡®æ˜¾ç¤º
- [ ] åœ°å€é€‰æ‹©å™¨åŠ è½½ç®¡å®¶å°åŒºçš„æ¥¼æ ‹ä¿¡æ¯
- [ ] é€‰æ‹©åœ°å€åæ­£ç¡®æŸ¥è¯¢ä¸šä¸»ä¿¡æ¯
- [ ] éç®¡å®¶è§’è‰²ä¸å—å½±å“

### 2. å¼‚å¸¸æµ‹è¯•
- [ ] ç®¡å®¶å°åŒºä¿¡æ¯æŸ¥è¯¢å¤±è´¥æ—¶çš„é™çº§å¤„ç†
- [ ] ç½‘ç»œå¼‚å¸¸æ—¶çš„é”™è¯¯æç¤º
- [ ] æ•°æ®æ ¼å¼å¼‚å¸¸çš„å¤„ç†

### 3. æ€§èƒ½æµ‹è¯•
- [ ] é¡µé¢åŠ è½½é€Ÿåº¦
- [ ] APIå“åº”æ—¶é—´
- [ ] å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ“‹ å®æ–½æ¸…å•

### å‰ç«¯ä¿®æ”¹
- [ ] ä¿®æ”¹getUserRoleæ–¹æ³•ï¼Œæ·»åŠ ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½
- [ ] æ–°å¢ç®¡å®¶å°åŒºä¿¡æ¯ç›¸å…³æ–¹æ³•
- [ ] ä¿®æ”¹updateParkingLotInfoæ–¹æ³•
- [ ] ä¿®æ”¹loadAddressDataæ–¹æ³•
- [ ] ä¼˜åŒ–UIæ˜¾ç¤º

### åç«¯ä¿®æ”¹
- [ ] æ–°å¢Butlerå°åŒºä¿¡æ¯æŸ¥è¯¢API
- [ ] ç¡®ä¿Butlerå®ä½“ç±»åŒ…å«å°åŒºå­—æ®µ
- [ ] æµ‹è¯•APIæ¥å£

### æµ‹è¯•éªŒè¯
- [ ] åŠŸèƒ½æµ‹è¯•
- [ ] å¼‚å¸¸æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. ç®¡å®¶ç”¨æˆ·ä¿¡æ¯ä¸­æ˜¯å¦åŒ…å«å°åŒºä¿¡æ¯
2. APIæ¥å£æ˜¯å¦æ­£å¸¸å“åº”
3. å‰ç«¯æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
4. æ•°æ®åº“ä¸­Butlerè¡¨çš„å­—æ®µç»“æ„

## ğŸ”§ å…·ä½“ä»£ç ä¿®æ”¹ç¤ºä¾‹

### 1. ä¿®æ”¹form.vueçš„dataéƒ¨åˆ†
åœ¨ç°æœ‰çš„data()æ–¹æ³•ä¸­æ·»åŠ ç®¡å®¶å°åŒºä¿¡æ¯ï¼š

```javascript
data() {
    return {
        // ç°æœ‰æ•°æ®ä¿æŒä¸å˜...
        currentUserRole: 'owner',

        // æ–°å¢ï¼šç®¡å®¶å°åŒºä¿¡æ¯ç›¸å…³
        managerCommunityInfo: null, // ç®¡å®¶çš„å°åŒºä¿¡æ¯
        isManagerCommunityLoaded: false, // æ˜¯å¦å·²åŠ è½½ç®¡å®¶å°åŒºä¿¡æ¯
        managerLoadingTimeout: null, // åŠ è½½è¶…æ—¶å®šæ—¶å™¨

        // ç°æœ‰çš„å…¶ä»–æ•°æ®...
        parkingLotInfo: {
            fullName: '',
            fullAddress: '',
            buildingInfo: ''
        },
    }
}
```

### 2. ä¿®æ”¹getUserRoleæ–¹æ³•
åœ¨ç°æœ‰çš„getUserRoleæ–¹æ³•ä¸­æ·»åŠ ç®¡å®¶å°åŒºä¿¡æ¯å¤„ç†ï¼š

```javascript
// åœ¨form.vueçš„methodsä¸­ä¿®æ”¹ç°æœ‰çš„getUserRoleæ–¹æ³•
async getUserRole() {
    try {
        const userInfo = uni.getStorageSync('userInfo');

        // è·å–è§’è‰²
        if (userInfo && userInfo.role) {
            this.currentUserRole = userInfo.role;
            console.log('ğŸ‘¤ å½“å‰ç”¨æˆ·è§’è‰²:', this.currentUserRole);

            // ğŸ†• å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ï¼ŒåŠ è½½ç®¡å®¶çš„å°åŒºä¿¡æ¯
            if (this.currentUserRole === 'manager') {
                console.log('ğŸ‘¨â€ğŸ’¼ æ£€æµ‹åˆ°ç®¡å®¶è§’è‰²ï¼Œå¼€å§‹åŠ è½½å°åŒºä¿¡æ¯');
                await this.loadManagerCommunityInfo(userInfo);
            }
        } else {
            this.currentUserRole = 'owner';
        }

        // è·å–ç”µè¯å·ç çš„ç°æœ‰é€»è¾‘ä¿æŒä¸å˜...
        let phone = '';
        if (userInfo && userInfo.phone) {
            phone = userInfo.phone;
        } else if (userInfo && userInfo.userInfo && userInfo.userInfo.phone) {
            phone = userInfo.userInfo.phone;
        }

        // ç®¡å®¶è§’è‰²ï¼šè”ç³»ç”µè¯åˆå§‹ä¸ºç©ºï¼Œé€‰æ‹©ä¸šä¸»åè‡ªåŠ¨å¡«å……ä¸šä¸»ç”µè¯
        // å…¶ä»–è§’è‰²ï¼šè‡ªåŠ¨å¡«å……å½“å‰ç”¨æˆ·ç”µè¯
        if (this.currentUserRole === 'manager') {
            this.model1.code = ''; // ç®¡å®¶è§’è‰²åˆå§‹ä¸ºç©º
            console.log('ğŸ‘¨â€ğŸ’¼ [ç®¡å®¶è§’è‰²] è”ç³»ç”µè¯åˆå§‹åŒ–ä¸ºç©ºï¼Œç­‰å¾…é€‰æ‹©ä¸šä¸»åå¡«å……');
        } else if (phone) {
            this.model1.code = phone; // å…¶ä»–è§’è‰²è‡ªåŠ¨å¡«å……
            console.log('ğŸ‘¤ [å…¶ä»–è§’è‰²] è”ç³»ç”µè¯è‡ªåŠ¨å¡«å……:', phone);
        }

        // ç°æœ‰çš„å…¶ä»–é€»è¾‘ä¿æŒä¸å˜...
        this.checkButlerInfo(userInfo);
        this.updateReasonOptions();
        await this.updateParkingLotInfo(userInfo);

        if (this.currentUserRole === 'owner') {
            this.loadMonthlyTicketInfo();
        }

    } catch (error) {
        console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', error);
        this.currentUserRole = 'owner';
    }
}
```

### 3. æ–°å¢ç®¡å®¶å°åŒºä¿¡æ¯å¤„ç†æ–¹æ³•
åœ¨form.vueçš„methodsä¸­æ·»åŠ ä»¥ä¸‹æ–°æ–¹æ³•ï¼š

```javascript
// ğŸ†• åŠ è½½ç®¡å®¶å°åŒºä¿¡æ¯
async loadManagerCommunityInfo(userInfo) {
    try {
        console.log('ğŸ  å¼€å§‹åŠ è½½ç®¡å®¶å°åŒºä¿¡æ¯:', userInfo);

        // æ–¹æ¡ˆ1: ä»ç”¨æˆ·ä¿¡æ¯ä¸­ç›´æ¥è·å–å°åŒºä¿¡æ¯
        if (userInfo.userInfo && userInfo.userInfo.community) {
            const managerCommunity = {
                name: userInfo.userInfo.community,
                province: userInfo.userInfo.province || 'é»‘é¾™æ±Ÿçœ',
                city: userInfo.userInfo.city || 'å“ˆå°”æ»¨å¸‚',
                district: userInfo.userInfo.district || 'é¦™åŠåŒº'
            };

            this.setManagerCommunityInfo(managerCommunity);
            console.log('âœ… ä»ç”¨æˆ·ä¿¡æ¯ä¸­è·å–åˆ°ç®¡å®¶å°åŒºä¿¡æ¯');
            return;
        }

        // æ–¹æ¡ˆ2: é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯
        const phone = userInfo.phone || userInfo.userInfo?.phone;
        if (phone) {
            console.log('ğŸ“ é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯:', phone);
            const response = await this.queryManagerCommunityByPhone(phone);

            if (response && response.data) {
                this.setManagerCommunityInfo(response.data);
                console.log('âœ… é€šè¿‡APIæŸ¥è¯¢åˆ°ç®¡å®¶å°åŒºä¿¡æ¯');
                return;
            }
        }

        // æ–¹æ¡ˆ3: ä½¿ç”¨é»˜è®¤å°åŒºä¿¡æ¯
        console.log('âš ï¸ æœªæ‰¾åˆ°ç®¡å®¶å°åŒºä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼');
        this.useDefaultCommunityInfo();

    } catch (error) {
        console.error('âŒ åŠ è½½ç®¡å®¶å°åŒºä¿¡æ¯å¤±è´¥:', error);
        this.useDefaultCommunityInfo();
    }
},

// ğŸ†• è®¾ç½®ç®¡å®¶å°åŒºä¿¡æ¯
setManagerCommunityInfo(communityInfo) {
    this.managerCommunityInfo = communityInfo;
    this.isManagerCommunityLoaded = true;

    // æ›´æ–°å½“å‰å°åŒºåç§°
    this.currentCommunityName = communityInfo.name;

    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¾›å…¶ä»–æ–¹æ³•ä½¿ç”¨
    const parkInfo = {
        name: communityInfo.name,
        fullName: `${communityInfo.name}-åœè½¦åœº`,
        province: communityInfo.province,
        city: communityInfo.city,
        district: communityInfo.district,
        fullAddress: `${communityInfo.province}${communityInfo.city}${communityInfo.district}${communityInfo.name}`
    };
    uni.setStorageSync('parkInfo', parkInfo);

    console.log('âœ… ç®¡å®¶å°åŒºä¿¡æ¯å·²è®¾ç½®:', this.managerCommunityInfo);
    console.log('âœ… parkInfoå·²æ›´æ–°:', parkInfo);
},

// ğŸ†• é€šè¿‡æ‰‹æœºå·æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯
async queryManagerCommunityByPhone(phone) {
    try {
        const response = await uni.request({
            url: `https://csharphrb.picp.vip/parking/butler/getCommunityByPhone?phone=${phone}`,
            method: 'GET',
            header: {
                'content-type': 'application/json'
            },
            timeout: 10000
        });

        console.log('ğŸ” ç®¡å®¶å°åŒºæŸ¥è¯¢APIå“åº”:', response);

        if (response.statusCode === 200 && response.data.code === '0') {
            return response.data;
        } else {
            console.warn('âš ï¸ æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯å¤±è´¥:', response.data.msg);
            return null;
        }

    } catch (error) {
        console.error('âŒ æŸ¥è¯¢ç®¡å®¶å°åŒºä¿¡æ¯APIè°ƒç”¨å¤±è´¥:', error);
        return null;
    }
},

// ğŸ†• ä½¿ç”¨é»˜è®¤å°åŒºä¿¡æ¯
useDefaultCommunityInfo() {
    const defaultCommunity = {
        name: 'å››å­£ä¸Šä¸œ',
        province: 'é»‘é¾™æ±Ÿçœ',
        city: 'å“ˆå°”æ»¨å¸‚',
        district: 'é¦™åŠåŒº'
    };
    this.setManagerCommunityInfo(defaultCommunity);
    console.log('ğŸ“ ä½¿ç”¨é»˜è®¤ç®¡å®¶å°åŒºä¿¡æ¯:', defaultCommunity);
},

// ğŸ†• ç­‰å¾…ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½å®Œæˆ
async waitForManagerCommunityInfo() {
    let attempts = 0;
    const maxAttempts = 20; // æœ€å¤šç­‰å¾…2ç§’

    while (!this.isManagerCommunityLoaded && attempts < maxAttempts) {
        await new Promise(resolve => setTimeout(resolve, 100));
        attempts++;
    }

    if (!this.isManagerCommunityLoaded) {
        console.warn('âš ï¸ ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½è¶…æ—¶ï¼Œä½¿ç”¨é»˜è®¤ä¿¡æ¯');
        this.useDefaultCommunityInfo();
    }

    console.log(`âœ… ç®¡å®¶å°åŒºä¿¡æ¯åŠ è½½å®Œæˆï¼Œè€—æ—¶: ${attempts * 100}ms`);
}
```

### 4. ä¿®æ”¹updateParkingLotInfoæ–¹æ³•
åœ¨ç°æœ‰çš„updateParkingLotInfoæ–¹æ³•ä¸­æ·»åŠ ç®¡å®¶è§’è‰²å¤„ç†ï¼š

```javascript
// ä¿®æ”¹ç°æœ‰çš„updateParkingLotInfoæ–¹æ³•
async updateParkingLotInfo(userInfo) {
    try {
        let addressInfo;

        // ğŸ†• å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ä¸”å·²åŠ è½½å°åŒºä¿¡æ¯ï¼Œä¼˜å…ˆä½¿ç”¨ç®¡å®¶çš„å°åŒºä¿¡æ¯
        if (this.currentUserRole === 'manager' && this.managerCommunityInfo) {
            addressInfo = {
                province: this.managerCommunityInfo.province,
                city: this.managerCommunityInfo.city,
                district: this.managerCommunityInfo.district,
                community: this.managerCommunityInfo.name
            };
            console.log('ğŸ‘¨â€ğŸ’¼ [ç®¡å®¶è§’è‰²] ä½¿ç”¨ç®¡å®¶å°åŒºä¿¡æ¯æ›´æ–°åœè½¦åœº:', addressInfo);
        } else {
            // å…¶ä»–è§’è‰²ä½¿ç”¨åŸæœ‰é€»è¾‘
            addressInfo = await this.getAddressInfo(userInfo);
            console.log('ğŸ‘¤ [å…¶ä»–è§’è‰²] ä½¿ç”¨åŸæœ‰é€»è¾‘è·å–åœ°å€ä¿¡æ¯:', addressInfo);
        }

        // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰æ›´æ–°çš„å°åŒºä¿¡æ¯ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        const parkInfo = uni.getStorageSync('parkInfo');
        if (parkInfo && parkInfo.name) {
            let fullName = parkInfo.fullName || `${parkInfo.name}-åœè½¦åœº`;
            let fullAddress = parkInfo.fullAddress;

            if (!fullAddress) {
                fullAddress = `${parkInfo.province || 'é»‘é¾™æ±Ÿçœ'}${parkInfo.city || 'å“ˆå°”æ»¨å¸‚'}${parkInfo.district || 'é¦™åŠåŒº'}${parkInfo.name}`;
            }

            // æ›´æ–°åœè½¦åœºä¿¡æ¯
            this.parkingLotInfo = {
                fullName: fullName,
                fullAddress: fullAddress,
                buildingInfo: this.parkingLotInfo.buildingInfo || ''
            };

            console.log("ğŸ” ä½¿ç”¨æœ¬åœ°å­˜å‚¨æ›´æ–°çš„åœè½¦åœºä¿¡æ¯:", this.parkingLotInfo);

            // ğŸ†• æ›´æ–°é¡µé¢æ ‡é¢˜
            uni.setNavigationBarTitle({
                title: fullName
            });

            return;
        }

        // å¦‚æœæ²¡æœ‰æœ¬åœ°å­˜å‚¨çš„ä¿¡æ¯ï¼Œä½¿ç”¨è·å–åˆ°çš„åœ°å€ä¿¡æ¯æ„å»º
        const fullName = `${addressInfo.community}-åœè½¦åœº`;
        const fullAddress = `${addressInfo.province}${addressInfo.city}${addressInfo.district}${addressInfo.community}`;

        // æ›´æ–°åœè½¦åœºä¿¡æ¯
        this.parkingLotInfo = {
            fullName: fullName,
            fullAddress: fullAddress,
            buildingInfo: ''
        };

        // ğŸ†• æ›´æ–°é¡µé¢æ ‡é¢˜
        uni.setNavigationBarTitle({
            title: fullName
        });

        console.log('âœ… åœè½¦åœºä¿¡æ¯å·²æ›´æ–°:', this.parkingLotInfo);

    } catch (error) {
        console.error('âŒ æ›´æ–°åœè½¦åœºä¿¡æ¯å¤±è´¥:', error);
    }
}
```

### 5. ä¿®æ”¹onLoadæ–¹æ³•
åœ¨ç°æœ‰çš„onLoadæ–¹æ³•ä¸­æ·»åŠ ç®¡å®¶è§’è‰²çš„ç‰¹æ®Šå¤„ç†ï¼š

```javascript
async onLoad(options) {
    try {
        console.log('ğŸ” onLoadå¼€å§‹æ‰§è¡Œï¼Œæ¥æ”¶åˆ°å‚æ•°:', options);

        // è·å–ç”¨æˆ·è§’è‰²ï¼ˆè¿™é‡Œä¼šå¤„ç†ç®¡å®¶å°åŒºä¿¡æ¯ï¼‰
        await this.getUserRole();

        // ğŸ†• å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ï¼Œç­‰å¾…å°åŒºä¿¡æ¯åŠ è½½å®Œæˆ
        if (this.currentUserRole === 'manager') {
            console.log('ğŸ‘¨â€ğŸ’¼ ç®¡å®¶è§’è‰²ï¼Œç­‰å¾…å°åŒºä¿¡æ¯åŠ è½½å®Œæˆ...');
            await this.waitForManagerCommunityInfo();
        }

        // å¤„ç†æ‰«ç ä¼ å…¥çš„åœ°å€å‚æ•°ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        if (options) {
            // ç°æœ‰çš„å‚æ•°å¤„ç†é€»è¾‘...
            const decodedParams = {};
            for (const key in options) {
                if (options.hasOwnProperty(key)) {
                    try {
                        decodedParams[key] = decodeURIComponent(options[key]);
                    } catch (e) {
                        decodedParams[key] = options[key];
                    }
                }
            }

            // ç°æœ‰çš„å°åŒºä¿¡æ¯å¤„ç†é€»è¾‘...
            if (decodedParams.community) {
                // åªæœ‰éç®¡å®¶è§’è‰²æ‰å¤„ç†æ‰«ç çš„å°åŒºä¿¡æ¯
                if (this.currentUserRole !== 'manager') {
                    const parkInfo = {
                        name: decodedParams.community,
                        fullName: `${decodedParams.community}-åœè½¦åœº`,
                        province: decodedParams.province || 'é»‘é¾™æ±Ÿçœ',
                        city: decodedParams.city || 'å“ˆå°”æ»¨å¸‚',
                        district: decodedParams.district || 'é¦™åŠåŒº',
                        address: decodedParams.address || '',
                        fullAddress: decodedParams.fullAddress || ''
                    };

                    uni.setStorageSync('parkInfo', parkInfo);

                    this.parkingLotInfo = {
                        fullName: parkInfo.fullName,
                        fullAddress: `${parkInfo.province}${parkInfo.city}${parkInfo.district}${parkInfo.address || parkInfo.name}`,
                        buildingInfo: ''
                    };

                    console.log('ğŸ” éç®¡å®¶è§’è‰²ï¼Œä½¿ç”¨æ‰«ç çš„åœè½¦åœºä¿¡æ¯:', this.parkingLotInfo);
                } else {
                    console.log('ğŸ‘¨â€ğŸ’¼ ç®¡å®¶è§’è‰²ï¼Œå¿½ç•¥æ‰«ç çš„å°åŒºä¿¡æ¯ï¼Œä½¿ç”¨ç®¡å®¶è‡ªå·±çš„å°åŒº');
                }
            }

            // å¤„ç†ç®¡å®¶ä¿¡æ¯ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
            if (decodedParams.butlerName || decodedParams.butlerPhone || decodedParams.butlerId) {
                this.processButlerInfo(decodedParams);
            }

            await this.processScannedAddressParams(decodedParams);
        }

        // åˆå§‹åŒ–åœ°å€æ•°æ®
        await this.loadCurrentCommunityInfo();

        // ç›‘å¬TabBarçŠ¶æ€æ›´æ–°äº‹ä»¶ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        uni.$on('updateTabBarIndex', (index) => {
            // TabBarçŠ¶æ€æ›´æ–°
        });

    } catch (error) {
        console.error('onLoadé”™è¯¯:', error);
        uni.showToast({
            title: 'é¡µé¢åŠ è½½å¤±è´¥',
            icon: 'none'
        });
    }
}
```

### 6. ä¿®æ”¹loadAddressDataæ–¹æ³•
åœ¨ç°æœ‰çš„loadAddressDataæ–¹æ³•ä¸­æ·»åŠ ç®¡å®¶è§’è‰²å¤„ç†ï¼š

```javascript
// ä¿®æ”¹ç°æœ‰çš„loadAddressDataæ–¹æ³•
async loadAddressData() {
    try {
        console.log('ğŸš€ å¼€å§‹åŠ è½½å››çº§åœ°å€æ•°æ®');

        let communityName;

        // ğŸ†• å¦‚æœæ˜¯ç®¡å®¶è§’è‰²ï¼Œä¼˜å…ˆä½¿ç”¨ç®¡å®¶çš„å°åŒºä¿¡æ¯
        if (this.currentUserRole === 'manager' && this.managerCommunityInfo) {
            communityName = this.managerCommunityInfo.name;
            console.log('ğŸ‘¨â€ğŸ’¼ [ç®¡å®¶è§’è‰²] ä½¿ç”¨ç®¡å®¶å°åŒºåç§°:', communityName);
        } else {
            // å…¶ä»–è§’è‰²ä½¿ç”¨åŸæœ‰é€»è¾‘
            const parkInfo = uni.getStorageSync('parkInfo');
            communityName = parkInfo?.name || this.currentCommunityName || 'å››å­£ä¸Šä¸œ';
            console.log('ğŸ‘¤ [å…¶ä»–è§’è‰²] ä½¿ç”¨åŸæœ‰é€»è¾‘è·å–å°åŒºåç§°:', communityName);
        }

        // URLç¼–ç å¤„ç†ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        try {
            if (communityName && typeof communityName === 'string' && communityName.includes('%')) {
                communityName = decodeURIComponent(communityName);
                console.log('ğŸ“ æ£€æµ‹åˆ°ç¼–ç çš„å°åŒºåç§°,å·²è§£ç ');
            }
        } catch (e) {
            console.error('è§£ç å°åŒºåç§°å¤±è´¥:', e);
        }

        console.log('ğŸ“ æœ€ç»ˆä½¿ç”¨çš„å°åŒºåç§°:', communityName);

        // æ˜¾ç¤ºåŠ è½½æç¤º
        uni.showLoading({
            title: 'åŠ è½½åœ°å€æ•°æ®...',
            mask: true
        });

        // è°ƒç”¨APIåŠ è½½åœ°å€æ•°æ®ï¼ˆä¿æŒåŸæœ‰é€»è¾‘ï¼‰
        const response = await uni.request({
            url: `https://csharphrb.picp.vip/parking/community/getAllCommunity?community=${encodeURIComponent(communityName)}`,
            method: 'GET',
            header: {
                'content-type': 'application/json'
            },
            timeout: 10000
        });

        // åç»­çš„æ•°æ®å¤„ç†é€»è¾‘ä¿æŒä¸å˜...
        console.log('ğŸ“ åœ°å€æ•°æ®APIå“åº”:', response);

        if (response.statusCode !== 200) {
            throw new Error(`è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : ${response.statusCode}`);
        }

        if (!response.data || response.data.code !== '0') {
            throw new Error(response.data?.msg || 'è·å–åœ°å€æ•°æ®å¤±è´¥');
        }

        if (!Array.isArray(response.data.data)) {
            throw new Error('è¿”å›æ•°æ®æ ¼å¼é”™è¯¯');
        }

        if (response.data.data.length === 0) {
            throw new Error(`æœªæ‰¾åˆ°å°åŒº"${communityName}"çš„åœ°å€æ•°æ®`);
        }

        // æ£€æŸ¥æ•°æ®ç»“æ„
        const hasValidData = response.data.data.some(item =>
            item.building && item.units && item.floor && item.roomnumber
        );

        if (!hasValidData) {
            throw new Error('åœ°å€æ•°æ®ç»“æ„ä¸å®Œæ•´');
        }

        // å¤„ç†åœ°å€æ•°æ®
        this.processAddressData(response.data.data);

        console.log('âœ… åœ°å€æ•°æ®åŠ è½½æˆåŠŸ');

    } catch (error) {
        console.error('âŒ åŠ è½½åœ°å€æ•°æ®å¤±è´¥:', error);

        uni.showToast({
            title: error.message || 'åŠ è½½åœ°å€æ•°æ®å¤±è´¥',
            icon: 'none',
            duration: 3000
        });

        // è®¾ç½®ç©ºçš„åœ°å€æ•°æ®
        this.addressRange = [[], [], [], []];

    } finally {
        uni.hideLoading();
    }
}
```

*æ–‡æ¡£ç‰ˆæœ¬: v1.0 | æ›´æ–°æ—¶é—´: 2025å¹´7æœˆ9æ—¥*
