# å››å±‚è§’è‰²åˆ¤æ–­ç³»ç»Ÿå®ç°æ–‡æ¡£

## ğŸ“‹ ç³»ç»Ÿæ¦‚è¿°

åŸºäºç°æœ‰çš„åœè½¦ç®¡ç†ç³»ç»Ÿï¼Œæˆ‘ä»¬å®ç°äº†å››å±‚è§’è‰²åˆ¤æ–­é€»è¾‘ï¼Œé€šè¿‡å¤šä¸ªæ•°æ®æºéªŒè¯ç”¨æˆ·èº«ä»½ï¼š

### ğŸ” å››å±‚è§’è‰²åˆ¤æ–­é¡ºåº

1. **ç¬¬ä¸€å±‚ï¼šButlerè¡¨ï¼ˆç®¡å®¶ï¼‰** - æœ€é«˜ä¼˜å…ˆçº§
2. **ç¬¬äºŒå±‚ï¼šOwnerinfoè¡¨ï¼ˆä¸šä¸»-æœ¬åœ°æ•°æ®ï¼‰** - æœ¬åœ°ä¸šä¸»æ•°æ®
3. **ç¬¬ä¸‰å±‚ï¼šå¤–éƒ¨APIï¼ˆä¸šä¸»-å¤–éƒ¨æ•°æ®ï¼‰** - æœˆç¥¨ç³»ç»Ÿè¡¥å……éªŒè¯
4. **ç¬¬å››å±‚ï¼šMemberè¡¨ï¼ˆè®¿å®¢ï¼‰** - è®¿å®¢å’Œå¾…å®¡æ ¸ç”¨æˆ·

## ğŸ—ï¸ æ ¸å¿ƒç»„ä»¶

### 1. OwnerRoleVerificationService
- **ä½ç½®**: `src/main/java/com/parkingmanage/service/OwnerRoleVerificationService.java`
- **åŠŸèƒ½**: é€šè¿‡å¤–éƒ¨æœˆç¥¨APIéªŒè¯ä¸šä¸»èº«ä»½
- **ç‰¹æ€§**: 
  - 5åˆ†é’Ÿç¼“å­˜æœºåˆ¶
  - æ™ºèƒ½åˆ†é¡µå¤„ç†ï¼ˆæ¯æ¬¡100æ¡ï¼‰
  - å¼‚å¸¸ä¿æŠ¤æœºåˆ¶

### 2. WeChatAuthController (æ›´æ–°)
- **ä½ç½®**: `src/main/java/com/parkingmanage/controller/WeChatAuthController.java`
- **åŠŸèƒ½**: å¾®ä¿¡å°ç¨‹åºæˆæƒå’Œå››å±‚è§’è‰²åˆ¤æ–­
- **æ–°å¢æ–¹æ³•**: 
  - `determineUserRole()` - å››å±‚è§’è‰²åˆ¤æ–­
  - `getRoleStats()` - è§’è‰²ç»Ÿè®¡ä¿¡æ¯

## ğŸ”„ å®ç°é€»è¾‘

### è§’è‰²åˆ¤æ–­æµç¨‹

```java
public Map<String, Object> determineUserRole(String phoneNumber, String openid) {
    // ç¬¬ä¸€å±‚ï¼šButlerè¡¨æŸ¥è¯¢
    if (isManager(phoneNumber)) {
        return buildManagerInfo();
    }
    
    // ç¬¬äºŒå±‚ï¼šOwnerinfoè¡¨æŸ¥è¯¢
    if (isLocalOwner(phoneNumber)) {
        return buildOwnerInfo();
    }
    
    // ç¬¬ä¸‰å±‚ï¼šå¤–éƒ¨APIæŸ¥è¯¢
    if (ownerRoleVerificationService.isOwnerByPhoneNumber(phoneNumber)) {
        return buildExternalOwnerInfo();
    }
    
    // ç¬¬å››å±‚ï¼šMemberè¡¨æŸ¥è¯¢ï¼ˆæš‚æ—¶è·³è¿‡ï¼Œå¾…å®ä½“ç±»å®Œå–„ï¼‰
    // if (isVisitor(openid)) {
    //     return buildVisitorInfo();
    // }
    
    // å®Œå…¨æœªæ³¨å†Œ
    return buildUnregisteredInfo();
}
```

### å¤–éƒ¨APIé›†æˆ

```java
// åŸºäºç°æœ‰MonthTicketControllerçš„é€»è¾‘
private List<Map<String, Object>> getOnlineMonthTicketsByPark(String parkCode) {
    // å¤ç”¨ç°æœ‰çš„åˆ†é¡µé€»è¾‘
    // è°ƒç”¨ aikeConfig.downHandler("getOnlineMonthTicketList")
    // è‡ªåŠ¨å¤„ç†åˆ†é¡µï¼Œè·å–æ‰€æœ‰æ•°æ®
}
```

## ğŸ“Š è§’è‰²æƒé™æ˜ å°„

### ç®¡å®¶æƒé™
```java
private String[] getManagerPermissions() {
    return new String[]{
        "appointment.query",        // é¢„çº¦æŸ¥è¯¢
        "appointment.audit",        // é¢„çº¦å®¡æ ¸
        "appointment.query.all",    // æŸ¥è¯¢æ‰€æœ‰é¢„çº¦
        "violation.manage",         // è¿è§„ç®¡ç†
        "violation.view.all",       // æŸ¥çœ‹æ‰€æœ‰è¿è§„
        "audit.member",            // å®¡æ ¸ä¼šå‘˜ç”³è¯·
        "audit.appointment",       // å®¡æ ¸é¢„çº¦ç”³è¯·
        "owner.manage",            // ä¸šä¸»ç®¡ç†
        "manage.facility"          // è®¾æ–½ç®¡ç†
    };
}
```

### ä¸šä¸»æƒé™
```java
private String[] getOwnerPermissions() {
    return new String[]{
        "appointment.create",       // åˆ›å»ºé¢„çº¦
        "appointment.query.own",    // æŸ¥è¯¢ä¸ªäººé¢„çº¦
        "appointment.cancel",       // å–æ¶ˆé¢„çº¦
        "violation.view.own",       // æŸ¥çœ‹ä¸ªäººè¿è§„
        "violation.report"          // ä¸¾æŠ¥è¿è§„
    };
}
```

### è®¿å®¢æƒé™
```java
private String[] getVisitorPermissions() {
    return new String[]{
        "visitor.appointment",      // è®¿å®¢é¢„çº¦
        "visitor.query",           // è®¿å®¢æŸ¥è¯¢
        "appointment.create",      // åˆ›å»ºé¢„çº¦ï¼ˆåŸºç¡€ï¼‰
        "appointment.query.own"    // æŸ¥è¯¢ä¸ªäººé¢„çº¦ï¼ˆåŸºç¡€ï¼‰
    };
}
```

## ğŸš€ APIæ¥å£

### 1. å¾®ä¿¡æˆæƒç™»å½•
```http
POST /parking/wechat/phoneAuth
Content-Type: application/json

{
    "code": "å¾®ä¿¡ç™»å½•å‡­è¯",
    "encryptedData": "åŠ å¯†çš„æ‰‹æœºå·æ•°æ®",
    "iv": "åŠ å¯†åˆå§‹å‘é‡"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
    "code": "0",
    "msg": "æˆæƒæˆåŠŸ",
    "data": {
        "phone": "13800138000",
        "openid": "mock_openid_123456789",
        "role": "owner",
        "roleText": "ä¸šä¸»",
        "source": "external_api",
        "needSync": true,
        "userInfo": {
            "ownername": "å¼ ä¸‰",
            "ownerphone": "13800138000",
            "carno": "äº¬A12345"
        },
        "permissions": [
            "appointment.create",
            "appointment.query.own",
            "appointment.cancel"
        ]
    }
}
```

### æƒé™æ£€æŸ¥
```http
GET /parking/wechat/checkPermission?phoneNumber=13800138000&permission=appointment.create&openid=123
```

### è§’è‰²ç»Ÿè®¡
```http
GET /parking/wechat/roleStats
```

## ğŸ¯ æ•°æ®æºæ˜ å°„

### åœè½¦åœºä»£ç æ˜ å°„
```java
private static final Map<String, String> PARK_CODE_MAP = new HashMap<>();
static {
    PARK_CODE_MAP.put("ä¸‡è±¡ä¸Šä¸œ", "2KST9MNP");
    PARK_CODE_MAP.put("å››å­£ä¸Šä¸œ", "2KUG6XLU");
}
```

### å¤–éƒ¨APIè°ƒç”¨
- **APIåœ°å€**: é€šè¿‡`AIKEConfig`é…ç½®
- **æ–¹æ³•**: `getOnlineMonthTicketList`
- **å‚æ•°**: `parkCodeList`, `pageNum`, `pageSize`, `validStatus`

## ğŸ”§ é…ç½®è¦æ±‚

### 1. Springç¼“å­˜é…ç½®
```java
@Cacheable(value = "ownerVerification", key = "#phoneNumber")
public boolean isOwnerByPhoneNumber(String phoneNumber) {
    // ç¼“å­˜5åˆ†é’Ÿ
}
```

### 2. å¾®ä¿¡å°ç¨‹åºé…ç½®
```java
private static final String APP_ID = "wx112d8a922018480e";
private static final String APP_SECRET = "d1081a76d17cd3a9ba44d04a7c78275b";
```

### 3. å¤–éƒ¨APIé…ç½®
éœ€è¦åœ¨`AIKEConfig`ä¸­é…ç½®ï¼š
- `AK_URL`: APIåŸºç¡€åœ°å€
- `AK_KEY`: APIå¯†é’¥
- `AK_SECRET`: APIç§˜é’¥

## âš ï¸ å·²çŸ¥é—®é¢˜å’Œå¾…å®Œå–„

### 1. Memberå®ä½“ç±»é—®é¢˜
- **é—®é¢˜**: Memberå®ä½“ç±»ç¼ºå°‘`auditstatus`å’Œ`openid`å­—æ®µ
- **çŠ¶æ€**: ç¬¬å››å±‚æŸ¥è¯¢æš‚æ—¶è·³è¿‡
- **è§£å†³æ–¹æ¡ˆ**: éœ€è¦å®Œå–„Memberå®ä½“ç±»å­—æ®µå®šä¹‰

### 2. OpenIDè·å–
- **é—®é¢˜**: å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿopenid
- **è§£å†³æ–¹æ¡ˆ**: éœ€è¦å®Œå–„WeChatUtilsç±»ï¼ŒåŒæ—¶è·å–sessionKeyå’Œopenid

### 3. ç¼“å­˜é…ç½®
- **å»ºè®®**: å¯ç”¨Redisç¼“å­˜ä»¥æé«˜æ€§èƒ½
- **é…ç½®**: application.ymlä¸­æ·»åŠ Redisé…ç½®

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. ç¼“å­˜ç­–ç•¥
- **ä¸šä¸»éªŒè¯**: 5åˆ†é’Ÿç¼“å­˜
- **ä¸šä¸»è¯¦æƒ…**: 5åˆ†é’Ÿç¼“å­˜
- **æ‰¹é‡éªŒè¯**: ä¸€æ¬¡æ€§è·å–æ‰€æœ‰æ•°æ®

### 2. åˆ†é¡µå¤„ç†
- **æ¯é¡µ100æ¡**: å¤ç”¨ç°æœ‰MonthTicketControlleré€»è¾‘
- **è‡ªåŠ¨åˆ†é¡µ**: å¾ªç¯è·å–æ‰€æœ‰æ•°æ®
- **é˜²æŠ¤æœºåˆ¶**: æœ€å¤§50é¡µé™åˆ¶

### 3. å¼‚å¸¸ä¿æŠ¤
- **å¤–éƒ¨APIå¼‚å¸¸**: ä¸å½±å“åç»­æŸ¥è¯¢
- **å±‚çº§éš”ç¦»**: æ¯å±‚æŸ¥è¯¢ç‹¬ç«‹å¼‚å¸¸å¤„ç†
- **é™çº§æœºåˆ¶**: APIå¤±è´¥æ—¶è·³è¿‡è¯¥å±‚æŸ¥è¯¢

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•
```java
@Test
public void testRoleVerification() {
    // æµ‹è¯•å„ç§è§’è‰²åˆ¤æ–­åœºæ™¯
}
```

### 2. é›†æˆæµ‹è¯•
- æµ‹è¯•å¤–éƒ¨APIè¿æ¥
- æµ‹è¯•ç¼“å­˜æœºåˆ¶
- æµ‹è¯•æƒé™æ£€æŸ¥

### 3. æ€§èƒ½æµ‹è¯•
- æ‰¹é‡ç”¨æˆ·éªŒè¯
- ç¼“å­˜å‘½ä¸­ç‡
- APIå“åº”æ—¶é—´

## ğŸ”„ å‡çº§è·¯å¾„

### çŸ­æœŸä¼˜åŒ–
1. å®Œå–„Memberå®ä½“ç±»å­—æ®µ
2. å®ç°çœŸå®openidè·å–
3. æ·»åŠ Redisç¼“å­˜é…ç½®

### ä¸­æœŸä¼˜åŒ–
1. å®ç°æ•°æ®åŒæ­¥æœºåˆ¶
2. æ·»åŠ è§’è‰²åˆ‡æ¢æ—¥å¿—
3. ä¼˜åŒ–APIè°ƒç”¨é¢‘ç‡

### é•¿æœŸä¼˜åŒ–
1. å®ç°åˆ†å¸ƒå¼ç¼“å­˜
2. æ·»åŠ ç›‘æ§å’Œå‘Šè­¦
3. æ”¯æŒæ›´å¤šè§’è‰²ç±»å‹

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### Javaåç«¯è°ƒç”¨
```java
@Autowired
private OwnerRoleVerificationService ownerRoleVerificationService;

// éªŒè¯å•ä¸ªç”¨æˆ·
boolean isOwner = ownerRoleVerificationService.isOwnerByPhoneNumber("13800138000");

// è·å–ç”¨æˆ·è¯¦æƒ…
Map<String, Object> ownerInfo = ownerRoleVerificationService.getOwnerDetailsByPhone("13800138000");

// æ‰¹é‡éªŒè¯
List<String> phones = Arrays.asList("13800138000", "13900139000");
Map<String, Boolean> results = ownerRoleVerificationService.batchVerifyOwners(phones);
```

### å‰ç«¯è°ƒç”¨ç¤ºä¾‹
```javascript
// å¾®ä¿¡æˆæƒç™»å½•
const authResult = await wx.request({
    url: '/parking/wechat/phoneAuth',
    method: 'POST',
    data: {
        code: code,
        encryptedData: encryptedData,
        iv: iv
    }
});

// æ£€æŸ¥æƒé™
const permissionResult = await wx.request({
    url: `/parking/wechat/checkPermission?phoneNumber=${phone}&permission=appointment.create`,
    method: 'GET'
});
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
1. ç³»ç»Ÿæ—¥å¿—ä¸­çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯
2. å¤–éƒ¨APIè°ƒç”¨å“åº”
3. ç¼“å­˜å‘½ä¸­æƒ…å†µ
4. æ•°æ®åº“è¿æ¥çŠ¶æ€

æ›´æ–°æ—¶é—´ï¼š2024å¹´12æœˆ 