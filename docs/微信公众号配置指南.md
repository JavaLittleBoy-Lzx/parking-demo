# 🔧 微信公众号配置指南

## 📍 第一步：确定你的服务器信息

### 1. 服务器域名或IP
- **生产环境推荐**：使用域名（如：`parking.example.com`）
- **开发环境**：可以使用IP地址（如：`192.168.1.100`）
- **端口**：你的应用运行端口（配置文件中是：`8543`）

### 2. SSL证书（推荐）
- 微信官方推荐使用HTTPS
- 如果你有SSL证书，URL格式：`https://你的域名/wechat/event`
- 如果没有SSL证书，URL格式：`http://你的域名:端口/wechat/event`

## 🔑 第二步：设置Token

### 1. 修改配置文件
在 `application.yml` 中设置你的Token：
```yaml
wechat:
  # 微信事件推送Token（用于验证微信服务器请求）
  token: 你的自定义Token   # 请修改为复杂的Token
```

### 2. Token要求
- **长度**：建议20-32个字符
- **复杂性**：包含字母、数字，避免特殊字符
- **示例**：`ParkingDemo2024Token123`、`MyWeChatToken2024ABC`

## 📱 第三步：微信公众号后台配置

### 1. 登录微信公众平台
访问：https://mp.weixin.qq.com/

### 2. 进入开发配置
1. 左侧菜单：**开发** → **基本配置**
2. 找到 **服务器配置** 部分

### 3. 填写服务器配置

| 配置项 | 填写内容 | 示例 |
|--------|----------|------|
| **URL** | `http(s)://你的域名:端口/wechat/event` | `https://parking.example.com/wechat/event` |
| **Token** | 与配置文件中相同的Token | `ParkingDemo2024Token123` |
| **EncodingAESKey** | 点击"随机生成"按钮 | 系统自动生成 |
| **消息加解密方式** | 选择"明文模式" | 明文模式 |

### 4. 启用服务器配置
1. 确保你的应用已启动
2. 点击**提交**按钮
3. 微信会验证你的服务器
4. 验证成功后，点击**启用**

## 🔍 第四步：验证配置

### 1. 检查日志
启动应用后，关注控制台日志：
```
📥 收到微信服务器验证请求 - signature: xxx, timestamp: xxx, nonce: xxx
✅ 微信服务器验证成功
```

### 2. 测试事件推送
1. 用微信扫码关注你的公众号
2. 查看日志是否有事件推送记录：
```
📥 收到微信事件推送
🔄 开始异步处理微信事件
🎯 处理微信事件 - 类型: event, 事件: subscribe, openId: xxx
✅ 异步处理微信事件完成
```

## ⚠️ 常见问题排查

### 1. 验证失败
- **检查Token**：确保配置文件和微信后台的Token完全一致
- **检查URL**：确保URL可以从外网访问
- **检查端口**：确保防火墙开放了对应端口

### 2. 事件推送失败
- **5秒响应**：确保服务器能在5秒内响应
- **异步处理**：确保异步配置正确加载
- **网络连通**：确保微信服务器能访问你的服务器

### 3. SSL证书问题
- 如果使用自签名证书，微信可能无法验证
- 建议使用正规CA颁发的证书
- 或者先使用HTTP测试，生产环境再升级HTTPS

## 📋 配置清单

在配置前，请确保：

- [ ] 服务器可以从外网访问
- [ ] 应用正常启动在指定端口
- [ ] Token已正确配置在 `application.yml` 中
- [ ] 微信公众号已认证或服务号
- [ ] 了解你的完整访问URL

## 🚀 示例配置

假设你的服务器配置如下：
- **域名**：`parking.mydomain.com`
- **端口**：`8543`（默认配置）
- **SSL**：已配置

### application.yml 配置：
```yaml
wechat:
  token: MyParkingToken2024
```

### 微信公众号后台配置：
- **URL**：`https://parking.mydomain.com:8543/wechat/event`
- **Token**：`MyParkingToken2024`

配置完成后，你的停车管理系统就能实时接收用户关注、取消关注等事件了！🎉 