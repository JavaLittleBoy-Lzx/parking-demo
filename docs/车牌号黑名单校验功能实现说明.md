# è½¦ç‰Œå·é»‘åå•æ ¡éªŒåŠŸèƒ½å®ç°è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

åœ¨ç”¨æˆ·è¿›è¡Œè½¦è¾†é¢„çº¦æ—¶ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨æ ¡éªŒè¾“å…¥çš„è½¦ç‰Œå·æ˜¯å¦åœ¨é»‘åå•ä¸­ã€‚å¦‚æœè½¦ç‰Œå·åœ¨é»‘åå•ä¸­ï¼Œç³»ç»Ÿå°†æ‹’ç»é¢„çº¦å¹¶è¿”å›ç›¸åº”çš„é”™è¯¯ä¿¡æ¯ã€‚

## å®ç°ä½ç½®

**æ–‡ä»¶è·¯å¾„**: `src/main/java/com/parkingmanage/controller/AppointmentController.java`

## æ ¸å¿ƒåŠŸèƒ½

### 1. é»‘åå•æ ¡éªŒæµç¨‹

åœ¨ `insertAppointment` æ–¹æ³•ä¸­ï¼Œæ·»åŠ äº†è½¦ç‰Œå·é»‘åå•æ ¡éªŒä½œä¸ºç¬¬ä¸€æ­¥éªŒè¯ï¼š

```java
// ğŸš« ç¬¬ä¸€æ­¥ï¼šè½¦ç‰Œå·é»‘åå•æ ¡éªŒ
String plateNumber = appointment.getPlatenumber();
if (plateNumber != null && !plateNumber.trim().isEmpty()) {
    try {
        logger.info("ğŸš« å¼€å§‹è½¦ç‰Œå·é»‘åå•æ ¡éªŒ: {}", plateNumber);
        boolean isBlacklisted = checkBlacklistStatus(plateNumber, appointment.getCommunity());
        if (isBlacklisted) {
            logger.warn("ğŸš« è½¦ç‰Œå· {} åœ¨é»‘åå•ä¸­ï¼Œæ‹’ç»é¢„çº¦", plateNumber);
            return R.failed("è¯¥è½¦ç‰Œå·å·²è¢«åˆ—å…¥é»‘åå•ï¼Œæ— æ³•è¿›è¡Œé¢„çº¦");
        }
        logger.info("âœ… è½¦ç‰Œå· {} é»‘åå•æ ¡éªŒé€šè¿‡", plateNumber);
    } catch (Exception e) {
        logger.error("ğŸš« é»‘åå•æ ¡éªŒå¼‚å¸¸: {}", e.getMessage(), e);
        return R.failed("é»‘åå•æ ¡éªŒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•");
    }
}
```

### 2. é»‘åå•æŸ¥è¯¢æ–¹æ³•

å®ç°äº† `checkBlacklistStatus` æ–¹æ³•æ¥è°ƒç”¨å¤–éƒ¨é»‘åå•æŸ¥è¯¢æ¥å£ï¼š

```java
private boolean checkBlacklistStatus(String plateNumber, String community) {
    try {
        // æ ¹æ®ç¤¾åŒºåç§°è·å–åœè½¦åœºç¼–ç 
        String parkCode = getParkCodeByCommunity(community);
        
        // æ„å»ºè¯·æ±‚å‚æ•°ï¼Œå‚è€ƒæœˆç¥¨æŸ¥è¯¢çš„æ–¹å¼
        HashMap<String, Object> params = new HashMap<>();
        params.put("parkCodeList", Arrays.asList(parkCode));
        params.put("pageNum", 1);
        params.put("pageSize", 1000);
        params.put("carCode", plateNumber);
        
        // è°ƒç”¨é»‘åå•æŸ¥è¯¢æ¥å£
        JSONObject response = aikeConfig.downHandler(
            AIKEConfig.AK_URL, 
            AIKEConfig.AK_KEY, 
            AIKEConfig.AK_SECRET, 
            "getParkBlackList", 
            params
        );
        
        // è§£æå“åº”ç»“æœå¹¶åˆ¤æ–­æ˜¯å¦åœ¨é»‘åå•ä¸­
        // æ£€æŸ¥ resultCode=0 å’Œ status=1 è¡¨ç¤ºæˆåŠŸ
        // ä» data.recordList ä¸­æŸ¥æ‰¾åŒ¹é…çš„è½¦ç‰Œå·
        
        return false; // ä¸åœ¨é»‘åå•ä¸­
    } catch (Exception e) {
        logger.error("ğŸš« é»‘åå•æ ¡éªŒå¼‚å¸¸: {}", e.getMessage(), e);
        return false; // å¼‚å¸¸æƒ…å†µä¸‹å…è®¸é¢„çº¦
    }
}
```

### 3. åœè½¦åœºç¼–ç æ˜ å°„

å®ç°äº† `getParkCodeByCommunity` æ–¹æ³•æ¥æ ¹æ®ç¤¾åŒºåç§°è·å–å¯¹åº”çš„åœè½¦åœºç¼–ç ï¼š

```java
private String getParkCodeByCommunity(String community) {
    if ("ä¸‡è±¡ä¸Šä¸œ".equals(community)) {
        return "2KST9MNP";
    } else if ("å››å­£ä¸Šä¸œ".equals(community)) {
        return "2KUG6XLU";
    } else {
        return "2KUG6XLU"; // é»˜è®¤ä½¿ç”¨å››å­£ä¸Šä¸œçš„ç¼–ç 
    }
}
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. ä¾èµ–æ³¨å…¥

æ·»åŠ äº†å¿…è¦çš„ä¾èµ–æ³¨å…¥ï¼š

```java
@Resource
private AIKEConfig aikeConfig;
```

### 2. å¯¼å…¥å£°æ˜

æ·»åŠ äº†å¿…è¦çš„å¯¼å…¥ï¼š

```java
import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.parkingmanage.common.config.AIKEConfig;
```

### 3. æ¥å£è°ƒç”¨

å‚è€ƒäº†ç°æœ‰çš„æœˆç¥¨æŸ¥è¯¢æ¥å£è°ƒç”¨æ–¹å¼ï¼Œä½¿ç”¨ `aikeConfig.downHandler` æ–¹æ³•è°ƒç”¨å¤–éƒ¨APIã€‚

## é”™è¯¯å¤„ç†

1. **é»‘åå•è½¦ç‰Œ**: è¿”å› "è¯¥è½¦ç‰Œå·å·²è¢«åˆ—å…¥é»‘åå•ï¼Œæ— æ³•è¿›è¡Œé¢„çº¦"
2. **æ¥å£å¼‚å¸¸**: è¿”å› "é»‘åå•æ ¡éªŒå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•"
3. **å¼‚å¸¸å¤„ç†**: åœ¨å¼‚å¸¸æƒ…å†µä¸‹ï¼Œä¸ºäº†ä¸å½±å“æ­£å¸¸ä¸šåŠ¡ï¼Œé€‰æ‹©å…è®¸é¢„çº¦ä½†è®°å½•å¼‚å¸¸æ—¥å¿—

## æ—¥å¿—è®°å½•

å®ç°äº†è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼š

- ğŸš« å¼€å§‹é»‘åå•æ ¡éªŒ
- âœ… é»‘åå•æ ¡éªŒé€šè¿‡
- ğŸš« å‘ç°é»‘åå•è½¦ç‰Œ
- ğŸš« é»‘åå•æ ¡éªŒå¼‚å¸¸

## æµ‹è¯•å»ºè®®

1. **æ­£å¸¸è½¦ç‰Œ**: æµ‹è¯•ä¸åœ¨é»‘åå•ä¸­çš„è½¦ç‰Œå·ï¼Œåº”è¯¥èƒ½æ­£å¸¸é¢„çº¦
2. **é»‘åå•è½¦ç‰Œ**: æµ‹è¯•åœ¨é»‘åå•ä¸­çš„è½¦ç‰Œå·ï¼Œåº”è¯¥è¢«æ‹’ç»é¢„çº¦
3. **ç©ºè½¦ç‰Œå·**: æµ‹è¯•ç©ºè½¦ç‰Œå·æˆ–nullå€¼çš„å¤„ç†
4. **æ¥å£å¼‚å¸¸**: æµ‹è¯•å¤–éƒ¨æ¥å£ä¸å¯ç”¨æ—¶çš„å¤„ç†

## ç›¸å…³æ¥å£

- **é»‘åå•æŸ¥è¯¢æ¥å£**: `BlackListController.getParkBlack`
- **å¤–éƒ¨API**: `getParkBlackList` å‘½ä»¤
- **åœè½¦åœºç¼–ç **: 
  - ä¸‡è±¡ä¸Šä¸œ: `2KST9MNP`
  - å››å­£ä¸Šä¸œ: `2KUG6XLU`

## å“åº”æ•°æ®ç»“æ„

é»‘åå•æŸ¥è¯¢æ¥å£çš„å“åº”ç»“æ„å¦‚ä¸‹ï¼š

```json
{
  "data": {
    "total": 1,
    "recordList": [
      {
        "owner": "A1-b-0320",
        "reason": "æ¬ è´¹",
        "specialCarTypeConfigName": "æ‚¨å·²æ¬ è´¹è¯·åŠæ—¶ç¼´è´¹",
        "specialCarTypeConfigId": 1526,
        "carCode": "é»‘AL1X07",
        "remark1": "",
        "blacklistForeverFlag": 1,
        "remark2": ""
      }
    ],
    "count": 1,
    "currCount": 1
  },
  "resultCode": 0,
  "message": "ä¸šåŠ¡æˆåŠŸ",
  "status": 1
}
```

### å“åº”å­—æ®µè¯´æ˜

- `resultCode`: ä¸šåŠ¡ç»“æœç ï¼Œ0è¡¨ç¤ºæˆåŠŸ
- `status`: çŠ¶æ€ç ï¼Œ1è¡¨ç¤ºæˆåŠŸ
- `message`: å“åº”æ¶ˆæ¯
- `data.recordList`: é»‘åå•è®°å½•åˆ—è¡¨
- `data.recordList[].carCode`: è½¦ç‰Œå·
- `data.recordList[].reason`: åŠ å…¥é»‘åå•çš„åŸå› 

## æ³¨æ„äº‹é¡¹

1. é»‘åå•æ ¡éªŒæ˜¯é¢„çº¦æµç¨‹çš„ç¬¬ä¸€æ­¥ï¼Œç¡®ä¿åœ¨å…¶ä»–éªŒè¯ä¹‹å‰æ‰§è¡Œ
2. å¼‚å¸¸æƒ…å†µä¸‹é€‰æ‹©å…è®¸é¢„çº¦ï¼Œé¿å…å› æ¥å£é—®é¢˜å½±å“æ­£å¸¸ä¸šåŠ¡
3. è¯¦ç»†çš„æ—¥å¿—è®°å½•ä¾¿äºé—®é¢˜æ’æŸ¥å’Œç›‘æ§
4. å‚è€ƒäº†ç°æœ‰çš„æœˆç¥¨æŸ¥è¯¢å®ç°ï¼Œä¿æŒä»£ç é£æ ¼ä¸€è‡´æ€§
5. å“åº”è§£æä½¿ç”¨ `resultCode` å’Œ `status` å­—æ®µåˆ¤æ–­æˆåŠŸçŠ¶æ€
6. ç›´æ¥ä» `data.recordList` ä¸­è·å–é»‘åå•è®°å½•ï¼Œæ— éœ€äºŒçº§åµŒå¥—
