# 访客预约自动填充业主信息功能说明

## 功能概述

当访客提交预约申请时，系统会自动从 `visitor_application` 表中查询相关的业主信息（业主姓名和手机号），并将这些信息自动填充到 `appointment` 表中，减少手动输入工作量。

## 实现逻辑

### 1. 查询策略

系统按以下优先级查询业主信息：

1. **优先级1**：通过访客手机号查询 `visitor_application` 表
2. **优先级2**：如果第一步未找到合适记录，通过业主手机号查询

### 2. 记录筛选条件

系统会优先选择符合以下条件的记录：
- 审核状态为 "已通过"
- 包含业主姓名信息的记录
- 按申请日期倒序排列（最新记录优先）

### 3. 自动填充规则

仅在以下情况下自动填充业主信息：
- 预约类型为 "自助" 或 "邀请"
- 前端未提供业主姓名或业主手机号
- 找到符合条件的访客申请记录

## 数据库变更

### visitor_application 表新增字段

```sql
-- 添加业主姓名字段
ALTER TABLE visitor_application 
ADD COLUMN IF NOT EXISTS owner_name varchar(50) DEFAULT NULL COMMENT '业主姓名' AFTER phone;

-- 添加业主手机号字段  
ALTER TABLE visitor_application 
ADD COLUMN IF NOT EXISTS owner_phone varchar(20) DEFAULT NULL COMMENT '业主手机号' AFTER owner_name;

-- 添加业主手机号索引
ALTER TABLE visitor_application 
ADD INDEX IF NOT EXISTS idx_owner_phone (owner_phone);
```

## 代码修改

### 1. AppointmentController.java

在 `insertAppointment` 方法中添加了业主信息自动填充逻辑：

```java
// 访客预约时，从visitor_application表中填充业主信息到appointment表
if (appointment.getAppointtype() != null && 
    (appointment.getAppointtype().equals("自助") || appointment.getAppointtype().equals("邀请"))) {
    
    // 填充业主姓名（如果前端没有提供）
    if (appointment.getOwnername() == null || appointment.getOwnername().isEmpty()) {
        if (foundApplication.getOwnerName() != null && !foundApplication.getOwnerName().isEmpty()) {
            appointment.setOwnername(foundApplication.getOwnerName());
        }
    }
    
    // 填充业主手机号（如果前端没有提供）
    if (appointment.getOwnerphone() == null || appointment.getOwnerphone().isEmpty()) {
        if (foundApplication.getOwnerPhone() != null && !foundApplication.getOwnerPhone().isEmpty()) {
            appointment.setOwnerphone(foundApplication.getOwnerPhone());
        }
    }
}
```

### 2. VisitorApplicationMapper.xml

优化了 `getByPhone` 查询，优先返回已通过审核且包含业主信息的记录：

```xml
<select id="getByPhone" parameterType="String" resultMap="BaseResultMap">
    SELECT
    <include refid="Base_Column_List" />
    FROM visitor_application
    WHERE phone = #{phone}
    ORDER BY 
        CASE WHEN auditstatus = '已通过' THEN 1 ELSE 2 END,
        CASE WHEN owner_name IS NOT NULL AND owner_name != '' THEN 1 ELSE 2 END,
        applydate DESC
    LIMIT 1
</select>
```

## 使用场景

### 适用场景
- 访客已通过访客申请审核
- 访客申请记录中包含了完整的业主信息
- 访客使用相同手机号进行停车预约

### 不适用场景
- 管家代为预约（预约类型为 "代人"）
- 前端已明确提供业主信息
- 访客申请记录未通过审核
- 访客申请记录中缺少业主信息

## 日志记录

系统会记录详细的查询和填充过程：

```
INFO: 通过访客手机号查询访客申请记录: phone=13800138000, found=true
INFO: 找到访客申请记录: applicationNo=VA20250627001, auditstatus=已通过, ownerName=张三, ownerPhone=13900139000
INFO: 从访客申请记录中填充业主姓名: 张三
INFO: 从访客申请记录中填充业主手机号: 13900139000
INFO: 访客预约业主信息填充完成 - 业主姓名: 张三, 业主手机: 13900139000
```

## 部署步骤

1. **执行数据库脚本**
   ```bash
   mysql -u [用户名] -p [数据库名] < src/main/resources/sql/update_visitor_application_simple.sql
   ```

2. **重启应用服务**
   确保新的代码生效

3. **验证功能**
   - 创建访客申请记录（包含业主信息）
   - 使用访客手机号提交预约
   - 检查 appointment 表中是否自动填充了业主信息

## 注意事项

1. **数据一致性**：确保访客申请表中的业主信息准确完整
2. **性能影响**：增加了业主手机号索引，提高查询性能
3. **向后兼容**：不影响现有预约流程，仅在符合条件时自动填充
4. **错误处理**：如果查询失败，不会影响预约提交流程

## 测试建议

1. **正常场景测试**
   - 访客申请已通过审核且包含业主信息
   - 访客使用相同手机号提交预约
   - 验证业主信息是否正确填充

2. **边界条件测试**
   - 访客申请未通过审核
   - 访客申请缺少业主信息
   - 前端已提供业主信息的情况

3. **性能测试**
   - 大量数据下的查询性能
   - 并发预约场景下的稳定性 