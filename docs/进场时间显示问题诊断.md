# è¿›åœºæ—¶é—´æ˜¾ç¤ºé—®é¢˜è¯Šæ–­

## é—®é¢˜æè¿°
å¾®ä¿¡é€šçŸ¥è·³è½¬é“¾æ¥ä¸­çš„ `enterTime` å‚æ•°ä¸æ•°æ®åº“ `appointment` è¡¨ä¸­çš„ `arrivedate` ä¸ä¸€è‡´ã€‚

**ç¤ºä¾‹ï¼š**
- URL å‚æ•°ï¼š`enterTime=2025-12-12+08:30:27`
- æ•°æ®åº“å®é™…å€¼ï¼š`arrivedate=2025-12-12 07:14:27`ï¼ˆé»‘A11111ï¼‰

## ä»£ç æ£€æŸ¥

### 1. é€šçŸ¥å‘é€ä»£ç 
**æ–‡ä»¶ï¼š** `ParkingTimeoutMonitoringTask.java:339`
```java
weChatTemplateMessageService.sendParkingAlmostTimeoutNotification(
    openid,
    appointment.getPlatenumber(),
    appointment.getCommunity(),
    appointment.getArrivedate(),  // âœ… ä½¿ç”¨çš„æ˜¯ arrivedate
    remainingMinutes
);
```

**æ–‡ä»¶ï¼š** `ParkingTimeoutController.java:385`
```java
weChatTemplateMessageService.sendParkingAlmostTimeoutNotification(
    openid,
    appointment.getPlatenumber(),
    appointment.getCommunity(),
    appointment.getArrivedate(),  // âœ… ä½¿ç”¨çš„æ˜¯ arrivedate
    timeValue
);
```

### 2. å°ç¨‹åºè·³è½¬è·¯å¾„æ„å»º
**æ–‡ä»¶ï¼š** `WeChatTemplateMessageServiceImpl.java:497-502`
```java
String miniprogramPath = String.format(
    "pagesA/reservation/dataList/dataList?keyword=%s&enterTime=%s&autoExpand=true",
    java.net.URLEncoder.encode(plateNumber, "UTF-8"),
    java.net.URLEncoder.encode(enterTime, "UTF-8")  // enterTime æ¥è‡ªæ–¹æ³•å‚æ•°
);
```

## å¯èƒ½çš„åŸå› 

### åŸå› 1ï¼šæ•°æ®æŸ¥è¯¢æ—¶è·å–äº†é”™è¯¯çš„è®°å½•
å¯èƒ½æŸ¥è¯¢æ¡ä»¶ä¸å‡†ç¡®ï¼Œè·å–åˆ°äº†åŒä¸€è½¦ç‰Œçš„å…¶ä»–é¢„çº¦è®°å½•ã€‚

### åŸå› 2ï¼šarrivedate å­—æ®µåœ¨æŸå¤„è¢«ä¿®æ”¹
æ£€æŸ¥æ˜¯å¦æœ‰å®šæ—¶ä»»åŠ¡æˆ–å…¶ä»–é€»è¾‘ä¿®æ”¹äº† `arrivedate` å­—æ®µã€‚

### åŸå› 3ï¼šæ—¶åŒºè½¬æ¢é—®é¢˜
`arrivedate` æ˜¯ String ç±»å‹ï¼Œå¯èƒ½åœ¨æŸå¤„è¿›è¡Œäº†æ—¶åŒºè½¬æ¢ã€‚

## è¯Šæ–­æ­¥éª¤

### 1. æ£€æŸ¥æ•°æ®åº“å®é™…å€¼
```sql
SELECT 
    id,
    platenumber AS è½¦ç‰Œå·,
    arrivedate AS è¿›åœºæ—¶é—´_æ•°æ®åº“,
    recorddate AS é¢„çº¦æ—¶é—´,
    venuestatus AS è½¦è¾†çŠ¶æ€
FROM appointment 
WHERE platenumber = 'é»‘A11111'
  AND venuestatus = 'å·²è¿›åœº'
ORDER BY arrivedate DESC 
LIMIT 3;
```

### 2. æ·»åŠ è¯¦ç»†æ—¥å¿—
åœ¨ `sendParkingAlmostTimeoutNotification` æ–¹æ³•å¼€å§‹å¤„æ·»åŠ ï¼š
```java
log.info("ğŸ” [è¶…æ—¶é€šçŸ¥] è½¦ç‰Œ: {}, è¿›åœºæ—¶é—´: {}, å‰©ä½™åˆ†é’Ÿ: {}", 
    plateNumber, enterTime, remainingMinutes);
```

### 3. æ£€æŸ¥å®šæ—¶ä»»åŠ¡æŸ¥è¯¢é€»è¾‘
æŸ¥çœ‹ `ParkingTimeoutMonitoringTask` ä¸­è·å– `appointment` çš„æŸ¥è¯¢æ¡ä»¶ï¼š
- æ˜¯å¦æŒ‰ `arrivedate` æ’åºï¼Ÿ
- æ˜¯å¦æœ‰æ—¶é—´èŒƒå›´é™åˆ¶ï¼Ÿ
- æ˜¯å¦æ­£ç¡®è¿‡æ»¤äº†è½¦è¾†çŠ¶æ€ï¼Ÿ

## æ¨èè§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šåœ¨é€šçŸ¥å‘é€å‰æ·»åŠ éªŒè¯æ—¥å¿—
```java
private boolean sendNotificationToUser(String openid, Appointment appointment, 
        long remainingMinutes, String notificationType) {
    try {
        // ğŸ†• æ·»åŠ è¯¦ç»†æ—¥å¿—
        log.info("ğŸ“§ [é€šçŸ¥å‡†å¤‡] è½¦ç‰Œ: {}, è¿›åœºæ—¶é—´: {}, openid: {}", 
            appointment.getPlatenumber(), 
            appointment.getArrivedate(), 
            openid);
            
        java.util.Map<String, Object> sendResult = 
            weChatTemplateMessageService.sendParkingAlmostTimeoutNotification(
                openid,
                appointment.getPlatenumber(),
                appointment.getCommunity(),
                appointment.getArrivedate(),
                remainingMinutes
            );
        // ...
    }
}
```

### æ–¹æ¡ˆ2ï¼šåœ¨å°ç¨‹åºè·³è½¬è·¯å¾„æ„å»ºå¤„æ·»åŠ æ—¥å¿—
```java
// WeChatTemplateMessageServiceImpl.java
log.info("ğŸ”— [è·³è½¬æ„å»º] è½¦ç‰Œ: {}, è¿›åœºæ—¶é—´: {}, ç¼–ç å: {}", 
    plateNumber, 
    enterTime,
    java.net.URLEncoder.encode(enterTime, "UTF-8")
);
```

### æ–¹æ¡ˆ3ï¼šæ£€æŸ¥æŸ¥è¯¢é€»è¾‘
ç¡®ä¿æŸ¥è¯¢æ—¶æŒ‰æœ€æ–°çš„ `arrivedate` æ’åºï¼š
```java
// æŸ¥è¯¢è¯¥è½¦ç‰Œæœ€æ–°çš„å·²è¿›åœºè®°å½•
Appointment appointment = appointmentMapper.selectOne(
    new QueryWrapper<Appointment>()
        .eq("platenumber", plateNumber)
        .eq("venuestatus", "å·²è¿›åœº")
        .orderByDesc("arrivedate")
        .last("LIMIT 1")
);
```

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨
1. âœ… æ‰§è¡Œ SQL æŸ¥è¯¢ç¡®è®¤æ•°æ®åº“å®é™…å€¼
2. â³ æ·»åŠ è¯¦ç»†æ—¥å¿—åˆ°é€šçŸ¥å‘é€æ–¹æ³•
3. â³ é‡å¯åç«¯æœåŠ¡
4. â³ è§¦å‘è¶…æ—¶é€šçŸ¥ï¼ŒæŸ¥çœ‹æ—¥å¿—è¾“å‡º
5. â³ å¯¹æ¯”æ—¥å¿—ä¸­çš„æ—¶é—´ä¸æ•°æ®åº“å€¼
