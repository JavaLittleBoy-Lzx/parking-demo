# 巡检员超时通知测试方案

## 📋 测试目标
验证巡检员在值班和非值班状态下，是否能正确接收车辆超时提醒通知。

---

## ✅ 修改完成
已完成以下修改：
- ✅ 移除了邀请预约中向管家发送通知的逻辑
- ✅ 现在邀请预约只通知：**访客、业主、巡检员**

---

## 🔍 查询条件说明

根据 `PatrolServiceImpl.java` 中的实现，巡检员接收通知需要满足以下条件：

```java
LambdaQueryWrapper<Patrol> wrapper = new LambdaQueryWrapper<>();
wrapper.eq(Patrol::getCommunity, community)          // 1. 小区匹配
       .eq(Patrol::getNotificationEnabled, 1)        // 2. 值班状态开启
       .eq(Patrol::getStatus, "已确定")              // 3. 状态为"已确定"
       .isNotNull(Patrol::getOpenid);                // 4. 有openid（已绑定微信）
```

### 关键字段
| 字段 | 说明 | 测试要求 |
|------|------|----------|
| `notification_enabled` | 值班状态（0=下班，1=值班） | 测试时需要切换此字段 |
| `status` | 巡检员状态 | 必须为"已确定" |
| `openid` | 微信openid | 不能为空 |
| `community` | 所属小区 | 需与预约车辆小区一致 |

---

## 🧪 测试步骤

### 准备工作

#### 1. 确认测试用巡检员数据
```sql
-- 查询当前巡检员信息
SELECT id, username, phone, community, status, notification_enabled, openid
FROM patrol
WHERE community = '东北林业大学';  -- 替换为实际小区名称
```

#### 2. 确认测试预约数据
```sql
-- 查询近期预约，找一个即将超时的
SELECT id, platenumber, community, arrivedate, appointtype, openid, owneropenid
FROM appointment
WHERE community = '东北林业大学'
  AND arrivedate >= DATE_SUB(NOW(), INTERVAL 2 HOUR)
ORDER BY arrivedate DESC;
```

---

### 测试场景1：巡检员值班中（应该收到通知）

#### 步骤1：设置巡检员为值班状态
```sql
-- 设置巡检员为值班状态
UPDATE patrol
SET notification_enabled = 1,
    update_time = NOW()
WHERE id = 1;  -- 替换为实际巡检员ID
```

#### 步骤2：验证巡检员状态
```sql
-- 验证值班状态查询
SELECT id, username, community, notification_enabled, status, openid
FROM patrol
WHERE community = '东北林业大学'
  AND notification_enabled = 1
  AND status = '已确定'
  AND openid IS NOT NULL;
```

#### 步骤3：创建测试预约或等待定时任务执行
```sql
-- 方案A：修改现有预约的进场时间（模拟即将超时）
UPDATE appointment
SET arrivedate = DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 105 MINUTE), '%Y-%m-%d %H:%i:%s')
WHERE id = 123;  -- 替换为实际预约ID

-- 方案B：等待定时任务自动执行（每分钟执行一次）
-- 查看后端日志输出
```

#### 步骤4：观察后端日志
关注以下日志：
```
⏰ [定时任务] 停车超时监控开始执行
📋 [查询值班巡检员] 开始查询 - 小区: 东北林业大学
📋 [查询值班巡检员] 查询完成 - 小区: 东北林业大学, 值班人数: 1
📋 [超时提醒] 向 1 位值班巡检员发送通知 - 小区: 东北林业大学
✅ [定时任务] 即将超时提醒(剩余15分钟)(巡检员:XXX)发送成功 - openid: xxx
```

#### 步骤5：检查微信通知
- 打开巡检员绑定的微信
- 查看是否收到服务通知
- 通知内容应包含车牌号、小区、剩余时间等信息

---

### 测试场景2：巡检员下班（不应该收到通知）

#### 步骤1：设置巡检员为下班状态
```sql
-- 设置巡检员为下班状态
UPDATE patrol
SET notification_enabled = 0,
    update_time = NOW()
WHERE id = 1;  -- 替换为实际巡检员ID
```

#### 步骤2：验证无值班巡检员
```sql
-- 应该查询不到任何结果
SELECT id, username, community, notification_enabled, status, openid
FROM patrol
WHERE community = '东北林业大学'
  AND notification_enabled = 1
  AND status = '已确定'
  AND openid IS NOT NULL;
```

#### 步骤3：触发超时提醒
```sql
-- 修改预约时间触发提醒
UPDATE appointment
SET arrivedate = DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 110 MINUTE), '%Y-%m-%d %H:%i:%s')
WHERE id = 123;
```

#### 步骤4：观察后端日志
应该看到警告日志：
```
📋 [查询值班巡检员] 查询完成 - 小区: 东北林业大学, 值班人数: 0
⚠️ [查询值班巡检员] 小区 东北林业大学 当前无值班巡检员！
⚠️ [超时提醒] 小区 东北林业大学 当前无值班巡检员
```

#### 步骤5：确认未收到通知
- 巡检员微信不应该收到任何新通知

---

### 测试场景3：多个巡检员值班

#### 步骤1：设置多个巡检员值班
```sql
-- 设置2-3个巡检员为值班状态
UPDATE patrol
SET notification_enabled = 1,
    update_time = NOW()
WHERE id IN (1, 2, 3);  -- 替换为实际巡检员ID
```

#### 步骤2：触发超时提醒
```sql
UPDATE appointment
SET arrivedate = DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 115 MINUTE), '%Y-%m-%d %H:%i:%s')
WHERE id = 123;
```

#### 步骤3：验证所有值班巡检员都收到通知
- 观察日志中 `值班人数: 3`
- 每个巡检员都应该收到微信通知

---

## 📊 验证检查清单

### 后端日志验证
- [ ] 定时任务每分钟执行一次
- [ ] 正确查询到值班巡检员数量
- [ ] 发送通知时带有 `(巡检员:姓名)` 标识
- [ ] 发送成功有 ✅ 日志，失败有 ⚠️ 日志
- [ ] 下班时输出警告日志

### 数据库验证
```sql
-- 查看最近的通知发送记录（如果有记录表）
SELECT * FROM notification_log 
WHERE recipient_type = 'patrol'
ORDER BY create_time DESC
LIMIT 10;
```

### 微信通知验证
- [ ] 值班巡检员收到通知
- [ ] 下班巡检员未收到通知
- [ ] 通知内容准确（车牌、小区、时间）
- [ ] 点击通知可跳转小程序

---

## 🐛 常见问题排查

### 问题1：巡检员值班但未收到通知

**检查项：**
```sql
-- 1. 检查值班状态
SELECT notification_enabled FROM patrol WHERE id = 1;
-- 应该为 1

-- 2. 检查巡检员状态
SELECT status FROM patrol WHERE id = 1;
-- 应该为 "已确定"

-- 3. 检查openid
SELECT openid FROM patrol WHERE id = 1;
-- 不应该为 NULL

-- 4. 检查小区名称是否一致
SELECT community FROM patrol WHERE id = 1;
SELECT community FROM appointment WHERE id = 123;
-- 两者应该完全一致（包括空格）
```

### 问题2：日志显示发送成功但未收到微信通知

**检查项：**
- 检查微信模板消息配置是否正确
- 验证 openid 是否有效
- 查看微信公众平台后台的模板消息发送记录

### 问题3：定时任务未执行

**检查项：**
```java
// 确认 Spring Boot 启动类是否启用了定时任务
@EnableScheduling  // 必须有这个注解
```

---

## 🎯 预期结果

| 场景 | notification_enabled | status | openid | 预期结果 |
|------|---------------------|--------|--------|---------|
| 值班中 | 1 | 已确定 | 有值 | ✅ 收到通知 |
| 下班 | 0 | 已确定 | 有值 | ❌ 不收到通知 |
| 未确认 | 1 | 待审核 | 有值 | ❌ 不收到通知 |
| 未绑定 | 1 | 已确定 | NULL | ❌ 不收到通知 |

---

## 📝 测试记录模板

### 测试日期：________

| 测试场景 | 巡检员姓名 | 值班状态 | 是否收到通知 | 备注 |
|---------|----------|---------|------------|------|
| 场景1：值班中 | | 1 | ✅/❌ | |
| 场景2：下班 | | 0 | ✅/❌ | |
| 场景3：多人值班 | | 1 | ✅/❌ | |

### 问题记录
```
问题描述：

复现步骤：

错误日志：

解决方案：
```

---

## 🔧 快速测试命令

```sql
-- 快速切换值班状态（上班）
UPDATE patrol SET notification_enabled = 1 WHERE id = 1;

-- 快速切换值班状态（下班）
UPDATE patrol SET notification_enabled = 0 WHERE id = 1;

-- 模拟即将超时（剩余15分钟）
UPDATE appointment 
SET arrivedate = DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 105 MINUTE), '%Y-%m-%d %H:%i:%s')
WHERE id = 123;

-- 模拟即将超时（剩余5分钟）
UPDATE appointment 
SET arrivedate = DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 115 MINUTE), '%Y-%m-%d %H:%i:%s')
WHERE id = 123;

-- 模拟即将超时（剩余1分钟）
UPDATE appointment 
SET arrivedate = DATE_FORMAT(DATE_SUB(NOW(), INTERVAL 119 MINUTE), '%Y-%m-%d %H:%i:%s')
WHERE id = 123;

-- 查看实时日志（Linux）
tail -f ParkingDemo.log | grep "巡检员"

-- 查看实时日志（Windows PowerShell）
Get-Content ParkingDemo.log -Wait | Select-String "巡检员"
```
