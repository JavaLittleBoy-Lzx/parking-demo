# æ¶ˆæ¯å‘é€è®°å½•ç³»ç»Ÿ - å®é™…é›†æˆç¤ºä¾‹

## âš ï¸ é‡è¦è¯´æ˜

**ä½ é—®å¾—éå¸¸å¯¹ï¼** è¿™äº›è®°å½•åŠŸèƒ½**å¿…é¡»åœ¨å®é™…å‘é€é€šçŸ¥çš„åœ°æ–¹è°ƒç”¨**æ‰èƒ½ç”Ÿæ•ˆï¼

æˆ‘å·²ç»åˆ›å»ºäº†å®Œæ•´çš„è®°å½•ç³»ç»Ÿï¼Œä½†è¿˜éœ€è¦åœ¨ä»¥ä¸‹åœ°æ–¹é›†æˆï¼š

---

## ğŸ“ éœ€è¦é›†æˆçš„ä½ç½®

### 1. è¶…æ—¶é€šçŸ¥ï¼ˆå·²é›†æˆï¼‰âœ…
- **ä½ç½®**ï¼š`ParkingTimeoutMonitoringTask.java` - å®šæ—¶ä»»åŠ¡
- **çŠ¶æ€**ï¼šâœ… å·²ä½¿ç”¨å†…å­˜ç¼“å­˜å»é‡

### 2. è¿è§„åœè½¦å‘Šè­¦ âš ï¸
- **ä½ç½®**ï¼š`ViolationsController.java` - æ·»åŠ é»‘åå•æ—¶å‘é€é€šçŸ¥
- **çŠ¶æ€**ï¼šâŒ éœ€è¦é›†æˆè®°å½•åŠŸèƒ½

### 3. è¿›å‡ºåœºé€šçŸ¥ âš ï¸
- **ä½ç½®**ï¼šè¯†åˆ«åˆ°è½¦è¾†è¿›å‡ºåœºçš„ä»£ç 
- **çŠ¶æ€**ï¼šâŒ éœ€è¦é›†æˆè®°å½•åŠŸèƒ½

### 4. é»‘åå•é€šçŸ¥ âš ï¸ï¼ˆ**æ–°å¢åŠŸèƒ½**ï¼‰
- **ä½ç½®**ï¼š`ViolationsController.java` æˆ–é»‘åå•ç®¡ç†ä»£ç 
- **çŠ¶æ€**ï¼šâŒ éœ€è¦å®ç°+é›†æˆ

### 5. é¢„çº¦ç›¸å…³é€šçŸ¥ âš ï¸
- **ä½ç½®**ï¼šé¢„çº¦Controllerï¼ˆåˆ›å»ºé¢„çº¦ã€å®¡æ ¸é¢„çº¦ï¼‰
- **çŠ¶æ€**ï¼šâŒ éœ€è¦é›†æˆè®°å½•åŠŸèƒ½

---

## ğŸ’» é›†æˆç¤ºä¾‹

### ç¤ºä¾‹1ï¼šé»‘åå•é€šçŸ¥é›†æˆï¼ˆViolationsControllerï¼‰

```java
@RestController
@RequestMapping("/violations")
public class ViolationsController {

    @Resource
    private WeChatTemplateMessageService weChatTemplateMessageService;
    
    @Resource
    private NotificationLogService notificationLogService;

    /**
     * æ·»åŠ è½¦è¾†åˆ°é»‘åå•
     */
    @PostMapping("/add-to-blacklist")
    public Result addToBlacklist(@RequestBody BlacklistRequest request) {
        try {
            // 1. æ·»åŠ åˆ°é»‘åå•é€»è¾‘
            // ... åŸæœ‰çš„é»‘åå•æ·»åŠ é€»è¾‘ ...
            
            // 2. å‘é€é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
            sendBlacklistAddNotificationWithLog(
                request.getPlateNumber(),
                request.getOpenid(),
                request.getParkName(),
                request.getEnterTime(),
                request.getParkingDuration(),
                request.getBlacklistDays()
            );
            
            return Result.success("æ·»åŠ é»‘åå•æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("âŒ æ·»åŠ é»‘åå•å¤±è´¥", e);
            return Result.error("æ·»åŠ é»‘åå•å¤±è´¥");
        }
    }
    
    /**
     * å‘é€é»‘åå•é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
     */
    private void sendBlacklistAddNotificationWithLog(String plateNumber, String openid, 
            String parkName, String enterTime, String parkingDuration, Integer blacklistDays) {
        try {
            // 1. åˆ›å»ºé€šçŸ¥è®°å½•
            NotificationLog notificationLog = notificationLogService.createBlacklistAddLog(
                plateNumber,
                openid,
                "è¿è§„åœè½¦è¶…æ—¶",  // é»‘åå•åŸå› 
                blacklistDays,
                NotificationLog.ReceiverType.VISITOR
            );
            
            // è®¾ç½®é¢å¤–ä¿¡æ¯
            notificationLog.setParkName(parkName);
            notificationLog.setEntryTime(LocalDateTime.parse(enterTime, DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
            notificationLog.setParkingDuration(parkingDuration);
            
            // 2. å‘é€é€šçŸ¥
            Map<String, Object> result = weChatTemplateMessageService.sendBlacklistAddNotification(
                openid,
                plateNumber,
                parkName,
                enterTime,
                parkingDuration,
                blacklistDays
            );
            
            // 3. è®°å½•ç»“æœ
            if (Boolean.TRUE.equals(result.get("success"))) {
                notificationLog.setWechatMsgId((String) result.get("msgid"));
                notificationLogService.logSuccess(notificationLog);
                log.info("âœ… é»‘åå•é€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", plateNumber);
            } else {
                notificationLog.setErrorMessage((String) result.get("message"));
                notificationLogService.logFailure(notificationLog);
                log.warn("âš ï¸ é»‘åå•é€šçŸ¥å‘é€å¤±è´¥ - è½¦ç‰Œ: {}, åŸå› : {}", 
                    plateNumber, result.get("message"));
            }
            
        } catch (Exception e) {
            log.error("âŒ å‘é€é»‘åå•é€šçŸ¥å¼‚å¸¸ - è½¦ç‰Œ: {}", plateNumber, e);
        }
    }
}
```

---

### ç¤ºä¾‹2ï¼šè¿è§„é€šçŸ¥é›†æˆï¼ˆViolationsControllerï¼‰

```java
/**
 * å‘é€è¿è§„åœè½¦å‘Šè­¦é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
private void sendViolationNotificationWithLog(Appointment appointment, 
        String violationLocation, String openid, String receiverType) {
    try {
        // 1. è®¡ç®—åœè½¦æ—¶é•¿
        LocalDateTime arriveTime = LocalDateTime.parse(appointment.getArrivedate(), 
            DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        long parkingMinutes = Duration.between(arriveTime, LocalDateTime.now()).toMinutes();
        
        // 2. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createViolationLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            openid,
            violationLocation,
            (int) parkingMinutes,
            receiverType,
            appointment.getAppointtype()
        );
        
        // 3. å‘é€é€šçŸ¥
        String parkingDuration = formatParkingDuration(parkingMinutes);
        Map<String, Object> result = weChatTemplateMessageService.sendParkingViolationNotification(
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            violationLocation,
            parkingDuration,
            openid
        );
        
        // 4. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… è¿è§„é€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€è¿è§„é€šçŸ¥å¼‚å¸¸", e);
    }
}

// æ ¼å¼åŒ–åœè½¦æ—¶é•¿
private String formatParkingDuration(long minutes) {
    long hours = minutes / 60;
    long mins = minutes % 60;
    return hours + "å°æ—¶" + mins + "åˆ†é’Ÿ";
}
```

---

### ç¤ºä¾‹3ï¼šè¿›åœºé€šçŸ¥é›†æˆ

```java
@RestController
@RequestMapping("/parking")
public class ParkingController {

    @Resource
    private WeChatTemplateMessageService weChatTemplateMessageService;
    
    @Resource
    private NotificationLogService notificationLogService;

    /**
     * è½¦è¾†è¿›åœº
     */
    @PostMapping("/entry")
    public Result vehicleEntry(@RequestBody VehicleEntryRequest request) {
        try {
            // 1. å¤„ç†è¿›åœºé€»è¾‘
            Appointment appointment = processVehicleEntry(request);
            
            // 2. å‘é€è¿›åœºé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
            sendEntryNotificationWithLog(appointment);
            
            return Result.success("è¿›åœºæˆåŠŸ");
            
        } catch (Exception e) {
            log.error("âŒ è½¦è¾†è¿›åœºå¤±è´¥", e);
            return Result.error("è¿›åœºå¤±è´¥");
        }
    }
    
    /**
     * å‘é€è¿›åœºé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
     */
    private void sendEntryNotificationWithLog(Appointment appointment) {
        try {
            // å‘é€ç»™è®¿å®¢
            if (StringUtils.hasText(appointment.getOpenid())) {
                sendEntryNotificationToUser(appointment, appointment.getOpenid(), 
                    NotificationLog.ReceiverType.VISITOR);
            }
            
            // æ ¹æ®é¢„çº¦ç±»å‹å‘é€ç»™å…¶ä»–äºº
            if ("é‚€è¯·".equals(appointment.getAppointtype()) || "ä»£äºº".equals(appointment.getAppointtype())) {
                // å‘é€ç»™ç®¡å®¶
                if (StringUtils.hasText(appointment.getAudiopenid())) {
                    sendEntryNotificationToUser(appointment, appointment.getAudiopenid(), 
                        NotificationLog.ReceiverType.HOUSEKEEPER);
                }
                // å‘é€ç»™ä¸šä¸»
                if (StringUtils.hasText(appointment.getOwneropenid())) {
                    sendEntryNotificationToUser(appointment, appointment.getOwneropenid(), 
                        NotificationLog.ReceiverType.OWNER);
                }
            }
            
        } catch (Exception e) {
            log.error("âŒ å‘é€è¿›åœºé€šçŸ¥å¼‚å¸¸", e);
        }
    }
    
    /**
     * å‘é€è¿›åœºé€šçŸ¥ç»™æŒ‡å®šç”¨æˆ·
     */
    private void sendEntryNotificationToUser(Appointment appointment, String openid, String receiverType) {
        try {
            // 1. åˆ›å»ºé€šçŸ¥è®°å½•
            NotificationLog notificationLog = notificationLogService.createEntryLog(
                appointment.getId(),
                appointment.getPlatenumber(),
                openid,
                appointment.getCommunity(),
                LocalDateTime.parse(appointment.getArrivedate(), 
                    DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")),
                receiverType
            );
            
            // 2. å‘é€é€šçŸ¥ï¼ˆå‡è®¾ä½ æœ‰è¿™ä¸ªæ–¹æ³•ï¼‰
            Map<String, Object> result = weChatTemplateMessageService.sendVehicleEntryNotification(
                openid,
                appointment.getPlatenumber(),
                appointment.getCommunity(),
                appointment.getArrivedate()
            );
            
            // 3. è®°å½•ç»“æœ
            if (Boolean.TRUE.equals(result.get("success"))) {
                notificationLog.setWechatMsgId((String) result.get("msgid"));
                notificationLogService.logSuccess(notificationLog);
            } else {
                notificationLog.setErrorMessage((String) result.get("message"));
                notificationLogService.logFailure(notificationLog);
            }
            
        } catch (Exception e) {
            log.error("âŒ å‘é€è¿›åœºé€šçŸ¥å¼‚å¸¸ - openid: {}", openid, e);
        }
    }
}
```

---

### ç¤ºä¾‹4ï¼šé¢„çº¦æˆåŠŸé€šçŸ¥é›†æˆ

```java
@RestController
@RequestMapping("/appointment")
public class AppointmentController {

    @Resource
    private WeChatTemplateMessageService weChatTemplateMessageService;
    
    @Resource
    private NotificationLogService notificationLogService;

    /**
     * åˆ›å»ºé¢„çº¦
     */
    @PostMapping("/create")
    public Result createAppointment(@RequestBody AppointmentRequest request) {
        try {
            // 1. åˆ›å»ºé¢„çº¦
            Appointment appointment = saveAppointment(request);
            
            // 2. å‘é€é¢„çº¦æˆåŠŸé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
            sendAppointmentSuccessNotificationWithLog(appointment);
            
            return Result.success("é¢„çº¦æˆåŠŸ");
            
        } catch (Exception e) {
            log.error("âŒ åˆ›å»ºé¢„çº¦å¤±è´¥", e);
            return Result.error("é¢„çº¦å¤±è´¥");
        }
    }
    
    /**
     * å‘é€é¢„çº¦æˆåŠŸé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
     */
    private void sendAppointmentSuccessNotificationWithLog(Appointment appointment) {
        try {
            String openid = appointment.getOpenid();
            if (!StringUtils.hasText(openid)) {
                log.warn("âš ï¸ è®¿å®¢openidä¸ºç©ºï¼Œæ— æ³•å‘é€é¢„çº¦æˆåŠŸé€šçŸ¥");
                return;
            }
            
            // 1. åˆ›å»ºé€šçŸ¥è®°å½•
            NotificationLog notificationLog = notificationLogService.createAppointmentSuccessLog(
                appointment.getId(),
                appointment.getPlatenumber(),
                openid,
                appointment.getCommunity(),
                appointment.getVisitdate(),
                NotificationLog.ReceiverType.VISITOR,
                appointment.getAppointtype()
            );
            
            // 2. å‘é€é€šçŸ¥
            Map<String, Object> result = weChatTemplateMessageService.sendAppointmentSuccessNotification(
                openid,
                appointment.getPlatenumber(),
                appointment.getCommunity(),
                appointment.getVisitdate(),
                appointment.getOwnername()
            );
            
            // 3. è®°å½•ç»“æœ
            if (Boolean.TRUE.equals(result.get("success"))) {
                notificationLog.setWechatMsgId((String) result.get("msgid"));
                notificationLogService.logSuccess(notificationLog);
                log.info("âœ… é¢„çº¦æˆåŠŸé€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
            } else {
                notificationLog.setErrorMessage((String) result.get("message"));
                notificationLogService.logFailure(notificationLog);
            }
            
        } catch (Exception e) {
            log.error("âŒ å‘é€é¢„çº¦æˆåŠŸé€šçŸ¥å¼‚å¸¸", e);
        }
    }
}
```

---

### ç¤ºä¾‹5ï¼šé¢„çº¦å®¡æ ¸ç»“æœé€šçŸ¥é›†æˆ

```java
/**
 * å®¡æ ¸é¢„çº¦
 */
@PostMapping("/audit")
public Result auditAppointment(@RequestBody AuditRequest request) {
    try {
        // 1. æ›´æ–°å®¡æ ¸çŠ¶æ€
        Appointment appointment = updateAuditStatus(request);
        
        // 2. å‘é€å®¡æ ¸ç»“æœé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
        sendAuditResultNotificationWithLog(
            appointment, 
            request.isApproved(),
            request.getReason()
        );
        
        return Result.success("å®¡æ ¸æˆåŠŸ");
        
    } catch (Exception e) {
        log.error("âŒ å®¡æ ¸å¤±è´¥", e);
        return Result.error("å®¡æ ¸å¤±è´¥");
    }
}

/**
 * å‘é€å®¡æ ¸ç»“æœé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
private void sendAuditResultNotificationWithLog(Appointment appointment, 
        boolean isApproved, String reason) {
    try {
        String openid = appointment.getOpenid();
        if (!StringUtils.hasText(openid)) {
            log.warn("âš ï¸ è®¿å®¢openidä¸ºç©ºï¼Œæ— æ³•å‘é€å®¡æ ¸ç»“æœé€šçŸ¥");
            return;
        }
        
        String auditStatus = isApproved ? "é€šè¿‡" : "æ‹’ç»";
        
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createAppointmentAuditLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            openid,
            appointment.getCommunity(),
            appointment.getVisitdate(),
            auditStatus,
            reason,
            NotificationLog.ReceiverType.VISITOR
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendAppointmentAuditResultNotification(
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            auditStatus,
            reason,
            appointment.getVisitdate(),
            appointment.getVisitorname(),
            appointment.getAuditname()
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… å®¡æ ¸ç»“æœé€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}, ç»“æœ: {}", 
                appointment.getPlatenumber(), auditStatus);
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€å®¡æ ¸ç»“æœé€šçŸ¥å¼‚å¸¸", e);
    }
}
```

---

## ğŸ“‹ é›†æˆæ¸…å•

| åŠŸèƒ½ | ä½ç½® | æ–¹æ³• | çŠ¶æ€ |
|------|------|------|------|
| **è¶…æ—¶é€šçŸ¥** | `ParkingTimeoutMonitoringTask` | `checkParkingTimeout()` | âœ… å·²é›†æˆï¼ˆå†…å­˜ç¼“å­˜ï¼‰ |
| **è¿è§„é€šçŸ¥** | `ViolationsController` | æ·»åŠ é»‘åå•æ—¶ | âŒ éœ€è¦é›†æˆ |
| **é»‘åå•é€šçŸ¥** | `ViolationsController` | `addToBlacklist()` | âŒ **æ–°åŠŸèƒ½**éœ€è¦å®ç° |
| **è¿›åœºé€šçŸ¥** | è¯†åˆ«è¿›åœºçš„Controller | è½¦è¾†è¿›åœºæ—¶ | âŒ éœ€è¦é›†æˆ |
| **å‡ºåœºé€šçŸ¥** | è¯†åˆ«å‡ºåœºçš„Controller | è½¦è¾†å‡ºåœºæ—¶ | âŒ éœ€è¦é›†æˆ |
| **é¢„çº¦æˆåŠŸ** | `AppointmentController` | `createAppointment()` | âŒ éœ€è¦é›†æˆ |
| **å¾…å®¡æ ¸æé†’** | `AppointmentController` | `createAppointment()` | âŒ éœ€è¦é›†æˆ |
| **å®¡æ ¸ç»“æœ** | `AppointmentController` | `auditAppointment()` | âŒ éœ€è¦é›†æˆ |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 1. æ‰§è¡ŒSQLåˆ›å»ºè¡¨
```bash
mysql -u root -p parking_db < src/main/resources/sql/notification_log.sql
```

### 2. åœ¨application.propertiesä¸­é…ç½®é»‘åå•æ¨¡æ¿ID
```properties
# è½¦è¾†åŠ å…¥é»‘åå•æˆåŠŸé€šçŸ¥æ¨¡æ¿ID
wechat.template.blacklist.add=VULfsba-5E9TXmEwZQZN57zg4rXh46xmka_wfoMpAnk
```

### 3. ä¾æ¬¡åœ¨å„Controllerä¸­é›†æˆè®°å½•åŠŸèƒ½
æŒ‰ç…§ä¸Šé¢çš„ç¤ºä¾‹ï¼Œåœ¨å®é™…å‘é€é€šçŸ¥çš„åœ°æ–¹é›†æˆè®°å½•åŠŸèƒ½ã€‚

---

## âœ¨ é›†æˆåçš„å¥½å¤„

1. âœ… **å®Œæ•´çš„å‘é€å†å²**ï¼šæ‰€æœ‰é€šçŸ¥éƒ½æœ‰è®°å½•
2. âœ… **é˜²æ­¢é‡å¤å‘é€**ï¼šåŸºäºæ•°æ®åº“åˆ¤æ–­ï¼Œæ¯”å†…å­˜ç¼“å­˜æ›´å¯é 
3. âœ… **ä¾¿äºé—®é¢˜æ’æŸ¥**ï¼šå¯ä»¥æŸ¥è¯¢æŸè¾†è½¦çš„æ‰€æœ‰é€šçŸ¥å†å²
4. âœ… **ç»Ÿè®¡åˆ†æ**ï¼šå¯ä»¥ç»Ÿè®¡å„ç±»å‹é€šçŸ¥çš„æˆåŠŸç‡
5. âœ… **å®¡è®¡è¿½æº¯**ï¼šå®Œæ•´çš„å®¡è®¡æ—¥å¿—

---

**åˆ›å»ºæ—¶é—´**ï¼š2024-12-04  
**ä½œè€…**ï¼šAI Assistant
