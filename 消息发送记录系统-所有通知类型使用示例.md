# æ¶ˆæ¯å‘é€è®°å½•ç³»ç»Ÿ - æ‰€æœ‰é€šçŸ¥ç±»å‹ä½¿ç”¨ç¤ºä¾‹

## ğŸ“‹ æ”¯æŒçš„é€šçŸ¥ç±»å‹

### 1. **è¶…æ—¶é€šçŸ¥**ï¼ˆ3ç§ï¼‰
- `timeout_15min` - åœè½¦å³å°†è¶…æ—¶15åˆ†é’Ÿæé†’
- `timeout_5min` - åœè½¦å³å°†è¶…æ—¶5åˆ†é’Ÿæé†’
- `timeout_1min` - åœè½¦å³å°†è¶…æ—¶1åˆ†é’Ÿæé†’

### 2. **è¿è§„é€šçŸ¥**
- `violation` - è½¦è¾†è¿è§„åœè½¦å‘Šè­¦é€šçŸ¥

### 3. **è¿›å‡ºåœºé€šçŸ¥**ï¼ˆ2ç§ï¼‰
- `entry` - è½¦è¾†è¿›åœºé€šçŸ¥
- `exit` - è½¦è¾†å‡ºåœºé€šçŸ¥

### 4. **é»‘åå•é€šçŸ¥**
- `blacklist_add` - è½¦è¾†åŠ å…¥é»‘åå•æˆåŠŸé€šçŸ¥

### 5. **é¢„çº¦é€šçŸ¥**ï¼ˆ3ç§ï¼‰
- `appointment_success` - é¢„çº¦æˆåŠŸæé†’
- `appointment_pending` - é¢„çº¦è½¦è¾†å¾…å®¡æ ¸æé†’
- `appointment_audit` - åœè½¦åœºé¢„çº¦å®¡æ ¸ç»“æœé€šçŸ¥

---

## ğŸ’» ä½¿ç”¨ç¤ºä¾‹

### 1. è¶…æ—¶é€šçŸ¥ï¼ˆå®šæ—¶ä»»åŠ¡ï¼‰

```java
@Resource
private NotificationLogService notificationLogService;
@Resource
private WeChatTemplateMessageService weChatTemplateMessageService;

/**
 * å‘é€è¶…æ—¶é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
private boolean sendTimeoutNotificationWithLog(Appointment appointment, long remainingMinutes, String openid, String receiverType) {
    try {
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createTimeoutLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            openid,
            (int) remainingMinutes,  // é€šçŸ¥æ—¶é—´ç‚¹ï¼ˆ15/5/1ï¼‰
            (int) remainingMinutes,  // å‰©ä½™æ—¶é—´
            receiverType,
            appointment.getAppointtype()
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendParkingAlmostTimeoutNotification(
            openid,
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getArrivedate(),
            remainingMinutes
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            return true;
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
            return false;
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€è¶…æ—¶é€šçŸ¥å¼‚å¸¸", e);
        return false;
    }
}
```

---

### 2. è¿è§„åœè½¦å‘Šè­¦é€šçŸ¥

```java
/**
 * å‘é€è¿è§„åœè½¦å‘Šè­¦é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendViolationNotificationWithLog(Appointment appointment, String violationLocation, String openid, String receiverType) {
    try {
        // 1. è®¡ç®—åœè½¦æ—¶é•¿
        long parkingMinutes = calculateParkingMinutes(appointment.getArrivedate());
        
        // 2. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createViolationLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            openid,
            violationLocation,
            (int) parkingMinutes,
            receiverType,
            appointment.getAppointtype()
        );
        
        // 3. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendParkingViolationNotification(
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            violationLocation,
            formatParkingDuration(parkingMinutes),
            openid
        );
        
        // 4. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… è¿è§„é€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
            log.warn("âš ï¸ è¿è§„é€šçŸ¥å‘é€å¤±è´¥ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€è¿è§„é€šçŸ¥å¼‚å¸¸", e);
    }
}
```

---

### 3. è½¦è¾†è¿›åœºé€šçŸ¥

```java
/**
 * å‘é€è½¦è¾†è¿›åœºé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendEntryNotificationWithLog(Appointment appointment) {
    try {
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createEntryLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            appointment.getOpenid(),  // è®¿å®¢openid
            appointment.getCommunity(),
            LocalDateTime.parse(appointment.getArrivedate(), DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")),
            NotificationLog.ReceiverType.VISITOR
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendVehicleEntryNotification(
            appointment.getOpenid(),
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getArrivedate()
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… è¿›åœºé€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€è¿›åœºé€šçŸ¥å¼‚å¸¸", e);
    }
}
```

---

### 4. è½¦è¾†å‡ºåœºé€šçŸ¥

```java
/**
 * å‘é€è½¦è¾†å‡ºåœºé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendExitNotificationWithLog(Appointment appointment) {
    try {
        // 1. è®¡ç®—åœè½¦æ—¶é•¿
        LocalDateTime entryTime = LocalDateTime.parse(appointment.getArrivedate(), DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        LocalDateTime exitTime = LocalDateTime.parse(appointment.getLeavedate(), DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));
        Duration duration = Duration.between(entryTime, exitTime);
        String parkingDuration = formatDuration(duration);
        
        // 2. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createExitLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            appointment.getOpenid(),
            appointment.getCommunity(),
            entryTime,
            exitTime,
            parkingDuration,
            NotificationLog.ReceiverType.VISITOR
        );
        
        // 3. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendVehicleExitNotification(
            appointment.getOpenid(),
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getArrivedate(),
            appointment.getLeavedate(),
            parkingDuration
        );
        
        // 4. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… å‡ºåœºé€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}, åœè½¦æ—¶é•¿: {}", appointment.getPlatenumber(), parkingDuration);
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€å‡ºåœºé€šçŸ¥å¼‚å¸¸", e);
    }
}

// æ ¼å¼åŒ–åœè½¦æ—¶é•¿
private String formatDuration(Duration duration) {
    long hours = duration.toHours();
    long minutes = duration.toMinutes() % 60;
    return String.format("%då°æ—¶%dåˆ†é’Ÿ", hours, minutes);
}
```

---

### 5. åŠ å…¥é»‘åå•é€šçŸ¥

```java
/**
 * å‘é€åŠ å…¥é»‘åå•é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendBlacklistAddNotificationWithLog(String plateNumber, String openid, String reason, int days) {
    try {
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createBlacklistAddLog(
            plateNumber,
            openid,
            reason,
            days,
            NotificationLog.ReceiverType.VISITOR
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendBlacklistAddNotification(
            openid,
            plateNumber,
            reason,
            days
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… é»‘åå•é€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}, åŸå› : {}, å¤©æ•°: {}", plateNumber, reason, days);
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€é»‘åå•é€šçŸ¥å¼‚å¸¸", e);
    }
}
```

---

### 6. é¢„çº¦æˆåŠŸé€šçŸ¥

```java
/**
 * å‘é€é¢„çº¦æˆåŠŸé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendAppointmentSuccessNotificationWithLog(Appointment appointment) {
    try {
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createAppointmentSuccessLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            appointment.getOpenid(),
            appointment.getCommunity(),
            appointment.getVisitdate(),
            NotificationLog.ReceiverType.VISITOR,
            appointment.getAppointtype()
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendAppointmentSuccessNotification(
            appointment.getOpenid(),
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getVisitdate()
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… é¢„çº¦æˆåŠŸé€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€é¢„çº¦æˆåŠŸé€šçŸ¥å¼‚å¸¸", e);
    }
}
```

---

### 7. é¢„çº¦å¾…å®¡æ ¸æé†’ï¼ˆå‘ç»™ç®¡å®¶ï¼‰

```java
/**
 * å‘é€é¢„çº¦å¾…å®¡æ ¸æé†’ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendAppointmentPendingNotificationWithLog(Appointment appointment, String housekeeperOpenid) {
    try {
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createAppointmentPendingLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            housekeeperOpenid,  // å‘é€ç»™ç®¡å®¶
            appointment.getCommunity(),
            appointment.getVisitdate(),
            NotificationLog.ReceiverType.HOUSEKEEPER
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendAppointmentPendingNotification(
            housekeeperOpenid,
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getVisitdate(),
            appointment.getOwnername()
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… å¾…å®¡æ ¸æé†’å‘é€æˆåŠŸ - è½¦ç‰Œ: {}", appointment.getPlatenumber());
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€å¾…å®¡æ ¸æé†’å¼‚å¸¸", e);
    }
}
```

---

### 8. é¢„çº¦å®¡æ ¸ç»“æœé€šçŸ¥

```java
/**
 * å‘é€é¢„çº¦å®¡æ ¸ç»“æœé€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 * @param isApproved true=å®¡æ ¸é€šè¿‡, false=å®¡æ ¸æ‹’ç»
 */
public void sendAppointmentAuditNotificationWithLog(Appointment appointment, boolean isApproved, String reason) {
    try {
        String auditStatus = isApproved ? "é€šè¿‡" : "æ‹’ç»";
        
        // 1. åˆ›å»ºé€šçŸ¥è®°å½•
        NotificationLog notificationLog = notificationLogService.createAppointmentAuditLog(
            appointment.getId(),
            appointment.getPlatenumber(),
            appointment.getOpenid(),  // å‘é€ç»™è®¿å®¢
            appointment.getCommunity(),
            appointment.getVisitdate(),
            auditStatus,
            reason,
            NotificationLog.ReceiverType.VISITOR
        );
        
        // 2. å‘é€é€šçŸ¥
        Map<String, Object> result = weChatTemplateMessageService.sendAppointmentAuditNotification(
            appointment.getOpenid(),
            appointment.getPlatenumber(),
            appointment.getCommunity(),
            appointment.getVisitdate(),
            auditStatus,
            reason
        );
        
        // 3. è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            notificationLog.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(notificationLog);
            log.info("âœ… å®¡æ ¸ç»“æœé€šçŸ¥å‘é€æˆåŠŸ - è½¦ç‰Œ: {}, ç»“æœ: {}", appointment.getPlatenumber(), auditStatus);
        } else {
            notificationLog.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(notificationLog);
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€å®¡æ ¸ç»“æœé€šçŸ¥å¼‚å¸¸", e);
    }
}
```

---

## ğŸ“Š æŸ¥è¯¢ç»Ÿè®¡ç¤ºä¾‹

### 1. æŸ¥è¯¢æŸè¾†è½¦çš„æ‰€æœ‰é€šçŸ¥å†å²

```java
List<NotificationLog> logs = notificationLogService.getByPlateNumber("äº¬A12345", 100);

for (NotificationLog log : logs) {
    System.out.println(String.format(
        "æ—¶é—´: %s | ç±»å‹: %s | çŠ¶æ€: %s | æ¥æ”¶è€…: %s",
        log.getSendTime(),
        log.getNotificationType(),
        log.getSendStatus() == 1 ? "æˆåŠŸ" : "å¤±è´¥",
        log.getReceiverType()
    ));
}
```

### 2. ç»Ÿè®¡å„ç±»å‹é€šçŸ¥çš„å‘é€æƒ…å†µï¼ˆæœ€è¿‘7å¤©ï¼‰

```java
LocalDateTime startTime = LocalDateTime.now().minusDays(7);
LocalDateTime endTime = LocalDateTime.now();

List<Map<String, Object>> stats = notificationLogService.getStatisticsByType(startTime, endTime);

for (Map<String, Object> stat : stats) {
    System.out.println(String.format(
        "é€šçŸ¥ç±»å‹: %s | æ€»æ•°: %s | æˆåŠŸ: %s | å¤±è´¥: %s | æˆåŠŸç‡: %s%%",
        stat.get("notificationType"),
        stat.get("totalCount"),
        stat.get("successCount"),
        stat.get("failCount"),
        stat.get("successRate")
    ));
}

// è¾“å‡ºç¤ºä¾‹ï¼š
// é€šçŸ¥ç±»å‹: timeout_15min | æ€»æ•°: 100 | æˆåŠŸ: 95 | å¤±è´¥: 5 | æˆåŠŸç‡: 95.00%
// é€šçŸ¥ç±»å‹: entry | æ€»æ•°: 200 | æˆåŠŸ: 198 | å¤±è´¥: 2 | æˆåŠŸç‡: 99.00%
// é€šçŸ¥ç±»å‹: exit | æ€»æ•°: 180 | æˆåŠŸ: 180 | å¤±è´¥: 0 | æˆåŠŸç‡: 100.00%
```

### 3. æŸ¥è¯¢å‘é€å¤±è´¥çš„é€šçŸ¥

```java
LocalDateTime today = LocalDateTime.now().withHour(0).withMinute(0).withSecond(0);
LocalDateTime tomorrow = today.plusDays(1);

List<NotificationLog> failed = notificationLogService.getFailedNotifications(today, tomorrow);

log.warn("ä»Šå¤©å‘é€å¤±è´¥çš„é€šçŸ¥æ•°é‡: {}", failed.size());
for (NotificationLog log : failed) {
    log.warn("å¤±è´¥é€šçŸ¥ - è½¦ç‰Œ: {}, ç±»å‹: {}, åŸå› : {}", 
        log.getPlateNumber(), 
        log.getNotificationType(), 
        log.getErrorMessage()
    );
}
```

---

## ğŸ¯ é€šçŸ¥ç±»å‹å¸¸é‡ä½¿ç”¨

```java
// è¶…æ—¶é€šçŸ¥
NotificationLog.NotificationType.TIMEOUT_15MIN
NotificationLog.NotificationType.TIMEOUT_5MIN
NotificationLog.NotificationType.TIMEOUT_1MIN

// è¿è§„é€šçŸ¥
NotificationLog.NotificationType.VIOLATION

// è¿›å‡ºåœºé€šçŸ¥
NotificationLog.NotificationType.ENTRY
NotificationLog.NotificationType.EXIT

// é»‘åå•é€šçŸ¥
NotificationLog.NotificationType.BLACKLIST_ADD

// é¢„çº¦é€šçŸ¥
NotificationLog.NotificationType.APPOINTMENT_SUCCESS
NotificationLog.NotificationType.APPOINTMENT_PENDING
NotificationLog.NotificationType.APPOINTMENT_AUDIT

// å‘é€çŠ¶æ€
NotificationLog.SendStatus.SUCCESS  // 1 - æˆåŠŸ
NotificationLog.SendStatus.FAILED   // 0 - å¤±è´¥
NotificationLog.SendStatus.SKIPPED  // 2 - è·³è¿‡ï¼ˆé‡å¤ï¼‰

// æ¥æ”¶è€…ç±»å‹
NotificationLog.ReceiverType.VISITOR      // visitor - è®¿å®¢
NotificationLog.ReceiverType.OWNER        // owner - ä¸šä¸»
NotificationLog.ReceiverType.HOUSEKEEPER  // housekeeper - ç®¡å®¶
```

---

## âœ¨ æœ€ä½³å®è·µ

### 1. ç»Ÿä¸€çš„å‘é€å°è£…

```java
/**
 * ç»Ÿä¸€çš„å‘é€é€šçŸ¥æ–¹æ³•ï¼ˆå¸¦è®°å½•ï¼‰
 */
private boolean sendNotificationWithLog(NotificationLog log, Supplier<Map<String, Object>> sendAction) {
    try {
        // å‘é€é€šçŸ¥
        Map<String, Object> result = sendAction.get();
        
        // è®°å½•ç»“æœ
        if (Boolean.TRUE.equals(result.get("success"))) {
            log.setWechatMsgId((String) result.get("msgid"));
            notificationLogService.logSuccess(log);
            return true;
        } else {
            log.setErrorMessage((String) result.get("message"));
            notificationLogService.logFailure(log);
            return false;
        }
    } catch (Exception e) {
        log.error("âŒ å‘é€é€šçŸ¥å¼‚å¸¸", e);
        return false;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
NotificationLog log = notificationLogService.createEntryLog(...);
sendNotificationWithLog(log, () -> 
    weChatTemplateMessageService.sendVehicleEntryNotification(...)
);
```

### 2. æ‰¹é‡å‘é€

```java
/**
 * æ‰¹é‡å‘é€é€šçŸ¥ï¼ˆå¸¦è®°å½•ï¼‰
 */
public void sendBatchNotifications(List<Appointment> appointments, String notificationType) {
    int successCount = 0;
    int failCount = 0;
    
    for (Appointment appointment : appointments) {
        NotificationLog log = createLogByType(appointment, notificationType);
        boolean sent = sendNotificationWithLog(log, () -> sendByType(appointment, notificationType));
        
        if (sent) {
            successCount++;
        } else {
            failCount++;
        }
    }
    
    log.info("æ‰¹é‡å‘é€å®Œæˆ - æˆåŠŸ: {}, å¤±è´¥: {}", successCount, failCount);
}
```

---

**åˆ›å»ºæ—¶é—´**ï¼š2024-12-04  
**ä½œè€…**ï¼šAI Assistant  
**ç‰ˆæœ¬**ï¼šv2.0ï¼ˆæ”¯æŒæ‰€æœ‰é€šçŸ¥ç±»å‹ï¼‰
