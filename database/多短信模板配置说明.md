# è½¦åœºå¤šçŸ­ä¿¡æ¨¡æ¿é…ç½®åŠŸèƒ½è¯´æ˜

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

è½¦åœºç°åœ¨æ”¯æŒå…³è”**å¤šä¸ªçŸ­ä¿¡æ¨¡æ¿**ï¼Œè€Œä¸æ˜¯ä¹‹å‰çš„å•ä¸ªæ¨¡æ¿ã€‚ä¸€ä¸ªè½¦åœºå¯ä»¥åŒæ—¶é…ç½®å¤šä¸ªçŸ­ä¿¡æ¨¡æ¿ï¼Œç”¨äºä¸åŒåœºæ™¯çš„æ¶ˆæ¯å‘é€ï¼ˆå¦‚è¿è§„æé†’ã€åœè½¦è¶…æ—¶ç­‰ï¼‰ã€‚

## ğŸ”„ æ¶æ„å˜æ›´

### ä»å•é€‰åˆ°å¤šé€‰çš„æ¶æ„å‡çº§

#### ä¹‹å‰çš„è®¾è®¡ï¼ˆå•é€‰ï¼‰
```
yard_info è¡¨
â”œâ”€â”€ id
â”œâ”€â”€ yard_code
â”œâ”€â”€ yard_name
â”œâ”€â”€ yard_no
â””â”€â”€ sms_template_id  â† ä¸€ä¸ªè½¦åœºåªèƒ½å…³è”ä¸€ä¸ªæ¨¡æ¿
```

#### æ–°çš„è®¾è®¡ï¼ˆå¤šé€‰ - å¤šå¯¹å¤šå…³ç³»ï¼‰
```
yard_info è¡¨                    yard_sms_template_relation è¡¨              sms_template è¡¨
â”œâ”€â”€ id                          â”œâ”€â”€ id                                     â”œâ”€â”€ id
â”œâ”€â”€ yard_code                   â”œâ”€â”€ yard_id (å¤–é”®)                         â”œâ”€â”€ template_name
â”œâ”€â”€ yard_name                   â”œâ”€â”€ sms_template_id (å¤–é”®)                 â”œâ”€â”€ sign_name
â””â”€â”€ yard_no                     â”œâ”€â”€ template_usage                         â”œâ”€â”€ template_code
                                â”œâ”€â”€ is_default                             â””â”€â”€ template_type
                                â””â”€â”€ deleted
```

**ä¼˜åŠ¿**ï¼š
- âœ… ä¸€ä¸ªè½¦åœºå¯ä»¥å…³è”å¤šä¸ªçŸ­ä¿¡æ¨¡æ¿
- âœ… æ”¯æŒè®¾ç½®é»˜è®¤æ¨¡æ¿ï¼ˆç¬¬ä¸€ä¸ªé€‰æ‹©çš„æ¨¡æ¿è‡ªåŠ¨è®¾ä¸ºé»˜è®¤ï¼‰
- âœ… å¯ä»¥ä¸ºä¸åŒç±»å‹çš„æ¶ˆæ¯é…ç½®ä¸åŒæ¨¡æ¿
- âœ… çµæ´»æ‰©å±•ï¼Œæ˜“äºç»´æŠ¤

## ğŸ“Š æ•°æ®åº“å˜æ›´

### 1. æ–°å¢å…³è”è¡¨

æ‰§è¡ŒSQLè„šæœ¬ï¼š`sms_template_relation.sql`

```sql
-- åˆ›å»ºè½¦åœºçŸ­ä¿¡æ¨¡æ¿å…³è”è¡¨
CREATE TABLE `yard_sms_template_relation` (
  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `yard_id` int(11) NOT NULL COMMENT 'è½¦åœºID',
  `sms_template_id` int(11) NOT NULL COMMENT 'çŸ­ä¿¡æ¨¡æ¿ID',
  `template_usage` int(11) DEFAULT NULL COMMENT 'æ¨¡æ¿ç”¨é€”ï¼š1-è¿è§„æé†’ï¼Œ2-åœè½¦è¶…æ—¶ï¼Œ3-å…¶ä»–',
  `is_default` tinyint(1) DEFAULT 0 COMMENT 'æ˜¯å¦ä¸ºé»˜è®¤æ¨¡æ¿ï¼š0-å¦ï¼Œ1-æ˜¯',
  `deleted` int(11) DEFAULT 0 COMMENT 'é€»è¾‘åˆ é™¤æ ‡è¯†ï¼š0-æœªåˆ é™¤ï¼Œ1-å·²åˆ é™¤',
  `gmt_create` datetime DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `gmt_modified` datetime DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  PRIMARY KEY (`id`),
  KEY `idx_yard_id` (`yard_id`),
  KEY `idx_sms_template_id` (`sms_template_id`),
  UNIQUE KEY `uk_yard_template` (`yard_id`, `sms_template_id`, `deleted`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è½¦åœºçŸ­ä¿¡æ¨¡æ¿å…³è”è¡¨';
```

### 2. å…³äº yard_info è¡¨çš„ sms_template_id å­—æ®µ

ä¹‹å‰æ·»åŠ çš„ `sms_template_id` å­—æ®µå¯ä»¥ï¼š
- **ä¿ç•™**ï¼šä½œä¸ºå¿«é€Ÿè®¿é—®å­—æ®µï¼Œå­˜å‚¨é»˜è®¤æ¨¡æ¿ID
- **åˆ é™¤**ï¼šå®Œå…¨ä½¿ç”¨å…³è”è¡¨ç®¡ç†ï¼Œæ•°æ®æ›´è§„èŒƒ

å»ºè®®ï¼š**ä¿ç•™ä½†ä¸å†å¼ºåˆ¶ä½¿ç”¨**ï¼Œç³»ç»Ÿä¼˜å…ˆä»å…³è”è¡¨è¯»å–æ•°æ®ã€‚

## ğŸ”§ åç«¯å®ç°

### 1. æ–°å¢å®ä½“ç±»

**YardSmsTemplateRelation.java** - å…³è”å…³ç³»å®ä½“
```java
public class YardSmsTemplateRelation {
    private Integer id;
    private Integer yardId;           // è½¦åœºID
    private Integer smsTemplateId;    // æ¨¡æ¿ID
    private Integer templateUsage;    // æ¨¡æ¿ç”¨é€”
    private Integer isDefault;        // æ˜¯å¦é»˜è®¤
    // ...
}
```

### 2. æ–°å¢ Mapper å’Œ Service

**YardSmsTemplateRelationMapper.java**
- `selectTemplateIdsByYardId(yardId)` - æŸ¥è¯¢è½¦åœºçš„æ‰€æœ‰æ¨¡æ¿ID
- `deleteByYardId(yardId)` - åˆ é™¤è½¦åœºçš„æ‰€æœ‰å…³è”
- `batchInsert(relations)` - æ‰¹é‡æ’å…¥å…³è”

**YardSmsTemplateRelationService.java**
- `getTemplateIdsByYardId(yardId)` - è·å–æ¨¡æ¿IDåˆ—è¡¨
- `updateYardTemplates(yardId, templateIds)` - æ›´æ–°è½¦åœºæ¨¡æ¿ï¼ˆå…ˆåˆ åå¢ï¼‰
- `deleteByYardId(yardId)` - åˆ é™¤æ‰€æœ‰å…³è”

### 3. ä¿®æ”¹ YardInfoController

**æ–°å¢/ä¿®æ”¹çš„æ–¹æ³•å‚æ•°ä» `YardInfo` æ”¹ä¸º `Map<String, Object>`**ï¼Œä»¥æ¥æ”¶æ¨¡æ¿IDæ•°ç»„ï¼š

```java
@PostMapping
public ResponseEntity<Result> insertYardInfo(@RequestBody Map<String, Object> params) {
    // æå–è½¦åœºåŸºæœ¬ä¿¡æ¯
    YardInfo yardInfo = new YardInfo();
    yardInfo.setYardCode((String) params.get("yardCode"));
    yardInfo.setYardName((String) params.get("yardName"));
    yardInfo.setYardNo((Integer) params.get("yardNo"));
    
    // ä¿å­˜è½¦åœºä¿¡æ¯
    yardInfoService.save(yardInfo);
    
    // å¤„ç†çŸ­ä¿¡æ¨¡æ¿å…³è”
    List<Integer> templateIds = (List<Integer>) params.get("smsTemplateIds");
    if (templateIds != null && !templateIds.isEmpty()) {
        yardSmsTemplateRelationService.updateYardTemplates(yardInfo.getId(), templateIds);
    }
}
```

**æ–°å¢æ¥å£**ï¼š
- `GET /parking/yardInfo/{yardId}/templates` - æŸ¥è¯¢è½¦åœºå…³è”çš„æ¨¡æ¿IDåˆ—è¡¨

## ğŸ¨ å‰ç«¯å®ç°

### 1. ä¿®æ”¹è½¦åœºç®¡ç†é¡µé¢ (YardInfo.vue)

#### è¡¨å•æ•°æ®ç»“æ„å˜æ›´

**ä¹‹å‰ï¼ˆå•é€‰ï¼‰**ï¼š
```javascript
form.data = {
    id: '',
    yardCode: '',
    yardName: '',
    yardNo: '',
    smsTemplateId: null  // å•ä¸ªID
}
```

**ç°åœ¨ï¼ˆå¤šé€‰ï¼‰**ï¼š
```javascript
form.data = {
    id: '',
    yardCode: '',
    yardName: '',
    yardNo: '',
    smsTemplateIds: []  // IDæ•°ç»„
}
```

#### ç»„ä»¶å˜æ›´

**ä¹‹å‰ï¼ˆå•é€‰ä¸‹æ‹‰æ¡†ï¼‰**ï¼š
```vue
<el-select v-model="form.data.smsTemplateId" placeholder="è¯·é€‰æ‹©çŸ­ä¿¡æ¨¡æ¿">
    <el-option v-for="template in smsTemplateList" 
               :key="template.id"
               :label="template.templateName" 
               :value="template.id">
    </el-option>
</el-select>
```

**ç°åœ¨ï¼ˆå¤šé€‰ä¸‹æ‹‰æ¡†ï¼‰**ï¼š
```vue
<el-select 
    v-model="form.data.smsTemplateIds" 
    placeholder="è¯·é€‰æ‹©çŸ­ä¿¡æ¨¡æ¿ï¼ˆå¯å¤šé€‰ï¼‰"
    multiple
    collapse-tags
    collapse-tags-tooltip>
    <el-option v-for="template in smsTemplateList" 
               :key="template.id"
               :label="template.templateName" 
               :value="template.id">
    </el-option>
</el-select>
```

**Element Plus å¤šé€‰å±æ€§è¯´æ˜**ï¼š
- `multiple` - å¯ç”¨å¤šé€‰
- `collapse-tags` - æŠ˜å æ˜¾ç¤ºå¤šä¸ªæ ‡ç­¾
- `collapse-tags-tooltip` - é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå®Œæ•´æ ‡ç­¾åˆ—è¡¨

#### é€‰ä¸­æ¨¡æ¿å±•ç¤º

```vue
<div v-if="selectedTemplates && selectedTemplates.length > 0" class="templates-list-box">
    <div class="templates-list-header">
        <el-icon><Document /></el-icon>
        <span>å·²é€‰æ‹© {{ selectedTemplates.length }} ä¸ªæ¨¡æ¿</span>
    </div>
    <div class="template-info-box" v-for="(template, index) in selectedTemplates" :key="template.id">
        <div class="template-badge">
            <el-tag :type="index === 0 ? 'success' : 'info'" size="small">
                {{ index === 0 ? 'é»˜è®¤' : `æ¨¡æ¿${index + 1}` }}
            </el-tag>
        </div>
        <!-- æ¨¡æ¿è¯¦ç»†ä¿¡æ¯ -->
    </div>
</div>
```

#### ç¼–è¾‘æ—¶åŠ è½½æ¨¡æ¿æ•°æ®

```javascript
const handleEdit = (row) => {
    dialogVisible.value = true
    form.data.id = row.id
    form.data.yardCode = row.yardCode
    form.data.yardName = row.yardName
    form.data.yardNo = row.yardNo
    
    // è·å–è¯¥è½¦åœºå…³è”çš„æ¨¡æ¿IDåˆ—è¡¨
    request.get(`/parking/yardInfo/${row.id}/templates`).then((res) => {
        if (res.data.data) {
            form.data.smsTemplateIds = res.data.data;
            handleTemplateChange(res.data.data);
        }
    });
};
```

## ğŸ¯ ä½¿ç”¨æµç¨‹

### 1. ä¸ºè½¦åœºæ·»åŠ å¤šä¸ªçŸ­ä¿¡æ¨¡æ¿

1. è¿›å…¥"è½¦åœºä¿¡æ¯ç®¡ç†"é¡µé¢
2. ç‚¹å‡»"æ–°å¢è½¦åœº"æˆ–"ç¼–è¾‘"ç°æœ‰è½¦åœº
3. å¡«å†™è½¦åœºåŸºæœ¬ä¿¡æ¯
4. åœ¨"çŸ­ä¿¡æ¨¡æ¿é…ç½®"åŒºåŸŸï¼Œç‚¹å‡»ä¸‹æ‹‰æ¡†
5. **é€‰æ‹©å¤šä¸ªæ¨¡æ¿**ï¼ˆæŒ‰ä½ Ctrl æˆ– Cmd é”®å¤šé€‰ï¼‰
6. ç³»ç»Ÿä¼šæ˜¾ç¤ºå·²é€‰æ‹©çš„æ‰€æœ‰æ¨¡æ¿è¯¦æƒ…
7. **ç¬¬ä¸€ä¸ªé€‰æ‹©çš„æ¨¡æ¿ä¼šè‡ªåŠ¨æ ‡è®°ä¸º"é»˜è®¤"**
8. ç‚¹å‡»"ç¡®å®š"ä¿å­˜

### 2. æ¨¡æ¿æ˜¾ç¤ºè§„åˆ™

- ç¬¬ä¸€ä¸ªæ¨¡æ¿æ˜¾ç¤ºç»¿è‰²"é»˜è®¤"æ ‡ç­¾
- å…¶ä»–æ¨¡æ¿æ˜¾ç¤º"æ¨¡æ¿2"ã€"æ¨¡æ¿3"ç­‰æ ‡ç­¾
- æ¯ä¸ªæ¨¡æ¿å¡ç‰‡æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼š
  - æ¨¡æ¿åç§°
  - æ¨¡æ¿ç­¾å
  - æ¨¡æ¿CODE
  - æ¨¡æ¿æè¿°

### 3. ç¼–è¾‘è½¦åœºæ¨¡æ¿

1. ç‚¹å‡»"ç¼–è¾‘"æŒ‰é’®
2. ç³»ç»Ÿè‡ªåŠ¨åŠ è½½è¯¥è½¦åœºå·²å…³è”çš„æ‰€æœ‰æ¨¡æ¿
3. å¯ä»¥æ·»åŠ æ–°æ¨¡æ¿ã€åˆ é™¤å·²æœ‰æ¨¡æ¿æˆ–é‡æ–°æ’åº
4. ä¿å­˜åï¼Œç³»ç»Ÿä¼šå…ˆåˆ é™¤æ—§å…³è”ï¼Œå†å»ºç«‹æ–°å…³è”

## ğŸ“¡ API æ¥å£å˜æ›´

### æ–°å¢æ¥å£

```
GET /parking/yardInfo/{yardId}/templates
åŠŸèƒ½ï¼šæŸ¥è¯¢è½¦åœºå…³è”çš„çŸ­ä¿¡æ¨¡æ¿IDåˆ—è¡¨
è¿”å›ï¼š{ "data": [1, 2, 3], "code": null, "msg": null }
```

### ä¿®æ”¹çš„æ¥å£

```
POST /parking/yardInfo
PUT /parking/yardInfo

è¯·æ±‚å‚æ•°å˜æ›´ï¼š
{
    "id": 1,
    "yardCode": "P001",
    "yardName": "ä¸œåœè½¦åœº",
    "yardNo": 1,
    "smsTemplateIds": [1, 2, 3]  â† æ”¹ä¸ºæ•°ç»„
}
```

## ğŸ” æ•°æ®æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢æŸä¸ªè½¦åœºçš„æ‰€æœ‰çŸ­ä¿¡æ¨¡æ¿

```sql
SELECT 
    y.id as yard_id,
    y.yard_name,
    st.id as template_id,
    st.template_name,
    st.sign_name,
    st.template_code,
    st.template_type,
    r.is_default,
    r.template_usage
FROM yard_info y
INNER JOIN yard_sms_template_relation r ON y.id = r.yard_id
INNER JOIN sms_template st ON r.sms_template_id = st.id
WHERE y.id = 1 
  AND r.deleted = 0 
  AND st.deleted = 0
ORDER BY r.is_default DESC, r.gmt_create ASC;
```

### æŸ¥è¯¢ä½¿ç”¨æŸä¸ªæ¨¡æ¿çš„æ‰€æœ‰è½¦åœº

```sql
SELECT 
    y.id,
    y.yard_name,
    y.yard_code,
    r.is_default
FROM yard_info y
INNER JOIN yard_sms_template_relation r ON y.id = r.yard_id
WHERE r.sms_template_id = 1 
  AND r.deleted = 0
ORDER BY y.yard_name;
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é»˜è®¤æ¨¡æ¿**ï¼šç¬¬ä¸€ä¸ªé€‰æ‹©çš„æ¨¡æ¿è‡ªåŠ¨è®¾ä¸ºé»˜è®¤ï¼Œåœ¨å…³è”è¡¨ä¸­ `is_default = 1`

2. **æ•°æ®ä¸€è‡´æ€§**ï¼šæ›´æ–°æ“ä½œé‡‡ç”¨"å…ˆåˆ åå¢"ç­–ç•¥ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§

3. **æ€§èƒ½è€ƒè™‘**ï¼šä½¿ç”¨æ‰¹é‡æ’å…¥æé«˜æ€§èƒ½ï¼Œé¿å…é€æ¡æ’å…¥

4. **é€»è¾‘åˆ é™¤**ï¼šåˆ é™¤æ“ä½œä¸ºé€»è¾‘åˆ é™¤ï¼ˆ`deleted = 1`ï¼‰ï¼Œæ•°æ®å¯æ¢å¤

5. **å”¯ä¸€æ€§çº¦æŸ**ï¼šåŒä¸€ä¸ªè½¦åœºä¸èƒ½é‡å¤å…³è”åŒä¸€ä¸ªæ¨¡æ¿ï¼ˆæ•°æ®åº“å”¯ä¸€ç´¢å¼•ä¿è¯ï¼‰

6. **å…¼å®¹æ€§**ï¼šå¦‚æœä¹‹å‰å·²æœ‰ä½¿ç”¨ `sms_template_id` å­—æ®µçš„æ•°æ®ï¼Œéœ€è¦æ‰‹åŠ¨è¿ç§»åˆ°å…³è”è¡¨

## ğŸ”„ æ•°æ®è¿ç§»ï¼ˆå¯é€‰ï¼‰

å¦‚æœä¹‹å‰å·²ç»æœ‰è½¦åœºé…ç½®äº†å•ä¸ªæ¨¡æ¿ï¼Œéœ€è¦è¿ç§»æ•°æ®ï¼š

```sql
-- å°† yard_info è¡¨ä¸­çš„å•æ¨¡æ¿å…³è”è¿ç§»åˆ°å…³è”è¡¨
INSERT INTO yard_sms_template_relation (yard_id, sms_template_id, is_default, deleted)
SELECT 
    id as yard_id,
    sms_template_id,
    1 as is_default,
    0 as deleted
FROM yard_info
WHERE sms_template_id IS NOT NULL
  AND deleted = 0
ON DUPLICATE KEY UPDATE 
    is_default = 1,
    gmt_modified = NOW();

-- è¿ç§»å®Œæˆåï¼Œå¯ä»¥é€‰æ‹©æ¸…ç©º yard_info çš„ sms_template_id å­—æ®µ
-- UPDATE yard_info SET sms_template_id = NULL WHERE deleted = 0;
```

## âœ… åŠŸèƒ½ä¼˜åŠ¿

1. **çµæ´»æ€§**ï¼šä¸€ä¸ªè½¦åœºå¯ä»¥é…ç½®å¤šä¸ªæ¨¡æ¿ï¼Œé€‚åº”ä¸åŒä¸šåŠ¡åœºæ™¯
2. **æ‰©å±•æ€§**ï¼šæ”¯æŒæŒ‰æ¨¡æ¿ç”¨é€”åˆ†ç±»ï¼ˆè¿è§„æé†’ã€åœè½¦è¶…æ—¶ç­‰ï¼‰
3. **æ˜“ç”¨æ€§**ï¼šå‰ç«¯å¤šé€‰ç•Œé¢å‹å¥½ï¼Œå®æ—¶æ˜¾ç¤ºå·²é€‰æ¨¡æ¿
4. **å¯ç»´æŠ¤æ€§**ï¼šå…³è”è¡¨è®¾è®¡æ¸…æ™°ï¼Œæ˜“äºæŸ¥è¯¢å’Œç®¡ç†
5. **å‘ä¸‹å…¼å®¹**ï¼šä¿ç•™åŸæœ‰å­—æ®µï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½

## ğŸ‰ æ€»ç»“

é€šè¿‡å¼•å…¥å…³è”è¡¨å®ç°è½¦åœºå’ŒçŸ­ä¿¡æ¨¡æ¿çš„å¤šå¯¹å¤šå…³ç³»ï¼Œç³»ç»Ÿçš„çµæ´»æ€§å’Œå¯æ‰©å±•æ€§éƒ½å¾—åˆ°äº†æ˜¾è‘—æå‡ã€‚ç”¨æˆ·å¯ä»¥ä¸ºæ¯ä¸ªè½¦åœºé…ç½®å¤šä¸ªçŸ­ä¿¡æ¨¡æ¿ï¼Œæ»¡è¶³ä¸åŒåœºæ™¯ä¸‹çš„æ¶ˆæ¯å‘é€éœ€æ±‚ã€‚

