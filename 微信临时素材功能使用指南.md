# 微信临时素材功能使用指南

## 功能概述

实现了微信临时素材上传、客服消息发送和定时刷新功能，用于在用户关注公众号时自动发送包含小程序二维码的欢迎消息。

## 主要特性

1. **临时素材上传**：支持图片、语音、视频等素材上传到微信服务器
2. **客服消息发送**：用户关注时自动发送欢迎语和小程序卡片
3. **自动刷新机制**：定时任务确保素材不会过期（临时素材有效期3天）
4. **前端管理界面**：可视化管理上传的素材

## 技术实现

### 后端架构

#### 1. 实体类
- **WeChatTempMedia**：临时素材实体，存储media_id等信息
- 位置：`com.parkingmanage.entity.WeChatTempMedia`

#### 2. 服务层
- **WeChatTempMediaService**：临时素材管理服务
  - 上传素材到微信服务器
  - 获取有效的media_id
  - 刷新过期的素材
  
- **WeChatCustomMessageService**：客服消息服务
  - 发送文本消息
  - 发送图片消息
  - 发送小程序卡片
  - 发送欢迎消息（组合消息）

#### 3. 控制器
- **WeChatTempMediaController**：临时素材管理接口
  - POST `/parking/wechat/media/upload`：上传素材
  - GET `/parking/wechat/media/getMediaId`：获取有效的media_id
  - GET `/parking/wechat/media/getInfo`：查询素材信息
  - POST `/parking/wechat/media/refresh`：手动刷新指定素材
  - POST `/parking/wechat/media/refreshAll`：批量刷新所有素材

#### 4. 定时任务
- **WeChatMediaRefreshTask**：自动刷新任务
  - 每2天凌晨3点执行（cron: `0 0 3 1/2 * ?`）
  - 每天凌晨2点检查即将过期的素材（备用）

### 前端界面

**位置**：`manage-front/src/views/wechat/tempMedia.vue`

**功能**：
- 上传新素材
- 查看已上传的素材列表
- 手动刷新单个或所有素材
- 查看media_id
- 显示素材过期状态

## 配置步骤

### 1. 数据库配置

执行SQL脚本创建数据表：

```bash
# 位置：src/main/resources/sql/wechat_temp_media.sql
mysql -u用户名 -p密码 数据库名 < wechat_temp_media.sql
```

### 2. 应用配置

在 `application.yml` 或 `application.properties` 中添加配置：

```yaml
wechat:
  public:
    appid: 你的公众号AppID
    secret: 你的公众号AppSecret
  miniapp:
    appid: 你的小程序AppID
  welcome:
    text: 欢迎关注！您可以通过小程序进行停车预约、查询等操作。
  temp:
    media:
      storage:
        path: d:/temp/wechat/media/  # 素材本地存储路径（Windows）
        # path: /var/temp/wechat/media/  # Linux路径
```

### 3. 启用定时任务

确保Spring Boot应用启用了定时任务：

```java
@SpringBootApplication
@EnableScheduling  // 添加此注解
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
}
```

### 4. 前端路由配置

在前端路由配置中添加页面路由：

```javascript
{
  path: '/wechat',
  component: Layout,
  children: [
    {
      path: 'tempMedia',
      name: 'TempMedia',
      component: () => import('@/views/wechat/tempMedia'),
      meta: { title: '临时素材管理', icon: 'upload' }
    }
  ]
}
```

## 使用流程

### 1. 上传小程序二维码

1. 登录管理后台
2. 进入"临时素材管理"页面
3. 选择素材类型：图片
4. 填写素材用途：小程序二维码
5. 上传小程序码图片（建议大小：430x430像素）
6. 点击上传

### 2. 用户关注触发欢迎消息

当用户关注公众号时，系统会自动：

1. 保存用户信息到`user_mapping`表
2. 发送欢迎文本消息
3. 延迟500ms后发送小程序卡片（包含二维码）

### 3. 查看和管理素材

在管理页面可以：
- 查看所有已上传的素材
- 查看素材状态和过期时间
- 手动刷新即将过期的素材
- 批量刷新所有素材

## API接口说明

### 上传临时素材

```http
POST /parking/wechat/media/upload
Content-Type: multipart/form-data

参数：
- file: 文件
- mediaType: 素材类型（image/voice/video/thumb）
- description: 素材用途说明

响应：
{
  "code": "0",
  "msg": "上传成功",
  "data": {
    "success": true,
    "mediaId": "xxx",
    "createdAt": 1234567890,
    "message": "上传成功"
  }
}
```

### 获取有效的media_id

```http
GET /parking/wechat/media/getMediaId?description=小程序二维码

响应：
{
  "code": "0",
  "msg": "查询成功",
  "data": "media_id_string"
}
```

### 手动刷新素材

```http
POST /parking/wechat/media/refresh?description=小程序二维码

响应：
{
  "code": "0",
  "msg": "刷新成功"
}
```

### 批量刷新所有素材

```http
POST /parking/wechat/media/refreshAll

响应：
{
  "code": "0",
  "msg": "批量刷新完成",
  "data": 3  // 成功刷新的数量
}
```

## 注意事项

### 1. 临时素材限制

- **有效期**：3天（72小时）
- **图片大小**：不超过2MB
- **图片格式**：支持JPG、PNG、GIF
- **语音大小**：不超过2MB，时长不超过60秒
- **视频大小**：不超过10MB

### 2. 客服消息限制

- 只能在用户与公众号互动后的48小时内发送
- 用户关注事件后可立即发送
- 每天发送次数有限制（根据公众号类型不同）

### 3. media_id复用

- media_id可以在有效期内多次使用
- 建议保存到数据库，避免重复上传
- 过期后需要重新上传获取新的media_id

### 4. 定时任务说明

- **主任务**：每2天凌晨3点刷新所有素材
- **备用任务**：每天凌晨2点检查即将过期的素材
- 双重保险确保素材不会过期
- 可根据实际需求调整cron表达式

### 5. 本地文件存储

- 系统会自动保存上传的文件到本地
- 用于定时任务重新上传
- 确保存储路径有足够的磁盘空间
- Windows和Linux路径格式不同，需相应配置

## 故障排查

### 问题1：上传失败

**可能原因**：
- access_token获取失败
- 文件大小超限
- 网络连接问题

**解决方法**：
1. 检查公众号appid和secret配置
2. 检查文件大小和格式
3. 查看日志中的错误信息

### 问题2：欢迎消息发送失败

**可能原因**：
- media_id已过期
- 用户已取消关注
- 客服消息权限不足

**解决方法**：
1. 手动刷新素材获取新的media_id
2. 检查用户关注状态
3. 确认公众号有客服消息权限

### 问题3：定时任务不执行

**可能原因**：
- 未启用@EnableScheduling
- 服务器时区问题
- 应用未持续运行

**解决方法**：
1. 在启动类添加@EnableScheduling注解
2. 检查服务器时区设置
3. 确保应用以服务形式持续运行

## 扩展功能建议

### 1. 永久素材支持

可以扩展支持永久素材管理，永久素材无需定时刷新。

### 2. 多种消息类型

可以扩展支持更多客服消息类型：
- 图文消息
- 音乐消息
- 视频消息
- 文章消息

### 3. 消息模板

可以创建多种欢迎消息模板，根据不同场景发送不同内容。

### 4. 统计分析

记录消息发送情况，分析用户关注和互动数据。

## 技术支持

如有问题，请查看：
- 微信官方文档：https://developers.weixin.qq.com/doc/
- 临时素材接口：https://developers.weixin.qq.com/doc/service/api/material/temporary/api_uploadtempmedia.html
- 客服消息接口：https://developers.weixin.qq.com/doc/service/api/customer/message/api_sendcustommessage.html
