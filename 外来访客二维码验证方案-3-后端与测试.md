# å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ - ç¬¬3éƒ¨åˆ†ï¼šåç«¯å®ç°ä¸æµ‹è¯•

## ç›®å½•
- [8. åç«¯å®ç°](#8-åç«¯å®ç°)
- [9. æµ‹è¯•åœºæ™¯](#9-æµ‹è¯•åœºæ™¯)
- [10. éƒ¨ç½²ä¸Šçº¿](#10-éƒ¨ç½²ä¸Šçº¿)

---

## 8. åç«¯å®ç°

### 8.1 ExternalVisitorController.java

```java
package com.parkingmanage.controller;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.parkingmanage.entity.ParkingLot;
import com.parkingmanage.entity.QrVisitorUsage;
import com.parkingmanage.entity.VisitorToken;
import com.parkingmanage.service.ParkingLotService;
import com.parkingmanage.service.QrVisitorUsageService;
import com.parkingmanage.service.VisitorTokenService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.web.bind.annotation.*;

import javax.annotation.Resource;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.util.HashMap;
import java.util.Map;
import java.util.UUID;

/**
 * å¤–æ¥è®¿å®¢éªŒè¯æ§åˆ¶å™¨
 */
@RestController
@RequestMapping("/visitor")
public class ExternalVisitorController {
    
    private static final Logger logger = LoggerFactory.getLogger(ExternalVisitorController.class);
    
    @Resource
    private ParkingLotService parkingLotService;
    
    @Resource
    private QrVisitorUsageService qrVisitorUsageService;
    
    @Resource
    private VisitorTokenService visitorTokenService;
    
    // é…ç½®å‚æ•°
    private static final int MAX_DISTANCE = 500;           // æœ€å¤§å…è®¸è·ç¦»ï¼ˆç±³ï¼‰
    private static final int TOKEN_EXPIRE_MINUTES = 5;     // Tokenæœ‰æ•ˆæœŸï¼ˆåˆ†é’Ÿï¼‰
    private static final int IDENTITY_EXPIRE_HOURS = 24;   // èº«ä»½æœ‰æ•ˆæœŸï¼ˆå°æ—¶ï¼‰
    private static final int MAX_USES_PER_DAY = 3;         // æ¯å¤©æœ€å¤šä½¿ç”¨æ¬¡æ•°
    
    /**
     * éªŒè¯å¹¶è·å–Tokenï¼ˆGPSä½ç½®éªŒè¯ + Tokenç”Ÿæˆï¼‰
     */
    @PostMapping("/verifyAndGetToken")
    public Map<String, Object> verifyAndGetToken(
            @RequestParam String qrId,
            @RequestParam String phone,
            @RequestParam Double latitude,
            @RequestParam Double longitude) {
        
        logger.info("ğŸ“ å¼€å§‹éªŒè¯å¤–æ¥è®¿å®¢: qrId={}, phone={}, ä½ç½®=({}, {})", 
            qrId, phone, latitude, longitude);
        
        try {
            // ç¬¬ä¸€æ­¥ï¼šéªŒè¯ä½ç½®
            ParkingLot parking = parkingLotService.getOne(
                new QueryWrapper<ParkingLot>().eq("qr_id", qrId)
            );
            
            if (parking == null) {
                logger.warn("âŒ è½¦åœºä¸å­˜åœ¨: qrId={}", qrId);
                return error("è½¦åœºä¸å­˜åœ¨");
            }
            
            // è®¡ç®—è·ç¦»
            double distance = calculateDistance(
                latitude, longitude,
                parking.getLatitude(), parking.getLongitude()
            );
            
            logger.info("ğŸ“ è®¡ç®—è·ç¦»: {}ç±³, è½¦åœº={}", distance, parking.getName());
            
            // éªŒè¯è·ç¦»
            int maxRadius = parking.getLocationRadius() != null ? 
                parking.getLocationRadius() : MAX_DISTANCE;
                
            if (distance > maxRadius) {
                logger.warn("âŒ ä½ç½®éªŒè¯å¤±è´¥: è·ç¦»{}ç±³ > æœ€å¤§å…è®¸{}ç±³", distance, maxRadius);
                return error(String.format(
                    "è¯·åœ¨è½¦åœºç°åœºæ‰«ç ï¼Œå½“å‰è·ç¦»%.1få…¬é‡Œ", distance / 1000));
            }
            
            logger.info("âœ… ä½ç½®éªŒè¯é€šè¿‡: è·ç¦»{}ç±³ < æœ€å¤§å…è®¸{}ç±³", distance, maxRadius);
            
            // ç¬¬äºŒæ­¥ï¼šæ£€æŸ¥ä½¿ç”¨è®°å½•
            QrVisitorUsage usage = qrVisitorUsageService.getOne(
                new QueryWrapper<QrVisitorUsage>()
                    .eq("qr_id", qrId)
                    .eq("phone", phone)
            );
            
            LocalDateTime now = LocalDateTime.now();
            LocalDateTime expiresAt = now.plusHours(IDENTITY_EXPIRE_HOURS);
            
            if (usage == null) {
                // é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºè®°å½•
                logger.info("ğŸ†• é¦–æ¬¡ä½¿ç”¨ï¼Œåˆ›å»ºè®°å½•");
                usage = new QrVisitorUsage();
                usage.setQrId(qrId);
                usage.setPhone(phone);
                usage.setFirstScanTime(now);
                usage.setLastScanTime(now);
                usage.setExpiresAt(expiresAt);
                usage.setScanCount(1);
                usage.setTotalCount(1);
                usage.setLastLatitude(latitude);
                usage.setLastLongitude(longitude);
                usage.setLastDistance(distance);
                usage.setStatus("active");
                qrVisitorUsageService.save(usage);
                
            } else {
                // å·²æœ‰è®°å½•ï¼Œæ£€æŸ¥æ˜¯å¦è¿‡æœŸ
                if (now.isAfter(usage.getExpiresAt())) {
                    // å·²è¿‡æœŸï¼Œé‡æ–°åˆ›å»º
                    logger.info("â° è®°å½•å·²è¿‡æœŸï¼Œé‡æ–°åˆ›å»º");
                    usage.setFirstScanTime(now);
                    usage.setExpiresAt(expiresAt);
                    usage.setScanCount(1);
                } else {
                    // æ£€æŸ¥ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°
                    LocalDate today = LocalDate.now();
                    LocalDate lastScanDate = usage.getLastScanTime().toLocalDate();
                    
                    if (lastScanDate.equals(today)) {
                        // ä»Šå¤©çš„è®°å½•
                        if (usage.getScanCount() >= MAX_USES_PER_DAY) {
                            logger.warn("âŒ ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™: {}/{}", 
                                usage.getScanCount(), MAX_USES_PER_DAY);
                            return error(String.format(
                                "ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™(%dæ¬¡)ï¼Œè¯·æ˜å¤©å†è¯•", MAX_USES_PER_DAY));
                        }
                        usage.setScanCount(usage.getScanCount() + 1);
                    } else {
                        // æ–°çš„ä¸€å¤©ï¼Œé‡ç½®è®¡æ•°
                        usage.setScanCount(1);
                    }
                }
                
                // æ›´æ–°è®°å½•
                usage.setLastScanTime(now);
                usage.setTotalCount(usage.getTotalCount() + 1);
                usage.setLastLatitude(latitude);
                usage.setLastLongitude(longitude);
                usage.setLastDistance(distance);
                qrVisitorUsageService.updateById(usage);
            }
            
            logger.info("ğŸ“ ä½¿ç”¨è®°å½•æ›´æ–°å®Œæˆ: ä»Šæ—¥ç¬¬{}æ¬¡, ç´¯è®¡ç¬¬{}æ¬¡", 
                usage.getScanCount(), usage.getTotalCount());
            
            // ç¬¬ä¸‰æ­¥ï¼šç”ŸæˆTokenå¹¶å­˜å…¥æ•°æ®åº“
            String token = UUID.randomUUID().toString();
            
            VisitorToken visitorToken = new VisitorToken();
            visitorToken.setToken(token);
            visitorToken.setQrId(qrId);
            visitorToken.setPhone(phone);
            visitorToken.setLatitude(latitude);
            visitorToken.setLongitude(longitude);
            visitorToken.setDistance(distance);
            visitorToken.setCreateTime(now);
            visitorToken.setExpireTime(now.plusMinutes(TOKEN_EXPIRE_MINUTES));
            visitorToken.setIsUsed(0);
            
            visitorTokenService.save(visitorToken);
            
            logger.info("âœ… Tokenç”ŸæˆæˆåŠŸ: {}, æœ‰æ•ˆæœŸ{}åˆ†é’Ÿ", token, TOKEN_EXPIRE_MINUTES);
            
            // è¿”å›ç»“æœ
            Map<String, Object> result = new HashMap<>();
            result.put("token", token);
            result.put("expiresAt", System.currentTimeMillis() + 
                (IDENTITY_EXPIRE_HOURS * 60 * 60 * 1000));
            result.put("distance", Math.round(distance * 10) / 10.0); // ä¿ç•™1ä½å°æ•°
            result.put("parkingName", parking.getName());
            result.put("remainingUses", MAX_USES_PER_DAY - usage.getScanCount());
            
            return success(result);
            
        } catch (Exception e) {
            logger.error("âŒ éªŒè¯å¤±è´¥:", e);
            return error("éªŒè¯å¤±è´¥: " + e.getMessage());
        }
    }
    
    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    @PostMapping("/validateToken")
    public Map<String, Object> validateToken(@RequestParam String token) {
        VisitorToken visitorToken = visitorTokenService.getById(token);
        
        if (visitorToken == null) {
            return error("Tokenä¸å­˜åœ¨");
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
        if (LocalDateTime.now().isAfter(visitorToken.getExpireTime())) {
            return error("Tokenå·²è¿‡æœŸ");
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨
        if (visitorToken.getIsUsed() == 1) {
            return error("Tokenå·²ä½¿ç”¨");
        }
        
        // æ„å»ºè¿”å›æ•°æ®
        Map<String, Object> tokenData = new HashMap<>();
        tokenData.put("qrId", visitorToken.getQrId());
        tokenData.put("phone", visitorToken.getPhone());
        tokenData.put("latitude", visitorToken.getLatitude());
        tokenData.put("longitude", visitorToken.getLongitude());
        tokenData.put("distance", visitorToken.getDistance());
        
        // æ ‡è®°ä¸ºå·²ä½¿ç”¨ï¼ˆä¸€æ¬¡æ€§ï¼‰
        visitorToken.setIsUsed(1);
        visitorToken.setUsedTime(LocalDateTime.now());
        visitorTokenService.updateById(visitorToken);
        
        logger.info("âœ… TokenéªŒè¯é€šè¿‡: {}", token);
        
        return success(tokenData);
    }
    
    /**
     * è®¡ç®—ä¸¤ç‚¹ä¹‹é—´çš„è·ç¦»ï¼ˆHaversineå…¬å¼ï¼‰
     * @return è·ç¦»ï¼ˆç±³ï¼‰
     */
    private double calculateDistance(double lat1, double lon1, double lat2, double lon2) {
        final int R = 6371000; // åœ°çƒåŠå¾„ï¼ˆç±³ï¼‰
        
        double latDistance = Math.toRadians(lat2 - lat1);
        double lonDistance = Math.toRadians(lon2 - lon1);
        
        double a = Math.sin(latDistance / 2) * Math.sin(latDistance / 2)
                + Math.cos(Math.toRadians(lat1)) * Math.cos(Math.toRadians(lat2))
                * Math.sin(lonDistance / 2) * Math.sin(lonDistance / 2);
        
        double c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        
        return R * c;
    }
    
    /**
     * æˆåŠŸå“åº”
     */
    private Map<String, Object> success(Object data) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", "0");
        result.put("msg", "success");
        result.put("data", data);
        return result;
    }
    
    /**
     * å¤±è´¥å“åº”
     */
    private Map<String, Object> error(String message) {
        Map<String, Object> result = new HashMap<>();
        result.put("code", "-1");
        result.put("msg", message);
        return result;
    }
}
```

### 8.2 QrVisitorUsageService.java

```java
package com.parkingmanage.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.parkingmanage.entity.QrVisitorUsage;

public interface QrVisitorUsageService extends IService<QrVisitorUsage> {
}
```

### 8.3 QrVisitorUsageServiceImpl.java

```java
package com.parkingmanage.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.parkingmanage.entity.QrVisitorUsage;
import com.parkingmanage.mapper.QrVisitorUsageMapper;
import com.parkingmanage.service.QrVisitorUsageService;
import org.springframework.stereotype.Service;

@Service
public class QrVisitorUsageServiceImpl 
    extends ServiceImpl<QrVisitorUsageMapper, QrVisitorUsage> 
    implements QrVisitorUsageService {
}
```

### 8.4 QrVisitorUsage.javaï¼ˆå®ä½“ç±»ï¼‰

```java
package com.parkingmanage.entity;

import com.baomidou.mybatisplus.annotation.IdType;
import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.time.LocalDateTime;

@Data
@TableName("qr_visitor_usage")
public class QrVisitorUsage {
    
    @TableId(type = IdType.AUTO)
    private Long id;
    
    private String qrId;
    private String phone;
    
    private LocalDateTime firstScanTime;
    private LocalDateTime lastScanTime;
    private LocalDateTime expiresAt;
    
    private Integer scanCount;
    private Integer totalCount;
    
    private Double lastLatitude;
    private Double lastLongitude;
    private Double lastDistance;
    
    private String status;
    private String blockReason;
    
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
}
```

### 8.5 VisitorToken.javaï¼ˆTokenå®ä½“ç±»ï¼‰

```java
package com.parkingmanage.entity;

import com.baomidou.mybatisplus.annotation.TableId;
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.time.LocalDateTime;

@Data
@TableName("visitor_token")
public class VisitorToken {
    
    @TableId
    private String token;  // UUID tokenï¼Œä¸»é”®
    
    private String qrId;
    private String phone;
    
    private Double latitude;
    private Double longitude;
    private Double distance;
    
    private LocalDateTime createTime;
    private LocalDateTime expireTime;
    
    private Integer isUsed;  // 0-æœªä½¿ç”¨ï¼Œ1-å·²ä½¿ç”¨
    private LocalDateTime usedTime;
}
```

### 8.6 VisitorTokenService.java

```java
package com.parkingmanage.service;

import com.baomidou.mybatisplus.extension.service.IService;
import com.parkingmanage.entity.VisitorToken;

public interface VisitorTokenService extends IService<VisitorToken> {
}
```

### 8.7 VisitorTokenServiceImpl.java

```java
package com.parkingmanage.service.impl;

import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.parkingmanage.entity.VisitorToken;
import com.parkingmanage.mapper.VisitorTokenMapper;
import com.parkingmanage.service.VisitorTokenService;
import org.springframework.stereotype.Service;

@Service
public class VisitorTokenServiceImpl 
    extends ServiceImpl<VisitorTokenMapper, VisitorToken> 
    implements VisitorTokenService {
}
```

### 8.8 VisitorTokenMapper.java

```java
package com.parkingmanage.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.parkingmanage.entity.VisitorToken;
import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.time.LocalDateTime;

@Mapper
public interface VisitorTokenMapper extends BaseMapper<VisitorToken> {
    
    /**
     * åˆ é™¤è¿‡æœŸToken
     */
    @Delete("DELETE FROM visitor_token WHERE expire_time < #{now}")
    int deleteExpired(@Param("now") LocalDateTime now);
}
```

### 8.9 QrVisitorUsageMapper.java

```java
package com.parkingmanage.mapper;

import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.parkingmanage.entity.QrVisitorUsage;
import org.apache.ibatis.annotations.Delete;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;
import org.apache.ibatis.annotations.Update;

import java.time.LocalDateTime;

@Mapper
public interface QrVisitorUsageMapper extends BaseMapper<QrVisitorUsage> {
    
    /**
     * é‡ç½®æ‰€æœ‰æ´»è·ƒè®°å½•çš„ä»Šæ—¥æ‰«ç æ¬¡æ•°
     */
    @Update("UPDATE qr_visitor_usage SET scan_count = 0 WHERE status = 'active'")
    int resetDailyScanCount();
    
    /**
     * åˆ é™¤å·²è¿‡æœŸçš„è®°å½•
     */
    @Delete("DELETE FROM qr_visitor_usage WHERE status = 'expired' AND updated_at < #{date}")
    int deleteExpired(@Param("date") LocalDateTime date);
}
```

### 8.10 AppointmentController.javaï¼ˆä¿®æ”¹é¢„çº¦æ¥å£ï¼‰

```java
@PostMapping("/create")
public Map<String, Object> createAppointment(
        @RequestBody AppointmentDTO dto,
        @RequestParam(required = false) String visitorToken) {
    
    try {
        // å¦‚æœæ˜¯å¤–æ¥è®¿å®¢ï¼ŒéªŒè¯token
        if (visitorToken != null && !visitorToken.isEmpty()) {
            VisitorToken token = visitorTokenService.getById(visitorToken);
            
            if (token == null) {
                logger.warn("âŒ Tokenä¸å­˜åœ¨: {}", visitorToken);
                return error("è®¿å®¢å‡­è¯ä¸å­˜åœ¨");
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²è¿‡æœŸ
            if (LocalDateTime.now().isAfter(token.getExpireTime())) {
                logger.warn("âŒ Tokenå·²è¿‡æœŸ: {}", visitorToken);
                return error("è®¿å®¢å‡­è¯å·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œè¯·é‡æ–°æ‰«æè½¦åœºäºŒç»´ç ");
            }
            
            // æ£€æŸ¥æ˜¯å¦å·²ä½¿ç”¨
            if (token.getIsUsed() == 1) {
                logger.warn("âŒ Tokenå·²ä½¿ç”¨: {}", visitorToken);
                return error("è®¿å®¢å‡­è¯å·²ä½¿ç”¨ï¼Œè¯·é‡æ–°æ‰«æ");
            }
            
            // éªŒè¯qrIdæ˜¯å¦åŒ¹é…
            if (!token.getQrId().equals(dto.getQrId())) {
                logger.warn("âŒ QrIdä¸åŒ¹é…: tokenä¸­={}, è¯·æ±‚ä¸­={}", 
                    token.getQrId(), dto.getQrId());
                return error("è½¦åœºä¿¡æ¯ä¸åŒ¹é…");
            }
            
            // æ ‡è®°Tokenä¸ºå·²ä½¿ç”¨ï¼ˆä¸€æ¬¡æ€§ï¼‰
            token.setIsUsed(1);
            token.setUsedTime(LocalDateTime.now());
            visitorTokenService.updateById(token);
            
            logger.info("âœ… TokenéªŒè¯é€šè¿‡å¹¶æ ‡è®°ä¸ºå·²ä½¿ç”¨: {}", visitorToken);
            
            // è®¾ç½®é¢„çº¦çŠ¶æ€ä¸ºå·²ç¡®è®¤
            dto.setStatus("confirmed");
            dto.setConfirmTime(LocalDateTime.now());
            dto.setConfirmQrId(dto.getQrId());
            
            // è®°å½•ä½ç½®ä¿¡æ¯
            dto.setConfirmLocation(token.getLatitude() + "," + token.getLongitude());
        } else {
            // éå¤–æ¥è®¿å®¢ï¼Œé»˜è®¤çŠ¶æ€ä¸ºå¾…ç¡®è®¤
            dto.setStatus("pending");
        }
        
        // åˆ›å»ºé¢„çº¦
        Appointment appointment = new Appointment();
        BeanUtils.copyProperties(dto, appointment);
        appointmentService.save(appointment);
        
        logger.info("âœ… é¢„çº¦åˆ›å»ºæˆåŠŸ: id={}, status={}", appointment.getId(), appointment.getStatus());
        
        return success(appointment);
        
    } catch (Exception e) {
        logger.error("âŒ åˆ›å»ºé¢„çº¦å¤±è´¥:", e);
        return error("åˆ›å»ºé¢„çº¦å¤±è´¥: " + e.getMessage());
    }
}
```

### 8.11 å®šæ—¶ä»»åŠ¡ï¼šVisitorCleanupTask.java

```java
package com.parkingmanage.task;

import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.parkingmanage.entity.QrVisitorUsage;
import com.parkingmanage.mapper.QrVisitorUsageMapper;
import com.parkingmanage.mapper.VisitorTokenMapper;
import com.parkingmanage.service.QrVisitorUsageService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.scheduling.annotation.Scheduled;
import org.springframework.stereotype.Component;

import javax.annotation.Resource;
import java.time.LocalDateTime;
import java.util.List;

/**
 * è®¿å®¢è®°å½•æ¸…ç†å®šæ—¶ä»»åŠ¡
 */
@Component
public class VisitorCleanupTask {
    
    private static final Logger logger = LoggerFactory.getLogger(VisitorCleanupTask.class);
    
    @Resource
    private QrVisitorUsageService qrVisitorUsageService;
    
    @Resource
    private QrVisitorUsageMapper qrVisitorUsageMapper;
    
    @Resource
    private VisitorTokenMapper visitorTokenMapper;
    
    /**
     * æ¯5åˆ†é’Ÿæ¸…ç†ä¸€æ¬¡è¿‡æœŸToken
     */
    @Scheduled(cron = "0 */5 * * * ?")
    public void cleanExpiredTokens() {
        logger.info("ğŸ§¹ å¼€å§‹æ¸…ç†è¿‡æœŸToken");
        
        try {
            LocalDateTime now = LocalDateTime.now();
            int deleted = visitorTokenMapper.deleteExpired(now);
            
            if (deleted > 0) {
                logger.info("âœ… æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ {} æ¡è¿‡æœŸToken", deleted);
            } else {
                logger.debug("âœ… æ²¡æœ‰è¿‡æœŸTokenéœ€è¦æ¸…ç†");
            }
            
        } catch (Exception e) {
            logger.error("âŒ æ¸…ç†è¿‡æœŸTokenå¤±è´¥:", e);
        }
    }
    
    /**
     * æ¯å¤©é›¶ç‚¹é‡ç½®scan_countï¼ˆæ¯æ—¥ä½¿ç”¨æ¬¡æ•°ï¼‰
     */
    @Scheduled(cron = "0 0 0 * * ?")
    public void resetDailyScanCount() {
        logger.info("ğŸ”„ å¼€å§‹é‡ç½®æ¯æ—¥æ‰«ç æ¬¡æ•°");
        
        try {
            int updated = qrVisitorUsageMapper.resetDailyScanCount();
            logger.info("âœ… é‡ç½®å®Œæˆï¼Œå…±æ›´æ–° {} æ¡è®°å½•", updated);
            
        } catch (Exception e) {
            logger.error("âŒ é‡ç½®æ¯æ—¥æ‰«ç æ¬¡æ•°å¤±è´¥:", e);
        }
    }
    
    /**
     * æ¯å°æ—¶æ ‡è®°è¿‡æœŸçš„è®¿å®¢è®°å½•
     */
    @Scheduled(cron = "0 0 * * * ?")
    public void markExpiredRecords() {
        logger.info("ğŸ§¹ å¼€å§‹æ ‡è®°è¿‡æœŸè®¿å®¢è®°å½•");
        
        try {
            LocalDateTime now = LocalDateTime.now();
            
            // æŸ¥è¯¢è¿‡æœŸè®°å½•
            List<QrVisitorUsage> expiredList = qrVisitorUsageService.list(
                new QueryWrapper<QrVisitorUsage>()
                    .eq("status", "active")
                    .lt("expires_at", now)
            );
            
            if (expiredList.isEmpty()) {
                logger.debug("âœ… æ²¡æœ‰è¿‡æœŸè®°å½•éœ€è¦æ ‡è®°");
                return;
            }
            
            // æ›´æ–°çŠ¶æ€ä¸ºå·²è¿‡æœŸ
            for (QrVisitorUsage usage : expiredList) {
                usage.setStatus("expired");
                qrVisitorUsageService.updateById(usage);
            }
            
            logger.info("âœ… æ ‡è®°å®Œæˆï¼Œå…±å¤„ç† {} æ¡è¿‡æœŸè®°å½•", expiredList.size());
            
        } catch (Exception e) {
            logger.error("âŒ æ ‡è®°è¿‡æœŸè®°å½•å¤±è´¥:", e);
        }
    }
    
    /**
     * æ¯å¤©å‡Œæ™¨1ç‚¹åˆ é™¤30å¤©å‰çš„è¿‡æœŸè®°å½•
     */
    @Scheduled(cron = "0 0 1 * * ?")
    public void deleteOldRecords() {
        logger.info("ğŸ—‘ï¸ å¼€å§‹åˆ é™¤æ—§è®°å½•");
        
        try {
            LocalDateTime thirtyDaysAgo = LocalDateTime.now().minusDays(30);
            int deleted = qrVisitorUsageMapper.deleteExpired(thirtyDaysAgo);
            
            logger.info("âœ… åˆ é™¤å®Œæˆï¼Œå…±åˆ é™¤ {} æ¡æ—§è®°å½•", deleted);
            
        } catch (Exception e) {
            logger.error("âŒ åˆ é™¤æ—§è®°å½•å¤±è´¥:", e);
        }
    }
}
```

---

## 9. æµ‹è¯•åœºæ™¯

### 9.1 åŠŸèƒ½æµ‹è¯•

#### æµ‹è¯•1ï¼šé¦–æ¬¡æ‰«ç ç™»å½•ï¼ˆç°åœºï¼‰âœ…
```
æ­¥éª¤ï¼š
1. è®¿å®¢åˆ°è¾¾è½¦åœºå…¥å£
2. æ‰«æè½¦åœºäºŒç»´ç 
3. æˆæƒä½ç½®æƒé™
4. ç³»ç»Ÿè·å–GPSä½ç½®
5. åç«¯éªŒè¯è·ç¦» < 500ç±³
6. åç«¯åˆ›å»ºä½¿ç”¨è®°å½•
7. åç«¯ç”Ÿæˆtoken
8. å‰ç«¯ä¿å­˜éªŒè¯ä¿¡æ¯
9. ç™»å½•æˆåŠŸ

é¢„æœŸç»“æœï¼š
- ä½ç½®éªŒè¯é€šè¿‡
- Tokenç”ŸæˆæˆåŠŸ
- æ•°æ®åº“åˆ›å»ºè®°å½•
- å‰ç«¯æ­£å¸¸è¿›å…¥ç³»ç»Ÿ
```

#### æµ‹è¯•2ï¼šåœ¨å®¶æ‰«ç…§ç‰‡ï¼ˆè¢«æ‹¦æˆªï¼‰âŒ
```
æ­¥éª¤ï¼š
1. è®¿å®¢åœ¨å®¶ä¸­
2. æ‰«æäºŒç»´ç ç…§ç‰‡
3. æˆæƒä½ç½®æƒé™
4. ç³»ç»Ÿè·å–GPSä½ç½®
5. åç«¯éªŒè¯è·ç¦» > 500ç±³

é¢„æœŸç»“æœï¼š
- ä½ç½®éªŒè¯å¤±è´¥
- å¼¹çª—æç¤º"è¯·åœ¨è½¦åœºç°åœºæ‰«ç ï¼Œå½“å‰è·ç¦»Xå…¬é‡Œ"
- æ‹’ç»ç™»å½•
- æ•°æ®åº“ä¸åˆ›å»ºè®°å½•
```

#### æµ‹è¯•3ï¼šTokenè¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰â°
```
æ­¥éª¤ï¼š
1. è®¿å®¢æ‰«ç ç™»å½•æˆåŠŸ
2. 5åˆ†é’Ÿåæäº¤é¢„çº¦
3. ç³»ç»Ÿæ£€æŸ¥token

é¢„æœŸç»“æœï¼š
- Tokenå·²ä»Redisåˆ é™¤
- å¼¹çª—æç¤º"Tokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°æ‰«ç "
- è¦æ±‚é‡æ–°æ‰«ç 
```

#### æµ‹è¯•4ï¼šè¶…è¿‡ä½¿ç”¨æ¬¡æ•°ï¼ˆæ¯å¤©3æ¬¡ï¼‰ğŸš«
```
æ­¥éª¤ï¼š
1. è®¿å®¢ç¬¬1æ¬¡æ‰«ç  â†’ æˆåŠŸ
2. è®¿å®¢ç¬¬2æ¬¡æ‰«ç  â†’ æˆåŠŸ
3. è®¿å®¢ç¬¬3æ¬¡æ‰«ç  â†’ æˆåŠŸ
4. è®¿å®¢ç¬¬4æ¬¡æ‰«ç 

é¢„æœŸç»“æœï¼š
- ç¬¬4æ¬¡æ‰«ç è¢«æ‹’ç»
- å¼¹çª—æç¤º"ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™(3æ¬¡)ï¼Œè¯·æ˜å¤©å†è¯•"
- æ•°æ®åº“scanCount = 3
```

#### æµ‹è¯•5ï¼šèº«ä»½è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰â°
```
æ­¥éª¤ï¼š
1. è®¿å®¢æ‰«ç ç™»å½•æˆåŠŸ
2. 24å°æ—¶åæ‰“å¼€å°ç¨‹åº

é¢„æœŸç»“æœï¼š
- onShowæ£€æµ‹åˆ°è¿‡æœŸ
- æ¸…é™¤æœ¬åœ°å­˜å‚¨
- å¼¹çª—æç¤º"è®¿å®¢èº«ä»½å·²è¿‡æœŸï¼Œè¯·é‡æ–°æ‰«ç "
- è·³è½¬åˆ°é¦–é¡µ
```

#### æµ‹è¯•6ï¼šæ‰«ç æ—¶é—´è¶…é™ï¼ˆ10åˆ†é’Ÿï¼‰â°
```
æ­¥éª¤ï¼š
1. è®¿å®¢æ‰«ç ç™»å½•æˆåŠŸ
2. 10åˆ†é’Ÿåæäº¤é¢„çº¦

é¢„æœŸç»“æœï¼š
- æ‰«ç æ—¶é—´æ£€æŸ¥å¤±è´¥
- å¼¹çª—æç¤º"æ‰«ç æ—¶é—´å·²è¶…è¿‡10åˆ†é’Ÿï¼Œè¯·é‡æ–°æ‰«ç "
- è¦æ±‚é‡æ–°æ‰«ç 
```

### 9.2 è¾¹ç•Œæµ‹è¯•

#### è¾¹ç•Œ1ï¼šGPSè¯¯å·®è¾¹ç¼˜ï¼ˆ495ç±³ï¼‰
```
æµ‹è¯•åœºæ™¯ï¼š
- å®é™…è·ç¦»ï¼š495ç±³
- GPSè¯¯å·®ï¼šÂ±50ç±³
- å¯èƒ½èŒƒå›´ï¼š445ç±³ï½545ç±³

é¢„æœŸç»“æœï¼š
- è·ç¦»<500ç±³ï¼šé€šè¿‡âœ…
- è·ç¦»>500ç±³ï¼šæ‹’ç»âŒ
- éœ€è¦å¤šæ¬¡æµ‹è¯•éªŒè¯ç¨³å®šæ€§
```

#### è¾¹ç•Œ2ï¼šåˆšå¥½5åˆ†é’Ÿ
```
æµ‹è¯•åœºæ™¯ï¼š
- tokenTime: 1732348800000
- å½“å‰æ—¶é—´: 1732349100000
- æ—¶é—´å·®: æ­£å¥½5åˆ†é’Ÿ

é¢„æœŸç»“æœï¼š
- 5åˆ†é’Ÿå†…(>5falseï¼Œä¸éœ€è¦æäº¤å®¡æ‰¹ï¼‰
â‘¢ åœºæ™¯3ï¼šå¤–æ¥è®¿å®¢æäº¤é¢„çº¦ï¼ˆ10åˆ†é’Ÿå†…ï¼‰âœ…
```
è®¿å®¢åœ¨10åˆ†é’Ÿå†…æ‰«ç å¹¶æäº¤é¢„çº¦

é¢„æœŸç»“æœï¼š
- æ‰«ç æ—¶é—´éªŒè¯é€šè¿‡ âœ…
- TokenéªŒè¯é€šè¿‡ âœ…
- é¢„çº¦åˆ›å»ºæˆåŠŸï¼Œstatus='confirmed'
- åç«¯åˆ é™¤Token
```

### 9.3 æ€§èƒ½æµ‹è¯•

#### æ€§èƒ½1ï¼šå¹¶å‘æ‰«ç 
```
åœºæ™¯ï¼š
- 100ä¸ªè®¿å®¢åŒæ—¶æ‰«ç 
- æ¯ä¸ªè®¿å®¢ç‹¬ç«‹çš„qrIdå’Œphone

æµ‹è¯•æŒ‡æ ‡ï¼š
- å“åº”æ—¶é—´ < 1ç§’
- æˆåŠŸç‡ > 99%
- æ•°æ®åº“è®°å½•æ­£ç¡®
- Redisæ— å†²çª
```

#### æ€§èƒ½2ï¼šGPSè®¡ç®—æ€§èƒ½
```
åœºæ™¯ï¼š
- 1000æ¬¡è·ç¦»è®¡ç®—
- Haversineå…¬å¼

æµ‹è¯•æŒ‡æ ‡ï¼š
- å¹³å‡è®¡ç®—æ—¶é—´ < 1ms
- CPUå ç”¨ < 10%
```

---

## 10. éƒ¨ç½²ä¸Šçº¿

### 10.1 éƒ¨ç½²å‰æ£€æŸ¥æ¸…å•

- [ ] æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ
- [ ] Redisé…ç½®æ­£ç¡®
- [ ] åç«¯ä»£ç éƒ¨ç½²
- [ ] å‰ç«¯ä»£ç æ‰“åŒ…
- [ ] é…ç½®å‚æ•°ç¡®è®¤
- [ ] è½¦åœºåæ ‡å½•å…¥
- [ ] å®šæ—¶ä»»åŠ¡å¯åŠ¨

### 10.2 é…ç½®å‚æ•°

```properties
# application.properties

# å¤–æ¥è®¿å®¢é…ç½®
visitor.max.distance=500
visitor.token.expire.minutes=5
visitor.identity.expire.hours=24
visitor.max.uses.per.day=3

# Redisé…ç½®
spring.redis.host=www.xuerparking.cn
spring.redis.port=6379
spring.redis.password=
spring.redis.database=0
```

### 10.3 ç°åº¦å‘å¸ƒå»ºè®®

#### é˜¶æ®µ1ï¼šå†…éƒ¨æµ‹è¯•ï¼ˆ1å‘¨ï¼‰
- æµ‹è¯•äººå‘˜éªŒè¯æ‰€æœ‰åŠŸèƒ½
- ä¿®å¤å‘ç°çš„Bug
- ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

#### é˜¶æ®µ2ï¼šå°èŒƒå›´è¯•ç‚¹ï¼ˆ2å‘¨ï¼‰
- é€‰æ‹©1-2ä¸ªè½¦åœºè¯•ç‚¹
- æ”¶é›†ç”¨æˆ·åé¦ˆ
- è°ƒæ•´å‚æ•°é…ç½®

#### é˜¶æ®µ3ï¼šå…¨é¢æ¨å¹¿
- æ‰€æœ‰è½¦åœºä¸Šçº¿
- ç›‘æ§ç³»ç»Ÿè¿è¡Œ
- æŒç»­ä¼˜åŒ–

### 10.4 ç›‘æ§æŒ‡æ ‡

| æŒ‡æ ‡ | è¯´æ˜ | é˜ˆå€¼ |
|------|------|------|
| **éªŒè¯æˆåŠŸç‡** | verifyAndGetTokenæˆåŠŸç‡ | > 95% |
| **GPSè·å–æˆåŠŸç‡** | getUserLocationæˆåŠŸç‡ | > 90% |
| **Tokenæœ‰æ•ˆä½¿ç”¨ç‡** | Tokenä½¿ç”¨å‰æœªè¿‡æœŸæ¯”ä¾‹ | > 80% |
| **å¹³å‡å“åº”æ—¶é—´** | éªŒè¯æ¥å£å“åº”æ—¶é—´ | < 1ç§’ |
| **æ—¥å‡è®¿å®¢æ•°** | æ¯å¤©æ‰«ç çš„è®¿å®¢æ•°é‡ | - |
| **è¶…é™æ‹’ç»ç‡** | å› æ¬¡æ•°è¶…é™è¢«æ‹’ç»çš„æ¯”ä¾‹ | < 5% |

### 10.5 åº”æ€¥é¢„æ¡ˆ

#### é—®é¢˜1ï¼šGPSæœåŠ¡å¼‚å¸¸
```
ç°è±¡ï¼šå¤§é‡ç”¨æˆ·æ— æ³•è·å–GPSä½ç½®

åº”æ€¥æªæ–½ï¼š
1. ä¸´æ—¶é™ä½è·ç¦»éªŒè¯è¦æ±‚ï¼ˆ500ç±³ â†’ 1000ç±³ï¼‰
2. æˆ–ä¸´æ—¶å…³é—­GPSéªŒè¯ï¼Œä»…ä½¿ç”¨TokenéªŒè¯
3. æ’æŸ¥GPSæœåŠ¡é—®é¢˜
4. ä¿®å¤åæ¢å¤æ­£å¸¸é…ç½®
```

#### é—®é¢˜2ï¼šRedisæœåŠ¡ä¸­æ–­
```
ç°è±¡ï¼šTokenæ— æ³•ç”Ÿæˆæˆ–éªŒè¯

åº”æ€¥æªæ–½ï¼š
1. å¿«é€Ÿé‡å¯RedisæœåŠ¡
2. ä¸´æ—¶ä½¿ç”¨æ•°æ®åº“å­˜å‚¨Token
3. æˆ–ä¸´æ—¶å…³é—­TokenéªŒè¯ï¼Œä»…ä½¿ç”¨GPS+ä½¿ç”¨æ¬¡æ•°éªŒè¯
4. æ¢å¤Redisååˆ‡å›æ­£å¸¸æµç¨‹
```

#### é—®é¢˜3ï¼šéªŒè¯æ¥å£æ€§èƒ½ä¸‹é™
```
ç°è±¡ï¼šå“åº”æ—¶é—´ > 3ç§’

åº”æ€¥æªæ–½ï¼š
1. æ£€æŸ¥æ•°æ®åº“æ…¢æŸ¥è¯¢
2. æ·»åŠ ç´¢å¼•ä¼˜åŒ–
3. å¢åŠ Redisç¼“å­˜
4. æ‰©å®¹æœåŠ¡å™¨èµ„æº
```

---

## 11. æ€»ç»“

### 11.1 æ–¹æ¡ˆç‰¹ç‚¹

| ç‰¹ç‚¹ | è¯´æ˜ |
|------|------|
| **å®‰å…¨æ€§** | GPS+TokenåŒé‡éªŒè¯ï¼Œåç«¯è®°å½•å¯è¿½æº¯ |
| **å®ç”¨æ€§** | é€‚é…å›ºå®šäºŒç»´ç ï¼Œç¬¦åˆå®é™…ä¸šåŠ¡éœ€æ±‚ |
| **çµæ´»æ€§** | å‚æ•°å¯é…ç½®ï¼Œæ”¯æŒä¸åŒè½¦åœºä¸åŒè§„åˆ™ |
| **ç”¨æˆ·ä½“éªŒ** | 24å°æ—¶å…æ‰«ç ï¼Œè‡ªåŠ¨éªŒè¯æ— æ„ŸçŸ¥ |
| **å¯ç»´æŠ¤æ€§** | ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ—¥å¿—å®Œå–„ |

### 11.2 æ ¸å¿ƒæµç¨‹æ€»ç»“

```
å¤–æ¥è®¿å®¢å®Œæ•´æµç¨‹ï¼š

æ‰«ç  â†’ GPSå®šä½ â†’ åç«¯éªŒè¯è·ç¦» â†’ æ£€æŸ¥ä½¿ç”¨æ¬¡æ•° â†’ 
ç”ŸæˆToken â†’ ä¿å­˜éªŒè¯ä¿¡æ¯ â†’ ç™»å½•æˆåŠŸ â†’ 
ï¼ˆ10åˆ†é’Ÿå†…ï¼‰æäº¤é¢„çº¦ â†’ éªŒè¯Token â†’ åˆ›å»ºé¢„çº¦ â†’ å®Œæˆ
```

### 11.3 å…³é”®å‚æ•°

- **GPSèŒƒå›´**ï¼š500ç±³
- **Tokenæœ‰æ•ˆæœŸ**ï¼š5åˆ†é’Ÿ
- **æ‰«ç æœ‰æ•ˆæœŸ**ï¼š10åˆ†é’Ÿ
- **èº«ä»½æœ‰æ•ˆæœŸ**ï¼š24å°æ—¶
- **æ¯æ—¥æ¬¡æ•°**ï¼š3æ¬¡

---

**æ–‡æ¡£å®Œæˆ** âœ…
