# 外来访客二维码验证方案 - 完整设计文档

## 📋 文档导航

本方案包含3个部分，共涵盖需求分析、技术设计、数据库、前后端实现、测试和部署等完整内容：

1. **[第1部分：需求与设计](./外来访客二维码验证方案-1-需求与设计.md)**
   - 需求背景与核心挑战
   - 问题分析与技术约束
   - 访客分类体系
   - 技术方案设计（4大验证机制）
   - 完整验证流程图
   - 预约验证策略

2. **[第2部分：数据库与前端实现](./外来访客二维码验证方案-2-数据库与前端.md)**
   - 数据库表设计（4张MySQL表）
   - 前端完整代码实现
   - GPS定位与Token验证
   - 身份过期检查
   - 预约提交验证
   - 工具函数封装

3. **[第3部分：后端实现与测试](./外来访客二维码验证方案-3-后端与测试.md)**
   - 后端Controller完整代码
   - Service层实现
   - Haversine距离计算
   - 定时任务（清理过期记录）
   - 9大测试场景（功能+边界+性能）
   - 部署上线指南
   - 监控指标与应急预案

---

## 🎯 方案概述

### 核心问题

车场二维码需要**固定印刷**张贴在车道入口，但存在以下挑战：
1. ❌ 无法使用动态时间戳（原计划1分钟过期）
2. ❌ 访客可拍照传播二维码
3. ❌ 可能在家里扫照片填写虚假预约
4. ❌ 小程序无法区分扫现场码还是照片

### 解决方案

采用 **GPS定位 + 动态Token + 使用记录追踪 + 身份有效期** 四重验证机制：

```
┌─────────────────────────────────────────────┐
│          外来访客验证完整流程                 │
└─────────────────────────────────────────────┘

访客扫码
    ↓
GPS定位 → 验证距离 < 500米
    ↓                ↓
   ✅ 通过          ❌ 拒绝（不在现场）
    ↓
检查使用记录 → 今日次数 < 3次
    ↓                ↓
   ✅ 通过          ❌ 拒绝（次数超限）
    ↓
生成Token（5分钟有效）
    ↓
保存验证信息（24小时有效期）
    ↓
登录成功
    ↓
（10分钟内）提交预约
    ↓
验证Token + 扫码时间
    ↓
创建预约 → 完成
```

---

## 🔐 四大验证机制

### 1. GPS位置验证 ⭐⭐⭐⭐⭐
- **目的**：确保用户在车场现场（500米范围内）
- **实现**：Haversine公式计算距离
- **优势**：能有效区分在家和在现场

### 2. 动态Token验证 ⭐⭐⭐⭐⭐
- **目的**：防止二维码照片长期传播
- **实现**：数据库存储，5分钟过期，一次性使用，定时清理
- **优势**：即使传播照片，5分钟后失效

### 3. 使用记录追踪 ⭐⭐⭐⭐
- **目的**：限制单个手机号的使用频率
- **实现**：数据库记录qrId+phone，每天最多3次
- **优势**：防止滥用，可追溯

### 4. 身份有效期 ⭐⭐⭐⭐
- **目的**：定期清理过期身份
- **实现**：24小时后自动过期，要求重新扫码
- **优势**：避免长期占用

---

## 📊 关键数据结构

### 前端存储（localStorage）
```javascript
scannedParams: {
    qrId: "11802",
    community: "欧洲新城",
    visitorToken: "abc123-def456-ghi789",
    tokenTime: 1732348800000,
    tokenExpiresAt: 1732349100000,
    scanTime: 1732348800000,
    scanLocation: {latitude: 45.7568, longitude: 126.6425},
    distance: 120.5,
    verified: true
}

userInfo: {
    role: "visitor",
    visitorType: "external",
    expiresAt: 1732435200000,  // 24小时后
    phone: "13593527970",
    ...
}
```

### 后端数据库（qr_visitor_usage表）
```sql
{
    id: 1,
    qr_id: "11802",
    phone: "13593527970",
    first_scan_time: "2025-11-23 14:00:00",
    last_scan_time: "2025-11-23 16:30:00",
    expires_at: "2025-11-24 14:00:00",
    scan_count: 2,        -- 今日第2次
    total_count: 5,       -- 累计第5次
    last_distance: 120.5,
    status: "active"
}
```

### 数据库存储（visitor_token表）
```sql
{
    token: "abc123-def456-ghi789",
    qr_id: "11802",
    phone: "13593527970",
    latitude: 45.7568,
    longitude: 126.6425,
    distance: 120.5,
    create_time: "2025-11-23 14:00:00",
    expire_time: "2025-11-23 14:05:00",  -- 5分钟后过期
    is_used: 0  -- 一次性使用
}
```

---

## 🔢 关键参数配置

| 参数 | 数值 | 说明 |
|------|------|------|
| **maxDistance** | 500米 | GPS验证最大允许距离 |
| **tokenExpireMinutes** | 5分钟 | Token有效期 |
| **scanValidMinutes** | 10分钟 | 扫码后预约的有效时间 |
| **identityExpireHours** | 24小时 | 访客身份有效期 |
| **maxUsesPerDay** | 3次 | 每天最多使用次数 |
| **minAdvanceMinutes** | 30分钟 | 最少提前预约时间 |
| **maxAdvanceMinutes** | 120分钟 | 最多提前预约时间 |

---

## 📱 访客类型对比

| 类型 | 识别 | 二维码 | 地址 | openid | 有效期 | GPS验证 |
|------|------|--------|------|--------|--------|---------|
| **受邀访客** | butlerId | 管家生成 | 锁定 | 需要 | 管家设置 | ❌ |
| **外来访客** | qrId | 车场固定 | 可选 | 不需要 | 24小时 | ✅ |
| **未知访客** | 无 | - | - | - | - | ❌拒绝 |

---

## 🧪 测试场景概览

### 功能测试（6个场景）
1. ✅ 首次扫码登录（现场）
2. ❌ 在家扫照片（被拦截）
3. ⏰ Token过期（5分钟）
4. 🚫 超过使用次数（每天3次）
5. ⏰ 身份过期（24小时）
6. ⏰ 扫码时间超限（10分钟）

### 边界测试（3个场景）
1. GPS误差边缘（495米）
2. 刚好5分钟临界点
3. 零点跨天场景

### 业务测试（3个场景）
1. 受邀访客正常流程
2. 外来访客立即预约
3. 外来访客10分钟内预约

---

## 💻 技术栈

### 核心技术
- **后端**：Spring Boot 2.5.5 + MyBatis-Plus
- **数据库**：MySQL（无需Redis）
- **前端**：uni-app（微信小程序）
- **定位**：微信小程序GPS定位API

### 数据存储
- **MySQL表**：4张表
  - `qr_visitor_usage`：访客使用记录（24小时有效期）
  - `visitor_token`：临时Token表（5分钟有效期）
  - `appointment`：预约记录表
  - `parking_lot`：车场信息表（含GPS坐标）

### 定时任务
- **每5分钟**：清理过期Token
- **每天零点**：重置每日扫码次数
- **每小时**：标记过期访客记录
- **每天凌晨1点**：删除30天前旧记录

---

## ⚠️ 重要说明

### 为什么不用Redis？

基于实际业务场景分析：
- ✅ **车道串行扫码**：访客排队进入，不存在高并发
- ✅ **日均500辆车**：流量不大，数据库完全够用
- ✅ **响应时间20-40ms**：用户无感知（扫码+填表需10-30秒）
- ✅ **简化运维**：只需维护MySQL，减少服务器资源

**如果未来流量增长（日均>2000辆或多车道并发），可快速升级到Redis方案。**

---

## 🚀 快速开始

### 1. 创建数据库表
```bash
# 执行SQL脚本
mysql -u root -p parking_db < create_tables.sql
```

### 2. 配置参数
```properties
# application.properties
visitor.max.distance=500
visitor.token.expire.minutes=5
visitor.identity.expire.hours=24
visitor.max.uses.per.day=3
```

### 3. 录入车场坐标
```sql
UPDATE parking_lot 
SET latitude = 45.7568,
    longitude = 126.6425,
    location_radius = 500,
    qr_id = '11802'
WHERE name = '欧洲新城停车场';
```

### 4. 启动服务
```bash
# 后端
mvn spring-boot:run

# 前端小程序
npm run dev:mp-weixin
```

---

## 📈 监控指标

| 指标 | 阈值 | 说明 |
|------|------|------|
| 验证成功率 | > 95% | verifyAndGetToken成功率 |
| GPS获取成功率 | > 90% | getUserLocation成功率 |
| Token有效使用率 | > 80% | Token使用前未过期比例 |
| 平均响应时间 | < 1秒 | 验证接口响应时间 |
| 超限拒绝率 | < 5% | 因次数超限被拒绝的比例 |

---

## 🎓 方案优势

| 优势 | 说明 |
|------|------|
| ✅ **适配固定二维码** | 不依赖timestamp，适合印刷张贴 |
| ✅ **安全可控** | GPS+Token双重验证，后端记录可追溯 |
| ✅ **用户体验好** | 24小时内免扫码，自动验证无感知 |
| ✅ **可扩展性强** | 参数可配置，支持不同车场不同规则 |
| ✅ **成本低** | 不需要额外硬件设备 |
| ✅ **可维护性好** | 代码结构清晰，日志完善 |

---

## 📞 技术支持

如有问题，请查看详细文档：
- [第1部分：需求与设计](./外来访客二维码验证方案-1-需求与设计.md)
- [第2部分：数据库与前端](./外来访客二维码验证方案-2-数据库与前端.md)
- [第3部分：后端与测试](./外来访客二维码验证方案-3-后端与测试.md)

---

**文档版本**：v2.0（纯数据库版本）  
**最后更新**：2025-11-23  
**技术方案**：MySQL（无需Redis）  
**适用场景**：日均 < 2000辆车，单车道串行扫码  
**状态**：设计完成，待实施 ✅
