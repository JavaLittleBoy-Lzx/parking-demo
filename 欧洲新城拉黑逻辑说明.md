# æ¬§æ´²æ–°åŸè¿‡å¤œæ‹‰é»‘å’Œç´¯è®¡è¿è§„æ‹‰é»‘åŠŸèƒ½è¯´æ˜

## ä¸€ã€è½¦åœºä¿¡æ¯

**è½¦åœºåç§°**ï¼šæ¬§æ´²æ–°åŸ  
**è½¦åœºç¼–ç (parkCode)**ï¼š`2KPL6XFF`

---

## äºŒã€æ‹‰é»‘è§¦å‘é€»è¾‘

### 1. è§¦å‘å…¥å£

åœ¨ `VehicleReservationController.java` çš„ `reportCarOut` æ–¹æ³•ä¸­ï¼š

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#938-943
if ("2KPL6XFF".equals(data.getParkCode()) && "ä¸‰å·é—¨è¾…é—¨å‡ºå£".equals(data.getLeaveChannelName()) && "3å·é—¨å…¥å£".equals(data.getEnterChannelName())) {
    processMonthlyTicketTimeoutCheck(data);
    // å­¦é™¢æ–°åŸé»‘åå•è½¦è¾†æ‹‰é»‘æ¡ä»¶ï¼šä¸´æ—¶è½¦è¿‡å¤œæ‹‰é»‘
} else if ("76F1MLQKL".equals(data.getParkCode()) && data.getEnterVipType() == 1){
    // å­¦é™¢æ–°åŸé»‘åå•è½¦è¾†é™åˆ¶æ¡ä»¶ï¼šä¸´æ—¶è½¦æ‹‰é»‘é€»è¾‘
    processCollegeNewCityBlacklist(data);
}
```

**è§¦å‘æ¡ä»¶**ï¼š
- è½¦åœºç¼–ç  = `2KPL6XFF`ï¼ˆæ¬§æ´²æ–°åŸï¼‰
- ç¦»åœºé€šé“åç§° = `ä¸‰å·é—¨è¾…é—¨å‡ºå£`
- è¿›åœºé€šé“åç§° = `3å·é—¨å…¥å£`

---

## ä¸‰ã€è¿‡å¤œæ‹‰é»‘é€»è¾‘

### 3.1 åˆ¤æ–­æ¡ä»¶

åœ¨ `processMonthlyTicketTimeoutCheck` æ–¹æ³•ä¸­ï¼š

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#1158
boolean isOvernight = checkIntelligentOvernightViolation(data.getParkCode(), enterDateTime, leaveDateTime, parkingDurationMinutes);
```

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#1166-1184
if (isOvernight) {
    logger.warn("ğŸŒ™ [è½¦è¾†è¿‡å¤œ] plateNumber={}, duration={}å°æ—¶, isExempt={}, isTemporaryCar={}",
            data.getLeaveCarLicenseNumber(), parkingDurationHours, isExemptTicket, isTemporaryCar);
    // ğŸ†• å…æ£€æœˆç¥¨ç±»å‹è¿‡å¤œä¹Ÿä¸è®°å½•è¿è§„ï¼ˆæ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼‰
    if (!isExemptTicket) {
        isViolation = true;
        if (isMonthTicketCar) {
            violationType = "æœˆç¥¨è½¦è¿‡å¤œåœè½¦";
        } else if (isTemporaryCar) {
            violationType = "ä¸´æ—¶è½¦è¿‡å¤œåœè½¦"; // ğŸ†• ä¸´æ—¶è½¦è¿‡å¤œç±»å‹
        } else {
            violationType = "è½¦è¾†è¿‡å¤œåœè½¦";
        }
        violationReason = "å¤œé—´æ—¶æ®µåœè½¦è¿è§„";
        shouldDirectBlacklist = true; // è¿‡å¤œç›´æ¥æ‹‰é»‘
    }
}
```

**è¿‡å¤œåˆ¤å®šè§„åˆ™**ï¼š
- è¿›åœºæ—¶é—´å¿…é¡»åœ¨å‡Œæ™¨0ç‚¹ä¹‹å‰ï¼ˆå‰ä¸€å¤©ï¼‰
- ç¦»åœºæ—¶é—´å¿…é¡»åœ¨å‡Œæ™¨0ç‚¹ä¹‹åï¼ˆç¬¬äºŒå¤©ï¼‰
- åœè½¦æ—¶é•¿è¶…è¿‡é…ç½®çš„é˜ˆå€¼

### 3.2 è¿‡å¤œæ‹‰é»‘å¤„ç†

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#1300-1317
if (shouldDirectBlacklist) {
    // è¿‡å¤œåœè½¦ç›´æ¥æ‹‰é»‘
    logger.warn("ğŸš« [è¿‡å¤œç›´æ¥æ‹‰é»‘] plateNumber={}, reason={}",
            data.getLeaveCarLicenseNumber(), violationReason);
    boolean blacklistResult = violationsService.addToBlacklist(
            data.getLeaveCarLicenseNumber(),
            parkName,
            violationType,
            violationReason + "ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘"
    );
    if (blacklistResult) {
        logger.info("âœ… [æ‹‰é»‘æˆåŠŸ] plateNumber={}", data.getLeaveCarLicenseNumber());
        // è°ƒç”¨é»‘åå•æ¥å£
        callAddBlackListCarAPI(data.getLeaveCarLicenseNumber(), data.getParkCode(),
                parkName, violationType, violationReason + "ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘");
    }
}
```

**ç‰¹æ®Šå¤„ç†**ï¼š
- è¿‡å¤œæ‹‰é»‘å‰ä¼š**æ¸…ç†è¯¥è½¦ç‰Œçš„æ‰€æœ‰è¿è§„è®°å½•**
- æ¬§æ´²æ–°åŸç´¯è®¡æ‹‰é»‘æ—¶ä¹Ÿä¼šæ¸…ç†è¿è§„è®°å½•

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#1329-1341
if ("2KPL6XFF".equals(data.getParkCode())) {
    try {
        int deletedCount = violationsService.deleteViolationsByPlateAndPark(
                data.getLeaveCarLicenseNumber(),
                data.getParkCode()
        );
        logger.info("ğŸ§¹ [ç´¯è®¡æ‹‰é»‘æ¸…ç†] plateNumber={}, parkCode={}, deletedCount={}",
                data.getLeaveCarLicenseNumber(), data.getParkCode(), deletedCount);
    } catch (Exception ex) {
        logger.error("âŒ [ç´¯è®¡æ‹‰é»‘æ¸…ç†å¼‚å¸¸] plateNumber={}, parkCode={}, error={}",
                data.getLeaveCarLicenseNumber(), data.getParkCode(), ex.getMessage(), ex);
    }
}
```

---

## å››ã€ç´¯è®¡è¿è§„æ‹‰é»‘é€»è¾‘

### 4.1 ç´¯è®¡è¿è§„åˆ¤å®š

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#1185-1211
} else if ((isMonthTicketCar || isTemporaryCar) && parkingDurationMinutes > timeoutMinutes) {
    // æœˆç¥¨è½¦æˆ–ä¸´æ—¶è½¦æ£€æŸ¥ç™½å¤©è¶…æ—¶
    if (isMonthTicketCar) {
        logger.warn("â° [æœˆç¥¨è½¦è¶…æ—¶] plateNumber={}, duration={}åˆ†é’Ÿ, limit={}åˆ†é’Ÿ, isExempt={}",
                data.getLeaveCarLicenseNumber(), parkingDurationMinutes, timeoutMinutes, isExemptTicket);

        if (!isExemptTicket) {
            isViolation = true;
            violationType = "æœˆç¥¨è½¦è¶…æ—¶åœè½¦";
            violationReason = "è¶…æ—¶åœè½¦ï¼Œéœ€ç´¯è®¡å¤„ç†";
            shouldDirectBlacklist = false; // è¶…æ—¶éœ€ç´¯è®¡å¤„ç†
            shouldCumulativeBlacklist = true;
        }
    } else if (isTemporaryCar) {
        // ğŸ†• ä¸´æ—¶è½¦ç™½å¤©è¶…æ—¶åœè½¦ï¼ˆç´¯è®¡è¿è§„å¤„ç†ï¼‰
        logger.warn("â° [ä¸´æ—¶è½¦ç™½å¤©è¶…æ—¶] plateNumber={}, duration={}åˆ†é’Ÿ, limit={}åˆ†é’Ÿ",
                data.getLeaveCarLicenseNumber(), parkingDurationMinutes, timeoutMinutes);
        isViolation = true;
        violationType = "ä¸´æ—¶è½¦è¶…æ—¶åœè½¦";
        violationReason = "è¶…æ—¶åœè½¦ï¼Œéœ€ç´¯è®¡å¤„ç†";
        shouldDirectBlacklist = false; // è¶…æ—¶éœ€ç´¯è®¡å¤„ç†
        shouldCumulativeBlacklist = true;
    }
}
```

### 4.2 ç´¯è®¡æ‹‰é»‘å¤„ç†

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#1318-1355
} else if (shouldCumulativeBlacklist) {
    // ğŸ†• ç´¯è®¡è¿è§„å¤„ç†ï¼ˆåŒ…æ‹¬è¶…æ—¶åœè½¦å’Œå¤œé—´åœè½¦è¶…ç™½å¤©é™åˆ¶ï¼‰
    logger.info("ğŸ“Š [ç´¯è®¡è¿è§„å¤„ç†] plateNumber={}, reason={}",
            data.getLeaveCarLicenseNumber(), violationReason);
    boolean shouldBlacklist = violationsService.checkAndProcessBlacklist(
            data.getLeaveCarLicenseNumber(),
            data.getParkCode()
    );
    if (shouldBlacklist) {
        logger.warn("ğŸš« [ç´¯è®¡æ‹‰é»‘] plateNumber={}", data.getLeaveCarLicenseNumber());
        // æ¬§æ´²æ–°åŸç´¯è®¡æ‹‰é»‘æ—¶ï¼Œè¾¾åˆ°é˜ˆå€¼ä¹Ÿéœ€è¦æ¸…ç†è¯¥è½¦ç‰Œçš„è¿è§„è®°å½•
        if ("2KPL6XFF".equals(data.getParkCode())) {
            // ... æ¸…ç†è¿è§„è®°å½• ...
        }
        // è°ƒç”¨é»‘åå•æ¥å£
        String blacklistType;
        if (isMonthTicketCar) {
            blacklistType = "æœˆç¥¨è½¦ç´¯è®¡è¿è§„";
        } else if (isTemporaryCar) {
            blacklistType = "ä¸´æ—¶è½¦ç´¯è®¡è¿è§„";
        } else {
            blacklistType = "å…¶ä»–è½¦è¾†ç´¯è®¡è¿è§„";
        }
        callAddBlackListCarAPI(data.getLeaveCarLicenseNumber(), data.getParkCode(),
                parkName, blacklistType, violationReason + "ç´¯è®¡è¾¾åˆ°é˜ˆå€¼ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘");
    }
}
```

### 4.3 ç´¯è®¡ç»Ÿè®¡é€»è¾‘

åœ¨ `ViolationsServiceImpl.java` çš„ `checkAndProcessBlacklist` æ–¹æ³•ä¸­ï¼š

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\service\impl\ViolationsServiceImpl.java#2183-2250
@Override
public boolean checkAndProcessBlacklist(String plateNumber, String parkCode) {
    // è·å–é…ç½®
    Map<String, Object> config = getMonthlyTicketTimeoutConfig(parkCode);
    Integer maxViolationCount = (Integer) config.get("maxViolationCount");
    
    // åˆ†åˆ«ç»Ÿè®¡æœˆç¥¨è½¦å’Œéæœˆç¥¨è½¦çš„è¿è§„æ¬¡æ•°
    QueryWrapper<Violations> monthlyTicketQuery = new QueryWrapper<>();
    monthlyTicketQuery.eq("plate_number", plateNumber)
              .eq("park_code", parkCode)
              .eq("is_monthly_ticket", true)
              .in("violation_type", "æœˆç¥¨è½¦è¶…æ—¶åœè½¦", "æœˆç¥¨è½¦å¤œé—´è¶…ç™½å¤©é™åˆ¶", "æœˆç¥¨è½¦è¿‡å¤œåœè½¦");
    
    long monthlyTicketViolationCount = baseMapper.selectCount(monthlyTicketQuery);
    
    QueryWrapper<Violations> nonMonthlyTicketQuery = new QueryWrapper<>();
    nonMonthlyTicketQuery.eq("plate_number", plateNumber)
              .eq("park_code", parkCode)
              .eq("is_monthly_ticket", false)
              .in("violation_type", "è¶…æ—¶åœè½¦", "éæœˆç¥¨è½¦å¤œé—´è¶…ç™½å¤©é™åˆ¶")
              .ge("created_at", LocalDateTime.now().minusDays(30)); // æœ€è¿‘30å¤©å†…çš„è¿è§„
    
    long nonMonthlyTicketViolationCount = baseMapper.selectCount(nonMonthlyTicketQuery);
    
    boolean shouldBlacklist = false;
    String reason = "";
    
    if (monthlyTicketViolationCount >= maxViolationCount) {
        shouldBlacklist = true;
        reason = String.format("æœˆç¥¨è½¦ç´¯è®¡è¿è§„%dæ¬¡", monthlyTicketViolationCount);
    } else if (nonMonthlyTicketViolationCount >= maxViolationCount) {
        shouldBlacklist = true;
        reason = String.format("éæœˆç¥¨è½¦ç´¯è®¡è¿è§„%dæ¬¡", nonMonthlyTicketViolationCount);
    }
    
    if (shouldBlacklist) {
        // æ·»åŠ åˆ°é»‘åå•
        return addToBlacklist(plateNumber, parkName, reason, "ç³»ç»Ÿè‡ªåŠ¨åŠ å…¥é»‘åå•");
    }
    
    return false;
}
```

**ç»Ÿè®¡è§„åˆ™**ï¼š
- **æœˆç¥¨è½¦**ï¼šç»Ÿè®¡æ‰€æœ‰å†å²è¿è§„è®°å½•ï¼ˆä¸é™æ—¶é—´èŒƒå›´ï¼‰
- **éæœˆç¥¨è½¦**ï¼šç»Ÿè®¡æœ€è¿‘30å¤©å†…çš„è¿è§„è®°å½•
- è¾¾åˆ°é…ç½®çš„ `maxViolationCount` é˜ˆå€¼å³è§¦å‘æ‹‰é»‘

---

## äº”ã€å¤–éƒ¨æ¥å£è°ƒç”¨

### 5.1 é€šç”¨æ‹‰é»‘æ¥å£

```java:d:\PakingDemo\parking-demo\src\main\java\com\parkingmanage\controller\VehicleReservationController.java#2082-2122
private void callAddBlackListCarAPI(String plateNumber, String parkCode, String parkName, String reason, String remark) {
    try {
        logger.info("ğŸš« [è°ƒç”¨æ‹‰é»‘æ¥å£] plateNumber={}, parkCode={}, reason={}", plateNumber, parkCode, reason);

        // æŸ¥è¯¢æœˆç¥¨è¡¨ä¸­çš„è½¦ä¸»å§“å
        String carOwner = getCarOwnerFromMonthTicket(plateNumber);
        if (carOwner == null || carOwner.trim().isEmpty()) {
            carOwner = "ç³»ç»Ÿè‡ªåŠ¨"; // é»˜è®¤è½¦ä¸»ä¿¡æ¯
        }

        HashMap<String, String> blacklistParams = new HashMap<>();
        blacklistParams.put("parkCode", parkCode);
        blacklistParams.put("carCode", plateNumber);
        blacklistParams.put("carOwner", carOwner);
        blacklistParams.put("isPermament", "1"); // æ°¸ä¹…æ‹‰é»‘
        blacklistParams.put("reason", reason);
        blacklistParams.put("remark1", remark);
        blacklistParams.put("remark2", "æœˆç¥¨è½¦è¿è§„ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘");
        blacklistParams.put("specialCarTypeId", "504127"); // å›ºå®šå€¼

        String response = HttpClientUtil.doGet("https://www.xuerparking.cn:8543/parking/blackList/addBlackListCar", blacklistParams);
        // å¤„ç†å“åº”...
    } catch (Exception e) {
        logger.error("âŒ [è°ƒç”¨æ‹‰é»‘æ¥å£å¼‚å¸¸] plateNumber={}, error={}", plateNumber, e.getMessage(), e);
    }
}
```

### 5.2 æ¥å£å‚æ•°è¯´æ˜

| å‚æ•°å | å€¼ | è¯´æ˜ |
|--------|-----|------|
| `parkCode` | `2KPL6XFF` | è½¦åœºç¼–ç ï¼ˆæ¬§æ´²æ–°åŸï¼‰ |
| `carCode` | è½¦ç‰Œå· | éœ€è¦æ‹‰é»‘çš„è½¦ç‰Œå· |
| `carOwner` | è½¦ä¸»å§“å | ä»æœˆç¥¨è¡¨æŸ¥è¯¢ï¼Œè‹¥æ— åˆ™ä¸º"ç³»ç»Ÿè‡ªåŠ¨" |
| `isPermament` | `1` | æ°¸ä¹…æ‹‰é»‘ |
| `reason` | æ‹‰é»‘åŸå›  | å¦‚"æœˆç¥¨è½¦è¿‡å¤œåœè½¦"ã€"æœˆç¥¨è½¦ç´¯è®¡è¿è§„" |
| `remark1` | è¯¦ç»†è¯´æ˜ | å¦‚"å¤œé—´æ—¶æ®µåœè½¦è¿è§„ï¼Œç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘" |
| `remark2` | `"æœˆç¥¨è½¦è¿è§„ç³»ç»Ÿè‡ªåŠ¨æ‹‰é»‘"` | å›ºå®šå€¼ |
| `specialCarTypeId` | `504127` | ç‰¹æ®Šè½¦è¾†ç±»å‹IDï¼ˆæ¬§æ´²æ–°åŸå›ºå®šå€¼ï¼‰ |

### 5.3 å¤–éƒ¨æ¥å£åœ°å€

```
https://www.xuerparking.cn:8543/parking/blackList/addBlackListCar
```

**è¯·æ±‚æ–¹å¼**ï¼šGETï¼ˆä½¿ç”¨ `HttpClientUtil.doGet`ï¼‰

---

## å…­ã€å…³é”®æµç¨‹å›¾

```
è½¦è¾†ç¦»åœº (reportCarOut)
    â†“
åˆ¤æ–­è½¦åœºç¼–ç æ˜¯å¦ä¸º 2KPL6XFF
    â†“
è°ƒç”¨ processMonthlyTicketTimeoutCheck
    â†“
è®¡ç®—åœè½¦æ—¶é•¿ï¼Œåˆ¤æ–­è½¦è¾†ç±»å‹ï¼ˆæœˆç¥¨è½¦/ä¸´æ—¶è½¦ï¼‰
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿‡å¤œåˆ¤å®š        â”‚ è¶…æ—¶åˆ¤å®š        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ isOvernight     â”‚ parkingDuration â”‚
â”‚    â†“            â”‚    > timeout    â”‚
â”‚ shouldDirect    â”‚       â†“         â”‚
â”‚ Blacklist=true  â”‚ shouldCumulativeâ”‚
â”‚                 â”‚ Blacklist=true  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“                    â†“
    ç›´æ¥æ‹‰é»‘              ç´¯è®¡æ‹‰é»‘åˆ¤å®š
         â†“                    â†“
    æ¸…ç†è¿è§„è®°å½•       checkAndProcessBlacklist
         â†“                    â†“
    è°ƒç”¨å¤–éƒ¨æ¥å£          è¾¾åˆ°é˜ˆå€¼?
         â†“                    â†“
 callAddBlackListCarAPI  æ¸…ç†è¿è§„è®°å½• + è°ƒç”¨æ¥å£
```

---

## ä¸ƒã€è¡¥å……è¯´æ˜

1. **å…æ£€æœˆç¥¨ç±»å‹**ï¼š
   - è¿‡å¤œå’Œè¶…æ—¶éƒ½ä¸ä¼šè®°å½•è¿è§„
   - ä¸ä¼šè§¦å‘ä»»ä½•æ‹‰é»‘é€»è¾‘

2. **è¿è§„è®°å½•æ¸…ç†**ï¼š
   - è¿‡å¤œæ‹‰é»‘ï¼šç›´æ¥æ¸…ç†è¯¥è½¦ç‰Œæ‰€æœ‰è¿è§„è®°å½•
   - ç´¯è®¡æ‹‰é»‘ï¼ˆæ¬§æ´²æ–°åŸï¼‰ï¼šè¾¾åˆ°é˜ˆå€¼åæ¸…ç†è¿è§„è®°å½•

3. **ä¸´æ—¶è½¦å¤„ç†**ï¼š
   - æ”¯æŒä¸´æ—¶è½¦è¿‡å¤œæ‹‰é»‘
   - æ”¯æŒä¸´æ—¶è½¦ç´¯è®¡è¿è§„æ‹‰é»‘
   - ä½¿ç”¨é¢„è¿›åœºæ—¶é—´ï¼ˆtemp_car_pre_entryè¡¨ï¼‰

4. **å­¦é™¢æ–°åŸå¯¹æ¯”**ï¼š
   - å­¦é™¢æ–°åŸä½¿ç”¨ä¸åŒçš„æ¥å£æ–¹æ³• `callAddBlackListCarAPIForCollegeNewCity`
   - specialCarTypeId = `504170`ï¼ˆè€Œæ¬§æ´²æ–°åŸæ˜¯`504127`ï¼‰

---

## å…«ã€ç›¸å…³æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `VehicleReservationController.java#reportCarOut` | ä¸»å…¥å£æ–¹æ³• |
| `VehicleReservationController.java#processMonthlyTicketTimeoutCheck` | æ¬§æ´²æ–°åŸè¶…æ—¶æ£€æŸ¥æ ¸å¿ƒé€»è¾‘ |
| `VehicleReservationController.java#checkIntelligentOvernightViolation` | æ™ºèƒ½è¿‡å¤œåˆ¤å®š |
| `VehicleReservationController.java#callAddBlackListCarAPI` | å¤–éƒ¨æ¥å£è°ƒç”¨ |
| `ViolationsServiceImpl.java#checkAndProcessBlacklist` | ç´¯è®¡è¿è§„ç»Ÿè®¡é€»è¾‘ |
| `ViolationsServiceImpl.java#addToBlacklist` | æ·»åŠ é»‘åå•è®°å½• |

---

**ç”Ÿæˆæ—¶é—´**ï¼š2024-12-09  
**è½¦åœºç¼–ç **ï¼š2KPL6XFFï¼ˆæ¬§æ´²æ–°åŸï¼‰
