# å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ - å®æ–½å®Œæˆè¯´æ˜

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¡¨åˆ›å»º âœ…

**æ–‡ä»¶ä½ç½®**ï¼š`src/main/resources/sql/visitor_verification_schema.sql`

å·²åˆ›å»ºä»¥ä¸‹æ•°æ®åº“è¡¨ï¼š
- âœ… `qr_visitor_usage` - è®¿å®¢ä½¿ç”¨è®°å½•è¡¨ï¼ˆ24å°æ—¶æœ‰æ•ˆæœŸï¼Œæ¯å¤©3æ¬¡é™åˆ¶ï¼‰
- âœ… `visitor_token` - ä¸´æ—¶Tokenè¡¨ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
- âœ… ä¿®æ”¹ `appointment` è¡¨ - æ–°å¢visitor_tokenå’Œscan_timeå­—æ®µ
- âœ… ä¿®æ”¹ `parking` è¡¨ - æ–°å¢GPSåæ ‡å­—æ®µï¼ˆlatitudeã€longitudeã€qr_idç­‰ï¼‰

**æ‰§è¡Œæ–¹å¼**ï¼š
```bash
# è¿›å…¥MySQL
mysql -u root -p parking_db

# æ‰§è¡ŒSQLè„šæœ¬
source /path/to/visitor_verification_schema.sql
```

---

### 2. Javaåç«¯ä»£ç åˆ›å»º âœ…

#### 2.1 å®ä½“ç±»ï¼ˆEntityï¼‰

å·²åˆ›å»ºï¼š
- âœ… `VisitorToken.java` - Tokenå®ä½“ç±»
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/entity/VisitorToken.java`
  
- âœ… `QrVisitorUsage.java` - è®¿å®¢ä½¿ç”¨è®°å½•å®ä½“ç±»
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/entity/QrVisitorUsage.java`

#### 2.2 Mapperæ¥å£

å·²åˆ›å»ºï¼š
- âœ… `VisitorTokenMapper.java`
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/mapper/VisitorTokenMapper.java`
  - æ–¹æ³•ï¼š`deleteExpired()` - åˆ é™¤è¿‡æœŸToken
  
- âœ… `QrVisitorUsageMapper.java`
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/mapper/QrVisitorUsageMapper.java`
  - æ–¹æ³•ï¼š
    - `resetDailyScanCount()` - é‡ç½®æ¯æ—¥è®¡æ•°
    - `deleteExpired()` - åˆ é™¤è¿‡æœŸè®°å½•
    - `markExpired()` - æ ‡è®°è¿‡æœŸè®°å½•

#### 2.3 Serviceå±‚

å·²åˆ›å»ºï¼š
- âœ… `VisitorTokenService.java` + `VisitorTokenServiceImpl.java`
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/service/` å’Œ `service/impl/`
  
- âœ… `QrVisitorUsageService.java` + `QrVisitorUsageServiceImpl.java`
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/service/` å’Œ `service/impl/`

#### 2.4 Controller

å·²åˆ›å»ºï¼š
- âœ… `ExternalVisitorController.java`
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/controller/ExternalVisitorController.java`
  - æ¥å£ï¼š
    - `POST /visitor/verifyAndGetToken` - éªŒè¯å¹¶è·å–Token
    - `POST /visitor/validateToken` - éªŒè¯Tokenæœ‰æ•ˆæ€§

#### 2.5 å®šæ—¶ä»»åŠ¡

å·²åˆ›å»ºï¼š
- âœ… `VisitorCleanupTask.java`
  - ä½ç½®ï¼š`src/main/java/com/parkingmanage/task/VisitorCleanupTask.java`
  - åŒ…å«4ä¸ªå®šæ—¶ä»»åŠ¡ï¼š
    - æ¯5åˆ†é’Ÿæ¸…ç†è¿‡æœŸToken
    - æ¯å¤©é›¶ç‚¹é‡ç½®æ¯æ—¥æ‰«ç æ¬¡æ•°
    - æ¯å°æ—¶æ ‡è®°è¿‡æœŸè®¿å®¢è®°å½•
    - æ¯å¤©å‡Œæ™¨1ç‚¹åˆ é™¤30å¤©å‰æ—§è®°å½•

---

## âš ï¸ éœ€è¦æ³¨æ„çš„äº‹é¡¹

### 1. Parkingè¡¨å­—æ®µé—®é¢˜

**å½“å‰é—®é¢˜**ï¼š
- `Parking.java` å®ä½“ç±»**æ²¡æœ‰**GPSç›¸å…³å­—æ®µï¼ˆlatitude, longitude, qr_idç­‰ï¼‰
- `ExternalVisitorController.java` ä¸­ä¸´æ—¶ç¡¬ç¼–ç äº†GPSåæ ‡

**è§£å†³æ–¹æ¡ˆ**ï¼š

#### æ–¹æ¡ˆAï¼šä¿®æ”¹Parkingå®ä½“ç±»ï¼ˆæ¨èï¼‰

åœ¨ `Parking.java` ä¸­æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

```java
@ApiModelProperty(value = "çº¬åº¦ï¼ˆWGS84åæ ‡ç³»ï¼‰")
private Double latitude;

@ApiModelProperty(value = "ç»åº¦ï¼ˆWGS84åæ ‡ç³»ï¼‰")
private Double longitude;

@ApiModelProperty(value = "æœ‰æ•ˆèŒƒå›´ï¼ˆç±³ï¼‰")
private Integer locationRadius;

@ApiModelProperty(value = "è½¦åœºäºŒç»´ç ID")
private String qrId;
```

#### æ–¹æ¡ˆBï¼šåˆ›å»ºæ–°çš„ParkingLotå®ä½“ç±»

å¦‚æœä¸æƒ³ä¿®æ”¹ç°æœ‰çš„Parkingç±»ï¼Œå¯ä»¥åˆ›å»ºæ–°çš„ParkingLotè¡¨å’Œå®ä½“ç±»ã€‚

---

### 2. å¯ç”¨Springå®šæ—¶ä»»åŠ¡

**éœ€è¦ç¡®ä¿**é¡¹ç›®å¯åŠ¨ç±»ä¸Šæœ‰ `@EnableScheduling` æ³¨è§£ï¼š

```java
@SpringBootApplication
@EnableScheduling  // æ·»åŠ è¿™ä¸ªæ³¨è§£
@MapperScan("com.parkingmanage.mapper")
public class ParkingManageApplication {
    public static void main(String[] args) {
        SpringApplication.run(ParkingManageApplication.class, args);
    }
}
```

---

### 3. Mapperæ‰«æé…ç½®

ç¡®ä¿Mapperæ¥å£èƒ½è¢«æ‰«æåˆ°ï¼š

**æ–¹å¼1ï¼šå¯åŠ¨ç±»æ·»åŠ æ³¨è§£**
```java
@MapperScan("com.parkingmanage.mapper")
```

**æ–¹å¼2ï¼šapplication.propertiesé…ç½®**
```properties
mybatis-plus.mapper-locations=classpath*:mapper/**/*.xml
```

---

## ğŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œæ¸…å•

### ç¬¬ä¸€æ­¥ï¼šæ•°æ®åº“å‡†å¤‡ â³

- [ ] 1.1 æ‰§è¡ŒSQLè„šæœ¬åˆ›å»ºè¡¨
  ```bash
  mysql -u root -p parking_db < visitor_verification_schema.sql
  ```

- [ ] 1.2 ç¡®è®¤è¡¨åˆ›å»ºæˆåŠŸ
  ```sql
  SHOW TABLES LIKE '%visitor%';
  DESC qr_visitor_usage;
  DESC visitor_token;
  ```

- [ ] 1.3 å½•å…¥è½¦åœºGPSåæ ‡
  ```sql
  -- æ¬§æ´²æ–°åŸåœè½¦åœºï¼ˆç¤ºä¾‹ï¼‰
  UPDATE parking 
  SET latitude = 45.7568,
      longitude = 126.6425,
      location_radius = 500,
      qr_id = '11802'
  WHERE community = 'æ¬§æ´²æ–°åŸ';
  
  -- å…¶ä»–è½¦åœº...
  ```

---

### ç¬¬äºŒæ­¥ï¼šä¿®æ”¹Parkingå®ä½“ç±» â³

- [ ] 2.1 æ‰“å¼€ `Parking.java`
- [ ] 2.2 æ·»åŠ GPSç›¸å…³å­—æ®µï¼ˆlatitudeã€longitudeã€locationRadiusã€qrIdï¼‰
- [ ] 2.3 æ·»åŠ å¯¹åº”çš„getter/setteræ–¹æ³•ï¼ˆå¦‚æœä½¿ç”¨Lombokåˆ™è‡ªåŠ¨ç”Ÿæˆï¼‰

---

### ç¬¬ä¸‰æ­¥ï¼šä¿®æ”¹ExternalVisitorController â³

- [ ] 3.1 æ‰“å¼€ `ExternalVisitorController.java`
- [ ] 3.2 æ‰¾åˆ°ç¡¬ç¼–ç çš„GPSåæ ‡ï¼ˆç¬¬83-84è¡Œï¼‰
- [ ] 3.3 æ”¹ä¸ºä»parkingå¯¹è±¡è·å–ï¼š
  ```java
  // ä¿®æ”¹å‰ï¼ˆä¸´æ—¶ç¡¬ç¼–ç ï¼‰
  double distance = calculateDistance(
      latitude, longitude,
      45.7568, 126.6425 // ä¸´æ—¶ç¡¬ç¼–ç 
  );
  
  // ä¿®æ”¹åï¼ˆä»æ•°æ®åº“è·å–ï¼‰
  double distance = calculateDistance(
      latitude, longitude,
      parking.getLatitude(), parking.getLongitude()
  );
  ```

---

### ç¬¬å››æ­¥ï¼šå¯ç”¨å®šæ—¶ä»»åŠ¡ â³

- [ ] 4.1 æ‰“å¼€é¡¹ç›®å¯åŠ¨ç±»ï¼ˆå¦‚ `ParkingManageApplication.java`ï¼‰
- [ ] 4.2 æ·»åŠ  `@EnableScheduling` æ³¨è§£
- [ ] 4.3 é‡å¯é¡¹ç›®

---

### ç¬¬äº”æ­¥ï¼šå‰ç«¯é›†æˆï¼ˆå¯é€‰ï¼‰ â³

å‰ç«¯ä»£ç å·²åœ¨æ–‡æ¡£ä¸­ï¼Œä½äºï¼š
- ğŸ“„ `å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ-2-æ•°æ®åº“ä¸å‰ç«¯.md`
- ğŸ“„ ç¬¬7ç« ï¼šå‰ç«¯å®ç°

ä¸»è¦ä¿®æ”¹æ–‡ä»¶ï¼š
- [ ] 5.1 `pages/auth/phone-auth.vue` - ç™»å½•é¡µé¢
- [ ] 5.2 `pagesA/reservation/form.vue` - é¢„çº¦è¡¨å•é¡µé¢

**æ³¨æ„**ï¼šå‰ç«¯ä»£ç ä¿®æ”¹è¾ƒå¤æ‚ï¼Œå»ºè®®å…ˆæµ‹è¯•åç«¯æ¥å£æ˜¯å¦æ­£å¸¸ã€‚

---

### ç¬¬å…­æ­¥ï¼šæµ‹è¯•éªŒè¯ â³

#### 6.1 åç«¯æ¥å£æµ‹è¯•

**æµ‹è¯•1ï¼šéªŒè¯å¹¶è·å–Token**
```bash
curl -X POST "http://www.xuerparking.cn:8080/visitor/verifyAndGetToken" \
  -d "qrId=11802" \
  -d "phone=13593527970" \
  -d "latitude=45.7568" \
  -d "longitude=126.6425"
```

é¢„æœŸå“åº”ï¼š
```json
{
  "code": "0",
  "msg": "success",
  "data": {
    "token": "abc123-def456-ghi789",
    "expiresAt": 1732435200000,
    "distance": 120.5,
    "parkingName": "æ¬§æ´²æ–°åŸ",
    "remainingUses": 2
  }
}
```

**æµ‹è¯•2ï¼šéªŒè¯Token**
```bash
curl -X POST "http://www.xuerparking.cn:8080/visitor/validateToken" \
  -d "token=abc123-def456-ghi789"
```

#### 6.2 å®šæ—¶ä»»åŠ¡æµ‹è¯•

æŸ¥çœ‹æ—¥å¿—ç¡®è®¤å®šæ—¶ä»»åŠ¡æ˜¯å¦æ­£å¸¸æ‰§è¡Œï¼š
```bash
# å¯åŠ¨åç­‰å¾…5åˆ†é’Ÿï¼ŒæŸ¥çœ‹Tokenæ¸…ç†æ—¥å¿—
tail -f logs/parking-demo.log | grep "å®šæ—¶ä»»åŠ¡"
```

é¢„æœŸæ—¥å¿—ï¼š
```
2025-11-23 14:05:00 [INFO] ğŸ§¹ [å®šæ—¶ä»»åŠ¡] å¼€å§‹æ¸…ç†è¿‡æœŸToken
2025-11-23 14:05:00 [INFO] âœ… [å®šæ—¶ä»»åŠ¡] æ¸…ç†å®Œæˆï¼Œå…±åˆ é™¤ 5 æ¡è¿‡æœŸToken
```

---

## ğŸ“Š ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å‰ç«¯ï¼ˆuni-appå°ç¨‹åºï¼‰              â”‚
â”‚   - æ‰«ç ç™»å½•                                 â”‚
â”‚   - GPSå®šä½                                  â”‚
â”‚   - é¢„çº¦æäº¤                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“ HTTPè¯·æ±‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         ExternalVisitorController            â”‚
â”‚   POST /visitor/verifyAndGetToken            â”‚
â”‚   POST /visitor/validateToken                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Serviceå±‚                       â”‚
â”‚   - VisitorTokenService                      â”‚
â”‚   - QrVisitorUsageService                    â”‚
â”‚   - ParkingService                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             MySQLæ•°æ®åº“                      â”‚
â”‚   - qr_visitor_usageï¼ˆä½¿ç”¨è®°å½•ï¼‰             â”‚
â”‚   - visitor_tokenï¼ˆä¸´æ—¶Tokenï¼‰               â”‚
â”‚   - parkingï¼ˆè½¦åœºä¿¡æ¯ï¼‰                      â”‚
â”‚   - appointmentï¼ˆé¢„çº¦ä¿¡æ¯ï¼‰                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   å®šæ—¶ä»»åŠ¡ï¼ˆåå°ï¼‰     â”‚
         â”‚  VisitorCleanupTask   â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
         â”‚ æ¯5åˆ†é’Ÿï¼šæ¸…ç†Token     â”‚
         â”‚ æ¯å¤©é›¶ç‚¹ï¼šé‡ç½®è®¡æ•°     â”‚
         â”‚ æ¯å°æ—¶ï¼šæ ‡è®°è¿‡æœŸ       â”‚
         â”‚ æ¯å¤©1ç‚¹ï¼šåˆ é™¤æ—§è®°å½•    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ æ ¸å¿ƒéªŒè¯æœºåˆ¶

### 1. GPSä½ç½®éªŒè¯ â­â­â­â­â­
```java
// è®¡ç®—è·ç¦»
double distance = calculateDistance(lat1, lon1, lat2, lon2);

// éªŒè¯è·ç¦»
if (distance > 500) {
    return error("è¯·åœ¨è½¦åœºç°åœºæ‰«ç ");
}
```

### 2. åŠ¨æ€TokenéªŒè¯ â­â­â­â­â­
```java
// ç”ŸæˆTokenï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆï¼‰
String token = UUID.randomUUID().toString();
visitorToken.setExpireTime(now.plusMinutes(5));

// ä¸€æ¬¡æ€§ä½¿ç”¨
visitorToken.setIsUsed(0);
```

### 3. ä½¿ç”¨è®°å½•è¿½è¸ª â­â­â­â­
```java
// æ£€æŸ¥ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°
if (usage.getScanCount() >= 3) {
    return error("ä»Šæ—¥ä½¿ç”¨æ¬¡æ•°å·²è¾¾ä¸Šé™");
}
```

### 4. èº«ä»½æœ‰æ•ˆæœŸ â­â­â­â­
```java
// 24å°æ—¶æœ‰æ•ˆæœŸ
LocalDateTime expiresAt = now.plusHours(24);
usage.setExpiresAt(expiresAt);
```

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- ğŸ“„ [éœ€æ±‚ä¸è®¾è®¡æ–‡æ¡£](./å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ-1-éœ€æ±‚ä¸è®¾è®¡.md)
- ğŸ“„ [æ•°æ®åº“ä¸å‰ç«¯æ–‡æ¡£](./å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ-2-æ•°æ®åº“ä¸å‰ç«¯.md)
- ğŸ“„ [åç«¯ä¸æµ‹è¯•æ–‡æ¡£](./å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ-3-åç«¯ä¸æµ‹è¯•.md)
- ğŸ“„ [æ–¹æ¡ˆæ€»è§ˆREADME](./å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ-README.md)

---

## âœ… æ€»ç»“

**å·²å®Œæˆ**ï¼š
- âœ… æ•°æ®åº“è¡¨SQLè„šæœ¬
- âœ… 2ä¸ªå®ä½“ç±»ï¼ˆVisitorTokenã€QrVisitorUsageï¼‰
- âœ… 2ä¸ªMapperæ¥å£ï¼ˆVisitorTokenMapperã€QrVisitorUsageMapperï¼‰
- âœ… 2ä¸ªServiceï¼ˆVisitorTokenServiceã€QrVisitorUsageServiceï¼‰
- âœ… 1ä¸ªControllerï¼ˆExternalVisitorControllerï¼‰
- âœ… 1ä¸ªå®šæ—¶ä»»åŠ¡ï¼ˆVisitorCleanupTaskï¼‰

**å¾…å®Œæˆ**ï¼š
- â³ æ‰§è¡Œæ•°æ®åº“SQLè„šæœ¬
- â³ ä¿®æ”¹Parkingå®ä½“ç±»æ·»åŠ GPSå­—æ®µ
- â³ ä¿®æ”¹Controllerä¸­çš„ç¡¬ç¼–ç GPSåæ ‡
- â³ å¯ç”¨å®šæ—¶ä»»åŠ¡ï¼ˆ@EnableSchedulingï¼‰
- â³ å‰ç«¯ä»£ç é›†æˆï¼ˆå¯é€‰ï¼‰
- â³ æµ‹è¯•éªŒè¯

**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š1-2å°æ—¶

---

**å®æ–½æ—¥æœŸ**ï¼š2025-11-23  
**å®æ–½äºº**ï¼šCascade AI  
**ç‰ˆæœ¬**ï¼šv2.0ï¼ˆçº¯æ•°æ®åº“ç‰ˆæœ¬ï¼Œæ— éœ€Redisï¼‰âœ…
