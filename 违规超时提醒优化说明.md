# è¿è§„è¶…æ—¶æé†’åŠŸèƒ½ä¼˜åŒ–è¯´æ˜

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

ç®€åŒ–äº†è¿è§„å’Œè¶…æ—¶æé†’çš„å‘é€é€»è¾‘ï¼Œä¸å†éœ€è¦æŸ¥è¯¢`user_mapping`è¡¨ï¼Œç›´æ¥ä½¿ç”¨`appointment`è¡¨ä¸­çš„openidå­—æ®µï¼Œå¹¶æ ¹æ®é¢„çº¦ç±»å‹ï¼ˆ`appointtype`ï¼‰åŒºåˆ†å‘é€å¯¹è±¡ã€‚

## âœ¨ æ ¸å¿ƒæ”¹è¿›

### 1. **æ•°æ®æºç®€åŒ–**
- âŒ **åŸé€»è¾‘**ï¼šé€šè¿‡è®¿å®¢å§“å(`visitorname`) â†’ æŸ¥è¯¢`user_mapping`è¡¨ â†’ è·å–`openid`
- âœ… **æ–°é€»è¾‘**ï¼šç›´æ¥ä½¿ç”¨`appointment`è¡¨ä¸­çš„å­—æ®µï¼š
  - `openid`ï¼šè®¿å®¢openid
  - `owneropenid`ï¼šä¸šä¸»openid
  - `auditopenid`ï¼šç®¡å®¶openid

### 2. **æ ¹æ®é¢„çº¦ç±»å‹åŒºåˆ†å‘é€å¯¹è±¡**

#### é‚€è¯·é¢„çº¦ (`appointtype = "é‚€è¯·"`)
**å‘é€å¯¹è±¡**ï¼šè®¿å®¢ + ç®¡å®¶ + ä¸šä¸»

```
è®¿å®¢é‚€è¯·é¢„çº¦
â”œâ”€ openid â†’ è®¿å®¢
â”œâ”€ auditopenid â†’ ç®¡å®¶
â””â”€ owneropenid â†’ ä¸šä¸»
```

#### ä»£äººé¢„çº¦ (`appointtype = "ä»£äºº"`)
**å‘é€å¯¹è±¡**ï¼šç®¡å®¶ + ä¸šä¸»

```
ç®¡å®¶ä»£äººé¢„çº¦
â”œâ”€ auditopenid â†’ ç®¡å®¶
â””â”€ owneropenid â†’ ä¸šä¸»
```

#### å…¶ä»–ç±»å‹ï¼ˆè‡ªåŠ©ã€ä¸šä¸»é¢„çº¦ï¼‰
**å‘é€å¯¹è±¡**ï¼šè®¿å®¢

```
è‡ªåŠ©/ä¸šä¸»é¢„çº¦
â””â”€ openid â†’ è®¿å®¢
```

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

### 1. ParkingTimeoutController.java
**ä½ç½®**ï¼š`src/main/java/com/parkingmanage/controller/ParkingTimeoutController.java`

**ä¸»è¦ä¿®æ”¹**ï¼š
- ç§»é™¤äº†`UserMappingMapper`ä¾èµ–
- ç§»é™¤äº†`getOpenidByNickname()`æ–¹æ³•
- ä¿®æ”¹`sendTimeoutNotificationToVisitor()`æ–¹æ³•ï¼š
  - ç›´æ¥ä½¿ç”¨`appointment.getOpenid()`ã€`appointment.getAuditopenid()`ã€`appointment.getOwneropenid()`
  - æ ¹æ®`appointment.getAppointtype()`åŒºåˆ†å‘é€å¯¹è±¡
- æ–°å¢`sendNotificationToUser()`è¾…åŠ©æ–¹æ³•ï¼šç»Ÿä¸€å‘é€é€šçŸ¥ç»™æŒ‡å®šç”¨æˆ·

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// é‚€è¯·é¢„çº¦ï¼šé€šçŸ¥è®¿å®¢+ç®¡å®¶+ä¸šä¸»
if ("é‚€è¯·".equals(appointType)) {
    // 1. é€šçŸ¥è®¿å®¢
    if (!StringUtils.isEmpty(appointment.getOpenid())) {
        sendNotificationToUser(appointment.getOpenid(), appointment, timeValue, "å³å°†è¶…æ—¶æé†’(è®¿å®¢)");
    }
    // 2. é€šçŸ¥ç®¡å®¶
    if (!StringUtils.isEmpty(appointment.getAuditopenid())) {
        sendNotificationToUser(appointment.getAuditopenid(), appointment, timeValue, "å³å°†è¶…æ—¶æé†’(ç®¡å®¶)");
    }
    // 3. é€šçŸ¥ä¸šä¸»
    if (!StringUtils.isEmpty(appointment.getOwneropenid())) {
        sendNotificationToUser(appointment.getOwneropenid(), appointment, timeValue, "å³å°†è¶…æ—¶æé†’(ä¸šä¸»)");
    }
}
```

### 2. ViolationsController.java
**ä½ç½®**ï¼š`src/main/java/com/parkingmanage/controller/ViolationsController.java`

**ä¸»è¦ä¿®æ”¹**ï¼š
- æ–°å¢`AppointmentService`ä¾èµ–æ³¨å…¥
- ç§»é™¤äº†`getOpenidByNickname()`æ–¹æ³•
- ä¿®æ”¹`sendViolationNotification()`æ–¹æ³•ï¼š
  - é€šè¿‡`appointmentService.getById()`ç›´æ¥è·å–`Appointment`å¯¹è±¡
  - æ ¹æ®`appointment.getAppointtype()`åŒºåˆ†å‘é€å¯¹è±¡
- æ–°å¢`sendViolationNotificationToUser()`è¾…åŠ©æ–¹æ³•ï¼šç»Ÿä¸€å‘é€è¿è§„é€šçŸ¥ç»™æŒ‡å®šç”¨æˆ·

**ä»£ç ç¤ºä¾‹**ï¼š
```java
// ğŸ“‹ ç›´æ¥æŸ¥è¯¢appointmentå¯¹è±¡
Appointment appointment = appointmentService.getById(violation.getAppointmentId());

// ğŸ“Œ æ ¹æ®é¢„çº¦ç±»å‹ç¡®å®šé€šçŸ¥å¯¹è±¡
String appointType = appointment.getAppointtype();

// âœ… é‚€è¯·é¢„çº¦ï¼šé€šçŸ¥è®¿å®¢+ç®¡å®¶+ä¸šä¸»
if ("é‚€è¯·".equals(appointType)) {
    if (appointment.getOpenid() != null && !appointment.getOpenid().trim().isEmpty()) {
        sendViolationNotificationToUser(appointment.getOpenid(), plateNumber, parkName,
                violationLocation, parkingDuration, "è¿è§„é€šçŸ¥(è®¿å®¢)");
    }
    // ... é€šçŸ¥ç®¡å®¶å’Œä¸šä¸»
}
```

### 3. WeChatTemplateMessageService.java (æ¥å£)
**ä½ç½®**ï¼š`src/main/java/com/parkingmanage/service/WeChatTemplateMessageService.java`

**ä¸»è¦ä¿®æ”¹**ï¼š
- ä¿®æ”¹`sendParkingViolationNotification()`æ–¹æ³•ç­¾åï¼š
  - å‚æ•°ç”±`String managerNickname`æ”¹ä¸º`String openid`
  - æ›´æ–°JavaDocæ³¨é‡Šï¼Œè¯´æ˜å¯ä»¥æ¥æ”¶è®¿å®¢ã€ç®¡å®¶æˆ–ä¸šä¸»çš„openid

```java
/**
 * å‘é€è½¦è¾†è¿è§„åœè½¦å‘Šè­¦é€šçŸ¥
 * @param plateNumber è½¦ç‰Œå·
 * @param parkName åœè½¦åœºåç§°
 * @param violationLocation è¿è§„åœ°ç‚¹
 * @param parkingDuration åœè½¦æ—¶é•¿
 * @param openid æ¥æ”¶è€…openidï¼ˆå¯ä»¥æ˜¯è®¿å®¢ã€ç®¡å®¶æˆ–ä¸šä¸»çš„openidï¼‰
 * @return å‘é€ç»“æœ
 */
Map<String, Object> sendParkingViolationNotification(String plateNumber, String parkName, 
    String violationLocation, String parkingDuration, String openid);
```

### 4. WeChatTemplateMessageServiceImpl.java (å®ç°ç±»)
**ä½ç½®**ï¼š`src/main/java/com/parkingmanage/service/impl/WeChatTemplateMessageServiceImpl.java`

**ä¸»è¦ä¿®æ”¹**ï¼š
- ä¿®æ”¹`sendParkingViolationNotification()`æ–¹æ³•å®ç°ï¼š
  - ç§»é™¤äº†é€šè¿‡nicknameæŸ¥è¯¢openidçš„é€»è¾‘
  - ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„openidå‚æ•°
  - æ›´æ–°æ—¥å¿—è¾“å‡ºï¼Œæ˜¾ç¤ºopenidè€Œä¸æ˜¯nickname

```java
@Override
public Map<String, Object> sendParkingViolationNotification(String plateNumber, String parkName, 
    String violationLocation, String parkingDuration, String openid) {
    
    try {
        log.info("ğŸš¨ å¼€å§‹å‘é€è½¦è¾†è¿è§„åœè½¦å‘Šè­¦é€šçŸ¥ - è½¦ç‰Œ: {}, åœè½¦åœº: {}, openid: {}", 
            plateNumber, parkName, openid);
        
        // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„openid
        if (!StringUtils.hasText(openid)) {
            result.put("success", false);
            result.put("message", "openidä¸ºç©ºï¼Œæ— æ³•å‘é€é€šçŸ¥");
            return result;
        }
        
        // ... å‘é€æ¨¡æ¿æ¶ˆæ¯
    }
}
```

## ğŸ” ä¼˜åŒ–æ•ˆæœ

### 1. æ€§èƒ½æå‡
- âœ… å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°ï¼ˆä¸å†æŸ¥è¯¢`user_mapping`è¡¨ï¼‰
- âœ… ç®€åŒ–æ•°æ®æµè½¬è·¯å¾„
- âœ… é™ä½ç³»ç»Ÿå¤æ‚åº¦

### 2. åŠŸèƒ½å¢å¼º
- âœ… æ”¯æŒå¤šè§’è‰²é€šçŸ¥ï¼ˆè®¿å®¢ã€ç®¡å®¶ã€ä¸šä¸»ï¼‰
- âœ… æ ¹æ®é¢„çº¦ç±»å‹æ™ºèƒ½åˆ†å‘é€šçŸ¥
- âœ… æé«˜é€šçŸ¥çš„ç²¾å‡†æ€§

### 3. ä»£ç è´¨é‡
- âœ… æ¶ˆé™¤å¯¹`user_mapping`è¡¨çš„ä¾èµ–
- âœ… ç»Ÿä¸€é€šçŸ¥å‘é€é€»è¾‘
- âœ… æé«˜ä»£ç å¯ç»´æŠ¤æ€§
- âœ… æ›´æ¸…æ™°çš„ä¸šåŠ¡é€»è¾‘

## ğŸ“Š é€šçŸ¥å‘é€è§„åˆ™æ€»ç»“

| é¢„çº¦ç±»å‹ | è®¿å®¢é€šçŸ¥ | ç®¡å®¶é€šçŸ¥ | ä¸šä¸»é€šçŸ¥ | æ•°æ®æ¥æº |
|---------|---------|---------|---------|---------|
| é‚€è¯· | âœ… | âœ… | âœ… | appointmentè¡¨ |
| ä»£äºº | âŒ | âœ… | âœ… | appointmentè¡¨ |
| è‡ªåŠ© | âœ… | âŒ | âŒ | appointmentè¡¨ |
| ä¸šä¸» | âœ… | âŒ | âŒ | appointmentè¡¨ |

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **ç¡®ä¿æ•°æ®å®Œæ•´æ€§**ï¼šappointmentè¡¨ä¸­çš„`openid`ã€`owneropenid`ã€`auditopenid`å­—æ®µå¿…é¡»æ­£ç¡®å¡«å……

2. **å…¼å®¹æ€§**ï¼šä¿®æ”¹åçš„ä»£ç ä¸åŸæœ‰ä¸šåŠ¡é€»è¾‘å®Œå…¨å…¼å®¹ï¼Œä¸å½±å“å…¶ä»–åŠŸèƒ½

3. **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰é€šçŸ¥å‘é€éƒ½æœ‰è¯¦ç»†çš„æ—¥å¿—è®°å½•ï¼Œä¾¿äºè¿½è¸ªå’Œè°ƒè¯•

4. **é”™è¯¯å¤„ç†**ï¼šå¦‚æœæŸä¸ªopenidä¸ºç©ºï¼Œä¼šè·³è¿‡è¯¥ç”¨æˆ·çš„é€šçŸ¥ï¼Œä¸å½±å“å…¶ä»–ç”¨æˆ·æ¥æ”¶é€šçŸ¥

## ğŸš€ åç»­å»ºè®®

1. ä¿®å¤`StringUtils.isEmpty()`çš„å¼ƒç”¨è­¦å‘Šï¼ˆä½¿ç”¨`StringUtils.hasText()`ä»£æ›¿ï¼‰
2. è€ƒè™‘æ·»åŠ é€šçŸ¥å‘é€å¤±è´¥çš„é‡è¯•æœºåˆ¶
3. å¯ä»¥å¢åŠ é€šçŸ¥å‘é€å†å²è®°å½•è¡¨ï¼Œä¾¿äºç»Ÿè®¡åˆ†æ

---

**ä¿®æ”¹å®Œæˆæ—¶é—´**ï¼š2025-12-04  
**ä¿®æ”¹äºº**ï¼šAI Assistant  
**å½±å“èŒƒå›´**ï¼šè¿è§„æé†’ã€è¶…æ—¶æé†’åŠŸèƒ½
