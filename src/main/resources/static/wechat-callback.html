<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡æˆæƒä¸­...</title>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 600px; /* å¢åŠ å®½åº¦ */
            margin: 50px auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1890ff, #40a9ff); /* æ”¹ä¸ºè“è‰²æ¸å˜ */
            color: white;
            padding: 50px 30px; /* å¢åŠ é«˜åº¦ */
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 300;
        }
        
        .content {
            padding: 30px;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
        }
        
        .loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1890ff; /* æ”¹ä¸ºè“è‰² */
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .user-info {
            display: none;
            text-align: center;
        }
        
        .avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: block;
            border: 3px solid #1890ff; /* æ”¹ä¸ºè“è‰² */
        }
        
        .nickname {
            font-size: 20px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #333;
        }
        
        /* ç§»é™¤openidæ ·å¼ */
        /* .openid {
            font-size: 12px;
            color: #999;
            word-break: break-all;
            background: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            margin: 20px 0;
        } */
        
        .error {
            display: none;
            color: #e74c3c;
            text-align: center;
            padding: 20px;
        }
        
        /* ç§»é™¤æŒ‰é’®ç›¸å…³æ ·å¼ */
        /* .success-actions {
            margin-top: 30px;
            text-align: center;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: #1AAD19;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 0 10px;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #179B16;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        } */
        
        .debug-info {
            margin-top: 30px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            color: #666;
            display: none;
        }
        
        .debug-info.show {
            display: block;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <!-- ç§»é™¤æ ‡é¢˜æ–‡å­— -->
            <!-- <h1>ğŸš— åœè½¦ç®¡ç†ç³»ç»Ÿ</h1> -->
        </div>
        
        <div class="content">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>æ­£åœ¨éªŒè¯å¾®ä¿¡æˆæƒ...</p>
            </div>
            
            <!-- ç”¨æˆ·ä¿¡æ¯å±•ç¤º -->
            <div id="userInfo" class="user-info">
                <img id="avatar" class="avatar" src="" alt="å¤´åƒ">
                <div id="nickname" class="nickname"></div>
                <!-- ç§»é™¤OpenIDæ˜¾ç¤º -->
                <!-- <div class="openid">OpenID: <span id="openid"></span></div> -->
                
                <!-- ç§»é™¤æŒ‰é’®åŒºåŸŸ -->
                <!-- <div class="success-actions">
                    <a href="#" class="btn" onclick="continueToApp()">ç»§ç»­ä½¿ç”¨åº”ç”¨</a>
                    <a href="#" class="btn btn-secondary" onclick="showDebugInfo()">è°ƒè¯•ä¿¡æ¯</a>
                </div> -->
            </div>
            
            <!-- é”™è¯¯ä¿¡æ¯ -->
            <div id="error" class="error">
                <h3>âŒ æˆæƒå¤±è´¥</h3>
                <p id="errorMessage"></p>
                <!-- ç§»é™¤é‡è¯•æŒ‰é’® -->
                <!-- <div style="margin-top: 20px;">
                    <a href="#" class="btn" onclick="retryAuth()">é‡è¯•æˆæƒ</a>
                </div> -->
            </div>
            
            <!-- è°ƒè¯•ä¿¡æ¯ -->
            <div id="debugInfo" class="debug-info">
                <h4>è°ƒè¯•ä¿¡æ¯</h4>
                <div id="debugContent"></div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡æ ‡è¯†JS-SDKæ˜¯å¦å·²å‡†å¤‡å°±ç»ª
        window.isWxReady = false;
        
        // é¡µé¢åŠ è½½å®Œæˆåæ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            handleWeChatCallback();
        });

        /**
         * åˆå§‹åŒ–å¾®ä¿¡JS-SDK
         */
        async function initWechatJSSDK() {
            console.log('ğŸ”§ å¼€å§‹åˆå§‹åŒ–å¾®ä¿¡JS-SDK...');
            
            const currentUrl = window.location.href.split('#')[0]; // å»æ‰hashéƒ¨åˆ†
            console.log('ğŸŒ å½“å‰URL:', currentUrl);
            
            try {
                // è°ƒç”¨åç«¯æ¥å£è·å–JS-SDKç­¾å
                const response = await fetch('/parking/wechat-public/getJssdkSignature', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        url: currentUrl
                    })
                });
                
                console.log('ğŸ“Š å“åº”çŠ¶æ€:', response.status, response.statusText);
                
                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ JS-SDKç­¾åè¯·æ±‚å¤±è´¥:', response.status, errorText);
                    addDebugInfo('JS-SDKç­¾åé”™è¯¯', {
                        status: response.status,
                        statusText: response.statusText,
                        errorText: errorText.substring(0, 200) // åªæ˜¾ç¤ºå‰200ä¸ªå­—ç¬¦
                    });
                    // å¦‚æœç­¾åå¤±è´¥ï¼Œä»ç„¶å°è¯•ä½¿ç”¨postMessageä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                    return;
                }
                
                const result = await response.json();
                console.log('ğŸ“¥ è·å–JS-SDKç­¾åå“åº”:', result);
                
                addDebugInfo('JS-SDKç­¾å', result);
                
                if (result.code === '0' && result.data) {
                    const config = result.data;
                    
                    // é…ç½®å¾®ä¿¡JS-SDK
                    wx.config({
                        debug: false, // ç”Ÿäº§ç¯å¢ƒè®¾ä¸ºfalse
                        appId: config.appId,
                        timestamp: config.timestamp,
                        nonceStr: config.nonceStr,
                        signature: config.signature,
                        jsApiList: [
                            'miniProgram'  // å°ç¨‹åºç›¸å…³æ¥å£
                        ]
                    });
                    
                    console.log('âœ… å¾®ä¿¡JS-SDKé…ç½®å®Œæˆ');
                    
                    // ç­‰å¾…é…ç½®å®Œæˆ
                    return new Promise((resolve, reject) => {
                        wx.ready(() => {
                            console.log('âœ… å¾®ä¿¡JS-SDKé…ç½®æˆåŠŸ');
                            window.isWxReady = true;
                            addDebugInfo('JS-SDKçŠ¶æ€', 'é…ç½®æˆåŠŸ');
                            resolve();
                        });
                        
                        wx.error((res) => {
                            console.error('âŒ å¾®ä¿¡JS-SDKé…ç½®å¤±è´¥:', res);
                            window.isWxReady = false;
                            addDebugInfo('JS-SDKçŠ¶æ€', 'é…ç½®å¤±è´¥: ' + JSON.stringify(res));
                            resolve(); // ä¸é˜»å¡åç»­æµç¨‹ï¼Œä½¿ç”¨postMessageä½œä¸ºå¤‡é€‰
                        });
                        
                        // è®¾ç½®è¶…æ—¶æœºåˆ¶
                        setTimeout(() => {
                            if (!window.isWxReady) {
                                console.warn('âš ï¸ JS-SDKé…ç½®è¶…æ—¶ï¼Œä½¿ç”¨å¤‡é€‰æ–¹æ¡ˆ');
                                addDebugInfo('JS-SDKçŠ¶æ€', 'é…ç½®è¶…æ—¶');
                                resolve();
                            }
                        }, 3000);
                    });
                    
                } else {
                    console.error('âŒ è·å–JS-SDKç­¾åå¤±è´¥:', result.msg);
                    addDebugInfo('JS-SDKé”™è¯¯', result.msg);
                    // å¦‚æœç­¾åå¤±è´¥ï¼Œä»ç„¶å°è¯•ä½¿ç”¨postMessageä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
                }
            } catch (error) {
                console.error('âŒ åˆå§‹åŒ–JS-SDKå¼‚å¸¸:', error);
                addDebugInfo('JS-SDKå¼‚å¸¸', error.message);
                // å¦‚æœç½‘ç»œå¼‚å¸¸ï¼Œä»ç„¶å°è¯•ä½¿ç”¨postMessageä½œä¸ºå¤‡é€‰æ–¹æ¡ˆ
            }
        }

        /**
         * å¤„ç†å¾®ä¿¡æˆæƒå›è°ƒ
         */
        async function handleWeChatCallback() {
            try {
                // ğŸ†• é¦–å…ˆåˆå§‹åŒ–å¾®ä¿¡JS-SDK
                // await initWechatJSSDK();
                
                // æ·»åŠ é¡µé¢åŸºæœ¬ä¿¡æ¯åˆ°è°ƒè¯•
                addDebugInfo('é¡µé¢ä¿¡æ¯', {
                    url: window.location.href,
                    timestamp: new Date().toISOString(),
                    userAgent: navigator.userAgent.substring(0, 100) + '...'
                });
                
                // 1. è·å–URLå‚æ•°
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                
                addDebugInfo('URLå‚æ•°', { code, state });
                
                // 2. æ£€æŸ¥æ˜¯å¦æœ‰codeå‚æ•°
                if (!code) {
                    const noCodeErrorMsg = 'æœªè·å–åˆ°æˆæƒç ï¼Œè¯·é‡æ–°æˆæƒ';
                    showError(noCodeErrorMsg);
                    
                    // ğŸ†• å¦‚æœåœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œå‘é€æˆæƒå¤±è´¥æ¶ˆæ¯
                    if (isInMiniProgramWebView()) {
                        sendAuthFailureToMiniProgram(noCodeErrorMsg);
                    }
                    return;
                }
                
                // 3. è°ƒç”¨åç«¯APIè¿›è¡Œæˆæƒ
                const response = await fetch('/parking/wechat/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        state: state
                    })
                });
                
                const result = await response.json();
                addDebugInfo('åç«¯å“åº”', result);
                
                // 4. å¤„ç†å“åº”ç»“æœ - åŸºäºæ§åˆ¶å™¨çš„Resultæ ¼å¼
                if (result.code === '0') {
                    showUserInfo(result.data);
                    
                    // ä¿å­˜ç”¨æˆ·ä¿¡æ¯åˆ°localStorageï¼ˆå¯é€‰ï¼‰
                    if (result.data.accessToken) {
                        localStorage.setItem('wechat_access_token', result.data.accessToken);
                    }
                    if (result.data.userInfo) {
                        localStorage.setItem('wechat_user_info', JSON.stringify(result.data.userInfo));
                    }
                    if (result.data.localUser) {
                        localStorage.setItem('local_user_info', JSON.stringify(result.data.localUser));
                    }
                } else {
                    const errorMsg = result.msg || 'æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•';
                    showError(errorMsg);
                    
                    // ğŸ†• å¦‚æœåœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œå‘é€æˆæƒå¤±è´¥æ¶ˆæ¯
                    if (isInMiniProgramWebView()) {
                        sendAuthFailureToMiniProgram(errorMsg);
                    }
                }
                
            } catch (error) {
                console.error('æˆæƒå¤„ç†å¼‚å¸¸:', error);
                addDebugInfo('å¼‚å¸¸ä¿¡æ¯', {
                    message: error.message,
                    stack: error.stack,
                    timestamp: new Date().toISOString()
                });
                const networkErrorMsg = 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•';
                showError(networkErrorMsg);
                
                // ğŸ†• å¦‚æœåœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œå‘é€æˆæƒå¤±è´¥æ¶ˆæ¯
                if (isInMiniProgramWebView()) {
                    sendAuthFailureToMiniProgram(networkErrorMsg);
                }
            }
        }

        /**
         * æ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
         */
        function showUserInfo(data) {
            const userInfo = data.userInfo || {};
            
            document.getElementById('loading').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            
            // è®¾ç½®ç”¨æˆ·ä¿¡æ¯
            const avatar = document.getElementById('avatar');
            avatar.src = userInfo.headimgurl || 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiMxQUFEMTkiLz4KPGC4Y3g9IjQwIiBjeT0iMzQiIHI9IjE0IiBmaWxsPSJ3aGl0ZSIvPgo8ZWxsaXBzZSBjeD0iNDAiIGN5PSI2NSIgcng9IjIwIiByeT0iMTIiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=';
            
            // å¤„ç†å¤´åƒåŠ è½½é”™è¯¯
            avatar.onerror = function() {
                this.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODAiIGhlaWdodD0iODAiIHZpZXdCb3g9IjAgMCA4MCA4MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iNDAiIGN5PSI0MCIgcj0iNDAiIGZpbGw9IiMxQUFEMTkiLz4KPGC4Y3g9IjQwIiBjeT0iMzQiIHI9IjE0IiBmaWxsPSJ3aGl0ZSIvPgo8ZWxsaXBzZSBjeD0iNDAiIGN5PSI2NSIgcng9IjIwIiByeT0iMTIiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=';
                this.onerror = null; // é˜²æ­¢æ— é™å¾ªç¯
            };
            
            document.getElementById('nickname').textContent = userInfo.nickname || 'å¾®ä¿¡ç”¨æˆ·';
            // ç§»é™¤OpenIDæ˜¾ç¤º
            // document.getElementById('openid').textContent = userInfo.openid || 'N/A';
            
            // ç§»é™¤è¯¦ç»†ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            // addUserDetails(data);
        }
        
        /**
         * æ·»åŠ è¯¦ç»†ç”¨æˆ·ä¿¡æ¯å±•ç¤º
         */
        function addUserDetails(data) {
            const userInfoDiv = document.getElementById('userInfo');
            
            // åˆ›å»ºè¯¦ç»†ä¿¡æ¯å®¹å™¨
            let detailsDiv = document.getElementById('userDetails');
            if (!detailsDiv) {
                detailsDiv = document.createElement('div');
                detailsDiv.id = 'userDetails';
                detailsDiv.style.cssText = `
                    margin-top: 20px;
                    padding: 15px;
                    background: #f8f9fa;
                    border-radius: 5px;
                    font-size: 14px;
                    text-align: left;
                `;
                
                // æ’å…¥åˆ°æˆåŠŸæ“ä½œæŒ‰é’®ä¹‹å‰
                const successActions = userInfoDiv.querySelector('.success-actions');
                userInfoDiv.insertBefore(detailsDiv, successActions);
            }
            
            // æ„å»ºè¯¦ç»†ä¿¡æ¯HTML
            let detailsHtml = '<h4 style="margin-top:0; color:#1AAD19;">âœ… æˆæƒä¿¡æ¯</h4>';
            
            // æˆæƒèŒƒå›´
            if (data.authScope) {
                detailsHtml += `<p><strong>æˆæƒèŒƒå›´ï¼š</strong>${data.authScope === 'snsapi_userinfo' ? 'è·å–ç”¨æˆ·ä¿¡æ¯' : 'ä»…è·å–OpenID'}</p>`;
            }
            
            // æœ¬åœ°ç”¨æˆ·çŠ¶æ€
            if (data.hasOwnProperty('isRegistered')) {
                detailsHtml += `<p><strong>æ³¨å†ŒçŠ¶æ€ï¼š</strong>${data.isRegistered ? 'âœ… å·²æ³¨å†Œ' : 'âŒ æœªæ³¨å†Œ'}</p>`;
            }
            
            // æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
            if (data.localUser) {
                detailsHtml += '<h4 style="color:#1AAD19;">ğŸ‘¤ æœ¬åœ°ç”¨æˆ·ä¿¡æ¯</h4>';
                detailsHtml += `<p><strong>ç”¨æˆ·IDï¼š</strong>${data.localUser.userid || 'N/A'}</p>`;
                detailsHtml += `<p><strong>æ‰‹æœºå·ï¼š</strong>${data.localUser.userphone || 'N/A'}</p>`;
                detailsHtml += `<p><strong>å§“åï¼š</strong>${data.localUser.username || 'N/A'}</p>`;
                if (data.localUser.userkind) {
                    detailsHtml += `<p><strong>ç”¨æˆ·ç±»å‹ï¼š</strong>${data.localUser.userkind}</p>`;
                }
            }
            
            // çŠ¶æ€å‚æ•°
            if (data.state) {
                detailsHtml += `<p><strong>çŠ¶æ€å‚æ•°ï¼š</strong>${data.state}</p>`;
            }
            
            detailsDiv.innerHTML = detailsHtml;
        }

        /**
         * æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
         */
        function showError(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').style.display = 'block';
            document.getElementById('errorMessage').textContent = message;
        }

        /**
         * æ˜¾ç¤ºæˆåŠŸä¿¡æ¯
         */
        function showSuccess(message) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('userInfo').style.display = 'block';
            
            // åˆ›å»ºæˆ–æ›´æ–°æˆåŠŸæç¤ºå…ƒç´ 
            let successElement = document.getElementById('successMessage');
            if (!successElement) {
                successElement = document.createElement('div');
                successElement.id = 'successMessage';
                successElement.style.cssText = `
                    color: #1AAD19;
                    text-align: center;
                    font-size: 16px;
                    font-weight: 500;
                    margin-bottom: 20px;
                    padding: 15px;
                    background: #f0fff0;
                    border-radius: 5px;
                    border: 1px solid #1AAD19;
                `;
                document.querySelector('.content').insertBefore(successElement, document.getElementById('userInfo'));
            }
            successElement.textContent = message;
        }

        /**
         * ç»§ç»­ä½¿ç”¨åº”ç”¨
         */
        function continueToApp() {
            // ğŸ†• æ£€æŸ¥æ˜¯å¦åœ¨å°ç¨‹åº web-view ç¯å¢ƒä¸­
            if (isInMiniProgramWebView()) {
                // åœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œå‘å°ç¨‹åºå‘é€æˆæƒæˆåŠŸæ¶ˆæ¯
                sendMessageToMiniProgram();
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æœ¬åœ°ç”¨æˆ·ä¿¡æ¯
            const localUserInfo = localStorage.getItem('local_user_info');
            const wechatUserInfo = localStorage.getItem('wechat_user_info');
            
            if (localUserInfo) {
                // å·²æ³¨å†Œç”¨æˆ·ï¼Œè·³è½¬åˆ°ä¸»åº”ç”¨
                window.location.href = '/parking/index.html';
            } else if (wechatUserInfo) {
                // ä»…æœ‰å¾®ä¿¡ä¿¡æ¯ï¼Œå¯èƒ½éœ€è¦æ³¨å†Œ
                window.location.href = '/parking/register.html';
            } else {
                // è·³è½¬åˆ°æµ‹è¯•é¡µé¢
                window.location.href = '/wechat-auth-test.html';
            }
            
            // åœ¨å¾®ä¿¡å†…ç½®æµè§ˆå™¨ä¸­å¯ä»¥é€‰æ‹©å…³é—­çª—å£
            // if (navigator.userAgent.indexOf('MicroMessenger') !== -1) {
            //     window.close();
            // }
        }

        /**
         * ğŸ†• æ£€æŸ¥æ˜¯å¦åœ¨å°ç¨‹åº web-view ç¯å¢ƒä¸­
         */
        function isInMiniProgramWebView() {
            // æ£€æŸ¥æ˜¯å¦å­˜åœ¨å°ç¨‹åºç¯å¢ƒçš„æ ‡è¯†
            return window.__wxjs_environment === 'miniprogram' || 
                   wx?.miniProgram || 
                   navigator.userAgent.indexOf('miniProgram') !== -1;
        }

        /**
         * ğŸ†• å‘å°ç¨‹åºå‘é€æˆæƒæˆåŠŸæ¶ˆæ¯
         */
        function sendMessageToMiniProgram() {
            try {
                const wechatUserInfo = JSON.parse(localStorage.getItem('wechat_user_info') || '{}');
                
                addDebugInfo('å‘å°ç¨‹åºå‘é€æ¶ˆæ¯', {
                    hasWechatUserInfo: !!wechatUserInfo.openid,
                    userInfo: {
                        openid: wechatUserInfo.openid || 'N/A',
                        nickname: wechatUserInfo.nickname || 'N/A'
                    }
                });

                // ğŸ†• ä¿å­˜æˆæƒç»“æœåˆ°æœ¬åœ°å­˜å‚¨ï¼Œä¾›å°ç¨‹åºè¯»å–
                const authResult = {
                    success: true,
                    userInfo: wechatUserInfo,
                    timestamp: Date.now()
                };
                
                try {
                    localStorage.setItem('wechat_auth_result', JSON.stringify(authResult));
                    addDebugInfo('æˆæƒç»“æœä¿å­˜', 'å·²ä¿å­˜åˆ°localStorage');
                } catch (e) {
                    addDebugInfo('æˆæƒç»“æœä¿å­˜å¤±è´¥', e.message);
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰å¾®ä¿¡JSSDKå¹¶ä¸”å·²æ­£ç¡®é…ç½®
                if (wx && wx.miniProgram) {
                    // ä½¿ç”¨å¾®ä¿¡JSSDKå‘é€æ¶ˆæ¯
                    wx.miniProgram.postMessage({
                        data: {
                            type: 'auth_success',
                            userInfo: wechatUserInfo,
                            timestamp: Date.now()
                        }
                    });
                    
                    // ğŸ†• ç«‹å³è·³è½¬åˆ°æ‰‹æœºå·æˆæƒé¡µé¢ï¼Œæºå¸¦ç”¨æˆ·ä¿¡æ¯ä½œä¸ºURLå‚æ•°
                    setTimeout(() => {
                        // æ„é€ URLå‚æ•°ï¼ŒåŒ…å«å®Œæ•´çš„ç”¨æˆ·ä¿¡æ¯
                        const urlParams = new URLSearchParams({
                            fromWechatAuth: 'true',
                            authSuccess: 'true',
                            openid: wechatUserInfo.openid || '',
                            nickname: encodeURIComponent(wechatUserInfo.nickname || ''),
                            sex: wechatUserInfo.sex || 0,
                            city: encodeURIComponent(wechatUserInfo.city || ''),
                            province: encodeURIComponent(wechatUserInfo.province || ''),
                            country: encodeURIComponent(wechatUserInfo.country || ''),
                            headimgurl: encodeURIComponent(wechatUserInfo.headimgurl || ''),
                            unionid: wechatUserInfo.unionid || '',
                            timestamp: Date.now()
                        });
                        
                        wx.miniProgram.navigateTo({
                            url: `/pages/auth/phone-auth?fromWechatAuth=true&${urlParams.toString()}`
                        });
                    }, 500); // ç¼©çŸ­å»¶è¿Ÿæ—¶é—´
                    
                    addDebugInfo('æ¶ˆæ¯å‘é€çŠ¶æ€', 'å·²é€šè¿‡å¾®ä¿¡JSSDKå‘é€ï¼ˆç­¾åéªŒè¯é€šè¿‡ï¼‰');
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ postMessage
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'auth_success',
                            userInfo: wechatUserInfo,
                            timestamp: Date.now()
                        }, '*');
                    }
                    
                    // é™çº§æ–¹æ¡ˆä¹Ÿè¦è·³è½¬
                    setTimeout(() => {
                        if (wx && wx.miniProgram) {
                            wx.miniProgram.navigateTo({
                                url: '/pages/auth/phone-auth?fromWechatAuth=true'
                            });
                        }
                    }, 500);
                    
                    addDebugInfo('æ¶ˆæ¯å‘é€çŠ¶æ€', 'å·²é€šè¿‡postMessageå‘é€ï¼ˆJS-SDKæœªå°±ç»ªï¼‰');
                }
                
                // æ˜¾ç¤ºæˆåŠŸæç¤º
                showSuccess('å¾®ä¿¡æˆæƒæˆåŠŸï¼æ­£åœ¨è·³è½¬åˆ°æ‰‹æœºå·æˆæƒé¡µé¢...');
                
            } catch (error) {
                console.error('å‘å°ç¨‹åºå‘é€æ¶ˆæ¯å¤±è´¥:', error);
                addDebugInfo('å‘é€æ¶ˆæ¯é”™è¯¯', {
                    message: error.message,
                    stack: error.stack
                });
                
                // ğŸ†• å³ä½¿å‘é€å¤±è´¥ï¼Œä¹Ÿè¦ä¿å­˜é”™è¯¯ç»“æœå¹¶è·³è½¬
                const errorResult = {
                    success: false,
                    error: error.message,
                    timestamp: Date.now()
                };
                
                try {
                    localStorage.setItem('wechat_auth_result', JSON.stringify(errorResult));
                } catch (e) {
                    console.error('ä¿å­˜é”™è¯¯ç»“æœå¤±è´¥:', e);
                }
                
                // å‘é€å¤±è´¥ï¼Œå°è¯•è·³è½¬åˆ°æ‰‹æœºå·æˆæƒé¡µé¢
                if (wx && wx.miniProgram) {
                    wx.miniProgram.navigateTo({
                        url: '/pages/auth/phone-auth?fromWechatAuth=true&error=true'
                    });
                }
            }
        }

        /**
         * ğŸ†• å‘å°ç¨‹åºå‘é€æˆæƒå¤±è´¥æ¶ˆæ¯
         */
        function sendAuthFailureToMiniProgram(errorMessage) {
            try {
                addDebugInfo('å‘å°ç¨‹åºå‘é€å¤±è´¥æ¶ˆæ¯', { errorMessage });

                // ğŸ†• ä¿å­˜æˆæƒå¤±è´¥ç»“æœåˆ°æœ¬åœ°å­˜å‚¨
                const errorResult = {
                    success: false,
                    error: errorMessage,
                    timestamp: Date.now()
                };
                
                try {
                    localStorage.setItem('wechat_auth_result', JSON.stringify(errorResult));
                    addDebugInfo('æˆæƒå¤±è´¥ç»“æœä¿å­˜', 'å·²ä¿å­˜åˆ°localStorage');
                } catch (e) {
                    addDebugInfo('æˆæƒå¤±è´¥ç»“æœä¿å­˜å¤±è´¥', e.message);
                }

                // æ£€æŸ¥æ˜¯å¦æœ‰å¾®ä¿¡JSSDKå¹¶ä¸”å·²æ­£ç¡®é…ç½®
                if (window.isWxReady && wx && wx.miniProgram) {
                    // ä½¿ç”¨å¾®ä¿¡JSSDKå‘é€æ¶ˆæ¯
                    wx.miniProgram.postMessage({
                        data: {
                            type: 'auth_error',
                            error: errorMessage,
                            timestamp: Date.now()
                        }
                    });
                    
                    // ğŸ†• å³ä½¿å¤±è´¥ä¹Ÿè¦è·³è½¬å›å»ï¼Œè®©ç”¨æˆ·å¯ä»¥é‡è¯•æˆ–è·³è¿‡
                    setTimeout(() => {
                        wx.miniProgram.navigateTo({
                            url: '/pages/auth/phone-auth?fromWechatAuth=true&error=true'
                        });
                    }, 1500); // ç¨å¾®å»¶é•¿ä¸€ç‚¹æ—¶é—´è®©ç”¨æˆ·çœ‹åˆ°é”™è¯¯ä¿¡æ¯
                    
                    addDebugInfo('å¤±è´¥æ¶ˆæ¯å‘é€çŠ¶æ€', 'å·²é€šè¿‡å¾®ä¿¡JSSDKå‘é€ï¼ˆç­¾åéªŒè¯é€šè¿‡ï¼‰');
                } else {
                    // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨ postMessage
                    if (window.parent && window.parent !== window) {
                        window.parent.postMessage({
                            type: 'auth_error',
                            error: errorMessage,
                            timestamp: Date.now()
                        }, '*');
                    }
                    
                    // é™çº§æ–¹æ¡ˆä¹Ÿè¦è·³è½¬
                    setTimeout(() => {
                        if (wx && wx.miniProgram) {
                            wx.miniProgram.navigateTo({
                                url: '/pages/auth/phone-auth?fromWechatAuth=true&error=true'
                            });
                        }
                    }, 1500);
                    
                    addDebugInfo('å¤±è´¥æ¶ˆæ¯å‘é€çŠ¶æ€', 'å·²é€šè¿‡postMessageå‘é€ï¼ˆJS-SDKæœªå°±ç»ªï¼‰');
                }
                
            } catch (error) {
                console.error('å‘å°ç¨‹åºå‘é€å¤±è´¥æ¶ˆæ¯å¤±è´¥:', error);
                addDebugInfo('å‘é€å¤±è´¥æ¶ˆæ¯é”™è¯¯', {
                    message: error.message,
                    stack: error.stack
                });
                
                // å‘é€å¤±è´¥ï¼Œå°è¯•è·³è½¬åˆ°æ‰‹æœºå·æˆæƒé¡µé¢
                if (wx && wx.miniProgram) {
                    wx.miniProgram.navigateTo({
                        url: '/pages/auth/phone-auth?fromWechatAuth=true&error=true'
                    });
                }
            }
        }

        /**
         * ğŸ†• é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ£€æµ‹å¹¶å¤„ç†
         */
        window.addEventListener('load', function() {
            // å»¶è¿Ÿæ‰§è¡Œï¼Œç¡®ä¿é¡µé¢å®Œå…¨åŠ è½½
            setTimeout(() => {
                // å¦‚æœåœ¨å°ç¨‹åºç¯å¢ƒä¸­ï¼Œæ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨è·³è½¬
                if (isInMiniProgramWebView()) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç”¨æˆ·ä¿¡æ¯
                    const wechatUserInfo = localStorage.getItem('wechat_user_info');
                    if (wechatUserInfo) {
                        // æœ‰ç”¨æˆ·ä¿¡æ¯ï¼Œè‡ªåŠ¨å‘é€æˆåŠŸæ¶ˆæ¯
                        addDebugInfo('è‡ªåŠ¨æ£€æµ‹', 'æ£€æµ‹åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè‡ªåŠ¨å‘é€æˆåŠŸæ¶ˆæ¯');
                        setTimeout(() => {
                            sendMessageToMiniProgram();
                        }, 3000); // 3ç§’åè‡ªåŠ¨è·³è½¬
                    }
                }
            }, 1000);
        });

        /**
         * é‡è¯•æˆæƒ
         */
        async function retryAuth() {
            try {
                // è°ƒç”¨æ§åˆ¶å™¨è·å–æ–°çš„æˆæƒURL
                const response = await fetch('/parking/wechat/auth-url?scope=snsapi_userinfo&state=retry_' + Date.now());
                const result = await response.json();
                
                if (result.code === '0') {
                    // è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
                    window.location.href = result.data;
                } else {
                    alert('è·å–æˆæƒURLå¤±è´¥: ' + result.msg);
                }
            } catch (error) {
                console.error('é‡è¯•æˆæƒå¤±è´¥:', error);
                alert('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•');
            }
        }

        /**
         * æ˜¾ç¤º/éšè—è°ƒè¯•ä¿¡æ¯
         */
        function showDebugInfo() {
            const debugInfo = document.getElementById('debugInfo');
            debugInfo.classList.toggle('show');
        }

        /**
         * æ·»åŠ è°ƒè¯•ä¿¡æ¯
         */
        function addDebugInfo(title, data) {
            const debugContent = document.getElementById('debugContent');
            const debugItem = document.createElement('div');
            debugItem.innerHTML = `
                <strong>${title}:</strong><br>
                <pre>${JSON.stringify(data, null, 2)}</pre>
                <hr>
            `;
            debugContent.appendChild(debugItem);
        }

        // å¾®ä¿¡JS-SDKç›¸å…³ï¼ˆå¯é€‰ï¼‰
        // å¦‚æœæ‚¨éœ€è¦è°ƒç”¨å¾®ä¿¡JS-SDKåŠŸèƒ½ï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ 
        /*
        function initWeChatJSSDK() {
            // é…ç½®å¾®ä¿¡JS-SDK
            wx.config({
                // é…ç½®ä¿¡æ¯
            });
        }
        */
    </script>
</body>
</html> 