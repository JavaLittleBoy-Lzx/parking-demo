<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¾®ä¿¡ç½‘é¡µæˆæƒæµ‹è¯•</title>
    <style>
        body {
            font-family: 'PingFang SC', 'Helvetica Neue', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #1AAD19, #2DC653);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 300;
        }
        
        .content {
            padding: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #eee;
            border-radius: 8px;
        }
        
        .test-section h3 {
            margin-top: 0;
            color: #1AAD19;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 30px;
            background: #1AAD19;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            margin: 10px 5px;
            font-size: 14px;
            transition: background 0.3s;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            background: #179B16;
        }
        
        .btn-secondary {
            background: #95a5a6;
        }
        
        .btn-secondary:hover {
            background: #7f8c8d;
        }
        
        .result {
            margin-top: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .input-group {
            margin: 15px 0;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .config-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        
        .config-info h4 {
            margin-top: 0;
            color: #1565c0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš— å¾®ä¿¡ç½‘é¡µæˆæƒæµ‹è¯•</h1>
        </div>
        
        <div class="content">
            <!-- é…ç½®ä¿¡æ¯ -->
            <div class="config-info">
                <h4>ğŸ“‹ å½“å‰é…ç½®</h4>
                <p><strong>å›è°ƒåœ°å€ï¼š</strong><span id="currentUrl"></span></p>
                <p><strong>æ¥å£å‰ç¼€ï¼š</strong>/parking/wechat/</p>
                <p><strong>çŠ¶æ€ï¼š</strong><span id="configStatus">æ£€æŸ¥ä¸­...</span></p>
            </div>
            
            <!-- æµ‹è¯•1ï¼šè·å–æˆæƒURL -->
            <div class="test-section">
                <h3>ğŸ“± æµ‹è¯•1ï¼šè·å–å¾®ä¿¡æˆæƒURL</h3>
                <div class="input-group">
                    <label>æˆæƒèŒƒå›´ (scope):</label>
                    <select id="authScope">
                        <option value="snsapi_userinfo">snsapi_userinfo (è·å–ç”¨æˆ·ä¿¡æ¯)</option>
                        <option value="snsapi_base">snsapi_base (ä»…è·å–openid)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>çŠ¶æ€å‚æ•° (state):</label>
                    <input type="text" id="authState" value="test_auth" placeholder="å¯é€‰çš„çŠ¶æ€å‚æ•°">
                </div>
                <button class="btn" onclick="getAuthUrl()">è·å–æˆæƒURL</button>
                <button class="btn btn-secondary" onclick="clearResult('authResult')">æ¸…ç©ºç»“æœ</button>
                <div id="authResult" class="result"></div>
            </div>
            
            <!-- æµ‹è¯•2ï¼šæ¨¡æ‹Ÿæˆæƒå›è°ƒ -->
            <div class="test-section">
                <h3>ğŸ”„ æµ‹è¯•2ï¼šæ¨¡æ‹Ÿæˆæƒå›è°ƒ</h3>
                <div class="input-group">
                    <label>æˆæƒç  (code):</label>
                    <input type="text" id="authCode" placeholder="ä»å¾®ä¿¡æˆæƒè¿”å›çš„code">
                </div>
                <div class="input-group">
                    <label>çŠ¶æ€å‚æ•° (state):</label>
                    <input type="text" id="callbackState" value="test_auth" placeholder="çŠ¶æ€å‚æ•°">
                </div>
                <button class="btn" onclick="testAuthCallback()">æµ‹è¯•æˆæƒå›è°ƒ</button>
                <button class="btn btn-secondary" onclick="clearResult('callbackResult')">æ¸…ç©ºç»“æœ</button>
                <div id="callbackResult" class="result"></div>
            </div>
            
            <!-- æµ‹è¯•3ï¼šå®Œæ•´æµç¨‹ -->
            <div class="test-section">
                <h3>ğŸ¯ æµ‹è¯•3ï¼šå®Œæ•´æˆæƒæµç¨‹</h3>
                <p>ç‚¹å‡»æŒ‰é’®å°†è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢ï¼Œæˆæƒåè‡ªåŠ¨è¿”å›åˆ°å›è°ƒé¡µé¢</p>
                <div class="input-group">
                    <label>æµ‹è¯•æ¨¡å¼:</label>
                    <select id="testMode">
                        <option value="snsapi_userinfo">å®Œæ•´æ¨¡å¼ (è·å–ç”¨æˆ·ä¿¡æ¯)</option>
                        <option value="snsapi_base">ç®€åŒ–æ¨¡å¼ (ä»…è·å–openid)</option>
                    </select>
                </div>
                <button class="btn" onclick="startFullAuth()">å¼€å§‹å®Œæ•´æˆæƒæµ‹è¯•</button>
                <p style="font-size: 12px; color: #666; margin-top: 10px;">
                    âš ï¸ æ³¨æ„ï¼šæ­¤åŠŸèƒ½éœ€è¦åœ¨å¾®ä¿¡å®¢æˆ·ç«¯ä¸­è®¿é—®æ‰èƒ½æ­£å¸¸å·¥ä½œ
                </p>
            </div>
            
            <!-- ç³»ç»ŸçŠ¶æ€ -->
            <div class="test-section">
                <h3>ğŸ”§ ç³»ç»ŸçŠ¶æ€æ£€æŸ¥</h3>
                <button class="btn btn-secondary" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
                <div id="statusResult" class="result"></div>
            </div>
        </div>
    </div>

    <script>
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateCurrentUrl();
            checkConfig();
        });

        // æ›´æ–°å½“å‰URLæ˜¾ç¤º
        function updateCurrentUrl() {
            document.getElementById('currentUrl').textContent = window.location.origin;
        }

        // æ£€æŸ¥é…ç½®
        function checkConfig() {
            const statusElement = document.getElementById('configStatus');
            
            // ç®€å•æ£€æŸ¥æ˜¯å¦èƒ½è®¿é—®åˆ°æ¥å£
            fetch('/parking/wechat/auth-url?scope=snsapi_base&state=config_test')
                .then(response => response.json())
                .then(data => {
                    if (data.code === '0') {
                        statusElement.textContent = 'âœ… é…ç½®æ­£å¸¸';
                        statusElement.style.color = '#4caf50';
                    } else {
                        statusElement.textContent = 'âŒ é…ç½®å¼‚å¸¸: ' + data.msg;
                        statusElement.style.color = '#f44336';
                    }
                })
                .catch(error => {
                    statusElement.textContent = 'âŒ æ¥å£ä¸å¯è®¿é—®';
                    statusElement.style.color = '#f44336';
                });
        }

        // è·å–æˆæƒURL
        async function getAuthUrl() {
            const scope = document.getElementById('authScope').value;
            const state = document.getElementById('authState').value;
            const resultElement = document.getElementById('authResult');
            
            try {
                resultElement.textContent = 'è¯·æ±‚ä¸­...';
                
                const response = await fetch(`/parking/wechat/auth-url?scope=${scope}&state=${state}`);
                const data = await response.json();
                
                resultElement.textContent = JSON.stringify(data, null, 2);
                
                if (data.code === '0') {
                    // æ·»åŠ å¿«æ·æ“ä½œæŒ‰é’®
                    const buttonHtml = `
                        <div style="margin-top: 15px;">
                            <button class="btn" onclick="window.open('${data.data}', '_blank')">åœ¨æ–°çª—å£æ‰“å¼€æˆæƒURL</button>
                            <button class="btn btn-secondary" onclick="copyToClipboard('${data.data}')">å¤åˆ¶URL</button>
                        </div>
                    `;
                    resultElement.innerHTML = resultElement.textContent + buttonHtml;
                }
            } catch (error) {
                resultElement.textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
            }
        }

        // æµ‹è¯•æˆæƒå›è°ƒ
        async function testAuthCallback() {
            const code = document.getElementById('authCode').value;
            const state = document.getElementById('callbackState').value;
            const resultElement = document.getElementById('callbackResult');
            
            if (!code.trim()) {
                alert('è¯·è¾“å…¥æˆæƒç ');
                return;
            }
            
            try {
                resultElement.textContent = 'å¤„ç†ä¸­...';
                
                const response = await fetch('/parking/wechat/auth', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        code: code,
                        state: state
                    })
                });
                
                const data = await response.json();
                resultElement.textContent = JSON.stringify(data, null, 2);
                
            } catch (error) {
                resultElement.textContent = 'è¯·æ±‚å¤±è´¥: ' + error.message;
            }
        }

        // å¼€å§‹å®Œæ•´æˆæƒæµç¨‹
        async function startFullAuth() {
            const mode = document.getElementById('testMode').value;
            const state = 'full_test_' + Date.now();
            
            try {
                const response = await fetch(`/parking/wechat/auth-url?scope=${mode}&state=${state}`);
                const data = await response.json();
                
                if (data.code === '0') {
                    // ç›´æ¥è·³è½¬åˆ°å¾®ä¿¡æˆæƒé¡µé¢
                    window.location.href = data.data;
                } else {
                    alert('è·å–æˆæƒURLå¤±è´¥: ' + data.msg);
                }
            } catch (error) {
                alert('è¯·æ±‚å¤±è´¥: ' + error.message);
            }
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const resultElement = document.getElementById('statusResult');
            
            const checks = [
                { name: 'æˆæƒURLæ¥å£', url: '/parking/wechat/auth-url?scope=snsapi_base&state=status_check' },
                { name: 'å›è°ƒé¡µé¢', url: '/wechat-callback.html' }
            ];
            
            let results = 'ç³»ç»ŸçŠ¶æ€æ£€æŸ¥ç»“æœ:\n\n';
            
            for (const check of checks) {
                try {
                    const response = await fetch(check.url);
                    if (response.ok) {
                        results += `âœ… ${check.name}: æ­£å¸¸\n`;
                    } else {
                        results += `âŒ ${check.name}: HTTP ${response.status}\n`;
                    }
                } catch (error) {
                    results += `âŒ ${check.name}: ${error.message}\n`;
                }
            }
            
            results += `\nå½“å‰æ—¶é—´: ${new Date().toLocaleString()}`;
            resultElement.textContent = results;
        }

        // æ¸…ç©ºç»“æœ
        function clearResult(elementId) {
            document.getElementById(elementId).textContent = '';
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(function() {
                alert('å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            }, function(err) {
                alert('å¤åˆ¶å¤±è´¥');
            });
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰ä»æˆæƒè¿”å›çš„å‚æ•°
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const state = urlParams.get('state');
            
            if (code && state && state.startsWith('full_test_')) {
                // è‡ªåŠ¨å¡«å……å›è°ƒæµ‹è¯•è¡¨å•
                document.getElementById('authCode').value = code;
                document.getElementById('callbackState').value = state;
                
                // è‡ªåŠ¨æ‰§è¡Œå›è°ƒæµ‹è¯•
                setTimeout(() => {
                    testAuthCallback();
                }, 1000);
            }
        };
    </script>
</body>
</html> 