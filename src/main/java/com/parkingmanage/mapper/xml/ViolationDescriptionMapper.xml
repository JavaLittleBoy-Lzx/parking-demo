<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.parkingmanage.mapper.ViolationDescriptionMapper">

    <!-- 基础结果映射 -->
    <resultMap id="BaseResultMap" type="com.parkingmanage.entity.ViolationDescription">
        <id column="id" property="id"/>
        <result column="description_text" property="descriptionText"/>
        <result column="violation_type_code" property="violationTypeCode"/>
        <result column="park_name" property="parkName"/>
        <result column="usage_count" property="usageCount"/>
        <result column="sort_order" property="sortOrder"/>
        <result column="is_enabled" property="isEnabled"/>
        <result column="created_by" property="createdBy"/>
        <result column="created_at" property="createdAt"/>
        <result column="updated_at" property="updatedAt"/>
    </resultMap>

    <!-- 分页查询违规描述列表 -->
    <select id="selectDescriptionPage" resultMap="BaseResultMap">
        SELECT
            id, description_text, violation_type_code, park_name,
            usage_count, sort_order, is_enabled,
            created_by, created_at, updated_at
        FROM violation_descriptions
        <where>
            <if test="descriptionText != null and descriptionText != ''">
                AND description_text LIKE CONCAT('%', #{descriptionText}, '%')
            </if>
            <if test="violationTypeCode != null and violationTypeCode != ''">
                AND violation_type_code = #{violationTypeCode}
            </if>
            <if test="parkName != null and parkName != ''">
                AND park_name = #{parkName}
            </if>
            <if test="isEnabled != null">
                AND is_enabled = #{isEnabled}
            </if>
        </where>
        ORDER BY sort_order ASC, usage_count DESC, created_at DESC
    </select>

    <!-- 查询启用的违规描述列表（用于下拉选择） -->
    <select id="selectEnabledDescriptions" resultMap="BaseResultMap">
        SELECT
            id, description_text, violation_type_code, park_name,
            usage_count, sort_order, is_enabled,
            created_by, created_at, updated_at
        FROM violation_descriptions
        WHERE is_enabled = 1
        <if test="violationTypeCode != null and violationTypeCode != ''">
            AND (violation_type_code = #{violationTypeCode} OR violation_type_code IS NULL)
        </if>
        <if test="parkName != null and parkName != ''">
            AND (park_name = #{parkName} OR park_name IS NULL)
        </if>
        ORDER BY sort_order ASC, usage_count DESC, description_text ASC
    </select>

    <!-- 增加使用次数 -->
    <update id="incrementUsageCount">
        UPDATE violation_descriptions
        SET usage_count = usage_count + 1
        WHERE id = #{id}
    </update>

</mapper>

