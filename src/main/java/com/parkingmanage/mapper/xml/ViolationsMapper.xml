<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.parkingmanage.mapper.ViolationsMapper">

    <!-- é€šç”¨æŸ¥è¯¢æ˜ å°„ç»“æœ -->
    <resultMap id="BaseResultMap" type="com.parkingmanage.entity.Violations">
        <id column="id" property="id" />
        <result column="plate_number" property="plateNumber" />
        <result column="owner_id" property="ownerId" />
        <result column="appointment_id" property="appointmentId" />
        <result column="violation_type" property="violationType" />
        <result column="custom_type" property="customType" />
        <result column="location" property="location" />
        <result column="description" property="description" />
        <result column="appointment_time" property="appointmentTime" />
        <result column="enter_time" property="enterTime" />
        <result column="leave_time" property="leaveTime" />
        <result column="status" property="status" />
        <result column="severity" property="severity" />
        <result column="reporter_id" property="reporterId" />
        <result column="handler_id" property="handlerId" />
        <result column="photos" property="photos" />
        <result column="voice_memo" property="voiceMemo" />
        <result column="remark" property="remark" />
        <result column="should_blacklist" property="shouldBlacklist" />
        <result column="blacklist_reason" property="blacklistReason" />
        <result column="created_at" property="createdAt" />
        <result column="updated_at" property="updatedAt" />
    </resultMap>

    <!-- åˆ†é¡µæŸ¥è¯¢è¿è§„è®°å½• -->
    <select id="selectViolationsWithOwnerInfo" resultType="map">
        SELECT 
            v.id,
            v.plate_number as plateNumber,
            v.appointment_id as appointmentId,
            v.violation_type as violationType,
            v.custom_type as customType,
            v.location,
            v.description,
            v.appointment_time as appointmentTime,
            v.enter_time as enterTime,
            v.leave_time as leaveTime,
            v.status,
            CASE 
                WHEN v.status = 'pending' THEN 'å¾…å¤„ç†'
                WHEN v.status = 'processing' THEN 'å¤„ç†ä¸­'
                WHEN v.status = 'completed' THEN 'å·²å¤„ç†'
                WHEN v.status = 'cancelled' THEN 'å·²å–æ¶ˆ'
            END as statusText,
            v.severity,
            v.photos,
            v.voice_memo as voiceMemo,
            v.remark,
            v.should_blacklist as shouldBlacklist,
            v.blacklist_reason as blacklistReason,
            v.created_at as createdAt,
            -- ä¸šä¸»ä¿¡æ¯ï¼ˆä¼˜å…ˆé¢„çº¦è®°å½•ï¼Œå…¶æ¬¡æœ¬åœ°è½¦ä¸»ï¼Œæœ€åæœˆç¥¨è½¦ä¸»ï¼‰
            COALESCE(apt.ownername, o.ownername, mt.user_name) as ownerName,
            COALESCE(apt.ownerphone, o.ownerphone, mt.user_phone) as ownerPhone,
            CASE 
                WHEN apt.id IS NOT NULL THEN CONCAT(apt.community, apt.building, 'æ ‹', apt.units, 'å•å…ƒ', apt.room, 'å®¤')
                WHEN o.id IS NOT NULL THEN CONCAT(o.building, 'æ ‹', o.units, 'å•å…ƒ', o.roomnumber, 'å®¤')
                WHEN mt.id IS NOT NULL THEN CONCAT(mt.park_name, 'åœè½¦åœºæœˆç¥¨è½¦ä¸»')
                ELSE NULL 
            END as ownerAddress,
            o.credit_score as creditScore,
            -- ä¸šä¸»ç±»å‹æ ‡è¯†
            CASE 
                WHEN apt.id IS NOT NULL THEN 'appointment'
                WHEN o.id IS NOT NULL THEN 'local'
                WHEN mt.id IS NOT NULL THEN 'monthly'
                ELSE 'unknown'
            END as ownerType,
            -- æœˆç¥¨ä¿¡æ¯ï¼ˆä»…æœˆç¥¨è½¦ä¸»æœ‰ï¼‰
            mt.ticket_name as monthTicketName,
            mt.park_name as parkName,
            mt.valid_status as monthTicketStatus,
            -- ğŸ†• é¢„çº¦è¯¦ç»†ä¿¡æ¯ï¼ˆä»…é¢„çº¦è½¦æœ‰ï¼‰
            apt.visitreason as appointmentReason,
            apt.appointtype as appointmentType,
            apt.auditusername as auditorName,
            apt.auditstatus as appointmentStatus,
            apt.visitdate as appointmentDate,
            apt.auditdate as auditDate,
            CASE 
                WHEN LENGTH(v.plate_number) = 8 THEN true 
                ELSE false 
            END as isNewEnergy
        FROM violations v
        LEFT JOIN ownerinfo o ON v.owner_id = o.id
        LEFT JOIN month_tick mt ON v.month_ticket_id = mt.id
        LEFT JOIN appointment apt ON v.appointment_id = apt.id
        <where>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number LIKE CONCAT('%', #{plateNumber}, '%')
            </if>
            <if test="status != null and status != ''">
                AND v.status = #{status}
            </if>
            <if test="violationType != null and violationType != ''">
                AND v.violation_type = #{violationType}
            </if>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <!-- ğŸ†• å°åŒºè¿‡æ»¤æ¡ä»¶ï¼šç®¡å®¶åªèƒ½æŸ¥çœ‹æ‰€åœ¨å°åŒºçš„è¿è§„è®°å½• -->
            <if test="communityFilter != null and communityFilter != ''">
                AND (
                    -- é¢„çº¦è½¦è¾†ï¼šåŒ¹é…é¢„çº¦è¡¨ä¸­çš„communityå­—æ®µ
                    (apt.id IS NOT NULL AND apt.community = #{communityFilter})
                    OR
                    -- æœ¬åœ°è½¦ä¸»ï¼šåŒ¹é…ownerinfoè¡¨ä¸­çš„communityå­—æ®µï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰
                    (o.id IS NOT NULL AND o.community = #{communityFilter})
                    OR
                    -- æœˆç¥¨è½¦ä¸»ï¼šåŒ¹é…month_tickè¡¨ä¸­çš„park_nameå­—æ®µ
                    (mt.id IS NOT NULL AND mt.park_name = #{communityFilter})
                OR
                -- æœˆç¥¨è½¦ä¸»ï¼šåŒ¹é…month_tickè¡¨ä¸­çš„park_nameå­—æ®µ
                (v.id IS NOT NULL AND v.park_name = #{communityFilter})
                )
            </if>
        </where>
        ORDER BY v.created_at DESC
    </select>

    <!-- ğŸ“ åˆ†é¡µæŸ¥è¯¢è¿è§„è®°å½•ï¼ˆç›´æ¥æŸ¥è¯¢æ¨¡å¼ï¼Œä¸å…³è”å…¶ä»–è¡¨ï¼‰-->
    <select id="selectViolationsDirectQuery" resultType="map">
        SELECT 
            v.id,
            v.plate_number as plateNumber,
            v.appointment_id as appointmentId,
            v.violation_type as violationType,
            v.custom_type as customType,
            v.location,
            v.description,
            v.appointment_time as appointmentTime,
            v.enter_time as enterTime,
            v.leave_time as leaveTime,
            v.status,
            CASE 
                WHEN v.status = 'pending' THEN 'å¾…å¤„ç†'
                WHEN v.status = 'processing' THEN 'å¤„ç†ä¸­'
                WHEN v.status = 'completed' THEN 'å·²å¤„ç†'
                WHEN v.status = 'cancelled' THEN 'å·²å–æ¶ˆ'
            END as statusText,
            v.severity,
            v.photos,
            v.voice_memo as voiceMemo,
            v.remark,
            v.should_blacklist as shouldBlacklist,
            v.blacklist_reason as blacklistReason,
            v.created_at as createdAt,
            v.created_by as createdBy,
            -- ğŸ“ ç›´æ¥ä½¿ç”¨violationsè¡¨ä¸­çš„ä¸šä¸»ä¿¡æ¯å­—æ®µ
            v.owner_name as ownerName,
            v.owner_phone as ownerPhone,
            v.owner_category as ownerCategory,
            v.park_name as parkName,
            -- ä¸šä¸»ç±»å‹æ ‡è¯†ï¼ˆæ ¹æ®is_monthly_ticketå­—æ®µåˆ¤æ–­ï¼‰
            CASE 
                WHEN v.is_monthly_ticket = 1 THEN 'monthly'
                WHEN v.owner_category = 'ä¸šä¸»' THEN 'local'
                ELSE 'visitor'
            END as ownerType,
            -- ä»violationsè¡¨ç›´æ¥è¯»å–çš„å­—æ®µ
            v.vip_type_name as monthTicketName,
            v.owner_address as ownerAddress,
            v.customer_company as customerCompany,
            v.customer_room_number as customerRoomNumber,
            -- é»˜è®¤ç©ºå€¼å­—æ®µï¼ˆä¿æŒä¸å…³è”æŸ¥è¯¢è¿”å›ç»“æ„ä¸€è‡´ï¼‰
            NULL as creditScore,
            NULL as monthTicketStatus,
            NULL as appointmentReason,
            NULL as appointmentType,
            NULL as auditorName,
            NULL as appointmentStatus,
            NULL as appointmentDate,
            NULL as auditDate,
            CASE 
                WHEN LENGTH(v.plate_number) = 8 THEN true 
                ELSE false 
            END as isNewEnergy
        FROM violations v
        <where>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number LIKE CONCAT('%', #{plateNumber}, '%')
            </if>
            <if test="status != null and status != ''">
                AND v.status = #{status}
            </if>
            <if test="violationType != null and violationType != ''">
                AND v.violation_type = #{violationType}
            </if>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <!-- ğŸ“ å°åŒºè¿‡æ»¤æ¡ä»¶ï¼šç›´æ¥ä½¿ç”¨violationsè¡¨çš„park_nameå­—æ®µ -->
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
        </where>
        ORDER BY v.created_at DESC
    </select>

    <!-- è·å–é«˜é£é™©è½¦è¾†åˆ—è¡¨ -->
    <select id="selectHighRiskVehicles" resultType="map">
        SELECT 
            v.plate_number as plateNumber,
            COUNT(*) as count,
            -- ä¸šä¸»ä¿¡æ¯ï¼ˆä¼˜å…ˆé¢„çº¦è®°å½•ï¼Œå…¶æ¬¡æœ¬åœ°è½¦ä¸»ï¼Œæœ€åæœˆç¥¨è½¦ä¸»ï¼‰
            COALESCE(apt.ownername, o.ownername, mt.user_name) as ownerName,
            COALESCE(apt.ownerphone, o.ownerphone, mt.user_phone) as phone,
            CASE 
                WHEN apt.id IS NOT NULL THEN CONCAT(apt.community, apt.building, 'æ ‹', apt.units, 'å•å…ƒ', apt.room, 'å®¤')
                WHEN o.id IS NOT NULL THEN CONCAT(o.building, 'æ ‹', o.units, 'å•å…ƒ', o.roomnumber, 'å®¤')
                WHEN mt.id IS NOT NULL THEN CONCAT(mt.park_name, 'åœè½¦åœºæœˆç¥¨è½¦ä¸»')
                ELSE 'æœªçŸ¥åœ°å€'
            END as address,
            o.credit_score as creditScore,
            -- ä¸šä¸»ç±»å‹æ ‡è¯†
            CASE 
                WHEN apt.id IS NOT NULL THEN 'appointment'
                WHEN o.id IS NOT NULL THEN 'local'
                WHEN mt.id IS NOT NULL THEN 'monthly'
                ELSE 'unknown'
            END as ownerType,
            -- æœˆç¥¨ä¿¡æ¯
            mt.ticket_name as monthTicketName,
            mt.park_name as parkName,
            -- ğŸ†• é¢„çº¦è¯¦ç»†ä¿¡æ¯ï¼ˆä»…é¢„çº¦è½¦æœ‰ï¼‰
            apt.visitreason as appointmentReason,
            apt.appointtype as appointmentType,
            apt.auditusername as auditorName,
            apt.auditstatus as appointmentStatus,
            apt.visitdate as appointmentDate,
            apt.auditdate as auditDate,
            CASE 
                WHEN LENGTH(v.plate_number) = 8 THEN true 
                ELSE false 
            END as isNewEnergy,
            GROUP_CONCAT(DISTINCT v.violation_type) as violationTypes,
            MAX(v.created_at) as lastViolationTime
        FROM violations v
        LEFT JOIN ownerinfo o ON v.owner_id = o.id
        LEFT JOIN month_tick mt ON v.month_ticket_id = mt.id
        LEFT JOIN appointment apt ON v.appointment_id = apt.id
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
        </where>
        GROUP BY v.plate_number
        HAVING count >= 2
        ORDER BY count DESC, lastViolationTime DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- ğŸ“ è·å–é«˜é£é™©è½¦è¾†åˆ—è¡¨ï¼ˆç›´æ¥æŸ¥è¯¢æ¨¡å¼ï¼Œä¸å…³è”å…¶ä»–è¡¨ï¼‰-->
    <select id="selectHighRiskVehiclesDirectQuery" resultType="map">
        SELECT 
            v.plate_number as plateNumber,
            COUNT(*) as count,
            -- ğŸ“ ç›´æ¥ä½¿ç”¨violationsè¡¨ä¸­çš„ä¸šä¸»ä¿¡æ¯å­—æ®µ
            MAX(v.owner_name) as ownerName,
            MAX(v.owner_phone) as phone,
            MAX(COALESCE(v.owner_address, 'æœªçŸ¥åœ°å€')) as address,
            -- ä¸šä¸»ç±»å‹æ ‡è¯†ï¼ˆæ ¹æ®is_monthly_ticketå­—æ®µåˆ¤æ–­ï¼‰
            CASE 
                WHEN v.is_monthly_ticket = 1 THEN 'monthly'
                WHEN v.is_monthly_ticket = '0' THEN 'local'
                ELSE 'visitor'
            END as ownerType,
            -- ä»violationsè¡¨ç›´æ¥è¯»å–çš„å­—æ®µ
            MAX(v.vip_type_name) as monthTicketName,
            MAX(v.park_name) as parkName,
            MAX(v.customer_company) as customerCompany,
            -- é»˜è®¤ç©ºå€¼å­—æ®µï¼ˆä¿æŒä¸å…³è”æŸ¥è¯¢è¿”å›ç»“æ„ä¸€è‡´ï¼‰
            NULL as creditScore,
            NULL as appointmentReason,
            NULL as appointmentType,
            NULL as auditorName,
            NULL as appointmentStatus,
            NULL as appointmentDate,
            NULL as auditDate,
            CASE 
                WHEN LENGTH(v.plate_number) = 8 THEN true 
                ELSE false 
            END as isNewEnergy,
            GROUP_CONCAT(DISTINCT v.violation_type) as violationTypes,
            MAX(v.created_at) as lastViolationTime
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <!-- ğŸ“ å°åŒºè¿‡æ»¤æ¡ä»¶ï¼šç›´æ¥ä½¿ç”¨violationsè¡¨çš„park_nameå­—æ®µ -->
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
        </where>
        GROUP BY v.plate_number
        HAVING count >= 2
        ORDER BY count DESC, lastViolationTime DESC
        <if test="limit != null">
            LIMIT #{limit}
        </if>
    </select>

    <!-- è·å–è¿è§„ç»Ÿè®¡æ•°æ® -->
    <select id="selectViolationStatistics" resultType="map">
        SELECT 
            v.status,
            COUNT(*) as count
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number = #{plateNumber}
            </if>
        </where>
        GROUP BY v.status
    </select>

    <!-- ğŸ“ è·å–è¿è§„ç»Ÿè®¡æ•°æ®ï¼ˆæ”¯æŒåˆ›å»ºè€…å’Œå°åŒºè¿‡æ»¤ï¼‰-->
    <select id="selectViolationStatisticsWithFilter" resultType="map">
        SELECT 
            v.status,
            COUNT(*) as count
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number = #{plateNumber}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <!-- ğŸ“ å°åŒºè¿‡æ»¤æ¡ä»¶ï¼šç›´æ¥ä½¿ç”¨violationsè¡¨çš„park_nameå­—æ®µ -->
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
        </where>
        GROUP BY v.status
    </select>

    <!-- æ ¹æ®è½¦ç‰Œå·æŸ¥è¯¢è½¦ä¸»ID -->
    <select id="selectOwnerIdByPlateNumber" resultType="java.lang.Integer">
        SELECT o.id FROM ownerinfo o
        WHERE FIND_IN_SET(#{plateNumber}, REPLACE(o.plates, ' ', '')) > 0
        AND o.isaudit = 'æ˜¯'
        LIMIT 1
    </select>

    <!-- æ›´æ–°è½¦ä¸»ä¿¡ç”¨åˆ† -->
    <update id="updateOwnerCreditScore">
        UPDATE ownerinfo 
        SET credit_score = GREATEST(0, credit_score - #{deduction})
        WHERE id = #{ownerId}
    </update>

    <!-- æŒ‰æ—¥æœŸç»Ÿè®¡è¿è§„æ•°é‡ -->
    <select id="selectDailyViolationStats" resultType="map">
        SELECT 
            DATE(v.created_at) as date,
            COUNT(*) as count
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number = #{plateNumber}
            </if>
        </where>
        GROUP BY DATE(v.created_at)
        ORDER BY date
    </select>

    <!-- ğŸ“ æŒ‰æ—¥æœŸç»Ÿè®¡è¿è§„æ•°é‡ï¼ˆæ”¯æŒåˆ›å»ºè€…å’Œå°åŒºè¿‡æ»¤ï¼‰-->
    <select id="selectDailyViolationStatsWithFilter" resultType="map">
        SELECT 
            DATE(v.created_at) as date,
            COUNT(*) as count
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number = #{plateNumber}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <!-- ğŸ“ å°åŒºè¿‡æ»¤æ¡ä»¶ï¼šç›´æ¥ä½¿ç”¨violationsè¡¨çš„park_nameå­—æ®µ -->
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
        </where>
        GROUP BY DATE(v.created_at)
        ORDER BY date
    </select>

    <!-- æŒ‰è¿è§„ç±»å‹ç»Ÿè®¡ -->
    <select id="selectViolationTypeStats" resultType="map">
        SELECT 
            v.violation_type as violationType,
            COUNT(*) as count
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
        </where>
        GROUP BY v.violation_type
        ORDER BY count DESC
    </select>

    <!-- ğŸ“ æŒ‰è¿è§„ç±»å‹ç»Ÿè®¡ï¼ˆæ”¯æŒåˆ›å»ºè€…å’Œå°åŒºè¿‡æ»¤ï¼‰-->
    <select id="selectViolationTypeStatsWithFilter" resultType="map">
        SELECT 
            v.violation_type as violationType,
            COUNT(*) as count
        FROM violations v
        <where>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <!-- ğŸ“ å°åŒºè¿‡æ»¤æ¡ä»¶ï¼šç›´æ¥ä½¿ç”¨violationsè¡¨çš„park_nameå­—æ®µ -->
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
        </where>
        GROUP BY v.violation_type
        ORDER BY count DESC
    </select>

    <!-- æ ¹æ®è½¦ç‰Œå·æŸ¥è¯¢é¢„çº¦è®°å½•ï¼ˆç”¨äºè¿è§„å½•å…¥ï¼‰ -->
    <select id="selectAppointmentRecordsByPlate" resultType="map">
        SELECT 
            a.id,
            a.plateNumber,
            a.visitdate,
            a.recorddate,
            a.arrivedate,
            a.leavedate,
            a.cartype,
            a.community,
            a.building,
            a.units,
            a.floor,
            a.room,
            a.ownername,
            a.ownerphone,
            a.status,
            a.auditstatus,
            CASE 
                WHEN a.auditstatus = 'approved' THEN 'å·²å®¡æ ¸'
                WHEN a.auditstatus = 'pending' THEN 'å¾…å®¡æ ¸'
                WHEN a.auditstatus = 'rejected' THEN 'å·²æ‹’ç»'
                ELSE 'æœªçŸ¥çŠ¶æ€'
            END as auditStatusText,
            CASE 
                WHEN a.arrivedate IS NOT NULL AND a.leavedate IS NOT NULL THEN 'å·²ç¦»åœº'
                WHEN a.arrivedate IS NOT NULL AND a.leavedate IS NULL THEN 'åœ¨åœºä¸­'
                WHEN a.arrivedate IS NULL THEN 'æœªè¿›åœº'
                ELSE 'æœªçŸ¥'
            END as parkingStatus
        FROM appointment a
        WHERE a.plateNumber = #{plateNumber}
            AND a.auditstatus != 'pending'  -- æ’é™¤å¾…å®¡æ ¸çš„è®°å½•
        ORDER BY a.recorddate DESC
        LIMIT 10  -- æœ€å¤šè¿”å›10æ¡è®°å½•
    </select>

    <!-- ğŸ†• æ ¹æ®é¢„çº¦è®°å½•IDæŸ¥è¯¢ä¸šä¸»ä¿¡æ¯ -->
    <select id="selectOwnerByAppointmentId" resultType="map">
        SELECT
            a.visitorname,
            a.id as appointmentId,
            a.plateNumber,
            a.ownername as ownerName,
            a.ownerphone as ownerPhone,
            CONCAT(a.community, a.building, 'æ ‹', a.units, 'å•å…ƒ', a.room, 'å®¤') as ownerAddress,
            'appointment' as ownerType,
            a.visitdate as appointmentDate,
            a.arrivedate,
            a.leavedate,
            a.auditstatus as appointmentStatus,
            -- ğŸ†• é¢„çº¦è¯¦ç»†ä¿¡æ¯
            a.visitreason as appointmentReason,
            a.appointtype as appointmentType,
            a.auditusername as auditorName,
            a.auditdate as auditDate,
            a.recorddate,
            a.refusereason as refuseReason,
            a.venuestatus as venueStatus,
            a.parking as parkingInfo
        FROM appointment a
        WHERE a.id = #{appointmentId}
        LIMIT 1
    </select>
    
    <!-- ğŸ†• æ ¹æ®è½¦ç‰Œå·æŸ¥è¯¢è½¦ä¸»ä¿¡æ¯ï¼ˆåªæŸ¥è¯¢æœˆç¥¨è½¦ä¸»ï¼‰ -->
    <select id="selectOwnerByPlateNumber" resultType="map">
        SELECT 
            -- æœˆç¥¨è½¦ä¸»åŸºæœ¬ä¿¡æ¯
            mt.user_name as ownerName,
            mt.user_phone as ownerPhone,
            CONCAT(mt.park_name, 'åœè½¦åœºæœˆç¥¨è½¦ä¸»') as ownerAddress,
            mt.id as ownerId,
            'monthly' as ownerType,
            -- æœˆç¥¨è¯¦ç»†ä¿¡æ¯
            mt.ticket_name as monthTicketName,
            mt.park_name as parkName,
            mt.valid_status as monthTicketStatus,
            mt.car_no as registeredPlates,
            mt.create_time as registrationDate,
            #{plateNumber} as plateNumber
        FROM month_tick mt 
        WHERE FIND_IN_SET(#{plateNumber}, REPLACE(mt.car_no, ' ', '')) > 0 
            AND mt.valid_status = 1
        ORDER BY mt.create_time DESC
        LIMIT 1
    </select>

    <!-- ==================== ğŸ†• è¿è§„è®°å½•å¤„ç†åŠŸèƒ½SQL ====================  -->
    
    <!-- ç»Ÿè®¡æŒ‡å®šè½¦ç‰Œçš„æœªå¤„ç†è¿è§„æ¬¡æ•° -->
    <select id="countUnprocessedByPlate" resultType="int">
        SELECT COUNT(*)
        FROM violations
        WHERE plate_number = #{plateNumber}
          AND (process_status IS NULL OR process_status = 'pending')
    </select>
    
    <!-- æ‰¹é‡æ›´æ–°æŒ‡å®šè½¦ç‰Œçš„è¿è§„è®°å½•å¤„ç†çŠ¶æ€ -->
    <update id="batchUpdateProcessStatusByPlate">
        UPDATE violations
        SET process_status = #{processStatus},
            process_type = #{processType},
            processed_at = #{processedAt},
            processed_by = #{processedBy},
            process_remark = #{processRemark},
            updated_at = NOW()
        WHERE plate_number = #{plateNumber}
          AND (process_status IS NULL OR process_status = 'pending')
    </update>
    
    <!-- åˆ†é¡µæŸ¥è¯¢è¿è§„è®°å½•ï¼ˆç›´æ¥æŸ¥è¯¢æ¨¡å¼ï¼Œæ”¯æŒå¤„ç†çŠ¶æ€ç­›é€‰ï¼‰ -->
    <select id="selectViolationsDirectQueryWithProcess" resultType="map">
        SELECT 
            v.id,
            v.plate_number as plateNumber,
            v.violation_type as violationType,
            v.custom_type as customType,
            v.location,
            v.description,
            v.park_code as parkCode,
            v.park_name as parkName,
            v.appointment_time as appointmentTime,
            v.enter_time as enterTime,
            v.leave_time as leaveTime,
            v.status,
            v.severity,
            v.photos,
            v.voice_memo as voiceMemo,
            v.remark,
            v.should_blacklist as shouldBlacklist,
            v.blacklist_reason as blacklistReason,
            v.blacklist_type_code as blacklistTypeCode,
            v.blacklist_type_name as blacklistTypeName,
            v.created_at as createdAt,
            v.created_by as createdBy,
            -- ğŸ“ ç›´æ¥ä»violationsè¡¨è¯»å–çš„ä¸šä¸»ä¿¡æ¯ï¼ˆä¸œåŒ—æ—ä¸šå¤§å­¦ç­‰åœºæ™¯ï¼‰
            v.month_ticket_id as monthTicketId,
            v.is_monthly_ticket as isMonthlyTicket,
            v.vip_type_name as violationsVipTypeName,
            v.owner_name as violationsOwnerName,
            v.owner_phone as violationsOwnerPhone,
            v.owner_address as violationsOwnerAddress,
            -- ğŸ« æœˆç¥¨ç±»å‹åç§°ï¼šä¼˜å…ˆä½¿ç”¨violationsè¡¨çš„vip_type_nameï¼Œè‹¥ä¸ºç©ºåˆ™ä½¿ç”¨month_tickè¡¨çš„ticket_name
            COALESCE(NULLIF(v.vip_type_name, ''), mt.ticket_name) as vipTypeName,
            -- ğŸ”§ é¢„çº¦è½¦è¾†çš„ä¸šä¸»ä¿¡æ¯ï¼ˆä¿ç•™åŸå§‹å­—æ®µï¼‰
            a.ownername as appointmentOwnerName,
            a.ownerphone as appointmentOwnerPhone,
            -- ğŸ”§ åˆå¹¶åçš„ä¸šä¸»ä¿¡æ¯ï¼šé¢„çº¦è½¦ä¼˜å…ˆç”¨appointmentï¼Œæœˆç¥¨è½¦ä¼˜å…ˆç”¨violationsï¼Œæœ€åç”¨month_tick
            COALESCE(NULLIF(a.ownername, ''), NULLIF(v.owner_name, ''), mt.user_name) as ownerName,
            COALESCE(NULLIF(a.ownerphone, ''), NULLIF(v.owner_phone, ''), mt.user_phone) as ownerPhone,
            COALESCE(NULLIF(v.owner_address, ''), CONCAT(mt.park_name, 'åœè½¦åœºæœˆç¥¨è½¦ä¸»')) as ownerAddress,
            v.owner_category as ownerCategory,
            v.customer_company as customerCompany,
            v.customer_room_number as customerRoomNumber,
            -- ğŸ« ä»month_tickè¡¨å…³è”è·å–çš„æœˆç¥¨ä¿¡æ¯ï¼ˆæ–°å¢å­—æ®µï¼Œç”¨äºå‰ç«¯æ˜¾ç¤ºå®Œæ•´æœˆç¥¨ä¿¡æ¯ï¼‰
            mt.ticket_name as monthTicketName,
            mt.user_name as monthTicketUserName,
            mt.user_phone as monthTicketUserPhone,
            mt.park_name as monthTicketParkName,
            -- ğŸ”§ ä¸šä¸»ç±»å‹æ ‡è¯†ï¼ˆæ ¹æ®is_monthly_ticketå­—æ®µåˆ¤æ–­ï¼‰
            CASE 
                WHEN v.is_monthly_ticket = 1 THEN 'monthly'
                WHEN v.owner_category = 'ä¸šä¸»' THEN 'local'
                ELSE 'visitor'
            END as ownerType,
            -- ğŸ†• å¤„ç†çŠ¶æ€ç›¸å…³å­—æ®µ
            v.process_status as processStatus,
            v.process_type as processType,
            v.processed_at as processedAt,
            v.processed_by as processedBy,
            v.process_remark as processRemark,
            CASE 
                WHEN LENGTH(v.plate_number) = 8 THEN true 
                ELSE false 
            END as isNewEnergy
        FROM violations v
        LEFT JOIN month_tick mt ON v.month_ticket_id = mt.id
        LEFT JOIN appointment a ON v.appointment_id = a.id
        <where>
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number LIKE CONCAT('%', #{plateNumber}, '%')
            </if>
            <if test="status != null and status != ''">
                AND v.status = #{status}
            </if>
            <if test="violationType != null and violationType != ''">
                AND v.violation_type = #{violationType}
            </if>
            <if test="startDate != null">
                AND v.created_at &gt;= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdByFilter != null and createdByFilter != ''">
                AND v.created_by = #{createdByFilter}
            </if>
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
            <!-- ğŸ†• å¤„ç†çŠ¶æ€ç­›é€‰ -->
            <if test="processStatus != null and processStatus != ''">
                AND v.process_status = #{processStatus}
            </if>
            <!-- ğŸ†• å¤„ç†æ–¹å¼ç­›é€‰ -->
            <if test="processType != null and processType != ''">
                AND v.process_type = #{processType}
            </if>
            <!-- ğŸ†• ä»…æŸ¥è¯¢æœªå¤„ç†çš„è®°å½•ï¼ˆå°ç¨‹åºç«¯ä½¿ç”¨ï¼‰ -->
            <if test="onlyUnprocessed != null and onlyUnprocessed == true">
                AND (v.process_status IS NULL OR v.process_status = 'pending')
            </if>
        </where>
        ORDER BY v.created_at DESC
    </select>

    <!-- ==================== ğŸ“Š æ–°å¢ç»Ÿè®¡æŸ¥è¯¢ ==================== -->

    <!-- 1. é«˜é¢‘è¿è§„è½¦è¾†Topç»Ÿè®¡ -->
    <select id="selectTopViolators" resultType="map">
        SELECT 
            v.plate_number as plateNumber,
            v.park_name as parkName,
            COUNT(*) as violationCount,
            GROUP_CONCAT(DISTINCT v.violation_type SEPARATOR ', ') as violationTypes,
            MAX(v.created_at) as lastViolationTime
        FROM violations v
        WHERE v.created_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        <if test="parkName != null and parkName != ''">
            AND v.park_name = #{parkName}
        </if>
        GROUP BY v.plate_number, v.park_name
        ORDER BY violationCount DESC
        LIMIT #{limit}
    </select>

    <!-- 2. è¿è§„è®°å½•è¶‹åŠ¿ç»Ÿè®¡ï¼ˆè¿‘Nå¤©ï¼‰ -->
    <select id="selectViolationTrend" resultType="map">
        SELECT 
            DATE_FORMAT(created_at, '%Y-%m-%d') as date,
            park_name as parkName,
            COUNT(*) as count,
            COUNT(DISTINCT plate_number) as uniqueVehicles
        FROM violations
        WHERE created_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        GROUP BY DATE_FORMAT(created_at, '%Y-%m-%d'), park_name
        ORDER BY date ASC, parkName ASC
    </select>

    <!-- 3. è¿è§„ç±»å‹è¶‹åŠ¿åˆ†æï¼ˆè¿‘Nå¤©ï¼‰ - ä»violation_typesè¡¨æŸ¥è¯¢æœªè¢«ç¦ç”¨çš„ç±»å‹ -->
    <select id="selectViolationTypeTrend" resultType="map">
        SELECT 
            DATE_FORMAT(v.created_at, '%Y-%m-%d') as date,
            v.park_name as parkName,
            COALESCE(vt.type_name, v.violation_type) as violationType,
            COUNT(*) as count
        FROM violations v
        LEFT JOIN violation_types vt ON v.violation_type COLLATE utf8mb4_unicode_ci = vt.type_code COLLATE utf8mb4_unicode_ci
        WHERE v.created_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
          AND (vt.is_enabled IS NULL OR vt.is_enabled = 1)
        GROUP BY DATE_FORMAT(v.created_at, '%Y-%m-%d'), v.park_name, COALESCE(vt.type_name, v.violation_type)
        ORDER BY date ASC, parkName ASC, violationType ASC
    </select>

    <!-- 4. å„ä½ç½®è¿è§„é¢‘æ¬¡ç»Ÿè®¡ -->
    <select id="selectLocationFrequency" resultType="map">
        SELECT
            v.location,
            v.park_name as parkName,
            COUNT(*) as count,
            COUNT(DISTINCT v.plate_number) as uniqueVehicles,
            GROUP_CONCAT(DISTINCT v.violation_type SEPARATOR ', ') as violationTypes
        FROM violations v
        WHERE v.created_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        <if test="location != null and location != ''">
            AND v.location LIKE CONCAT('%', #{location}, '%')
        </if>
        GROUP BY v.location, v.park_name
        ORDER BY count DESC
    </select>

    <!-- 5. é‡å¤è¿è§„è½¦è¾†é¢„è­¦ -->
    <select id="selectRepeatViolators" resultType="map">
        SELECT 
            v.plate_number as plateNumber,
            v.park_name as parkName,
            COUNT(*) as totalCount,
            COUNT(DISTINCT v.violation_type) as typeCount,
            GROUP_CONCAT(DISTINCT v.violation_type SEPARATOR ', ') as violationTypes,
            MAX(v.created_at) as lastViolationTime,
            MIN(v.created_at) as firstViolationTime,
            DATEDIFF(MAX(v.created_at), MIN(v.created_at)) as daySpan
        FROM violations v
        WHERE v.created_at >= DATE_SUB(NOW(), INTERVAL #{days} DAY)
        GROUP BY v.plate_number, v.park_name
        HAVING COUNT(*) >= #{threshold}
        ORDER BY totalCount DESC
    </select>

    <!-- ğŸ†• éä¸œæ—è½¦åœºï¼šåˆ†é¡µæŸ¥è¯¢è¿è§„è®°å½•ï¼ˆå…³è” vehicle_reservation å’Œ appointment è¡¨ï¼‰-->
    <select id="selectViolationsWithReservation" resultType="map">
        SELECT 
            v.id,
            v.plate_number as plateNumber,
            v.appointment_id as appointmentId,
            v.violation_type as violationType,
            v.custom_type as customType,
            v.location,
            v.description,
            v.appointment_time as appointmentTime,
            v.enter_time as enterTime,
            v.leave_time as leaveTime,
            v.status,
            CASE 
                WHEN v.status = 'pending' THEN 'å¾…å¤„ç†'
                WHEN v.status = 'processing' THEN 'å¤„ç†ä¸­'
                WHEN v.status = 'completed' THEN 'å·²å¤„ç†'
                WHEN v.status = 'cancelled' THEN 'å·²å–æ¶ˆ'
            END as statusText,
            v.severity,
            v.photos,
            v.voice_memo as voiceMemo,
            v.remark,
            v.should_blacklist as shouldBlacklist,
            v.blacklist_reason as blacklistReason,
            v.created_at as createdAt,
            v.created_by as createdBy,
            v.park_name as parkName,
            v.process_status as processStatus,
            v.process_type as processType,
            v.processed_at as processedAt,
            v.processed_by as processedBy,
            v.process_remark as processRemark,
            -- ğŸ†• ä¸šä¸»ä¿¡æ¯ï¼ˆä»appointmentè¡¨æˆ–violationsè¡¨è·å–ï¼‰
            COALESCE(apt.ownername, v.owner_name) as ownerName,
            COALESCE(apt.ownerphone, v.owner_phone) as ownerPhone,
            -- ğŸ†• åœ°å€ä¿¡æ¯
            CASE 
                WHEN apt.id IS NOT NULL THEN CONCAT(apt.community, apt.building, 'æ ‹', apt.units, 'å•å…ƒ', apt.room, 'å®¤')
                ELSE v.owner_address
            END as ownerAddress,
            -- ğŸ†• å…³è” appointment è¡¨è·å–å°ç¨‹åºé¢„çº¦ä¿¡æ¯
            apt.ownername as aptOwnerName,
            apt.ownerphone as aptOwnerPhone,
            apt.visitreason as appointmentReason,
            apt.appointtype as aptAppointType,
            apt.auditusername as auditorName,
            apt.auditstatus as appointmentStatus,
            apt.visitdate as appointmentDate,
            apt.auditdate as auditDate,
            apt.arrivedate as aptArriveDate,
            apt.leavedate as aptLeaveDate,
            apt.community as aptCommunity,
            apt.building as aptBuilding,
            apt.units as aptUnits,
            apt.room as aptRoom,
            -- ğŸ†• åå°é¢„çº¦ä¿¡æ¯ï¼ˆä»vehicle_reservationè¡¨è·å–ï¼Œä½¿ç”¨å­æŸ¥è¯¢é¿å…é‡å¤ï¼‰
            -- æ³¨æ„ï¼šåªæŒ‰è½¦ç‰Œå·åŒ¹é…ï¼Œä¸è¦æ±‚è½¦åœºåå®Œå…¨ä¸€è‡´
            IFNULL((SELECT vr.remark FROM vehicle_reservation vr 
             WHERE vr.plate_number COLLATE utf8mb4_unicode_ci = v.plate_number COLLATE utf8mb4_unicode_ci
             AND vr.deleted = 0 ORDER BY vr.create_time DESC LIMIT 1), '') as vrRemark,
            IFNULL((SELECT vr.appointment_time FROM vehicle_reservation vr 
             WHERE vr.plate_number COLLATE utf8mb4_unicode_ci = v.plate_number COLLATE utf8mb4_unicode_ci
             AND vr.deleted = 0 ORDER BY vr.create_time DESC LIMIT 1), '') as reserveTime,
            IFNULL((SELECT vr.notifier_name FROM vehicle_reservation vr 
             WHERE vr.plate_number COLLATE utf8mb4_unicode_ci = v.plate_number COLLATE utf8mb4_unicode_ci
             AND vr.deleted = 0 ORDER BY vr.create_time DESC LIMIT 1), '') as vrNotifierName,
            IFNULL((SELECT vr.merchant_name FROM vehicle_reservation vr 
             WHERE vr.plate_number COLLATE utf8mb4_unicode_ci = v.plate_number COLLATE utf8mb4_unicode_ci
             AND vr.deleted = 0 ORDER BY vr.create_time DESC LIMIT 1), '') as merchantName,
            -- ä¸šä¸»ç±»å‹æ ‡è¯†
            CASE 
                WHEN apt.id IS NOT NULL THEN 'appointment'
                WHEN v.is_monthly_ticket = 1 THEN 'monthly'
                WHEN (SELECT COUNT(*) FROM vehicle_reservation vr 
                      WHERE vr.plate_number COLLATE utf8mb4_unicode_ci = v.plate_number COLLATE utf8mb4_unicode_ci
                      AND vr.deleted = 0) > 0 THEN 'visitor'
                ELSE 'unknown'
            END as ownerType,
            -- é¢„çº¦ç±»å‹
            CASE 
                WHEN apt.id IS NOT NULL THEN COALESCE(apt.appointtype, 'å°ç¨‹åº')
                WHEN (SELECT COUNT(*) FROM vehicle_reservation vr 
                      WHERE vr.plate_number COLLATE utf8mb4_unicode_ci = v.plate_number COLLATE utf8mb4_unicode_ci
                      AND vr.deleted = 0) > 0 THEN 'åå°'
                ELSE NULL
            END as appointmentType,
            -- é»˜è®¤ç©ºå€¼å­—æ®µ
            NULL as creditScore,
            NULL as monthTicketStatus,
            CASE 
                WHEN LENGTH(v.plate_number) = 8 THEN true 
                ELSE false 
            END as isNewEnergy
        FROM violations v
        LEFT JOIN appointment apt ON v.appointment_id = apt.id
        <where>
            <!-- ğŸ†• æ’é™¤ä¸œåŒ—æ—ä¸šå¤§å­¦è½¦åœº -->
            AND (v.park_name IS NULL OR v.park_name != 'ä¸œåŒ—æ—ä¸šå¤§å­¦')
            <if test="plateNumber != null and plateNumber != ''">
                AND v.plate_number LIKE CONCAT('%', #{plateNumber}, '%')
            </if>
            <if test="status != null and status != ''">
                AND v.status = #{status}
            </if>
            <if test="violationType != null and violationType != ''">
                AND v.violation_type = #{violationType}
            </if>
            <if test="startDate != null">
                AND v.created_at >= #{startDate}
            </if>
            <if test="endDate != null">
                AND v.created_at &lt;= #{endDate}
            </if>
            <if test="createdByFilter != null">
                AND v.created_by = #{createdByFilter}
            </if>
            <if test="communityFilter != null and communityFilter != ''">
                AND v.park_name = #{communityFilter}
            </if>
        </where>
        ORDER BY v.created_at DESC
    </select>

</mapper>
