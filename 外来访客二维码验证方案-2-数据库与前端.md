# å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ - ç¬¬2éƒ¨åˆ†ï¼šæ•°æ®åº“ä¸å‰ç«¯å®ç°

## ç›®å½•
- [6. æ•°æ®åº“è®¾è®¡](#6-æ•°æ®åº“è®¾è®¡)
- [7. å‰ç«¯å®ç°](#7-å‰ç«¯å®ç°)

---

## 6. æ•°æ®åº“è®¾è®¡

### 6.1 qr_visitor_usageï¼ˆè®¿å®¢ä½¿ç”¨è®°å½•è¡¨ï¼‰

```sql
CREATE TABLE qr_visitor_usage (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
    qr_id VARCHAR(50) NOT NULL COMMENT 'è½¦åœºäºŒç»´ç ID',
    phone VARCHAR(20) NOT NULL COMMENT 'è®¿å®¢æ‰‹æœºå·',
    
    -- æ—¶é—´ç›¸å…³
    first_scan_time DATETIME NOT NULL COMMENT 'é¦–æ¬¡æ‰«ç æ—¶é—´',
    last_scan_time DATETIME NOT NULL COMMENT 'æœ€åæ‰«ç æ—¶é—´',
    expires_at DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆé¦–æ¬¡æ‰«ç +24å°æ—¶ï¼‰',
    
    -- ä½¿ç”¨ç»Ÿè®¡
    scan_count INT DEFAULT 1 COMMENT 'ä»Šæ—¥æ‰«ç æ¬¡æ•°',
    total_count INT DEFAULT 1 COMMENT 'ç´¯è®¡ä½¿ç”¨æ¬¡æ•°',
    
    -- ä½ç½®ä¿¡æ¯
    last_latitude DECIMAL(10, 6) COMMENT 'æœ€åæ‰«ç çº¬åº¦',
    last_longitude DECIMAL(10, 6) COMMENT 'æœ€åæ‰«ç ç»åº¦',
    last_distance DECIMAL(10, 2) COMMENT 'æœ€åæ‰«ç è·ç¦»ï¼ˆç±³ï¼‰',
    
    -- çŠ¶æ€ç®¡ç†
    status VARCHAR(20) DEFAULT 'active' COMMENT 'çŠ¶æ€: active-æ´»è·ƒ, expired-å·²è¿‡æœŸ, blocked-å·²å°ç¦',
    block_reason VARCHAR(200) COMMENT 'å°ç¦åŸå› ',
    
    -- å®¡è®¡å­—æ®µ
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
    
    -- ç´¢å¼•
    UNIQUE KEY uk_qr_phone (qr_id, phone) COMMENT 'å”¯ä¸€ç´¢å¼•ï¼šä¸€ä¸ªæ‰‹æœºå·åœ¨ä¸€ä¸ªè½¦åœºåªæœ‰ä¸€æ¡æœ‰æ•ˆè®°å½•',
    INDEX idx_phone (phone) COMMENT 'æ‰‹æœºå·ç´¢å¼•',
    INDEX idx_qr_id (qr_id) COMMENT 'äºŒç»´ç IDç´¢å¼•',
    INDEX idx_first_scan (first_scan_time) COMMENT 'é¦–æ¬¡æ‰«ç æ—¶é—´ç´¢å¼•',
    INDEX idx_expires (expires_at) COMMENT 'è¿‡æœŸæ—¶é—´ç´¢å¼•',
    INDEX idx_status (status) COMMENT 'çŠ¶æ€ç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è½¦åœºäºŒç»´ç è®¿å®¢ä½¿ç”¨è®°å½•è¡¨';
```

### 6.2 appointmentï¼ˆé¢„çº¦è¡¨ä¿®æ”¹ï¼‰

```sql
-- æ–°å¢å­—æ®µ
ALTER TABLE appointment 
ADD COLUMN status VARCHAR(20) DEFAULT 'pending' 
    COMMENT 'çŠ¶æ€: pending-å¾…ç¡®è®¤, confirmed-å·²ç¡®è®¤, cancelled-å·²å–æ¶ˆ, completed-å·²å®Œæˆ',
ADD COLUMN confirm_time DATETIME 
    COMMENT 'ç°åœºç¡®è®¤æ—¶é—´',
ADD COLUMN confirm_qr_id VARCHAR(50) 
    COMMENT 'ç¡®è®¤æ—¶æ‰«æçš„qrId',
ADD COLUMN confirm_location VARCHAR(100) 
    COMMENT 'ç¡®è®¤æ—¶çš„ä½ç½®ä¿¡æ¯ï¼ˆç»çº¬åº¦ï¼‰',
ADD COLUMN visitor_token VARCHAR(100) 
    COMMENT 'è®¿å®¢tokenï¼ˆç”¨äºéªŒè¯ï¼‰',
ADD COLUMN scan_time DATETIME 
    COMMENT 'æ‰«ç æ—¶é—´';

-- ç´¢å¼•
ALTER TABLE appointment 
ADD INDEX idx_status (status),
ADD INDEX idx_visitor_token (visitor_token),
ADD INDEX idx_scan_time (scan_time);
```

### 6.3 parking_lotï¼ˆè½¦åœºè¡¨ä¿®æ”¹ï¼‰

```sql
-- æ–°å¢å­—æ®µï¼šè½¦åœºåæ ‡
ALTER TABLE parking_lot
ADD COLUMN latitude DECIMAL(10, 6) COMMENT 'çº¬åº¦ï¼ˆWGS84åæ ‡ç³»ï¼‰',
ADD COLUMN longitude DECIMAL(10, 6) COMMENT 'ç»åº¦ï¼ˆWGS84åæ ‡ç³»ï¼‰',
ADD COLUMN location_radius INT DEFAULT 500 COMMENT 'æœ‰æ•ˆèŒƒå›´ï¼ˆç±³ï¼‰',
ADD COLUMN qr_id VARCHAR(50) UNIQUE COMMENT 'è½¦åœºäºŒç»´ç ID';

-- ç´¢å¼•
ALTER TABLE parking_lot
ADD INDEX idx_qr_id (qr_id);

-- ç¤ºä¾‹æ•°æ®
UPDATE parking_lot 
SET latitude = 45.7568,          -- å“ˆå°”æ»¨æ¬§æ´²æ–°åŸ
    longitude = 126.6425,
    location_radius = 500,
    qr_id = '11802'
WHERE name = 'æ¬§æ´²æ–°åŸåœè½¦åœº';
```

### 6.4 visitor_tokenï¼ˆTokenä¸´æ—¶è¡¨ï¼‰

```sql
CREATE TABLE visitor_token (
    token VARCHAR(100) PRIMARY KEY COMMENT 'UUID token',
    qr_id VARCHAR(50) NOT NULL COMMENT 'è½¦åœºäºŒç»´ç ID',
    phone VARCHAR(20) NOT NULL COMMENT 'è®¿å®¢æ‰‹æœºå·',
    
    -- ä½ç½®ä¿¡æ¯
    latitude DECIMAL(10, 6) COMMENT 'GPSçº¬åº¦',
    longitude DECIMAL(10, 6) COMMENT 'GPSç»åº¦',
    distance DECIMAL(10, 2) COMMENT 'è·ç¦»è½¦åœºçš„è·ç¦»ï¼ˆç±³ï¼‰',
    
    -- æ—¶é—´ç®¡ç†
    create_time DATETIME NOT NULL COMMENT 'åˆ›å»ºæ—¶é—´',
    expire_time DATETIME NOT NULL COMMENT 'è¿‡æœŸæ—¶é—´ï¼ˆåˆ›å»ºæ—¶é—´+5åˆ†é’Ÿï¼‰',
    
    -- ä½¿ç”¨çŠ¶æ€
    is_used TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦å·²ä½¿ç”¨ï¼ˆ0-æœªä½¿ç”¨ï¼Œ1-å·²ä½¿ç”¨ï¼Œä¸€æ¬¡æ€§tokenï¼‰',
    used_time DATETIME COMMENT 'ä½¿ç”¨æ—¶é—´',
    
    -- ç´¢å¼•
    INDEX idx_expire (expire_time) COMMENT 'è¿‡æœŸæ—¶é—´ç´¢å¼•ï¼ˆå®šæ—¶æ¸…ç†ï¼‰',
    INDEX idx_phone (phone) COMMENT 'æ‰‹æœºå·ç´¢å¼•',
    INDEX idx_qr_id (qr_id) COMMENT 'äºŒç»´ç IDç´¢å¼•'
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='è®¿å®¢ä¸´æ—¶Tokenè¡¨ï¼ˆ5åˆ†é’Ÿæœ‰æ•ˆæœŸï¼‰';
```

**è®¾è®¡è¯´æ˜**ï¼š
- **ä¸»é”®**ï¼štokenï¼ˆUUIDï¼‰ï¼Œç¡®ä¿å”¯ä¸€æ€§
- **æœ‰æ•ˆæœŸ**ï¼š5åˆ†é’Ÿï¼Œé€šè¿‡å®šæ—¶ä»»åŠ¡æ¸…ç†è¿‡æœŸè®°å½•
- **ä¸€æ¬¡æ€§**ï¼šis_usedæ ‡è®°ï¼Œé˜²æ­¢é‡å¤ä½¿ç”¨
- **å…³è”ä¿¡æ¯**ï¼šä¿å­˜qrIdã€phoneã€GPSä½ç½®ç­‰éªŒè¯ä¿¡æ¯

---

## 7. å‰ç«¯å®ç°

### 7.1 pages/auth/phone-auth.vue

#### 7.1.1 å¤–æ¥è®¿å®¢éªŒè¯ä¸»æµç¨‹

```javascript
async onGetPhoneNumber(e) {
    // ... ç°æœ‰ç™»å½•ä»£ç 
    
    // åˆ¤æ–­è®¿å®¢ç±»å‹
    if (phoneResult.role === 'unregistered') {
        const butlerId = this.scannedParams.butlerId;
        const qrId = this.scannedParams.qrId;
        
        let visitorType = 'unknown';
        
        if (butlerId) {
            visitorType = 'invited'; // å—é‚€è®¿å®¢
        } else if (qrId) {
            visitorType = 'external'; // å¤–æ¥è®¿å®¢
            
            // âœ… å¤–æ¥è®¿å®¢ï¼šGPSå®šä½ + TokenéªŒè¯
            try {
                uni.showLoading({ title: 'æ­£åœ¨éªŒè¯ä½ç½®...' });
                await this.verifyExternalVisitor(qrId, phoneResult.phone);
                uni.hideLoading();
            } catch (error) {
                uni.hideLoading();
                console.error('âŒ å¤–æ¥è®¿å®¢éªŒè¯å¤±è´¥:', error);
                uni.showModal({
                    title: 'éªŒè¯å¤±è´¥',
                    content: error.message || 'ä½ç½®éªŒè¯å¤±è´¥ï¼Œè¯·ç¡®ä¿åœ¨è½¦åœºç°åœºæ‰«ç ',
                    showCancel: false
                });
                return;
            }
        }
        
        // æœªçŸ¥è®¿å®¢æ‹’ç»è®¿é—®
        if (visitorType === 'unknown') {
            uni.showModal({
                title: 'è®¿é—®å—é™',
                content: 'æ£€æµ‹åˆ°æ‚¨æœªé€šè¿‡æœ‰æ•ˆçš„äºŒç»´ç è®¿é—®ã€‚\nè¯·æ‰«æè½¦åœºäºŒç»´ç æˆ–ç®¡å®¶é‚€è¯·ç åå†è¯•ã€‚',
                showCancel: false
            });
            return;
        }
        
        // æ„å»ºè®¿å®¢ä¿¡æ¯
        const visitorResult = {
            phone: phoneResult.phone,
            role: 'visitor',
            roleText: visitorType === 'invited' ? 'å—é‚€è®¿å®¢' : 'å¤–æ¥è®¿å®¢',
            visitorType: visitorType,
            userInfo: {
                id: Date.now(),
                openid: 'visitor_' + phoneResult.phone,
                nickname: visitorType === 'invited' ? 'å—é‚€è®¿å®¢' : 'å¤–æ¥è®¿å®¢',
                phone: phoneResult.phone,
                visitorType: visitorType
            },
            permissions: ['appointment.create', 'appointment.query.own'],
            expiresAt: Date.now() + (24 * 60 * 60 * 1000), // âœ… 24å°æ—¶åè¿‡æœŸ
            scannedInfo: {
                qrId: this.scannedParams.qrId,
                butlerId: this.scannedParams.butlerId,
                community: this.scannedParams.community
            }
        };
        
        // ç»§ç»­ç™»å½•æµç¨‹
        return this.continueLogin(visitorResult);
    }
}
```

#### 7.1.2 å¤–æ¥è®¿å®¢éªŒè¯æ–¹æ³•

```javascript
/**
 * éªŒè¯å¤–æ¥è®¿å®¢ï¼ˆGPSå®šä½ + åŠ¨æ€Tokenï¼‰
 * @param {string} qrId - è½¦åœºäºŒç»´ç ID
 * @param {string} phone - è®¿å®¢æ‰‹æœºå·
 */
async verifyExternalVisitor(qrId, phone) {
    try {
        // ç¬¬ä¸€æ­¥ï¼šè·å–GPSä½ç½®
        console.log('ğŸ“ å¼€å§‹è·å–GPSä½ç½®...');
        const location = await this.getUserLocation();
        console.log('âœ… è·å–åˆ°ä½ç½®:', location);
        
        // ç¬¬äºŒæ­¥ï¼šè°ƒç”¨åç«¯éªŒè¯æ¥å£
        console.log('ğŸ” å¼€å§‹ä½ç½®éªŒè¯...');
        const verification = await this.verifyAndGetToken(qrId, phone, location);
        
        if (!verification.success) {
            throw new Error(verification.message);
        }
        
        console.log('âœ… å¤–æ¥è®¿å®¢éªŒè¯é€šè¿‡');
        console.log('ğŸ“ Token:', verification.token);
        console.log('â° è¿‡æœŸæ—¶é—´:', new Date(verification.expiresAt));
        console.log('ğŸ“ è·ç¦»:', verification.distance, 'ç±³');
        
        // ç¬¬ä¸‰æ­¥ï¼šä¿å­˜éªŒè¯ä¿¡æ¯åˆ°æœ¬åœ°å­˜å‚¨
        this.scannedParams.visitorToken = verification.token;
        this.scannedParams.tokenTime = Date.now();
        this.scannedParams.tokenExpiresAt = verification.expiresAt;
        this.scannedParams.scanLocation = location;
        this.scannedParams.distance = verification.distance;
        this.scannedParams.parkingName = verification.parkingName;
        this.scannedParams.verified = true;
        this.scannedParams.scanTime = Date.now(); // âœ… è®°å½•æ‰«ç æ—¶é—´
        
        uni.setStorageSync('scannedParams', this.scannedParams);
        
        return true;
        
    } catch (error) {
        console.error('âŒ éªŒè¯å¤±è´¥:', error);
        throw error;
    }
}
```

#### 7.1.3 è·å–GPSä½ç½®

```javascript
/**
 * è·å–ç”¨æˆ·GPSä½ç½®
 * @returns {Promise<{latitude, longitude, accuracy}>}
 */
async getUserLocation() {
    return new Promise((resolve, reject) => {
        uni.getLocation({
            type: 'gcj02', // ç«æ˜Ÿåæ ‡ç³»ï¼ˆä¸­å›½åœ°å›¾ä½¿ç”¨ï¼‰
            altitude: false,
            geocode: false,
            isHighAccuracy: true, // é«˜ç²¾åº¦æ¨¡å¼
            success: (res) => {
                console.log('âœ… GPSå®šä½æˆåŠŸ:', res);
                resolve({
                    latitude: res.latitude,
                    longitude: res.longitude,
                    accuracy: res.accuracy || 0
                });
            },
            fail: (err) => {
                console.error('âŒ GPSå®šä½å¤±è´¥:', err);
                
                // åˆ¤æ–­å¤±è´¥åŸå› 
                if (err.errMsg.indexOf('auth deny') !== -1) {
                    // ç”¨æˆ·æ‹’ç»æˆæƒ
                    uni.showModal({
                        title: 'éœ€è¦ä½ç½®æƒé™',
                        content: 'ä¸ºç¡®ä¿æ‚¨åœ¨è½¦åœºç°åœºï¼Œéœ€è¦è·å–æ‚¨çš„ä½ç½®ä¿¡æ¯ã€‚æˆ‘ä»¬ä»…åœ¨æ‰«ç éªŒè¯æ—¶ä½¿ç”¨ï¼Œä¸ä¼šè®°å½•æ‚¨çš„è¡Œè¸ªã€‚',
                        confirmText: 'å»è®¾ç½®',
                        cancelText: 'å–æ¶ˆ',
                        success: (modalRes) => {
                            if (modalRes.confirm) {
                                uni.openSetting();
                            }
                        }
                    });
                    reject(new Error('ç”¨æˆ·æ‹’ç»ä½ç½®æˆæƒ'));
                } else if (err.errMsg.indexOf('timeout') !== -1) {
                    // å®šä½è¶…æ—¶
                    reject(new Error('å®šä½è¶…æ—¶ï¼Œè¯·æ£€æŸ¥GPSæ˜¯å¦å¼€å¯'));
                } else {
                    // å…¶ä»–é”™è¯¯
                    reject(new Error('è·å–ä½ç½®å¤±è´¥ï¼Œè¯·æ£€æŸ¥å®šä½æœåŠ¡æ˜¯å¦å¼€å¯'));
                }
            }
        });
    });
}
```

#### 7.1.4 è°ƒç”¨åç«¯éªŒè¯æ¥å£

```javascript
/**
 * è°ƒç”¨åç«¯éªŒè¯æ¥å£ï¼ˆä½ç½®éªŒè¯ + è·å–Tokenï¼‰
 * @param {string} qrId - è½¦åœºäºŒç»´ç ID
 * @param {string} phone - è®¿å®¢æ‰‹æœºå·
 * @param {object} location - GPSä½ç½® {latitude, longitude}
 * @returns {Promise<{success, token, expiresAt, distance, parkingName}>}
 */
async verifyAndGetToken(qrId, phone, location) {
    try {
        const res = await request({
            url: '/visitor/verifyAndGetToken',
            method: 'POST',
            data: {
                qrId: qrId,
                phone: phone,
                latitude: location.latitude,
                longitude: location.longitude
            },
            header: {
                'Content-Type': 'application/json'
            }
        });
        
        if (res.code === '0') {
            return {
                success: true,
                token: res.data.token,
                expiresAt: res.data.expiresAt,
                distance: res.data.distance,
                parkingName: res.data.parkingName
            };
        } else {
            return {
                success: false,
                message: res.msg || 'éªŒè¯å¤±è´¥'
            };
        }
    } catch (error) {
        console.error('âŒ è°ƒç”¨éªŒè¯æ¥å£å¤±è´¥:', error);
        throw new Error('ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•');
    }
}
```

#### 7.1.5 èº«ä»½è¿‡æœŸæ£€æŸ¥ï¼ˆonShowç”Ÿå‘½å‘¨æœŸï¼‰

```javascript
onShow() {
    // æ£€æŸ¥å¤–æ¥è®¿å®¢èº«ä»½æ˜¯å¦è¿‡æœŸ
    this.checkVisitorExpiry();
},

/**
 * æ£€æŸ¥è®¿å®¢èº«ä»½æ˜¯å¦è¿‡æœŸ
 */
checkVisitorExpiry() {
    const userInfo = uni.getStorageSync('userInfo');
    
    // åªæ£€æŸ¥å¤–æ¥è®¿å®¢
    if (userInfo && userInfo.role === 'visitor' && userInfo.visitorType === 'external') {
        const now = Date.now();
        const expiresAt = userInfo.expiresAt;
        
        if (expiresAt && now > expiresAt) {
            console.log('â° è®¿å®¢èº«ä»½å·²è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰');
            
            // æ¸…é™¤æœ¬åœ°å­˜å‚¨
            uni.clearStorageSync();
            
            // å¼¹çª—æç¤º
            uni.showModal({
                title: 'è®¿å®¢èº«ä»½å·²è¿‡æœŸ',
                content: 'æ‚¨çš„è®¿å®¢èº«ä»½æœ‰æ•ˆæœŸå·²è¿‡ï¼ˆ24å°æ—¶ï¼‰ï¼Œè¯·é‡æ–°æ‰«æè½¦åœºäºŒç»´ç è¿›è¡ŒéªŒè¯ã€‚',
                showCancel: false,
                confirmText: 'é‡æ–°æ‰«ç ',
                success: () => {
                    uni.reLaunch({
                        url: '/pages/index/index'
                    });
                }
            });
        } else {
            // è®¡ç®—å‰©ä½™æ—¶é—´
            const remainingHours = Math.floor((expiresAt - now) / 1000 / 60 / 60);
            console.log(`âœ… è®¿å®¢èº«ä»½æœ‰æ•ˆï¼Œå‰©ä½™ ${remainingHours} å°æ—¶`);
        }
    }
}
```

### 7.2 pagesA/reservation/form.vue

#### 7.2.1 é¢„çº¦æäº¤éªŒè¯

```javascript
async submitAppointment() {
    const userInfo = uni.getStorageSync('userInfo');
    
    // å¤–æ¥è®¿å®¢éœ€è¦é¢å¤–éªŒè¯
    if (userInfo?.visitorType === 'external') {
        const scannedParams = uni.getStorageSync('scannedParams');
        
        // ========== éªŒè¯1ï¼šTokenæœ‰æ•ˆæ€§ ==========
        if (!scannedParams || !scannedParams.visitorToken) {
            uni.showModal({
                title: 'éœ€è¦é‡æ–°æ‰«ç ',
                content: 'æœªæ£€æµ‹åˆ°æœ‰æ•ˆçš„è®¿å®¢å‡­è¯ï¼Œè¯·é‡æ–°æ‰«æè½¦åœºäºŒç»´ç ',
                showCancel: false,
                success: () => {
                    uni.reLaunch({ url: '/pages/index/index' });
                }
            });
            return;
        }
        
        // æ£€æŸ¥tokenæ˜¯å¦è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰
        const tokenAge = (Date.now() - scannedParams.tokenTime) / 1000 / 60;
        if (tokenAge > 5) {
            uni.showModal({
                title: 'Tokenå·²è¿‡æœŸ',
                content: 'Tokenå·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰ï¼Œè¯·é‡æ–°æ‰«æè½¦åœºäºŒç»´ç ',
                showCancel: false,
                success: () => {
                    uni.removeStorageSync('scannedParams');
                    uni.reLaunch({ url: '/pages/index/index' });
                }
            });
            return;
        }
        
        // ========== éªŒè¯2ï¼šæ‰«ç æ—¶é—´ ==========
        const scanTime = scannedParams.scanTime || 0;
        const scanAge = (Date.now() - scanTime) / 1000 / 60;
        
        if (scanAge > 10) {
            uni.showModal({
                title: 'éœ€è¦é‡æ–°æ‰«ç ',
                content: 'æ‰«ç æ—¶é—´å·²è¶…è¿‡10åˆ†é’Ÿï¼Œä¸ºç¡®ä¿æ‚¨åœ¨è½¦åœºç°åœºï¼Œè¯·é‡æ–°æ‰«æè½¦é“äºŒç»´ç ',
                showCancel: false,
                success: () => {
                    uni.removeStorageSync('scannedParams');
                    uni.reLaunch({ url: '/pages/index/index' });
                }
            });
            return;
        }
        
        // ========== éªŒè¯3ï¼šé¢„çº¦æ—¶é—´èŒƒå›´ ==========
        const appointmentTime = new Date(this.form.appointmentTime);
        const now = new Date();
        const minutesAdvance = (appointmentTime - now) / 1000 / 60;
        
        if (minutesAdvance < 30) {
            uni.showToast({
                title: 'è¯·è‡³å°‘æå‰30åˆ†é’Ÿé¢„çº¦',
                icon: 'none'
            });
            return;
        }
        
        if (minutesAdvance > 120) {
            uni.showToast({
                title: 'åªèƒ½é¢„çº¦2å°æ—¶å†…çš„æ—¶é—´',
                icon: 'none'
            });
            return;
        }
        
        console.log('âœ… å¤–æ¥è®¿å®¢éªŒè¯é€šè¿‡ï¼Œå‡†å¤‡æäº¤é¢„çº¦');
    }
    
    // æäº¤é¢„çº¦
    try {
        uni.showLoading({ title: 'æäº¤ä¸­...' });
        
        const appointmentData = {
            ...this.form,
            // å¤–æ¥è®¿å®¢é¢å¤–å­—æ®µ
            visitorToken: scannedParams?.visitorToken,
            qrId: scannedParams?.qrId,
            scanTime: scannedParams?.scanTime,
            scanLocation: scannedParams?.scanLocation
        };
        
        const res = await request({
            url: '/appointment/create',
            method: 'POST',
            data: appointmentData
        });
        
        uni.hideLoading();
        
        if (res.code === '0') {
            uni.showToast({
                title: 'é¢„çº¦æˆåŠŸ',
                icon: 'success'
            });
            
            setTimeout(() => {
                uni.navigateBack();
            }, 1500);
        } else {
            uni.showModal({
                title: 'é¢„çº¦å¤±è´¥',
                content: res.msg || 'æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•',
                showCancel: false
            });
        }
        
    } catch (error) {
        uni.hideLoading();
        uni.showModal({
            title: 'æäº¤å¤±è´¥',
            content: error.message || 'ç½‘ç»œå¼‚å¸¸ï¼Œè¯·é‡è¯•',
            showCancel: false
        });
    }
}
```

#### 7.2.2 é¡µé¢åŠ è½½æ—¶æ£€æŸ¥

```javascript
onLoad(options) {
    // ... ç°æœ‰ä»£ç 
    
    const userInfo = uni.getStorageSync('userInfo');
    
    // å¤–æ¥è®¿å®¢æ£€æŸ¥
    if (userInfo?.visitorType === 'external') {
        const scannedParams = uni.getStorageSync('scannedParams');
        
        // æ£€æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆæ‰«ç ä¿¡æ¯
        if (!scannedParams || !scannedParams.scanTime) {
            uni.showModal({
                title: 'éœ€è¦æ‰«ç ',
                content: 'è¯·å…ˆæ‰«æè½¦åœºäºŒç»´ç åå†è¿›è¡Œé¢„çº¦',
                showCancel: false,
                success: () => {
                    uni.reLaunch({ url: '/pages/index/index' });
                }
            });
            return;
        }
        
        // æ£€æŸ¥æ‰«ç æ—¶é—´æ˜¯å¦è¿‡ä¹…
        const scanAge = (Date.now() - scannedParams.scanTime) / 1000 / 60;
        if (scanAge > 10) {
            uni.showModal({
                title: 'æ‰«ç å·²è¿‡æœŸ',
                content: 'æ‰«ç æ—¶é—´å·²è¶…è¿‡10åˆ†é’Ÿï¼Œè¯·é‡æ–°æ‰«ç ',
                showCancel: false,
                success: () => {
                    uni.removeStorageSync('scannedParams');
                    uni.reLaunch({ url: '/pages/index/index' });
                }
            });
            return;
        }
        
        console.log('âœ… å¤–æ¥è®¿å®¢éªŒè¯é€šè¿‡ï¼Œæ‰«ç æ—¶é—´:', new Date(scannedParams.scanTime));
    }
}
```

### 7.3 å·¥å…·å‡½æ•°ï¼ˆutils/visitor.jsï¼‰

```javascript
/**
 * å¤–æ¥è®¿å®¢å·¥å…·ç±»
 */
export default {
    /**
     * æ£€æŸ¥Tokenæ˜¯å¦æœ‰æ•ˆ
     * @returns {{valid: boolean, message: string}}
     */
    checkToken() {
        const scannedParams = uni.getStorageSync('scannedParams');
        
        if (!scannedParams || !scannedParams.visitorToken) {
            return { valid: false, message: 'æœªæ£€æµ‹åˆ°è®¿å®¢token' };
        }
        
        const tokenAge = (Date.now() - scannedParams.tokenTime) / 1000 / 60;
        if (tokenAge > 5) {
            return { valid: false, message: 'Tokenå·²è¿‡æœŸï¼ˆ5åˆ†é’Ÿï¼‰' };
        }
        
        return { valid: true, message: 'Tokenæœ‰æ•ˆ' };
    },
    
    /**
     * æ£€æŸ¥æ‰«ç æ—¶é—´æ˜¯å¦æœ‰æ•ˆ
     * @returns {{valid: boolean, message: string}}
     */
    checkScanTime() {
        const scannedParams = uni.getStorageSync('scannedParams');
        
        if (!scannedParams || !scannedParams.scanTime) {
            return { valid: false, message: 'æœªæ£€æµ‹åˆ°æ‰«ç æ—¶é—´' };
        }
        
        const scanAge = (Date.now() - scannedParams.scanTime) / 1000 / 60;
        if (scanAge > 10) {
            return { valid: false, message: 'æ‰«ç æ—¶é—´å·²è¶…è¿‡10åˆ†é’Ÿ' };
        }
        
        return { valid: true, message: 'æ‰«ç æ—¶é—´æœ‰æ•ˆ' };
    },
    
    /**
     * æ£€æŸ¥èº«ä»½æ˜¯å¦è¿‡æœŸ
     * @returns {{valid: boolean, message: string}}
     */
    checkExpiry() {
        const userInfo = uni.getStorageSync('userInfo');
        
        if (!userInfo || !userInfo.expiresAt) {
            return { valid: false, message: 'æœªæ£€æµ‹åˆ°ç”¨æˆ·ä¿¡æ¯' };
        }
        
        const now = Date.now();
        if (now > userInfo.expiresAt) {
            return { valid: false, message: 'è®¿å®¢èº«ä»½å·²è¿‡æœŸï¼ˆ24å°æ—¶ï¼‰' };
        }
        
        const remainingHours = Math.floor((userInfo.expiresAt - now) / 1000 / 60 / 60);
        return { valid: true, message: `èº«ä»½æœ‰æ•ˆï¼Œå‰©ä½™${remainingHours}å°æ—¶` };
    },
    
    /**
     * å…¨é¢æ£€æŸ¥å¤–æ¥è®¿å®¢çŠ¶æ€
     * @returns {{valid: boolean, message: string}}
     */
    checkAll() {
        // æ£€æŸ¥èº«ä»½è¿‡æœŸ
        const expiry = this.checkExpiry();
        if (!expiry.valid) return expiry;
        
        // æ£€æŸ¥token
        const token = this.checkToken();
        if (!token.valid) return token;
        
        // æ£€æŸ¥æ‰«ç æ—¶é—´
        const scanTime = this.checkScanTime();
        if (!scanTime.valid) return scanTime;
        
        return { valid: true, message: 'å…¨éƒ¨éªŒè¯é€šè¿‡' };
    }
};
```

---

**ä¸‹ä¸€éƒ¨åˆ†ï¼š[åç«¯å®ç°ä¸æµ‹è¯•](./å¤–æ¥è®¿å®¢äºŒç»´ç éªŒè¯æ–¹æ¡ˆ-3-åç«¯ä¸æµ‹è¯•.md)**
