# å¾®ä¿¡é€šçŸ¥è·³è½¬å°ç¨‹åºå®ç°æ–¹æ¡ˆ

## ğŸ“‹ éœ€æ±‚è¯´æ˜
å®ç°ç‚¹å‡»å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯é€šçŸ¥åï¼Œè‡ªåŠ¨è·³è½¬åˆ°å°ç¨‹åºçš„å¯¹åº”é¡µé¢ã€‚

---

## ğŸ” ç°çŠ¶åˆ†æ

### å½“å‰å®ç°ä½ç½®

#### 1. æ¨¡æ¿æ¶ˆæ¯å‘é€æ ¸å¿ƒæ–¹æ³•
**æ–‡ä»¶**: `WeChatTemplateMessageServiceImpl.java`

```java
@Override
public Map<String, Object> sendTemplateMessage(String openid, String templateId, 
    Map<String, Object> data, String url) {
    
    // ...è·å–access_token...
    
    // æ„å»ºè¯·æ±‚å‚æ•°
    JSONObject requestBody = new JSONObject();
    requestBody.put("touser", openid);
    requestBody.put("template_id", templateId);
    
    // âš ï¸ å½“å‰åªæ”¯æŒurlè·³è½¬ï¼ˆH5é¡µé¢ï¼‰ï¼Œä¸æ”¯æŒå°ç¨‹åºè·³è½¬
    if (!StringUtils.isEmpty(url)) {
        requestBody.put("url", url);  // â† è¿™é‡Œåªé…ç½®äº†url
    }
    
    requestBody.put("data", data);
    
    // å‘é€è¯·æ±‚...
}
```

#### 2. è¶…æ—¶æé†’å‘é€æ–¹æ³•
**æ–‡ä»¶**: `WeChatTemplateMessageServiceImpl.java` (ç¬¬369-438è¡Œ)

```java
@Override
public Map<String, Object> sendParkingAlmostTimeoutNotification(String openid, String plateNumber, 
    String parkName, String enterTime, long remainingMinutes) {
    
    // ...æ„å»ºæ¨¡æ¿æ•°æ®...
    
    // âš ï¸ å½“å‰ä¼ é€’çš„urlå‚æ•°ä¸ºnullï¼Œç‚¹å‡»é€šçŸ¥æ— æ³•è·³è½¬
    return sendTemplateMessage(openid, parkingTimeoutTemplateId, templateData, null);
    //                                                                           â†‘
    //                                                                        è¿™é‡Œæ˜¯null
}
```

### é—®é¢˜æ€»ç»“
1. âœ… å·²æœ‰åŸºç¡€çš„æ¨¡æ¿æ¶ˆæ¯å‘é€åŠŸèƒ½
2. âŒ åªæ”¯æŒH5é¡µé¢è·³è½¬ï¼ˆurlï¼‰ï¼Œä¸æ”¯æŒå°ç¨‹åºè·³è½¬ï¼ˆminiprogramï¼‰
3. âŒ å½“å‰è¶…æ—¶æé†’çš„urlå‚æ•°ä¸ºnullï¼Œç‚¹å‡»æ— æ³•è·³è½¬

---

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ”¯æŒä¸¤ç§è·³è½¬æ–¹å¼ï¼š

### æ–¹å¼1ï¼šè·³è½¬åˆ°å°ç¨‹åºï¼ˆæ¨èï¼‰â­

ä½¿ç”¨å¾®ä¿¡æä¾›çš„ `miniprogram` å‚æ•°ï¼Œå¯ä»¥ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºæŒ‡å®šé¡µé¢ã€‚

#### è¯·æ±‚JSONæ ¼å¼
```json
{
    "touser": "OPENID",
    "template_id": "TEMPLATE_ID",
    "miniprogram": {
        "appid": "xiaochengxuappid12345",
        "pagepath": "pages/index?foo=bar"
    },
    "data": {
        "thing2": {"value": "ä¸œåŒ—æ—ä¸šå¤§å­¦"},
        "car_number5": {"value": "äº¬A12345"},
        // ...å…¶ä»–æ•°æ®
    }
}
```

### æ–¹å¼2ï¼šè·³è½¬åˆ°H5é¡µé¢

ä½¿ç”¨ `url` å‚æ•°è·³è½¬åˆ°H5é¡µé¢ï¼ˆå½“å‰å·²æ”¯æŒä½†æœªé…ç½®ï¼‰ã€‚

```json
{
    "touser": "OPENID",
    "template_id": "TEMPLATE_ID",
    "url": "https://your-domain.com/h5-page?plateNumber=äº¬A12345",
    "data": {
        // ...æ¨¡æ¿æ•°æ®
    }
}
```

---

## ğŸ”§ å®ç°æ­¥éª¤

### æ­¥éª¤1ï¼šä¿®æ”¹ sendTemplateMessage æ–¹æ³•

**æ–‡ä»¶**: `WeChatTemplateMessageServiceImpl.java`

**ä¿®æ”¹å‰**:
```java
public Map<String, Object> sendTemplateMessage(String openid, String templateId, 
    Map<String, Object> data, String url) {
    
    // ...
    
    // æ„å»ºè¯·æ±‚å‚æ•°
    JSONObject requestBody = new JSONObject();
    requestBody.put("touser", openid);
    requestBody.put("template_id", templateId);
    
    if (!StringUtils.isEmpty(url)) {
        requestBody.put("url", url);
    }
    
    requestBody.put("data", data);
    
    // ...
}
```

**ä¿®æ”¹å**:
```java
// é‡è½½æ–¹æ³•1ï¼šæ”¯æŒurlè·³è½¬ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
public Map<String, Object> sendTemplateMessage(String openid, String templateId, 
    Map<String, Object> data, String url) {
    return sendTemplateMessage(openid, templateId, data, url, null);
}

// é‡è½½æ–¹æ³•2ï¼šæ”¯æŒå°ç¨‹åºè·³è½¬ï¼ˆæ–°å¢ï¼‰
public Map<String, Object> sendTemplateMessage(String openid, String templateId, 
    Map<String, Object> data, String url, Map<String, String> miniprogram) {
    
    Map<String, Object> result = new HashMap<>();
    
    try {
        // è·å–access_token
        String accessToken = getAccessToken();
        if (StringUtils.isEmpty(accessToken)) {
            log.error("âŒ è·å–access_tokenå¤±è´¥");
            result.put("success", false);
            result.put("message", "è·å–access_tokenå¤±è´¥");
            return result;
        }
        
        // æ„å»ºè¯·æ±‚å‚æ•°
        JSONObject requestBody = new JSONObject();
        requestBody.put("touser", openid);
        requestBody.put("template_id", templateId);
        
        // æ”¯æŒå°ç¨‹åºè·³è½¬ï¼ˆä¼˜å…ˆçº§é«˜äºurlï¼‰
        if (miniprogram != null && !miniprogram.isEmpty()) {
            JSONObject miniprogramObj = new JSONObject();
            miniprogramObj.put("appid", miniprogram.get("appid"));
            miniprogramObj.put("pagepath", miniprogram.get("pagepath"));
            requestBody.put("miniprogram", miniprogramObj);
            
            log.info("ğŸ“± è®¾ç½®å°ç¨‹åºè·³è½¬ - appid: {}, pagepath: {}", 
                miniprogram.get("appid"), miniprogram.get("pagepath"));
        } 
        // å¦‚æœæ²¡æœ‰é…ç½®å°ç¨‹åºè·³è½¬ï¼Œä½¿ç”¨urlè·³è½¬
        else if (!StringUtils.isEmpty(url)) {
            requestBody.put("url", url);
            log.info("ğŸ”— è®¾ç½®URLè·³è½¬ - url: {}", url);
        }
        
        requestBody.put("data", data);
        
        // å‘é€è¯·æ±‚
        String requestUrl = TEMPLATE_MESSAGE_URL + accessToken;
        String response = HttpClientUtil.doPostJson(requestUrl, requestBody.toJSONString());
        
        log.info("ğŸ“¤ å‘é€æ¨¡æ¿æ¶ˆæ¯ - openid: {}, templateId: {}, response: {}", 
            openid, templateId, response);
        
        JSONObject responseJson = JSONObject.parseObject(response);
        if (responseJson.getInteger("errcode") == 0) {
            result.put("success", true);
            result.put("message", "å‘é€æˆåŠŸ");
            result.put("msgid", responseJson.getLong("msgid"));
        } else {
            result.put("success", false);
            result.put("message", "å‘é€å¤±è´¥: " + responseJson.getString("errmsg"));
            result.put("errcode", responseJson.getInteger("errcode"));
        }
        
    } catch (Exception e) {
        log.error("âŒ å‘é€æ¨¡æ¿æ¶ˆæ¯å¼‚å¸¸", e);
        result.put("success", false);
        result.put("message", "å‘é€å¼‚å¸¸: " + e.getMessage());
    }
    
    return result;
}
```

---

### æ­¥éª¤2ï¼šé…ç½®å°ç¨‹åºAppID

**æ–‡ä»¶**: `application.yml`

```yaml
wechat:
  # å…¬ä¼—å·é…ç½®
  public:
    appid: wx1234567890abcdef
    secret: your_secret_here
  
  # å°ç¨‹åºé…ç½®ï¼ˆæ–°å¢ï¼‰
  miniprogram:
    appid: wx_miniprogram_appid_here  # ä½ çš„å°ç¨‹åºAppID
  
  # æ¨¡æ¿æ¶ˆæ¯IDé…ç½®
  template:
    parking:
      timeout: your_timeout_template_id
      # ...å…¶ä»–æ¨¡æ¿ID
```

åœ¨Javaä»£ç ä¸­æ·»åŠ é…ç½®è¯»å–ï¼š
```java
// å°ç¨‹åºAppIDé…ç½®
@Value("${wechat.miniprogram.appid:}")
private String miniprogramAppId;
```

---

### æ­¥éª¤3ï¼šä¿®æ”¹è¶…æ—¶æé†’å‘é€æ–¹æ³•

**æ–‡ä»¶**: `WeChatTemplateMessageServiceImpl.java`

**ä¿®æ”¹å‰**:
```java
@Override
public Map<String, Object> sendParkingAlmostTimeoutNotification(String openid, String plateNumber, 
    String parkName, String enterTime, long remainingMinutes) {
    
    // ...æ„å»ºæ¨¡æ¿æ•°æ®...
    
    // ä½¿ç”¨é…ç½®çš„è¶…æ—¶æé†’æ¨¡æ¿IDå‘é€æ¶ˆæ¯
    return sendTemplateMessage(openid, parkingTimeoutTemplateId, templateData, null);
}
```

**ä¿®æ”¹å**:
```java
@Override
public Map<String, Object> sendParkingAlmostTimeoutNotification(String openid, String plateNumber, 
    String parkName, String enterTime, long remainingMinutes) {
    
    Map<String, Object> result = new HashMap<>();
    
    try {
        log.info("â° æ£€æŸ¥å³å°†è¶…æ—¶æé†’ - è½¦ç‰Œ: {}, åœè½¦åœº: {}, å‰©ä½™: {}åˆ†é’Ÿ", 
            plateNumber, parkName, remainingMinutes);
        
        if (!StringUtils.hasText(openid)) {
            result.put("success", false);
            result.put("message", "è®¿å®¢å¾®ä¿¡openidä¸ºç©º");
            return result;
        }
        
        // ...æ„å»ºæ¨¡æ¿æ•°æ®çš„ä»£ç ä¿æŒä¸å˜...
        
        // ğŸ†• æ„å»ºå°ç¨‹åºè·³è½¬å‚æ•°
        Map<String, String> miniprogram = null;
        if (StringUtils.hasText(miniprogramAppId)) {
            miniprogram = new HashMap<>();
            miniprogram.put("appid", miniprogramAppId);
            
            // è·³è½¬åˆ°é¢„çº¦åˆ—è¡¨é¡µé¢ï¼Œå¹¶ä¼ é€’è½¦ç‰Œå·å‚æ•°
            String pagePath = String.format("pagesA/appointment/appointment?plateNumber=%s", 
                plateNumber);
            miniprogram.put("pagepath", pagePath);
            
            log.info("ğŸ“± é…ç½®å°ç¨‹åºè·³è½¬ - è½¦ç‰Œ: {}, é¡µé¢è·¯å¾„: {}", plateNumber, pagePath);
        }
        
        // å‘é€æ¨¡æ¿æ¶ˆæ¯ï¼ˆå¸¦å°ç¨‹åºè·³è½¬ï¼‰
        return sendTemplateMessage(openid, parkingTimeoutTemplateId, templateData, null, miniprogram);
        
    } catch (Exception e) {
        log.error("âŒ å‘é€å³å°†è¶…æ—¶æé†’å¼‚å¸¸", e);
        result.put("success", false);
        result.put("message", "å‘é€å¼‚å¸¸: " + e.getMessage());
        return result;
    }
}
```

---

### æ­¥éª¤4ï¼šå°ç¨‹åºé¡µé¢æ¥æ”¶å‚æ•°

**æ–‡ä»¶**: `pagesA/appointment/appointment.vue` æˆ–å¯¹åº”çš„é¢„çº¦é¡µé¢

```javascript
export default {
    onLoad(options) {
        // æ¥æ”¶ä»å¾®ä¿¡é€šçŸ¥è·³è½¬è¿‡æ¥çš„å‚æ•°
        if (options.plateNumber) {
            console.log('ä»å¾®ä¿¡é€šçŸ¥è·³è½¬ï¼Œè½¦ç‰Œå·:', options.plateNumber);
            
            // æ ¹æ®è½¦ç‰Œå·ç­›é€‰æˆ–é«˜äº®æ˜¾ç¤ºå¯¹åº”çš„é¢„çº¦è®°å½•
            this.searchPlateNumber = options.plateNumber;
            this.loadAppointmentList();
        }
    },
    
    methods: {
        loadAppointmentList() {
            // åŠ è½½é¢„çº¦åˆ—è¡¨ï¼Œå¦‚æœæœ‰æœç´¢æ¡ä»¶åˆ™è¿›è¡Œç­›é€‰
            // ...
        }
    }
}
```

---

## ğŸ“± å°ç¨‹åºé¡µé¢è·¯å¾„é…ç½®

æ ¹æ®ä¸åŒçš„é€šçŸ¥ç±»å‹ï¼Œå¯ä»¥è·³è½¬åˆ°ä¸åŒçš„é¡µé¢ï¼š

### 1. è¶…æ—¶æé†’ â†’ é¢„çº¦åˆ—è¡¨é¡µ
```javascript
pagePath: `pagesA/appointment/appointment?plateNumber=${plateNumber}`
```

### 2. è¶…æ—¶æé†’ â†’ è¿è§„å¤„ç†é¡µï¼ˆå¦‚æœè¦ç›´æ¥å¤„ç†ï¼‰
```javascript
pagePath: `pagesE/violation/violation?plateNumber=${plateNumber}&type=timeout`
```

### 3. è¶…æ—¶æé†’ â†’ ä¸“é—¨çš„è¶…æ—¶å¤„ç†é¡µ
```javascript
pagePath: `pagesD/timeout/timeout?plateNumber=${plateNumber}&remainingMinutes=${remainingMinutes}`
```

### é¡µé¢è·¯å¾„æ ¼å¼è¯´æ˜
- è·¯å¾„ä¸èƒ½ä»¥ `/` å¼€å¤´
- å‚æ•°ä½¿ç”¨ `?key=value&key2=value2` æ ¼å¼
- è·¯å¾„éœ€è¦åœ¨ `app.json` ä¸­æ³¨å†Œï¼ˆåˆ†åŒ…é¡µé¢åœ¨å¯¹åº”åˆ†åŒ…çš„é…ç½®ä¸­æ³¨å†Œï¼‰

---

## ğŸ¨ æ¨èçš„è·³è½¬æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šè·³è½¬åˆ°é¢„çº¦è¯¦æƒ…é¡µï¼ˆæ¨èï¼‰â­

**ä¼˜ç‚¹**ï¼š
- ç”¨æˆ·å¯ä»¥æŸ¥çœ‹å®Œæ•´çš„é¢„çº¦ä¿¡æ¯
- å¯ä»¥ç›´æ¥æ“ä½œï¼ˆå¦‚å»¶é•¿æ—¶é—´ã€è”ç³»è½¦ä¸»ç­‰ï¼‰
- ä¿¡æ¯å±•ç¤ºå®Œæ•´

**é¡µé¢è·¯å¾„**ï¼š
```javascript
pagePath: `pagesA/appointment/appointment?plateNumber=${plateNumber}&action=timeout`
```

**é¡µé¢å®ç°**ï¼š
```javascript
// appointment.vue
onLoad(options) {
    if (options.action === 'timeout' && options.plateNumber) {
        // æ˜¾ç¤ºè¶…æ—¶æç¤º
        uni.showModal({
            title: 'è½¦è¾†å³å°†è¶…æ—¶',
            content: `è½¦ç‰Œ ${options.plateNumber} å³å°†è¶…æ—¶ï¼Œè¯·åŠæ—¶å¤„ç†`,
            confirmText: 'æŸ¥çœ‹è¯¦æƒ…',
            success: (res) => {
                if (res.confirm) {
                    // è·³è½¬åˆ°è¯¦æƒ…æˆ–æ‰§è¡Œå…¶ä»–æ“ä½œ
                    this.viewDetails(options.plateNumber);
                }
            }
        });
    }
}
```

### æ–¹æ¡ˆ2ï¼šè·³è½¬åˆ°ä¸“é—¨çš„è¶…æ—¶å¤„ç†é¡µ

**ä¼˜ç‚¹**ï¼š
- ä¸“é—¨é’ˆå¯¹è¶…æ—¶åœºæ™¯è®¾è®¡
- æ“ä½œæ›´èšç„¦
- å¯ä»¥æ˜¾ç¤ºå€’è®¡æ—¶

**é¡µé¢è·¯å¾„**ï¼š
```javascript
pagePath: `pagesD/timeout/handle?plateNumber=${plateNumber}&remainingMinutes=${remainingMinutes}`
```

### æ–¹æ¡ˆ3ï¼šè·³è½¬åˆ°é¦–é¡µå¹¶æ˜¾ç¤ºæç¤º

**ä¼˜ç‚¹**ï¼š
- ç®€å•ç›´æ¥
- ç”¨æˆ·å¯ä»¥ä»é¦–é¡µå¯¼èˆªåˆ°ä»»ä½•åŠŸèƒ½

**é¡µé¢è·¯å¾„**ï¼š
```javascript
pagePath: `pages/index/index?notification=timeout&plateNumber=${plateNumber}`
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å°ç¨‹åºAppIDé…ç½®
- å…¬ä¼—å·å’Œå°ç¨‹åºéœ€è¦è¿›è¡Œ**å…³è”**
- åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ï¼š`è®¾ç½®ä¸å¼€å‘` â†’ `å…¬ä¼—å·è®¾ç½®` â†’ `ç›¸å…³å°ç¨‹åº` ä¸­è¿›è¡Œå…³è”
- ç¡®ä¿ `miniprogram.appid` é…ç½®æ­£ç¡®

### 2. é¡µé¢è·¯å¾„é™åˆ¶
- è·¯å¾„é•¿åº¦ä¸èƒ½è¶…è¿‡ **256 ä¸ªå­—ç¬¦**
- å‚æ•°å€¼éœ€è¦è¿›è¡Œ URL ç¼–ç ï¼ˆç‰¹æ®Šå­—ç¬¦ï¼‰
- é¡µé¢å¿…é¡»åœ¨ `app.json` æˆ–åˆ†åŒ…é…ç½®ä¸­æ³¨å†Œ

### 3. æƒé™è¦æ±‚
- éœ€è¦å¾®ä¿¡è®¤è¯çš„å…¬ä¼—å·
- æ¨¡æ¿æ¶ˆæ¯éœ€è¦åœ¨å…¬ä¼—å¹³å°ç”³è¯·
- å°ç¨‹åºéœ€è¦å‘å¸ƒï¼ˆæˆ–ä½“éªŒç‰ˆï¼‰

### 4. ç”¨æˆ·æˆæƒ
- ç”¨æˆ·éœ€è¦å…³æ³¨å…¬ä¼—å·æ‰èƒ½æ”¶åˆ°æ¨¡æ¿æ¶ˆæ¯
- ç”¨æˆ·éœ€è¦æˆæƒå°ç¨‹åºæ‰èƒ½è·³è½¬

### 5. è·³è½¬å¤±è´¥é™çº§
å¦‚æœå°ç¨‹åºè·³è½¬å¤±è´¥ï¼Œå¯ä»¥æä¾›é™çº§æ–¹æ¡ˆï¼š

```java
// ä¸»æ–¹æ¡ˆï¼šè·³è½¬å°ç¨‹åº
if (StringUtils.hasText(miniprogramAppId)) {
    miniprogram = new HashMap<>();
    miniprogram.put("appid", miniprogramAppId);
    miniprogram.put("pagepath", pagePath);
}

// é™çº§æ–¹æ¡ˆï¼šè·³è½¬H5é¡µé¢
String fallbackUrl = null;
if (miniprogram == null) {
    fallbackUrl = "https://your-domain.com/timeout-handle?plateNumber=" + plateNumber;
}

return sendTemplateMessage(openid, templateId, templateData, fallbackUrl, miniprogram);
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ¡ˆ

### æµ‹è¯•æ­¥éª¤

#### 1. é…ç½®éªŒè¯
```yaml
# æ£€æŸ¥é…ç½®æ–‡ä»¶
wechat:
  miniprogram:
    appid: wxXXXXXXXXXXXXXXXX  # ç¡®è®¤è¿™é‡Œé…ç½®æ­£ç¡®
```

#### 2. æ—¥å¿—éªŒè¯
è§¦å‘è¶…æ—¶é€šçŸ¥åï¼ŒæŸ¥çœ‹æ—¥å¿—ï¼š
```
ğŸ“± é…ç½®å°ç¨‹åºè·³è½¬ - è½¦ç‰Œ: äº¬A12345, é¡µé¢è·¯å¾„: pagesA/appointment/appointment?plateNumber=äº¬A12345
ğŸ“¤ å‘é€æ¨¡æ¿æ¶ˆæ¯ - openid: xxx, templateId: xxx, response: {"errcode":0,"errmsg":"ok","msgid":123456}
```

#### 3. å¾®ä¿¡ç«¯éªŒè¯
- æ‰“å¼€å¾®ä¿¡
- æŸ¥çœ‹æœåŠ¡é€šçŸ¥
- ç‚¹å‡»é€šçŸ¥
- **é¢„æœŸç»“æœ**ï¼šè‡ªåŠ¨è·³è½¬åˆ°å°ç¨‹åºå¯¹åº”é¡µé¢

#### 4. å¼‚å¸¸æƒ…å†µæµ‹è¯•
- AppIDé…ç½®é”™è¯¯ â†’ åº”è¯¥æœ‰é”™è¯¯æ—¥å¿—
- é¡µé¢è·¯å¾„ä¸å­˜åœ¨ â†’ å°ç¨‹åºæ˜¾ç¤º404
- ç”¨æˆ·æœªæˆæƒå°ç¨‹åº â†’ æç¤ºæˆæƒ

---

## ğŸ“Š å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·è½¦è¾†å³å°†è¶…æ—¶
    â†“
å®šæ—¶ä»»åŠ¡æ£€æµ‹åˆ° (ParkingTimeoutMonitoringTask)
    â†“
è°ƒç”¨å‘é€é€šçŸ¥æ–¹æ³• (sendParkingAlmostTimeoutNotification)
    â†“
æ„å»ºæ¨¡æ¿æ•°æ® + å°ç¨‹åºè·³è½¬å‚æ•°
    â†“
è°ƒç”¨å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯API
    â†“
ç”¨æˆ·å¾®ä¿¡æ”¶åˆ°æœåŠ¡é€šçŸ¥
    â†“
ç”¨æˆ·ç‚¹å‡»é€šçŸ¥
    â†“
å¾®ä¿¡è‡ªåŠ¨æ‰“å¼€å°ç¨‹åºå¹¶è·³è½¬åˆ°æŒ‡å®šé¡µé¢
    â†“
å°ç¨‹åºé¡µé¢æ¥æ”¶å‚æ•° (onLoad)
    â†“
æ ¹æ®å‚æ•°æ˜¾ç¤ºå¯¹åº”çš„é¢„çº¦ä¿¡æ¯/è¶…æ—¶æç¤º
```

---

## ğŸ’¡ æœ€ä½³å®è·µå»ºè®®

### 1. ç»Ÿä¸€çš„è·³è½¬å‚æ•°ç®¡ç†
åˆ›å»ºä¸€ä¸ªå·¥å…·ç±»ç®¡ç†æ‰€æœ‰å°ç¨‹åºè·³è½¬è·¯å¾„ï¼š

```java
public class MiniprogramPagePathBuilder {
    
    /**
     * æ„å»ºè¶…æ—¶æé†’è·³è½¬è·¯å¾„
     */
    public static String buildTimeoutPath(String plateNumber, long remainingMinutes) {
        return String.format("pagesA/appointment/appointment?plateNumber=%s&remainingMinutes=%d&action=timeout",
            urlEncode(plateNumber), remainingMinutes);
    }
    
    /**
     * æ„å»ºè¿è§„é€šçŸ¥è·³è½¬è·¯å¾„
     */
    public static String buildViolationPath(String plateNumber) {
        return String.format("pagesE/violation/violation?plateNumber=%s",
            urlEncode(plateNumber));
    }
    
    /**
     * URLç¼–ç 
     */
    private static String urlEncode(String value) {
        try {
            return URLEncoder.encode(value, "UTF-8");
        } catch (UnsupportedEncodingException e) {
            return value;
        }
    }
}
```

### 2. é…ç½®åŒ–ç®¡ç†
å°†è·³è½¬è·¯å¾„é…ç½®åŒ–ï¼š

```yaml
wechat:
  miniprogram:
    appid: wxXXXXXXXXXXXXXXXX
    pages:
      timeout: pagesA/appointment/appointment
      violation: pagesE/violation/violation
      appointment: pagesA/appointment/detail
```

### 3. ç›‘æ§å’Œæ—¥å¿—
è®°å½•æ¯æ¬¡è·³è½¬çš„è¯¦ç»†æ—¥å¿—ï¼Œä¾¿äºæ’æŸ¥é—®é¢˜ï¼š

```java
log.info("ğŸ“± å°ç¨‹åºè·³è½¬é…ç½® - appid: {}, pagepath: {}, openid: {}, plateNumber: {}", 
    miniprogramAppId, pagePath, openid, plateNumber);
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯å¼€å‘æ–‡æ¡£](https://developers.weixin.qq.com/doc/offiaccount/Message_Management/Template_Message_Interface.html)
- [å°ç¨‹åºè·³è½¬å‚æ•°è¯´æ˜](https://developers.weixin.qq.com/miniprogram/dev/api/route/wx.navigateTo.html)
- [å…¬ä¼—å·å…³è”å°ç¨‹åº](https://developers.weixin.qq.com/doc/offiaccount/Account_Management/Applying_for_Applets.html)

---

## âœ… æ€»ç»“

è¦å®ç°ç‚¹å‡»å¾®ä¿¡é€šçŸ¥è·³è½¬åˆ°å°ç¨‹åºï¼Œéœ€è¦å®Œæˆä»¥ä¸‹å·¥ä½œï¼š

1. **ä¿®æ”¹ä»£ç **ï¼š
   - [ ] æ”¹é€  `sendTemplateMessage` æ–¹æ³•ï¼Œæ”¯æŒ `miniprogram` å‚æ•°
   - [ ] ä¿®æ”¹ `sendParkingAlmostTimeoutNotification` æ–¹æ³•ï¼Œæ·»åŠ å°ç¨‹åºè·³è½¬é…ç½®
   - [ ] å°ç¨‹åºé¡µé¢æ·»åŠ å‚æ•°æ¥æ”¶é€»è¾‘

2. **é…ç½®æ›´æ–°**ï¼š
   - [ ] åœ¨ `application.yml` ä¸­æ·»åŠ å°ç¨‹åºAppIDé…ç½®
   - [ ] ç¡®è®¤å…¬ä¼—å·å’Œå°ç¨‹åºå·²å…³è”

3. **æµ‹è¯•éªŒè¯**ï¼š
   - [ ] æµ‹è¯•è¶…æ—¶é€šçŸ¥æ˜¯å¦èƒ½æ­£ç¡®è·³è½¬
   - [ ] æµ‹è¯•é¡µé¢å‚æ•°æ˜¯å¦æ­£ç¡®æ¥æ”¶
   - [ ] æµ‹è¯•å¼‚å¸¸æƒ…å†µçš„å¤„ç†

4. **ä¼˜åŒ–å»ºè®®**ï¼š
   - [ ] åˆ›å»ºç»Ÿä¸€çš„è·³è½¬è·¯å¾„ç®¡ç†å·¥å…·ç±»
   - [ ] æ·»åŠ è¯¦ç»†çš„æ—¥å¿—è®°å½•
   - [ ] é…ç½®é™çº§æ–¹æ¡ˆ

å®Œæˆè¿™äº›æ­¥éª¤åï¼Œç”¨æˆ·ç‚¹å‡»å¾®ä¿¡é€šçŸ¥å°±èƒ½ç›´æ¥è·³è½¬åˆ°å°ç¨‹åºçš„å¯¹åº”é¡µé¢äº†ï¼
