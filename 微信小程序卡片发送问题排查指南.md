# 微信小程序卡片发送问题排查指南

## 📌 问题描述
用户关注公众号时，发送的小程序卡片无法点击进入小程序，或者只是显示一张图片。

## 🔍 问题原因分析

### 1. 小程序卡片 vs 图片消息的区别

| 消息类型 | 用户体验 | API类型 | 是否可点击 |
|---------|---------|---------|-----------|
| **小程序卡片** | 显示卡片，点击直接打开小程序 | `miniprogrampage` | ✅ 可点击 |
| **图片消息** | 只显示图片，无法点击 | `image` | ❌ 不可点击 |

### 2. 小程序卡片的必需条件

✅ **公众号与小程序必须关联**
- 登录微信公众平台
- 进入"小程序管理" → "已关联的小程序"
- 确认小程序已经和公众号关联

✅ **小程序AppID必须正确**
```yaml
wechat:
  miniapp:
    appid: wx112d8a922018480e  # 必须是正确的小程序AppID
```

✅ **页面路径必须存在**
```java
pagePath: "pages/index/index"  // 小程序中必须有这个页面
```

✅ **封面图必须是有效的临时素材**
- 必须上传到微信服务器，获得有效的media_id
- media_id有效期为3天
- 建议使用小程序码或相关的宣传图

## 🛠️ 排查步骤

### 第一步：检查配置文件

打开 `application.yml`，确认以下配置：

```yaml
wechat:
  # 小程序AppID（重要！）
  miniapp:
    appid: wx112d8a922018480e  # 替换为您的小程序AppID
    
  # 公众号AppID和Secret（用于发送消息）
  public:
    appid: wx7fcbbc5d885b630b
    secret: 19b9f00b48f266875b1b7e55eda6dd17
    
  # 欢迎消息文本
  welcome:
    text: 欢迎关注雪人停车服务号！您可以通过小程序进行停车预约、代人预约、查询、查看违规记录等操作。点击下方小程序卡片即可进入。
```

### 第二步：上传封面图素材

**方法1：通过前端管理页面上传（推荐）**

1. 访问：`https://www.xuerparking.cn/#/admin/tempMedia`
2. 准备一张图片（建议是小程序的宣传图或LOGO，尺寸建议：520x416）
3. 填写表单：
   - 素材类型：`图片`
   - 素材用途：`小程序二维码`（必须是这个名称！）
4. 上传图片

**方法2：通过微信开发者工具生成小程序码**

1. 使用微信开发者工具打开小程序项目
2. 生成小程序码图片
3. 通过管理页面上传此图片

### 第三步：查看日志诊断

重启应用后，让用户关注公众号，观察后端日志：

**✅ 成功的日志示例：**
```
👋 发送欢迎消息 - openId: oxxx
📌 小程序配置 - miniAppId: wx112d8a922018480e, welcomeText: 欢迎关注...
📤 发送文本消息 - openId: oxxx, 内容: 欢迎关注...
✅ 文本消息发送成功
🔍 获取到的media_id: MEDIA_ID_12345
📤 准备发送小程序卡片 - appid: wx112d8a922018480e, pagepath: pages/index/index
📤 发送小程序卡片 - openId: oxxx, title: 智慧停车小程序
📥 微信API响应: {"errcode":0,"errmsg":"ok"}
✅ 小程序卡片发送成功
✅ 欢迎消息发送成功（文本+小程序卡片）
```

**❌ 失败的日志示例及解决方法：**

#### 问题1：未找到素材
```
⚠️ 未找到小程序二维码素材！
⚠️ 请确保：1.已上传素材 2.素材用途为'小程序二维码' 3.素材未过期
```
**解决方法**：按照"第二步"上传素材

#### 问题2：小程序AppID未配置
```
❌ 小程序AppID未配置！请检查application.yml中的wechat.miniapp.appid配置
```
**解决方法**：检查配置文件，确保`wechat.miniapp.appid`已正确配置

#### 问题3：小程序卡片发送失败
```
📥 微信API响应: {"errcode":40165,"errmsg":"invalid appid"}
❌ 小程序卡片发送失败！
```
**可能原因及解决方法**：
- `errcode: 40165` - 小程序AppID错误或未关联
  - 解决：检查AppID是否正确，公众号和小程序是否已关联
- `errcode: 40007` - media_id无效
  - 解决：重新上传素材获取新的media_id
- `errcode: 47003` - 参数错误
  - 解决：检查页面路径是否正确（`pages/index/index`）

### 第四步：测试小程序页面路径

确认小程序中存在指定的页面路径：

1. 打开小程序项目
2. 检查 `pages/index/index` 文件是否存在
3. 检查 `app.json` 中是否注册了该页面：

```json
{
  "pages": [
    "pages/index/index",
    ...
  ]
}
```

如果使用其他页面路径，需要修改代码：

```java
// WeChatCustomMessageServiceImpl.java 第185行
"pages/index/index",  // 改为您的实际页面路径，如 "pages/home/home"
```

## 📱 用户端效果对比

### ✅ 正确效果（小程序卡片）
```
┌─────────────────────────┐
│ 智慧停车小程序          │
│ [小程序封面图]          │
│                         │
│ 点击进入 >              │
└─────────────────────────┘
```
- 用户看到卡片式消息
- 显示"智慧停车小程序"标题
- 点击后直接打开小程序，进入指定页面

### ❌ 错误效果（图片消息）
```
┌─────────────────────────┐
│                         │
│   [只是一张图片]        │
│                         │
└─────────────────────────┘
```
- 用户只看到一张图片
- 无法点击
- 需要长按识别二维码（如果是二维码图）

## 🔧 降级处理

如果小程序卡片发送失败，代码会自动降级为图片消息：

```java
// 作为降级方案，发送图片消息
log.info("📤 降级方案：发送图片消息");
sendImageMessage(openId, qrcodeMediaId);
```

此时用户会收到图片，但需要长按识别二维码（如果上传的是二维码图片）。

## ✅ 完整检查清单

使用前请确认以下所有项目：

- [ ] 公众号和小程序已在微信公众平台关联
- [ ] `application.yml` 中 `wechat.miniapp.appid` 配置正确
- [ ] `application.yml` 中 `wechat.public.appid` 和 `secret` 配置正确
- [ ] 已通过管理页面上传封面图，素材用途为"小程序二维码"
- [ ] 素材未过期（3天内）
- [ ] 小程序中存在 `pages/index/index` 页面（或已修改为实际路径）
- [ ] 已重启Spring Boot应用
- [ ] 公众号已设置IP白名单（生产环境必需）

## 🎯 快速测试方法

1. **重新关注公众号**
   - 先取消关注
   - 再重新关注
   - 触发欢迎消息

2. **查看后端日志**
   - 观察是否有"✅ 小程序卡片发送成功"
   - 如有错误，根据日志提示排查

3. **检查手机端效果**
   - 如果是卡片样式且可点击 → 成功 ✅
   - 如果只是图片 → 检查日志，按照上述步骤排查 ❌

## 📞 常见问题FAQ

### Q1: 为什么我上传的是二维码图片，但发送出来无法扫描？
A: 因为是以"小程序卡片"形式发送的，不是图片消息。用户应该**点击卡片**进入小程序，而不是扫描二维码。如果希望用户扫码，需要发送图片消息。

### Q2: 如何修改小程序的进入页面？
A: 修改 `WeChatCustomMessageServiceImpl.java` 第185行的 `pagePath` 参数。

### Q3: 封面图有什么要求？
A: 
- 格式：JPG/PNG
- 大小：不超过2MB
- 尺寸建议：520x416（可以其他比例，但不要太小）
- 内容：小程序的宣传图、LOGO或小程序码都可以

### Q4: 多久刷新一次素材？
A: 定时任务每2天凌晨3点自动刷新，也可以在管理页面手动刷新。

### Q5: 如何确认公众号和小程序已关联？
A: 
1. 登录微信公众平台（公众号）
2. 左侧菜单：小程序管理 → 已关联的小程序
3. 查看列表中是否有您的小程序
4. 如未关联，点击"关联小程序"按钮

## 🚀 最佳实践建议

1. **封面图选择**：使用清晰的小程序宣传图，比纯二维码更美观
2. **欢迎文案**：在欢迎文字中明确引导用户"点击下方卡片进入小程序"
3. **定期检查**：每月检查一次临时素材是否有效
4. **监控日志**：定期查看日志，及时发现问题

## 📝 修改记录
- 2024-11-24: 增强日志输出，添加降级方案
- 2024-11-24: 创建排查指南文档
